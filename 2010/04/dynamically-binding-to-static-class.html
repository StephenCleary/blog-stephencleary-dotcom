<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Dynamically Binding to Static (Class-Scoped) Members</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content=".NET 4.0 was a huge release, containing a wide variety of much-anticipated features. One of these features is the C# support for dynamic languages via the new keyword dynamic. Dynamic brings some very powerful semantics into the language, and naturally also comes with a few limitations." />
    <link rel="canonical" href="http://blog.stephencleary.com/2010/04/dynamically-binding-to-static-class.html" />
    
    <link rel="alternate" type="application/rss+xml" title="Stephen Cleary (the blog)" href="http://feeds.feedburner.com/NitoPrograms" />
    
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/bootswatch/3.2.0/spacelab/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" />
    <link type="text/css" rel="stylesheet" href="http://stephencleary.com/css/main.css" />
    <meta name="application-name" content="Stephen Cleary" />
    <link rel="apple-touch-icon" sizes="57x57" href="http://stephencleary.com/icons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="http://stephencleary.com/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="http://stephencleary.com/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="http://stephencleary.com/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="http://stephencleary.com/icons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="http://stephencleary.com/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="http://stephencleary.com/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="http://stephencleary.com/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" href="http://stephencleary.com/icons/apple-touch-icon.png"/>
    <link rel="apple-touch-icon-precomposed" href="http://stephencleary.com/icons/apple-touch-icon-precomposed.png"/>
    <link rel="icon" type="image/png" href="http://stephencleary.com/icons/favicon-196x196.png" sizes="196x196">
    <link rel="icon" type="image/png" href="http://stephencleary.com/icons/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="http://stephencleary.com/icons/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="http://stephencleary.com/icons/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="http://stephencleary.com/icons/favicon-32x32.png" sizes="32x32">
    
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <div class="navbar-brand-container"><a class="navbar-brand" href="http://stephencleary.com">Stephen Cleary</a></div>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
            <li  class="active"  ><a href="http://blog.stephencleary.com">Blog</a></li>
            <li  ><a href="http://stephencleary.com/projects/">Projects</a></li>
            <li  ><a href="http://stephencleary.com/publications/">Publications</a></li>
            <li  ><a href="http://stephencleary.com/contact/">Contact</a></li>
            <li><a href="http://feeds.feedburner.com/NitoPrograms"><i class="fa fa-rss-square fa-lg"></i></a></li>
            <li  ><a href="http://stephencleary.com/search/"><i class="fa fa-search"></i></a></li>
        </ul>
    </div>
</nav>

    <div class="container-fluid">
        <div class="col-sm-8 col-sm-offset-2 col-md-6 col-md-offset-3">
            <div class="post">

  <header>
      <div class="page-header">
          <h1>Dynamically Binding to Static (Class-Scoped) Members</h1>
          <small><time datetime="2010-04-30">Apr 30, 2010</time> &bull; <a data-disqus-identifier="/2010/04/dynamically-binding-to-static-class" href="#disqus_thread">Comments</a></small>
      </div>
  </header>

  <article>
  <p>.NET 4.0 was a huge release, containing a wide variety of much-anticipated features. One of these features is the C# support for dynamic languages via the new keyword <em>dynamic</em>. Dynamic brings some very powerful semantics into the language, and naturally also comes with a few limitations.</p>

<p>One limitation is dynamically accessing static (class-scoped) members. The <em>dynamic</em> type is intended to represent a dynamic instance, not a dynamic class. For example, if two different classes have the same static method defined, there is no way to use <em>dynamic</em> to invoke those static methods.</p>

<p>One can use the <a href="http://msdn.microsoft.com/en-us/library/system.dynamic.dynamicobject.aspx">DynamicObject</a> class to redirect instance member access to static member access. This approach was first explored in David Ebbo’s blog post <a href="http://blogs.msdn.com/davidebb/archive/2009/10/23/using-c-dynamic-to-call-static-members.aspx">“Using C# dynamic to call static members”</a>. However, this approach brings with it its own limitation.</p>

<p>The general concept is to implement a DynamicObject type that uses reflection to access static members. This makes sense since <em>dynamic</em> may be seen as a more user-friendly type of reflection (of course, this simple interpretation ignores a lot of other DLR benefits). Unfortunately, DynamicObject does not support the concept of ref/out parameters, even though they are fully supported by <em>dynamic</em>. There is a work-around for this: wrapping ref or out parameters, adding a layer of indirection. The RefOutArg class was invented for this purpose (<a href="http://nitokitchensink.codeplex.com/SourceControl/changeset/view/51391#1073961">official source</a>):</p>

<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// A wrapper around a &quot;ref&quot; or &quot;out&quot; argument invoked dynamically.</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">RefOutArg</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Initializes a new instance of the &lt;see cref=&quot;RefOutArg&quot;/&gt; class.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">private</span> <span class="nf">RefOutArg</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Gets or sets the wrapped value as an object.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="kt">object</span> <span class="n">ValueAsObject</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Gets or sets the wrapped value.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="kt">dynamic</span> <span class="n">Value</span>
    <span class="p">{</span>
        <span class="k">get</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">ValueAsObject</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">set</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">ValueAsObject</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Creates a new instance of the &lt;see cref=&quot;RefOutArg&quot;/&gt; class wrapping the default value of &lt;typeparamref name=&quot;T&quot;/&gt;.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;typeparam name=&quot;T&quot;&gt;The type of value to wrap.&lt;/typeparam&gt;</span>
    <span class="c1">/// &lt;returns&gt;A new instance of the &lt;see cref=&quot;RefOutArg&quot;/&gt; class wrapping the default value of &lt;typeparamref name=&quot;T&quot;/&gt;.&lt;/returns&gt;</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">RefOutArg</span> <span class="n">Create</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">RefOutArg</span> <span class="p">{</span> <span class="n">ValueAsObject</span> <span class="p">=</span> <span class="k">default</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="p">};</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Creates a new instance of the &lt;see cref=&quot;RefOutArg&quot;/&gt; class wrapping the specified value.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name=&quot;value&quot;&gt;The value to wrap.&lt;/param&gt;</span>
    <span class="c1">/// &lt;returns&gt;A new instance of the &lt;see cref=&quot;RefOutArg&quot;/&gt; class wrapping the specified value.&lt;/returns&gt;</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">RefOutArg</span> <span class="nf">Create</span><span class="p">(</span><span class="kt">object</span> <span class="k">value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">RefOutArg</span> <span class="p">{</span> <span class="n">ValueAsObject</span> <span class="p">=</span> <span class="k">value</span> <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>RefOutArg is a very simple class that contains a single value (which can be accessed either as <em>object</em> or <em>dynamic</em>).</p>

<p>The DynamicStaticTypeMembers class enables dynamic access to static members. It is similar to David’s StaticMembersDynamicWrapper, only this class allows setting static properties, invoking overloaded static methods, and ref/out parameters using RefOutArg (<a href="http://nitokitchensink.codeplex.com/SourceControl/changeset/view/51391#1073960">official source</a>):</p>

<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Diagnostics.Contracts</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Dynamic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>

<span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// A dynamic object that allows access to a type&#39;s static members, resolved dynamically at runtime.</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">DynamicStaticTypeMembers</span> <span class="p">:</span> <span class="n">DynamicObject</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// The underlying type.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Type</span> <span class="n">type</span><span class="p">;</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Initializes a new instance of the &lt;see cref=&quot;DynamicStaticTypeMembers&quot;/&gt; class wrapping the specified type.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name=&quot;type&quot;&gt;The underlying type to wrap.&lt;/param&gt;</span>
    <span class="k">private</span> <span class="nf">DynamicStaticTypeMembers</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">type</span> <span class="p">=</span> <span class="n">type</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Gets a value for a static property defined by the wrapped type.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name=&quot;binder&quot;&gt;Provides information about the object that called the dynamic operation. The binder.Name property provides the name of the member on which the dynamic operation is performed. For example, for the Console.WriteLine(sampleObject.SampleProperty) statement, where sampleObject is an instance of the class derived from the &lt;see cref=&quot;T:System.Dynamic.DynamicObject&quot;/&gt; class, binder.Name returns &quot;SampleProperty&quot;. The binder.IgnoreCase property specifies whether the member name is case-sensitive.&lt;/param&gt;</span>
    <span class="c1">/// &lt;param name=&quot;result&quot;&gt;The result of the get operation. For example, if the method is called for a property, you can assign the property value to &lt;paramref name=&quot;result&quot;/&gt;.&lt;/param&gt;</span>
    <span class="c1">/// &lt;returns&gt;</span>
    <span class="c1">/// true if the operation is successful; otherwise, false. If this method returns false, the run-time binder of the language determines the behavior. (In most cases, a run-time exception is thrown.)</span>
    <span class="c1">/// &lt;/returns&gt;</span>
    <span class="k">public</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">TryGetMember</span><span class="p">(</span><span class="n">GetMemberBinder</span> <span class="n">binder</span><span class="p">,</span> <span class="k">out</span> <span class="kt">object</span> <span class="n">result</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">prop</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">GetProperty</span><span class="p">(</span><span class="n">binder</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">FlattenHierarchy</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Static</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Public</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prop</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">result</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">result</span> <span class="p">=</span> <span class="n">prop</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Sets a value for a static property defined by the wrapped type.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name=&quot;binder&quot;&gt;Provides information about the object that called the dynamic operation. The binder.Name property provides the name of the member to which the value is being assigned. For example, for the statement sampleObject.SampleProperty = &quot;Test&quot;, where sampleObject is an instance of the class derived from the &lt;see cref=&quot;T:System.Dynamic.DynamicObject&quot;/&gt; class, binder.Name returns &quot;SampleProperty&quot;. The binder.IgnoreCase property specifies whether the member name is case-sensitive.&lt;/param&gt;</span>
    <span class="c1">/// &lt;param name=&quot;value&quot;&gt;The value to set to the member. For example, for sampleObject.SampleProperty = &quot;Test&quot;, where sampleObject is an instance of the class derived from the &lt;see cref=&quot;T:System.Dynamic.DynamicObject&quot;/&gt; class, the &lt;paramref name=&quot;value&quot;/&gt; is &quot;Test&quot;.&lt;/param&gt;</span>
    <span class="c1">/// &lt;returns&gt;</span>
    <span class="c1">/// true if the operation is successful; otherwise, false. If this method returns false, the run-time binder of the language determines the behavior. (In most cases, a language-specific run-time exception is thrown.)</span>
    <span class="c1">/// &lt;/returns&gt;</span>
    <span class="k">public</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">TrySetMember</span><span class="p">(</span><span class="n">SetMemberBinder</span> <span class="n">binder</span><span class="p">,</span> <span class="kt">object</span> <span class="k">value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">prop</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">GetProperty</span><span class="p">(</span><span class="n">binder</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">FlattenHierarchy</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Static</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Public</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prop</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">prop</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="k">value</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Calls a static method defined by the wrapped type.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name=&quot;binder&quot;&gt;Provides information about the dynamic operation. The binder.Name property provides the name of the member on which the dynamic operation is performed. For example, for the statement sampleObject.SampleMethod(100), where sampleObject is an instance of the class derived from the &lt;see cref=&quot;T:System.Dynamic.DynamicObject&quot;/&gt; class, binder.Name returns &quot;SampleMethod&quot;. The binder.IgnoreCase property specifies whether the member name is case-sensitive.&lt;/param&gt;</span>
    <span class="c1">/// &lt;param name=&quot;args&quot;&gt;The arguments that are passed to the object member during the invoke operation. For example, for the statement sampleObject.SampleMethod(100), where sampleObject is derived from the &lt;see cref=&quot;T:System.Dynamic.DynamicObject&quot;/&gt; class, &lt;c&gt;args[0]&lt;/c&gt; is equal to 100.&lt;/param&gt;</span>
    <span class="c1">/// &lt;param name=&quot;result&quot;&gt;The result of the member invocation.&lt;/param&gt;</span>
    <span class="c1">/// &lt;returns&gt;</span>
    <span class="c1">/// true if the operation is successful; otherwise, false. If this method returns false, the run-time binder of the language determines the behavior. (In most cases, a language-specific run-time exception is thrown.)</span>
    <span class="c1">/// &lt;/returns&gt;</span>
    <span class="k">public</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">TryInvokeMember</span><span class="p">(</span><span class="n">InvokeMemberBinder</span> <span class="n">binder</span><span class="p">,</span> <span class="kt">object</span><span class="p">[]</span> <span class="n">args</span><span class="p">,</span> <span class="k">out</span> <span class="kt">object</span> <span class="n">result</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Convert any RefOutArg arguments into ref/out arguments</span>
        <span class="kt">var</span> <span class="n">refArguments</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RefOutArg</span><span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">Length</span><span class="p">];</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">!=</span> <span class="n">args</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">refArguments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">as</span> <span class="n">RefOutArg</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">refArguments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">refArguments</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ValueAsObject</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// Resolve the method</span>
        <span class="k">const</span> <span class="n">BindingFlags</span> <span class="n">flags</span> <span class="p">=</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">InvokeMethod</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">FlattenHierarchy</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Static</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Public</span><span class="p">;</span>
        <span class="kt">object</span> <span class="n">state</span><span class="p">;</span>
        <span class="n">MethodBase</span> <span class="n">method</span><span class="p">;</span>

        <span class="kt">var</span> <span class="n">methods</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">GetMethods</span><span class="p">(</span><span class="n">flags</span><span class="p">).</span><span class="n">Where</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="n">binder</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
        <span class="n">method</span> <span class="p">=</span> <span class="n">Type</span><span class="p">.</span><span class="n">DefaultBinder</span><span class="p">.</span><span class="n">BindToMethod</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">methods</span><span class="p">.</span><span class="n">ToArray</span><span class="p">(),</span> <span class="k">ref</span> <span class="n">args</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">out</span> <span class="n">state</span><span class="p">);</span>

        <span class="c1">// Ensure that all ref/out arguments were properly wrapped</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">method</span><span class="p">.</span><span class="n">GetParameters</span><span class="p">().</span><span class="n">Count</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">ParameterType</span><span class="p">.</span><span class="n">IsByRef</span><span class="p">)</span> <span class="p">!=</span> <span class="n">refArguments</span><span class="p">.</span><span class="n">Count</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span> <span class="p">!=</span> <span class="k">null</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="s">&quot;ref/out parameters need a RefOutArg wrapper when invoking &quot;</span> <span class="p">+</span> <span class="k">this</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">Name</span> <span class="p">+</span> <span class="s">&quot;.&quot;</span> <span class="p">+</span> <span class="n">binder</span><span class="p">.</span><span class="n">Name</span> <span class="p">+</span> <span class="s">&quot;.&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Invoke the method, allowing exceptions to propogate</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="n">result</span> <span class="p">=</span> <span class="n">method</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">finally</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Type</span><span class="p">.</span><span class="n">DefaultBinder</span><span class="p">.</span><span class="n">ReorderArgumentArray</span><span class="p">(</span><span class="k">ref</span> <span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// Convert any ref/out arguments into RefOutArg results</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">!=</span> <span class="n">args</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">refArguments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">refArguments</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ValueAsObject</span> <span class="p">=</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Creates a new instance of the &lt;see cref=&quot;DynamicStaticTypeMembers&quot;/&gt; class wrapping the specified type.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name=&quot;type&quot;&gt;The underlying type to wrap. May not be &lt;c&gt;null&lt;/c&gt;.&lt;/param&gt;</span>
    <span class="c1">/// &lt;returns&gt;An instance of &lt;see cref=&quot;DynamicStaticTypeMembers&quot;/&gt;, as a dynamic type.&lt;/returns&gt;</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">dynamic</span> <span class="nf">Create</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Contract</span><span class="p">.</span><span class="n">Requires</span><span class="p">&lt;</span><span class="n">ArgumentNullException</span><span class="p">&gt;(</span><span class="n">type</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DynamicStaticTypeMembers</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Creates a new instance of the &lt;see cref=&quot;DynamicStaticTypeMembers&quot;/&gt; class wrapping the specified type.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;typeparam name=&quot;T&quot;&gt;The underlying type to wrap.&lt;/typeparam&gt;</span>
    <span class="c1">/// &lt;returns&gt;An instance of &lt;see cref=&quot;DynamicStaticTypeMembers&quot;/&gt;, as a dynamic type.&lt;/returns&gt;</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">dynamic</span> <span class="n">Create</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DynamicStaticTypeMembers</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>An instance of DynamicStaticTypeMembers may be constructed by passing either a generic type or Type instance into the Create method:</p>

<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">mathClass</span> <span class="p">=</span> <span class="n">DynamicStaticTypeMembers</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Math</span><span class="p">));</span>
<span class="kt">var</span> <span class="n">intEqualityComparerClass</span> <span class="p">=</span> <span class="n">DynamicStaticTypeMembers</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="n">EqualityComparer</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;&gt;();</span>
<span class="kt">var</span> <span class="n">threadClass</span> <span class="p">=</span> <span class="n">DynamicStaticTypeMembers</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="n">Thread</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">intClass</span> <span class="p">=</span> <span class="n">DynamicStaticTypeMembers</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;();</span></code></pre></div>

<p>Once created, any static property or method of that class may be invoked using instance syntax:</p>

<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">int</span> <span class="n">result0</span> <span class="p">=</span> <span class="n">mathClass</span><span class="p">.</span><span class="n">Min</span><span class="p">(</span><span class="m">13</span><span class="p">,</span> <span class="m">15</span><span class="p">);</span> <span class="c1">// invokes Math.Min(int, int)</span>
<span class="kt">var</span> <span class="n">comparer</span> <span class="p">=</span> <span class="n">intEqualityComparerClass</span><span class="p">.</span><span class="n">Default</span><span class="p">;</span> <span class="c1">// gets EqualityComparer&lt;int&gt;.Default</span>
<span class="n">threadClass</span><span class="p">.</span><span class="n">CurrentPrincipal</span> <span class="p">=</span> <span class="k">new</span> <span class="n">GenericPrincipal</span><span class="p">(</span><span class="k">new</span> <span class="n">GenericIdentity</span><span class="p">(</span><span class="s">&quot;Bob&quot;</span><span class="p">),</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="p">});</span> <span class="c1">// sets Thread.CurrentPrincipal</span></code></pre></div>

<p>Invoking methods with ref or out parameters is more awkward, but possible:</p>

<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">int</span> <span class="n">result1</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">result1arg</span> <span class="p">=</span> <span class="n">RefOutArg</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;();</span> <span class="c1">// or: RefOutArg.Create(0);</span>
<span class="n">intClass</span><span class="p">.</span><span class="n">TryParse</span><span class="p">(</span><span class="s">&quot;13&quot;</span><span class="p">,</span> <span class="n">result1arg</span><span class="p">);</span> <span class="c1">// invokes int.TryParse(string, out int)</span>
<span class="n">result1</span> <span class="p">=</span> <span class="n">result1arg</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span></code></pre></div>

<p>This can be a powerful tool in some cases, allowing a higher form of “duck typing.” For instance, the new <a href="http://msdn.microsoft.com/en-us/library/system.numerics.biginteger.aspx">BigInteger</a> numeric type defines its own <em>DivRem</em> method similar to the existing <em>DivRem</em> methods defined on the <a href="http://msdn.microsoft.com/en-us/library/system.math.aspx">Math</a> class for <em>int</em> and <em>long</em>. Using DynamicStaticTypeMembers, it is possible to define a generic <em>DivRem</em> that attempts to invoke <em>Math.DivRem</em> but falls back on a <em>DivRem</em> defined by the numeric type:</p>

<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="n">T</span> <span class="n">DivRem</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">dividend</span><span class="p">,</span> <span class="n">T</span> <span class="n">divisor</span><span class="p">,</span> <span class="k">out</span> <span class="n">T</span> <span class="n">remainder</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">remainderArg</span> <span class="p">=</span> <span class="n">RefOutArg</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
    <span class="kt">dynamic</span> <span class="n">ret</span><span class="p">;</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">dT</span> <span class="p">=</span> <span class="n">DynamicStaticTypeMembers</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Math</span><span class="p">));</span>
        <span class="n">ret</span> <span class="p">=</span> <span class="n">dT</span><span class="p">.</span><span class="n">DivRem</span><span class="p">(</span><span class="n">dividend</span><span class="p">,</span> <span class="n">divisor</span><span class="p">,</span> <span class="n">remainderArg</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">dT</span> <span class="p">=</span> <span class="n">DynamicStaticTypeMembers</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
        <span class="n">ret</span> <span class="p">=</span> <span class="n">dT</span><span class="p">.</span><span class="n">DivRem</span><span class="p">(</span><span class="n">dividend</span><span class="p">,</span> <span class="n">divisor</span><span class="p">,</span> <span class="n">remainderArg</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">remainder</span> <span class="p">=</span> <span class="n">remainderArg</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<p>Our generic <em>DivRem</em> can be invoked with T being <em>int</em>, <em>long</em>, <em>BigInteger</em>, or any other type as long as that type defines its own <em>DivRem</em> with a compatible signature.</p>

<p>Most programs will not require this level of type flexibility, but it’s nice to know it’s there for those few cases that do need it.</p>


  </article>
    
    <footer>
        
        
        
        <ul class="pager">
            <li class="previous"><a href="/2010/04/innovations-are-great-but-content-is.html" title="Innovations Are Great, but Content Is Necessary">&larr; Previous Post</a></li>
            <li class="next"><a href="/2010/05/ms-bug-mvcbuildviews-with-one-click.html" title="MS Bug: MvcBuildViews with One-Click Publish">Next Post &rarr;</a></li>
        </ul>

        <div id="disqus_thread"></div>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </footer>
</div>
        </div>
        <div class="col-sm-2 col-md-3 col-md-offset-0 col-lg-2 col-lg-offset-1 affix" data-spy="affix" role="navigation">
            
            
        </div>
        <div class="col-sm-2 sidebar">
            <div class="panel panel-default">
                <div class="panel-heading">About Stephen Cleary</div>
                <div class="panel-body">
                    <div class="center"><img src="http://stephencleary.com/www.assets/Me-large.jpg"/></div>
                    <div class="center vertical-margins">Stephen Cleary is a <a href="http://www.landmarkbaptist.ws/salvation">Christian</a>, <a href="http://picasaweb.google.com/stephenandmandy">husband, father,</a> and programmer living in Northern Michigan.</div>
                    <div class="center"><a href="http://mvp.microsoft.com/en-us/mvp/Stephen%20Cleary-5000058"><img class="mvp-logo" src="http://stephencleary.com/www.assets/MVP.png"/></a></div>
                </div>
            </div>
            <div class="panel panel-primary">
                <div class="panel-heading">My book</div>
                <div class="panel-body center">
                    <div><a href="http://tinyurl.com/ConcurrencyCookbook"><img src="http://stephencleary.com/www.assets/Book-small.jpg"/></a></div>
                    <div>Available from <a href="http://tinyurl.com/ConcurrencyCookbook">O'Reilly</a> or <a href="http://tinyurl.com/ConcurrencyCookbookAmazon">Amazon</a>.</div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Advertisement</div>
                <div class="panel-body">
                    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2749292939902134" data-ad-slot="7584809820" data-ad-format="auto"></ins>
                </div>
            </div>
            
            <div class="panel panel-primary">
                <div class="panel-heading">Popular Posts</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2012/02/async-and-await.html">Async/await Intro</a></li>
                        <li><a href="/2013/11/there-is-no-thread.html">There Is No Thread</a></li>
                        <li><a href="/2012/07/dont-block-on-async-code.html">Don't Block on Async Code</a></li>
                    </ul>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Series</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2014/04/a-tour-of-task-part-0-overview.html">A Tour of Task</a></li>
                        <li><a href="/2013/10/taskrun-etiquette-and-proper-usage.html">Task.Run Etiquette</a></li>
                        <li><a href="/2013/05/taskrun-vs-backgroundworker-intro.html">Task.Run vs. BackgroundWorker</a></li>
                        <li><a href="/2013/01/async-oop-0-introduction.html">Async OOP</a></li>
                        <li><a href="/2009/04/tcpip-net-sockets-faq.html">TCP/IP .NET Sockets FAQ</a></li>
                        <li><a href="/2013/10/managed-services-roundup.html">Managed Services</a></li>
                        <li><a href="/2009/08/how-to-implement-idisposable-and.html">IDisposable and Finalizers</a></li>
                        <li><a href="/2011/02/option-parsing-introduction.html">Option Parsing</a></li>
                    </ul>
                </div>
            </div>
            
        </div>
    </div>

    <div class="google">
        <gcse:searchresults></gcse:searchresults>
    </div>
    
    <!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
<script type="text/javascript">window.jQuery || document.write('<script src="/lib/jquery-2.1.1.min.js"><\/script>')</script>

<!-- Bootstrap -->
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script type="text/javascript">window.jQuery.fn.modal || document.write('<script src="/lib/bootstrap.min.js"><\/script>')</script>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('body').css('color') !== 'rgb(102, 102, 102)') {
                $('head').prepend('<link rel="stylesheet" href="/lib/bootstrap.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Font Awesome -->
<span id="facheck" class="fa" style="display:none"></span>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('#facheck').css('fontFamily') !== 'FontAwesome') {
                $('head').prepend('<link rel="stylesheet" href="/lib/font-awesome.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Scroll the sidebar into view (if necessary) -->


<!-- Google analytics -->
<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-8910661-5', 'stephencleary.com');
    ga('send', 'pageview');
</script>







<!-- Disqus variables -->
<script type="text/javascript">
    var disqus_shortname = 'stephencleary';
    var disqus_identifier = "/2010/04/dynamically-binding-to-static-class";
    var disqus_title = "Dynamically Binding to Static (Class-Scoped) Members";
    var disqus_url = "http://blog.stephencleary.com/2010/04/dynamically-binding-to-static-class.html";
</script>

<!-- Disqus comment counter -->
<script type="text/javascript">
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
    }());
</script>

<!-- Disqus comment section -->
<script type="text/javascript">
    (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>



<!-- Google AdSense -->
<script src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- Moment -->
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.6.0/moment.min.js"></script>
<script type="text/javascript">window.moment || document.write('<script src="/lib/moment.min.js"><\/script>')</script>
<script type="text/javascript">
    (function($) {
        $(function() {
            $('time').each(function (_, e) {
                var text = moment($(e).attr('datetime'), 'YYYY-MM-DD').fromNow();
                $(e).text(function(_, oldText) { return text + ' (' + oldText + ')'; });
            });
        });
    })(window.jQuery);
</script>

</body>
</html>