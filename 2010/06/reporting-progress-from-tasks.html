<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Reporting Progress from Tasks</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <link rel="canonical" href="https://blog.stephencleary.com/2010/06/reporting-progress-from-tasks.html" />
    
    <link rel="alternate" type="application/rss+xml" title="Stephen Cleary (the blog)" href="http://feeds.feedburner.com/NitoPrograms" />
    
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/bootswatch/3.2.0/spacelab/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" />
    <style type="text/css">/* Layout Styles */
/* ----------------------------------------------------------*/

body {
    padding-top: 50px;
}

.affix {
    top: 70px;
    bottom: 0;
    overflow-y: auto;
}

.navbar-brand {
    font-weight: bold;
}

.navbar-brand-container.active>a, .navbar-brand-container.active>a:hover, .navbar-brand-container.active>a:focus {
    color: #3399f3;
    background-color: transparent;
}

.sidebar {
    margin-top: 20px;
}

.sidenavitem {
    height: auto;
}

.sidebar img {
    /* Responsive images */
    display: inline-block;
    height: auto;
    max-width: 100%;
}

@media(max-width:767px) {
    .affix {
        position: static;
    }
}

div .vertical-margins {
    margin-top: 10px;
    margin-bottom: 10px;
}

.page-header {
    margin-top: 20px;
}

.center {
    text-align: center;
}

.project-icon {
    height: 128px;
    width: 128px;
}

.list-group-item h2 {
    margin-top: 10px;
}

/* Fixes for Google Custom Search in a Bootstrap page */
/* ----------------------------------------------------------*/
.google, .google *, .google *:before, .google *:after {
    -webkit-box-sizing: content-box;
    -moz-box-sizing: content-box;
    box-sizing: content-box;
}

.google table {
    border-collapse: separate;
}

.gsc-input-box {
    height: auto !important;
}

/* Fixes for Amazon widget in Bootstrap page */
.amzn_wdgt * {
    -webkit-box-sizing: content-box;
    -moz-box-sizing: content-box;
    box-sizing: content-box;
}

/* Post styles */
/* ----------------------------------------------------------*/

code {
    background-color: #F2F3F9;
    color: inherit;
}

.post img {
    /* Responsive images */
    display: inline-block;
    height: auto;
    max-width: 100%;
}

.post .table {
    table-layout: fixed;
}

.post .table code {
    white-space: normal;
}

.post .yes {
    color: #008000;
}

.post .no {
    color: #FF0000;
}

/* Syntax highlighting styles */
/* ----------------------------------------------------------*/

.highlight  { background: #ffffff; }
.highlight .c { color: #008000 } /* Comment */
.highlight .k { color: #0000ff } /* Keyword */
.highlight .cm { color: #008000 } /* Comment.Multiline */
.highlight .cp { color: #0000ff } /* Comment.Preproc */
.highlight .c1 { color: #008000 } /* Comment.Single */
.highlight .cs { color: #008000 } /* Comment.Special */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gh { font-weight: bold } /* Generic.Heading */
.highlight .gp { font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { font-weight: bold } /* Generic.Subheading */
.highlight .kc { color: #0000ff } /* Keyword.Constant */
.highlight .kd { color: #0000ff } /* Keyword.Declaration */
.highlight .kn { color: #0000ff } /* Keyword.Namespace */
.highlight .kp { color: #0000ff } /* Keyword.Pseudo */
.highlight .kr { color: #0000ff } /* Keyword.Reserved */
.highlight .kt { color: #2b91af } /* Keyword.Type */
.highlight .s { color: #a31515 } /* Literal.String */
.highlight .nc { color: #2b91af } /* Name.Class */
.highlight .ow { color: #0000ff } /* Operator.Word */
.highlight .sb { color: #a31515 } /* Literal.String.Backtick */
.highlight .sc { color: #a31515 } /* Literal.String.Char */
.highlight .sd { color: #a31515 } /* Literal.String.Doc */
.highlight .s2 { color: #a31515 } /* Literal.String.Double */
.highlight .se { color: #a31515 } /* Literal.String.Escape */
.highlight .sh { color: #a31515 } /* Literal.String.Heredoc */
.highlight .si { color: #a31515 } /* Literal.String.Interpol */
.highlight .sx { color: #a31515 } /* Literal.String.Other */
.highlight .sr { color: #a31515 } /* Literal.String.Regex */
.highlight .s1 { color: #a31515 } /* Literal.String.Single */
.highlight .ss { color: #a31515 } /* Literal.String.Symbol */

/* Comments */
/* ----------------------------------------------------------*/

.comment-container {
    margin-top: 1em;
}

.comment-container > .comment-container {
    margin-left: 2em;
}

.comment-container > .comment-container > .comment-container > .comment-container > .comment-container {
    margin-left: 0;
}

/* Correct anchor links in comments (they are offset by the height of the fixed header) */
.comment-anchor {
    display: block;
    position: relative;
    top: -60px;
    visibility: hidden;
}

img.comment-author-profile-image {
    height: 80px;
    width: 80px;
    margin-right: 10px;
}

.comment-message {
    overflow-x: auto;
}

.comment-form {
    border: 1px solid black;
    padding: 1em;
}

.comment-new {
    margin-top: 1em;
    margin-bottom: 1em;
}

.comment-new, .comment-reply {
    margin-left: 1em;
}

.comment-hidden {
    display: none;
}

.comment-form-buttonbar {
    margin-top: 1em;
}
</style>
    
    <meta name="application-name" content="Stephen Cleary" />
    <link rel="search" type="application/opensearchdescription+xml" href="https://stephencleary.com/opensearch.xml" title="Cleary Search">
    <link rel="apple-touch-icon" sizes="57x57" href="https://stephencleary.com/icons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="https://stephencleary.com/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://stephencleary.com/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://stephencleary.com/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="https://stephencleary.com/icons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="https://stephencleary.com/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="https://stephencleary.com/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://stephencleary.com/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" href="https://stephencleary.com/icons/apple-touch-icon.png"/>
    <link rel="apple-touch-icon-precomposed" href="https://stephencleary.com/icons/apple-touch-icon-precomposed.png"/>
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-196x196.png" sizes="196x196">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-32x32.png" sizes="32x32">
    
    <meta name="google-site-verification" content="L8q0fpGSwpNSD0OGFI07hyMujSpORrV4tAaNx_Js7oQ" />
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <div class="navbar-brand-container"><a class="navbar-brand" href="https://stephencleary.com">Stephen Cleary</a></div>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
            <li  class="active"  ><a href="https://blog.stephencleary.com">Blog</a></li>
            <li  ><a href="https://stephencleary.com/book/">Book</a></li>
            <li  ><a href="https://stephencleary.com/projects/">Projects</a></li>
            <li  ><a href="https://stephencleary.com/publications/">Publications</a></li>
            <li  ><a href="https://stephencleary.com/contact/">Contact</a></li>
            <li  ><a href="https://stephencleary.com/contract/">Hire Me</a></li>
            <li><a href="http://feeds.feedburner.com/NitoPrograms"><i class="fa fa-rss-square fa-lg"></i></a></li>
            <li  ><a href="https://stephencleary.com/search/"><i class="fa fa-search"></i></a></li>
        </ul>
    </div>
</nav>

    <div class="container-fluid">
        <div class="col-sm-8 col-sm-offset-2 col-md-6 col-md-offset-3">
            <div class="post">

  <header>
      <div class="page-header">
          <h1>Reporting Progress from Tasks</h1>
          <small><time datetime="2010-06-18">Jun 18, 2010</time> &bull; <a id="comment-counter" href="#comments">Comments</a></small>
      </div>
  </header>

  <article>
  <div class="alert alert-danger">
  <p><i class="fa fa-exclamation-triangle fa-2x pull-left"></i></p>

  <p><strong>Update, 2012-02-16:</strong> The information in this post is old. See the new post <a href="/2012/02/reporting-progress-from-async-tasks.html" class="alert-link">Reporting Progress from Async Tasks</a> for a better solution.</p>
</div>

<p>The .NET 4.0 <a href="http://msdn.microsoft.com/en-us/library/dd460717.aspx?WT.mc_id=DT-MVP-5000058">Task Parallel Library</a> respresents a huge shift in the way future multithreaded code will be written. The TPL and higher-level abstractions (such as the <a href="http://msdn.microsoft.com/en-us/library/system.threading.tasks.parallel.aspx?WT.mc_id=DT-MVP-5000058">Parallel class</a>, <a href="http://msdn.microsoft.com/en-us/library/dd460688.aspx?WT.mc_id=DT-MVP-5000058">Parallel LINQ</a>, and the <a href="http://msdn.microsoft.com/en-us/devlabs/ee794896.aspx?WT.mc_id=DT-MVP-5000058">Reactive Extensions</a>) will (hopefully) become the default approach for handling all multithreading situations. There is (almost) no reason to use the old <a href="http://msdn.microsoft.com/en-us/library/system.threading.thread.aspx?WT.mc_id=DT-MVP-5000058">Thread class</a> anymore.</p>

<p>Similarly, the <a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.backgroundworker.aspx?WT.mc_id=DT-MVP-5000058">BackgroundWorker class</a> has seen its heyday. It is time for this old class to retire as well. However, BGW does have one benefit over the TPL: it is easier to use for background tasks that need to report progress to the UI.</p>

<p>Background tasks come in two basic flavors. Some of them update the UI infrequently, and can be easily broken into separate tasks which only update at each “checkpoint.” Other background tasks update the UI more frequently, and cannot be easily divided this way.</p>

<p>For the background tasks that infrequently update the UI, the common approach is to split them into separate Tasks with “checkpoints” in-between. At these “checkpoints,” a <a href="http://msdn.microsoft.com/en-us/library/ee372288.aspx?WT.mc_id=DT-MVP-5000058">task continuation</a> is used to update the UI. The C# FAQ blog has <a href="https://docs.microsoft.com/en-us/archive/blogs/csharpfaq/parallel-programming-task-schedulers-and-synchronization-context?WT.mc_id=DT-MVP-5000058">an entry</a> describing this approach.</p>

<p>For the background tasks that need to frequently update the UI (and can’t be easily split into “checkpointed” Tasks), another approach is necessary. The easiest solution is to create an inner Task to update the UI.</p>

<p>This post introduces the ProgressReporter type, which greatly simplifies background tasks that need to do frequent progress reporting. The goal for ProgressReporter is to allow update code that is as simple as <a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.backgroundworker.progresschanged.aspx?WT.mc_id=DT-MVP-5000058">BackgroundWorker.ProgressChanged</a>.</p>

<h2 id="the-example-framework">The Example Framework</h2>

<p>The UI is a single form with 3 buttons and a progress bar. The three buttons are Start, Error, and Cancel. The buttons are enabled and disabled based on whether the background task is running. The progress bar shows the progress of the task.</p>

<p>The background task runs for 3 seconds, counting from 0 to 99, updating the progress bar every 30 milliseconds. The task will then produce a result of 42. If the Error button is used to start the task, then the task will throw an exception instead of producing a result. The task is also cancelable, checking for cancellation each time it reports progress.</p>

<p>This is a rather complex example; it covers each background task scenario (successful completion, error conditions, and cancellation).</p>

<p>The UI framework is the same regardless of whether a BackgroundWorker or Task object is used for the background task:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Windows.Forms</span><span class="p">;</span>

<span class="k">public</span> <span class="k">sealed</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">MainForm</span> <span class="p">:</span> <span class="n">Form</span>
<span class="p">{</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="n">Button</span> <span class="n">startButton</span><span class="p">;</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="n">Button</span> <span class="n">errorButton</span><span class="p">;</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="n">Button</span> <span class="n">cancelButton</span><span class="p">;</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="n">ProgressBar</span> <span class="n">progressBar</span><span class="p">;</span>

  <span class="k">public</span> <span class="nf">MainForm</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">startButton</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Button</span>
    <span class="p">{</span>
      <span class="n">Text</span> <span class="p">=</span> <span class="s">&quot;Start&quot;</span><span class="p">,</span>
      <span class="n">Height</span> <span class="p">=</span> <span class="m">23</span><span class="p">,</span> <span class="n">Width</span> <span class="p">=</span> <span class="m">75</span><span class="p">,</span>
      <span class="n">Left</span> <span class="p">=</span> <span class="m">12</span><span class="p">,</span> <span class="n">Top</span> <span class="p">=</span> <span class="m">12</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="n">errorButton</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Button</span>
    <span class="p">{</span>
      <span class="n">Text</span> <span class="p">=</span> <span class="s">&quot;Error&quot;</span><span class="p">,</span>
      <span class="n">Height</span> <span class="p">=</span> <span class="m">23</span><span class="p">,</span> <span class="n">Width</span> <span class="p">=</span> <span class="m">75</span><span class="p">,</span>
      <span class="n">Left</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">startButton</span><span class="p">.</span><span class="n">Right</span> <span class="p">+</span> <span class="m">6</span><span class="p">,</span>
      <span class="n">Top</span> <span class="p">=</span> <span class="m">12</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="n">cancelButton</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Button</span>
    <span class="p">{</span>
      <span class="n">Text</span> <span class="p">=</span> <span class="s">&quot;Cancel&quot;</span><span class="p">,</span>
      <span class="n">Enabled</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
      <span class="n">Height</span> <span class="p">=</span> <span class="m">23</span><span class="p">,</span> <span class="n">Width</span> <span class="p">=</span> <span class="m">75</span><span class="p">,</span>
      <span class="n">Left</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">errorButton</span><span class="p">.</span><span class="n">Right</span> <span class="p">+</span> <span class="m">6</span><span class="p">,</span>
      <span class="n">Top</span> <span class="p">=</span> <span class="m">12</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="n">progressBar</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ProgressBar</span>
    <span class="p">{</span>
      <span class="n">Width</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">cancelButton</span><span class="p">.</span><span class="n">Right</span> <span class="p">-</span> <span class="m">12</span><span class="p">,</span>
      <span class="n">Height</span> <span class="p">=</span> <span class="m">23</span><span class="p">,</span>
      <span class="n">Left</span> <span class="p">=</span> <span class="m">12</span><span class="p">,</span>
      <span class="n">Top</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">startButton</span><span class="p">.</span><span class="n">Bottom</span> <span class="p">+</span> <span class="m">6</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="n">startButton</span><span class="p">.</span><span class="n">Click</span> <span class="p">+=</span>
      <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="n">startButton_Click</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="n">errorButton</span><span class="p">.</span><span class="n">Click</span> <span class="p">+=</span>
      <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="n">errorButton_Click</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="n">cancelButton</span><span class="p">.</span><span class="n">Click</span> <span class="p">+=</span>
      <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="n">cancelButton_Click</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="n">Controls</span><span class="p">.</span><span class="n">AddRange</span><span class="p">(</span><span class="k">new</span> <span class="n">Control</span><span class="p">[]</span>
    <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="n">startButton</span><span class="p">,</span>
      <span class="k">this</span><span class="p">.</span><span class="n">errorButton</span><span class="p">,</span>
      <span class="k">this</span><span class="p">.</span><span class="n">cancelButton</span><span class="p">,</span>
      <span class="k">this</span><span class="p">.</span><span class="n">progressBar</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="k">partial</span> <span class="k">void</span> <span class="nf">startButton_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">);</span>
  <span class="k">partial</span> <span class="k">void</span> <span class="nf">errorButton_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">);</span>
  <span class="k">partial</span> <span class="k">void</span> <span class="nf">cancelButton_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">);</span>

  <span class="k">private</span> <span class="k">void</span> <span class="nf">TaskIsRunning</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="c1">// Update UI to reflect background task.</span>
    <span class="k">this</span><span class="p">.</span><span class="n">startButton</span><span class="p">.</span><span class="n">Enabled</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="n">errorButton</span><span class="p">.</span><span class="n">Enabled</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="n">cancelButton</span><span class="p">.</span><span class="n">Enabled</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">void</span> <span class="nf">TaskIsComplete</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="c1">// Reset UI.</span>
    <span class="k">this</span><span class="p">.</span><span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="n">startButton</span><span class="p">.</span><span class="n">Enabled</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="n">errorButton</span><span class="p">.</span><span class="n">Enabled</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="n">cancelButton</span><span class="p">.</span><span class="n">Enabled</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
<span class="na">  [STAThread]</span>
  <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="c1">// Run the UI.</span>
    <span class="n">Application</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="k">new</span> <span class="n">MainForm</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>This defines a form called MainForm that has the UI described above. The two methods TaskIsRunning and TaskIsComplete handle the enabling and disabling of the buttons. There are also partial methods as placeholders for the button click events; these are used by the sample code below.</p>

<p>You can copy the code above by double-clicking it and then pressing Ctrl-C; then paste it into the Program.cs of a Windows Forms project. It should compile and run, displaying the form, but the buttons don’t do anything yet.</p>

<h2 id="a-bgw-that-updates-progress-frequently">A BGW That Updates Progress Frequently</h2>

<p>Here’s what the code looks like for a BGW that checks in frequently:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.ComponentModel</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Windows.Forms</span><span class="p">;</span>

<span class="k">partial</span> <span class="k">class</span> <span class="nc">MainForm</span>
<span class="p">{</span>
  <span class="k">private</span> <span class="n">BackgroundWorker</span> <span class="n">backgroundWorker</span><span class="p">;</span>

  <span class="k">partial</span> <span class="k">void</span> <span class="nf">startButton_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Start the background task without error.</span>
    <span class="k">this</span><span class="p">.</span><span class="n">StartBackgroundTask</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>

    <span class="c1">// Update UI to reflect background task.</span>
    <span class="k">this</span><span class="p">.</span><span class="n">TaskIsRunning</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">partial</span> <span class="k">void</span> <span class="nf">errorButton_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Start the background task with error.</span>
    <span class="k">this</span><span class="p">.</span><span class="n">StartBackgroundTask</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>

    <span class="c1">// Update UI to reflect background task.</span>
    <span class="k">this</span><span class="p">.</span><span class="n">TaskIsRunning</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">partial</span> <span class="k">void</span> <span class="nf">cancelButton_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Cancel the background task.</span>
    <span class="k">this</span><span class="p">.</span><span class="n">backgroundWorker</span><span class="p">.</span><span class="n">CancelAsync</span><span class="p">();</span>

    <span class="c1">// The UI will be updated by the cancellation handler.</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">void</span> <span class="nf">StartBackgroundTask</span><span class="p">(</span><span class="kt">bool</span> <span class="n">causeError</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">backgroundWorker</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BackgroundWorker</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="n">backgroundWorker</span><span class="p">.</span><span class="n">WorkerReportsProgress</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="n">backgroundWorker</span><span class="p">.</span><span class="n">WorkerSupportsCancellation</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="n">backgroundWorker</span><span class="p">.</span><span class="n">DoWork</span> <span class="p">+=</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">!=</span> <span class="m">100</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="c1">// Check for cancellation.</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">backgroundWorker</span><span class="p">.</span><span class="n">CancellationPending</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">args</span><span class="p">.</span><span class="n">Cancel</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">30</span><span class="p">);</span> <span class="c1">// Do some work.</span>

        <span class="c1">// Report progress of the work.</span>
        <span class="k">this</span><span class="p">.</span><span class="n">backgroundWorker</span><span class="p">.</span><span class="n">ReportProgress</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// After all that work, cause the error if requested.</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">causeError</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">&quot;Oops...&quot;</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// The answer, at last!</span>
      <span class="n">args</span><span class="p">.</span><span class="n">Result</span> <span class="p">=</span> <span class="m">42</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="n">backgroundWorker</span><span class="p">.</span><span class="n">ProgressChanged</span> <span class="p">+=</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
      <span class="c1">// Update UI to reflect the progress.</span>
      <span class="k">this</span><span class="p">.</span><span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">ProgressPercentage</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="n">backgroundWorker</span><span class="p">.</span><span class="n">RunWorkerCompleted</span> <span class="p">+=</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
      <span class="c1">// Update UI to reflect completion.</span>
      <span class="k">this</span><span class="p">.</span><span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="m">100</span><span class="p">;</span>

      <span class="c1">// Display results.</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Error</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="n">MessageBox</span><span class="p">.</span><span class="n">Show</span><span class="p">(</span><span class="s">&quot;Background task error: &quot;</span> <span class="p">+</span> <span class="n">args</span><span class="p">.</span><span class="n">Error</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
      <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Cancelled</span><span class="p">)</span>
        <span class="n">MessageBox</span><span class="p">.</span><span class="n">Show</span><span class="p">(</span><span class="s">&quot;Background task cancelled&quot;</span><span class="p">);</span>
      <span class="k">else</span>
        <span class="n">MessageBox</span><span class="p">.</span><span class="n">Show</span><span class="p">(</span><span class="s">&quot;Background task result: &quot;</span> <span class="p">+</span> <span class="n">args</span><span class="p">.</span><span class="n">Result</span><span class="p">);</span>

      <span class="c1">// Reset UI.</span>
      <span class="k">this</span><span class="p">.</span><span class="n">TaskIsComplete</span><span class="p">();</span>
    <span class="p">};</span>

    <span class="c1">// Kick off the background task.</span>
    <span class="k">this</span><span class="p">.</span><span class="n">backgroundWorker</span><span class="p">.</span><span class="n">RunWorkerAsync</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>You can copy and paste this code into a cs file in the Windows Forms solution, such as MainForm.cs. The solution should then build, and you can play with the buttons to test all three scenarios (successful completion, error condition, and cancellation).</p>

<h2 id="a-task-that-updates-progress-frequently">A Task That Updates Progress Frequently</h2>

<p>Using the ProgressReporter class (defined below), translating this BGW code to Task code is rather easy; no explicit continuation scheduling is needed:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Windows.Forms</span><span class="p">;</span>

<span class="k">partial</span> <span class="k">class</span> <span class="nc">MainForm</span>
<span class="p">{</span>
  <span class="k">private</span> <span class="n">CancellationTokenSource</span> <span class="n">cancellationTokenSource</span><span class="p">;</span>

  <span class="k">partial</span> <span class="k">void</span> <span class="nf">startButton_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Start the background task without error.</span>
    <span class="k">this</span><span class="p">.</span><span class="n">StartBackgroundTask</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>

    <span class="c1">// Update UI to reflect background task.</span>
    <span class="k">this</span><span class="p">.</span><span class="n">TaskIsRunning</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">partial</span> <span class="k">void</span> <span class="nf">errorButton_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Start the background task with error.</span>
    <span class="k">this</span><span class="p">.</span><span class="n">StartBackgroundTask</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>

    <span class="c1">// Update UI to reflect background task.</span>
    <span class="k">this</span><span class="p">.</span><span class="n">TaskIsRunning</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">partial</span> <span class="k">void</span> <span class="nf">cancelButton_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Cancel the background task.</span>
    <span class="k">this</span><span class="p">.</span><span class="n">cancellationTokenSource</span><span class="p">.</span><span class="n">Cancel</span><span class="p">();</span>

    <span class="c1">// The UI will be updated by the cancellation handler.</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">void</span> <span class="nf">StartBackgroundTask</span><span class="p">(</span><span class="kt">bool</span> <span class="n">causeError</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">cancellationTokenSource</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CancellationTokenSource</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">cancellationTokenSource</span><span class="p">.</span><span class="n">Token</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">progressReporter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ProgressReporter</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">task</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="n">StartNew</span><span class="p">(()</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">!=</span> <span class="m">100</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="c1">// Check for cancellation </span>
        <span class="n">cancellationToken</span><span class="p">.</span><span class="n">ThrowIfCancellationRequested</span><span class="p">();</span>

        <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">30</span><span class="p">);</span> <span class="c1">// Do some work. </span>

        <span class="c1">// Report progress of the work. </span>
        <span class="n">progressReporter</span><span class="p">.</span><span class="n">ReportProgress</span><span class="p">(()</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
          <span class="c1">// Note: code passed to &quot;ReportProgress&quot; can access UI elements freely. </span>
          <span class="k">this</span><span class="p">.</span><span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="n">i</span><span class="p">;</span>
        <span class="p">});</span>
      <span class="p">}</span>

      <span class="c1">// After all that work, cause the error if requested.</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">causeError</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">&quot;Oops...&quot;</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// The answer, at last! </span>
      <span class="k">return</span> <span class="m">42</span><span class="p">;</span>
    <span class="p">},</span> <span class="n">cancellationToken</span><span class="p">);</span>

    <span class="c1">// ProgressReporter can be used to report successful completion,</span>
    <span class="c1">//  cancelation, or failure to the UI thread. </span>
    <span class="n">progressReporter</span><span class="p">.</span><span class="n">RegisterContinuation</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
      <span class="c1">// Update UI to reflect completion.</span>
      <span class="k">this</span><span class="p">.</span><span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="m">100</span><span class="p">;</span>

      <span class="c1">// Display results.</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">Exception</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="n">MessageBox</span><span class="p">.</span><span class="n">Show</span><span class="p">(</span><span class="s">&quot;Background task error: &quot;</span> <span class="p">+</span> <span class="n">task</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
      <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">IsCanceled</span><span class="p">)</span>
        <span class="n">MessageBox</span><span class="p">.</span><span class="n">Show</span><span class="p">(</span><span class="s">&quot;Background task cancelled&quot;</span><span class="p">);</span>
      <span class="k">else</span>
        <span class="n">MessageBox</span><span class="p">.</span><span class="n">Show</span><span class="p">(</span><span class="s">&quot;Background task result: &quot;</span> <span class="p">+</span> <span class="n">task</span><span class="p">.</span><span class="n">Result</span><span class="p">);</span>

      <span class="c1">// Reset UI.</span>
      <span class="k">this</span><span class="p">.</span><span class="n">TaskIsComplete</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>You can copy and paste this code into a cs file in the Windows Forms solution, such as MainForm.cs. The solution won’t build until you add the code for the ProgressReporter class below.</p>

<h2 id="the-progressreporter-class">The ProgressReporter Class</h2>

<p>The ProgressReporter class is responsible for two things: the reporting of <em>progress</em> by a background task, and the reporting of a <em>final result</em> by the background task.</p>

<p>A background Task calls ProgressReporter.ReportProgress to report progress to the UI thread. This method will pause the background task until the UI has finished updating; if the task does not need to wait, then it can call ProgressReporter.ReportProgressAsync.</p>

<p>The code starting the background Task can also use ProgressReporter to retrieve the final result of the background task. This is done by calling the ProgressReporter.RegisterContinuation method. The delegate passed to this method is executed in the UI thread context after the background task completes. The delegate can then examine the Task object for its status (see the example code above).</p>

<p>In addition to the RegisterContinuation method, the ProgressReporter provides RegisterSucceededHandler, RegisterFaultedHandler, and RegisterCancelledHandler methods if it is easier to handle these situations separately.</p>

<p>The code for this class is not very complex:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>

<span class="c1">/// &lt;summary&gt; </span>
<span class="c1">/// A class used by Tasks to report progress or completion updates back to the UI. </span>
<span class="c1">/// &lt;/summary&gt; </span>
<span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">ProgressReporter</span>
<span class="p">{</span>
  <span class="c1">/// &lt;summary&gt; </span>
  <span class="c1">/// The underlying scheduler for the UI&#39;s synchronization context. </span>
  <span class="c1">/// &lt;/summary&gt; </span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="n">TaskScheduler</span> <span class="n">scheduler</span><span class="p">;</span>

  <span class="c1">/// &lt;summary&gt; </span>
  <span class="c1">/// Initializes a new instance of the &lt;see cref=&quot;ProgressReporter&quot;/&gt; class.</span>
  <span class="c1">/// This should be run on a UI thread. </span>
  <span class="c1">/// &lt;/summary&gt; </span>
  <span class="k">public</span> <span class="nf">ProgressReporter</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">scheduler</span> <span class="p">=</span> <span class="n">TaskScheduler</span><span class="p">.</span><span class="n">FromCurrentSynchronizationContext</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">/// &lt;summary&gt; </span>
  <span class="c1">/// Gets the task scheduler which executes tasks on the UI thread. </span>
  <span class="c1">/// &lt;/summary&gt; </span>
  <span class="k">public</span> <span class="n">TaskScheduler</span> <span class="n">Scheduler</span>
  <span class="p">{</span>
    <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">scheduler</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">/// &lt;summary&gt; </span>
  <span class="c1">/// Reports the progress to the UI thread. This method should be called from the task.</span>
  <span class="c1">/// Note that the progress update is asynchronous with respect to the reporting Task.</span>
  <span class="c1">/// For a synchronous progress update, wait on the returned &lt;see cref=&quot;Task&quot;/&gt;. </span>
  <span class="c1">/// &lt;/summary&gt; </span>
  <span class="c1">/// &lt;param name=&quot;action&quot;&gt;The action to perform in the context of the UI thread.</span>
  <span class="c1">/// Note that this action is run asynchronously on the UI thread.&lt;/param&gt; </span>
  <span class="c1">/// &lt;returns&gt;The task queued to the UI thread.&lt;/returns&gt; </span>
  <span class="k">public</span> <span class="n">Task</span> <span class="nf">ReportProgressAsync</span><span class="p">(</span><span class="n">Action</span> <span class="n">action</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="n">StartNew</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="n">TaskCreationOptions</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">scheduler</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">/// &lt;summary&gt; </span>
  <span class="c1">/// Reports the progress to the UI thread, and waits for the UI thread to process</span>
  <span class="c1">/// the update before returning. This method should be called from the task. </span>
  <span class="c1">/// &lt;/summary&gt; </span>
  <span class="c1">/// &lt;param name=&quot;action&quot;&gt;The action to perform in the context of the UI thread.&lt;/param&gt; </span>
  <span class="k">public</span> <span class="k">void</span> <span class="nf">ReportProgress</span><span class="p">(</span><span class="n">Action</span> <span class="n">action</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">ReportProgressAsync</span><span class="p">(</span><span class="n">action</span><span class="p">).</span><span class="n">Wait</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">/// &lt;summary&gt; </span>
  <span class="c1">/// Registers a UI thread handler for when the specified task finishes execution,</span>
  <span class="c1">/// whether it finishes with success, failiure, or cancellation. </span>
  <span class="c1">/// &lt;/summary&gt; </span>
  <span class="c1">/// &lt;param name=&quot;task&quot;&gt;The task to monitor for completion.&lt;/param&gt; </span>
  <span class="c1">/// &lt;param name=&quot;action&quot;&gt;The action to take when the task has completed, in the context of the UI thread.&lt;/param&gt; </span>
  <span class="c1">/// &lt;returns&gt;The continuation created to handle completion. This is normally ignored.&lt;/returns&gt; </span>
  <span class="k">public</span> <span class="n">Task</span> <span class="nf">RegisterContinuation</span><span class="p">(</span><span class="n">Task</span> <span class="n">task</span><span class="p">,</span> <span class="n">Action</span> <span class="n">action</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">action</span><span class="p">(),</span> <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">scheduler</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">/// &lt;summary&gt; </span>
  <span class="c1">/// Registers a UI thread handler for when the specified task finishes execution,</span>
  <span class="c1">/// whether it finishes with success, failiure, or cancellation. </span>
  <span class="c1">/// &lt;/summary&gt; </span>
  <span class="c1">/// &lt;typeparam name=&quot;TResult&quot;&gt;The type of the task result.&lt;/typeparam&gt; </span>
  <span class="c1">/// &lt;param name=&quot;task&quot;&gt;The task to monitor for completion.&lt;/param&gt; </span>
  <span class="c1">/// &lt;param name=&quot;action&quot;&gt;The action to take when the task has completed, in the context of the UI thread.&lt;/param&gt; </span>
  <span class="c1">/// &lt;returns&gt;The continuation created to handle completion. This is normally ignored.&lt;/returns&gt; </span>
  <span class="k">public</span> <span class="n">Task</span> <span class="n">RegisterContinuation</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">task</span><span class="p">,</span> <span class="n">Action</span> <span class="n">action</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">action</span><span class="p">(),</span> <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">scheduler</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">/// &lt;summary&gt; </span>
  <span class="c1">/// Registers a UI thread handler for when the specified task successfully finishes execution. </span>
  <span class="c1">/// &lt;/summary&gt; </span>
  <span class="c1">/// &lt;param name=&quot;task&quot;&gt;The task to monitor for successful completion.&lt;/param&gt; </span>
  <span class="c1">/// &lt;param name=&quot;action&quot;&gt;The action to take when the task has successfully completed, in the context of the UI thread.&lt;/param&gt; </span>
  <span class="c1">/// &lt;returns&gt;The continuation created to handle successful completion. This is normally ignored.&lt;/returns&gt; </span>
  <span class="k">public</span> <span class="n">Task</span> <span class="nf">RegisterSucceededHandler</span><span class="p">(</span><span class="n">Task</span> <span class="n">task</span><span class="p">,</span> <span class="n">Action</span> <span class="n">action</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">action</span><span class="p">(),</span> <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnRanToCompletion</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">scheduler</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">/// &lt;summary&gt; </span>
  <span class="c1">/// Registers a UI thread handler for when the specified task successfully finishes execution</span>
  <span class="c1">/// and returns a result. </span>
  <span class="c1">/// &lt;/summary&gt; </span>
  <span class="c1">/// &lt;typeparam name=&quot;TResult&quot;&gt;The type of the task result.&lt;/typeparam&gt; </span>
  <span class="c1">/// &lt;param name=&quot;task&quot;&gt;The task to monitor for successful completion.&lt;/param&gt; </span>
  <span class="c1">/// &lt;param name=&quot;action&quot;&gt;The action to take when the task has successfully completed, in the context of the UI thread.</span>
  <span class="c1">/// The argument to the action is the return value of the task.&lt;/param&gt; </span>
  <span class="c1">/// &lt;returns&gt;The continuation created to handle successful completion. This is normally ignored.&lt;/returns&gt; </span>
  <span class="k">public</span> <span class="n">Task</span> <span class="n">RegisterSucceededHandler</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">task</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">action</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">action</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">Result</span><span class="p">),</span> <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnRanToCompletion</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">Scheduler</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">/// &lt;summary&gt; </span>
  <span class="c1">/// Registers a UI thread handler for when the specified task becomes faulted. </span>
  <span class="c1">/// &lt;/summary&gt; </span>
  <span class="c1">/// &lt;param name=&quot;task&quot;&gt;The task to monitor for faulting.&lt;/param&gt; </span>
  <span class="c1">/// &lt;param name=&quot;action&quot;&gt;The action to take when the task has faulted, in the context of the UI thread.&lt;/param&gt; </span>
  <span class="c1">/// &lt;returns&gt;The continuation created to handle faulting. This is normally ignored.&lt;/returns&gt; </span>
  <span class="k">public</span> <span class="n">Task</span> <span class="nf">RegisterFaultedHandler</span><span class="p">(</span><span class="n">Task</span> <span class="n">task</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">Exception</span><span class="p">&gt;</span> <span class="n">action</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">action</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">Exception</span><span class="p">),</span> <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnFaulted</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">Scheduler</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">/// &lt;summary&gt; </span>
  <span class="c1">/// Registers a UI thread handler for when the specified task becomes faulted. </span>
  <span class="c1">/// &lt;/summary&gt; </span>
  <span class="c1">/// &lt;typeparam name=&quot;TResult&quot;&gt;The type of the task result.&lt;/typeparam&gt; </span>
  <span class="c1">/// &lt;param name=&quot;task&quot;&gt;The task to monitor for faulting.&lt;/param&gt; </span>
  <span class="c1">/// &lt;param name=&quot;action&quot;&gt;The action to take when the task has faulted, in the context of the UI thread.&lt;/param&gt; </span>
  <span class="c1">/// &lt;returns&gt;The continuation created to handle faulting. This is normally ignored.&lt;/returns&gt; </span>
  <span class="k">public</span> <span class="n">Task</span> <span class="n">RegisterFaultedHandler</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">task</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">Exception</span><span class="p">&gt;</span> <span class="n">action</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">action</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">Exception</span><span class="p">),</span> <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnFaulted</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">Scheduler</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">/// &lt;summary&gt; </span>
  <span class="c1">/// Registers a UI thread handler for when the specified task is cancelled. </span>
  <span class="c1">/// &lt;/summary&gt; </span>
  <span class="c1">/// &lt;param name=&quot;task&quot;&gt;The task to monitor for cancellation.&lt;/param&gt; </span>
  <span class="c1">/// &lt;param name=&quot;action&quot;&gt;The action to take when the task is cancelled, in the context of the UI thread.&lt;/param&gt; </span>
  <span class="c1">/// &lt;returns&gt;The continuation created to handle cancellation. This is normally ignored.&lt;/returns&gt; </span>
  <span class="k">public</span> <span class="n">Task</span> <span class="nf">RegisterCancelledHandler</span><span class="p">(</span><span class="n">Task</span> <span class="n">task</span><span class="p">,</span> <span class="n">Action</span> <span class="n">action</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">action</span><span class="p">(),</span> <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnCanceled</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">Scheduler</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">/// &lt;summary&gt; </span>
  <span class="c1">/// Registers a UI thread handler for when the specified task is cancelled. </span>
  <span class="c1">/// &lt;/summary&gt; </span>
  <span class="c1">/// &lt;typeparam name=&quot;TResult&quot;&gt;The type of the task result.&lt;/typeparam&gt; </span>
  <span class="c1">/// &lt;param name=&quot;task&quot;&gt;The task to monitor for cancellation.&lt;/param&gt; </span>
  <span class="c1">/// &lt;param name=&quot;action&quot;&gt;The action to take when the task is cancelled, in the context of the UI thread.&lt;/param&gt; </span>
  <span class="c1">/// &lt;returns&gt;The continuation created to handle cancellation. This is normally ignored.&lt;/returns&gt; </span>
  <span class="k">public</span> <span class="n">Task</span> <span class="n">RegisterCancelledHandler</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">task</span><span class="p">,</span> <span class="n">Action</span> <span class="n">action</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">action</span><span class="p">(),</span> <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnCanceled</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">Scheduler</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>You can copy and paste this code into a cs file in the Windows Forms solution, such as ProgressReporter.cs. The solution should then build, and you can play with the buttons to test all three scenarios (successful completion, error condition, and cancellation).</p>


  </article>
    
    <footer class="hidden-print">
        <div class="alert alert-info" markdown="1">
            <i class="fa fa-hand-o-right fa-2x pull-left"></i>
            
            <div>Has this been helpful? You can show your appreciation by <a href="https://github.com/sponsors/StephenCleary?frequency=one-time&amount=5" class="alert-link">leaving a "coffee" tip.</a> Thanks!</div>
        </div>

        
        
        <ul class="pager">
            <li class="previous"><a href="/2010/06/transactionscope-has-default-timeout.html" title="TransactionScope Has a Default Timeout">&larr; Previous Post</a></li>
            <li class="next"><a href="/2010/06/sqlite-and-entity-framework-4.html" title="SQLite and Entity Framework 4">Next Post &rarr;</a></li>
        </ul>

        <div id="comments"></div>
    </footer>
</div>
        </div>
        <div class="col-sm-2 col-md-3 col-md-offset-0 col-lg-2 col-lg-offset-1 affix hidden-print" data-spy="affix" role="navigation">
            
            
        </div>
        <div class="col-sm-2 sidebar hidden-print">
            <div class="panel panel-default">
                <div class="panel-heading">About Stephen Cleary</div>
                <div class="panel-body">
                    <div class="center"><img src="https://stephencleary.com/www.assets/Me-large.jpg"/></div>
                    <div class="center vertical-margins">Stephen Cleary is a <a href="https://stephencleary.com/god/">Christian</a>, husband, father, and programmer living in Northern Michigan.</div>
                    <div class="center"><a href="http://mvp.microsoft.com/en-us/mvp/Stephen%20Cleary-5000058"><img class="mvp-logo" src="https://stephencleary.com/www.assets/MVP.png"/></a></div>
                </div>
            </div>
            <div class="panel panel-primary">
                <div class="panel-heading">My book</div>
                <div class="panel-body center">
                    <div><a href="https://stephencleary.com/book/"><img src="https://stephencleary.com/www.assets/Book-2nd-small.jpg"/></a></div>
                    <div>Available from <a href="https://www.amazon.com/dp/149205450x/ref=as_li_ss_tl?&ref=pd_sl_a04BABB1D18C7F2658168FF785&linkCode=sl1&tag=stepheclearys-20&linkId=fb22bb126d6e60f305fecddf3d4ecbd8" rel="nofollow">Amazon (print/Kindle)</a>, <a href="https://learning.oreilly.com/library/view/concurrency-in-c/9781492054498/" rel="nofollow">O'Reilly (Safari)</a>, or <a href="https://www.ebooks.com/cj.asp?IID=209766469&cjsku=209766469" rel="nofollow">eBooks.com (PDF/epub)</a>.</div>
                    <div>Also available in <a href="https://www.labirint.ru/books/745595/" rel="nofollow">Russian</a>, <a href="https://item.jd.com/12769567.html" rel="nofollow">Chinese</a>, and <a href="https://www.aladin.co.kr/shop/wproduct.aspx?ItemId=270818316" rel="nofollow">Korean</a>.</div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Advertisement</div>
                <div><a href="https://stephencleary.com/contract/">I am available for contract work if you need in-depth assistance!</a></div>
                <div>This page may contain affiliate links.</div>
            </div>
            
            <div class="panel panel-primary">
                <div class="panel-heading">Popular Posts</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2012/02/async-and-await.html">Async/await Intro</a></li>
                        <li><a href="/2013/11/there-is-no-thread.html">There Is No Thread</a></li>
                        <li><a href="/2012/07/dont-block-on-async-code.html">Don't Block on Async Code</a></li>
                    </ul>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Series</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2016/02/react-redux-todomvc.html">React/Redux TodoMVC</a></li>
                        <li><a href="/2014/04/a-tour-of-task-part-0-overview.html">A Tour of Task</a></li>
                        <li><a href="/2013/10/taskrun-etiquette-and-proper-usage.html">Task.Run Etiquette</a></li>
                        <li><a href="/2013/05/taskrun-vs-backgroundworker-intro.html">Task.Run vs. BackgroundWorker</a></li>
                        <li><a href="/2013/01/async-oop-0-introduction.html">Async OOP</a></li>
                        <li><a href="/2009/04/tcpip-net-sockets-faq.html">TCP/IP .NET Sockets FAQ</a></li>
                        <li><a href="/2013/10/managed-services-roundup.html">Managed Services</a></li>
                        <li><a href="/2009/08/how-to-implement-idisposable-and.html">IDisposable and Finalizers</a></li>
                        <li><a href="/2011/02/option-parsing-introduction.html">Option Parsing</a></li>
                    </ul>
                </div>
            </div>
            
        </div>
    </div>

    <div class="google">
        <gcse:searchresults></gcse:searchresults>
    </div>
    
    <!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
<script type="text/javascript">window.jQuery || document.write('<script src="/lib/jquery-2.1.1.min.js"><\/script>')</script>

<!-- Bootstrap -->
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script type="text/javascript">window.jQuery.fn.modal || document.write('<script src="/lib/bootstrap.min.js"><\/script>')</script>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('body').css('color') !== 'rgb(102, 102, 102)') {
                $('head').prepend('<link rel="stylesheet" href="/lib/bootstrap.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Font Awesome -->
<span id="facheck" class="fa" style="display:none"></span>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('#facheck').css('fontFamily') !== 'FontAwesome') {
                $('head').prepend('<link rel="stylesheet" href="/lib/font-awesome.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Scroll the sidebar into view (if necessary) -->


<!-- Moment -->
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.6.0/moment.min.js"></script>
<script type="text/javascript">window.moment || document.write('<script src="/lib/moment.min.js"><\/script>')</script>

<!-- Google analytics -->
<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-8910661-5', 'stephencleary.com');
    ga('send', 'pageview');
</script>

<!-- Show appropriate elements based on time -->
<script type="text/javascript">
    (function ($) {
        $(function () {
            var targets = $('[data-hide-after]');
            targets.each(function () {
                var $item = $(this);
                if (moment() < moment($item.attr('data-hide-after'))) {
                    $item.removeClass('hidden');
                }
            });
        });
    })(window.jQuery);
</script>




<!-- Email obfuscation -->
<script type="text/javascript">
    (function($) {
        $(function() {
            var x = 'an',
                y = 'steph',
                email = 'mailto:' + y + 'en' + x + 'dm' + x + 'dy@' + 'gma' + 'il.' + 'com';
            $('.email-link').attr('href', email);
        });
    })(window.jQuery);
</script>



<script src="/lib/uuid-v3-3.2.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/showdown@1.8.6/dist/showdown.min.js" integrity="sha256-dwhppIrxD8qC6lNulndZgtIm4XBU9zoMd9OUoXzIDAE=" crossorigin="anonymous"></script>
<script src="/lib/sanitize-html-1.18.2.min.js"></script>
<script src="/lib/autosize.min.js"></script>
<script src="/lib/base64js.min.js"></script>
<script src="/lib/md5.min.js"></script>

<script type="text/javascript">

var pageUrl = "https://blog.stephencleary.com" + "/2010/06/reporting-progress-from-tasks.html";

// (unnecessary) 1) If the URL starts with http://, replace with https://

// 2) Take the URL path (not including scheme and domain).
var url = document.createElement('a');
url.href = pageUrl; //'https://developer.mozilla.org:8080/en-US/search?q=URL#search-results-close-container';
var path = url.pathname;

// 3) Path: If the path ends with .html or any two- to six-character [A-Za-z0-9] extension, strip it.
if (path.endsWith(".html"))
    path = path.substr(0, path.length - 5);
else
    path = path.replace(/\.[A-Za-z0-9]{2,6}$/, "");

// 4) Path: For each UTF-16 code unit, if it's not in the whitelist [A-Za-z0-9-_;.~()], then replace it with _.
path = path.replace(/[^-A-Za-z0-9_;.~()]/g, "_");

// 5) Path: Trim leading and trailing _ characters.
path = path.replace(/^_+|_+$/g, "");

// 6) Calculate the V3 URL GUID for the URL.
var guid = uuidv3(pageUrl, uuidv3.URL);

// 7) Combine the path and lowercase-hyphenated GUID, separated by '-'.
var postId = path + "-" + guid;

var nofollowLinkExtension = {
    type: 'output',
    regex: /(<a[^<]+<\/a>)/g,
    replace: (match, $1, $2) => {
        var result = $('<div/>').append($($1).attr('rel', 'nofollow noopener ugc')).html();
        return result;
    }
};
showdown.extension('nofollowLink', nofollowLinkExtension);

var comments;
var markdownConverter = new showdown.Converter({
    omitExtraWLInCodeBlocks: true,
    noHeaderId: true,
    headerLevelStart: 3,
    simplifiedAutoLink: true,
    excludeTrailingPunctuationFromURLs: true,
    literalMidWordUnderscores: true,
    strikethrough: true,
    smoothLivePreview: true,
    disableForced4SpacesIndentedSublists: true,
    extensions: ['nofollowLink']
});
var sanitizeOptions = {
    allowedTags: [ 'blockquote', 'p', 'a', 'ul', 'ol', 'nl', 'li', 'b', 'i', 'strong', 'em', 'strike', 'code', 'br', 'div', 'pre', 'img' ],
    allowedAttributes: {
        a: [
            'href',
            {
                name: 'rel',
                multiple: true,
                values: ['nofollow', 'noopener', 'ugc']
            }
        ],
        img: [ 'src' ]
    },
    allowedIframeHostnames: []
};

function fixedEncodeURIComponent(str) {
  return encodeURIComponent(str).replace(/[!'()*]/g, function(c) {
    return '%' + c.charCodeAt(0).toString(16);
  });
}

function filterComments(replyTo) {
    return comments
        .filter(function (x) { return x.replyTo === replyTo; })
        .sort(function (a, b) { return a.timestamp - b.timestamp; });
}

function avatarUri(authorEmailMD5) {
    if (authorEmailMD5 === "")
        return "https://www.gravatar.com/avatar/?d=mp&f=y";
    else
        return "https://www.gravatar.com/avatar/" + authorEmailMD5 + "?d=retro";
}

var jwk = {"kty":"RSA","alg":"RSA-OAEP","n":"wviXqUJGtV8hZrvJMcTbyzm7MmiJSqsAfWI_7pCyAhXXzz5C9F3NtXp79CCUMqkOck6IbNKUntPtGNOGwtoc5LTJNKLhx3TPi4TJyKUSfNr3pAdLpMRNeeRXCHFyyVsDb6z8ueixlKzdbDpZhV05bam49PurMHfeexJ3EJy2NpdFviykRJxtrERi6ckBe96VMlT_pHHIWLN5EwOK54DvNn1DYjiFK5ux5WRCFatZByzytrFvIllZRctNXZ8oTuMjQwKLY2bUrURblbIvLfX-9Yd7uVgdUSFE7-vSel9-DMyp_NQ-NRXrQbJG7IAYhSGSx-TPepCDPbFpMq3yC0iET7wF7-OQOb-Kwej_TKVJv-z4SbN-cpCqaMr5Q9scyGih7xr1YrOhe3TMs_cbgjtxsZbzkOqcuRreON_sGb9nlDpSIFCo6aH47GeMkA23Hk3HXAPyYQ7AfWhU9daiPcySiAFnfkrg2QvFNJmMSZ-bo4Co-JkjiqKw-LEpOw6Ed9LK4walxWUAqPGcT4_Uys3TH9XVex9_rEmigHXiJY3_Lwi6mTSkW10-zen5UXxqnyHpMxlmumohT96OyLyhEPeaaq8FrTYMCX8TiMOst3jF5QCNP-LFz21yeUEAr5_3-FKV2mjWEU9iW0dOOVTII2rlD0WtCkqkDwZtakQ1ynGdW1E","e":"AQAB"};

function commentId(id) { return "comment-" + id; }

function $commentForm(hideForm, comment) {
    var $previewDiv = $('<div/>');
    var $authorEmailEncrypted = $('<input type="hidden" name="authorEmailEncrypted">');
    var $authorEmailMD5 = $('<input type="hidden" name="authorEmailMD5">');
    var $email = $('<input type="email" name="email" class="form-control" placeholder="Email">');
    var $name = $('<input type="text" name="authorName" class="form-control" placeholder="Name">');
    var $url = $('<input type="url" name="authorUri" class="form-control" placeholder="Url">');
    var $message = $('<textarea name="message" class="form-control" placeholder="Message"/></textarea>');
    autosize($message);
    var $replyTo = $('<input type="hidden" name="replyTo">').val("");
    var $recaptcha = $('<div class="g-recaptcha" data-sitekey="6LfSaV8UAAAAAEFq-7HeUDiSQCkCtLtO_yc_SOi_"></div>');
    var $buttonBar = $('<div class="comment-form-buttonbar"/>').append($('<button type="submit" class="btn btn-primary pull-right">Submit</button>'), $recaptcha);
    var $form = $('<form method="POST" action="https://blogcomments.azurewebsites.net/api/Function1"/>')
        .append($('<input type="hidden" name="postId">').val(postId))
        .append($('<input type="hidden" name="postUri">').val(location.href.replace(/#.*/, '')))
        .append($replyTo)
        .append($authorEmailEncrypted)
        .append($authorEmailMD5)
        .append($('<div class="form-group"><label>Name (optional)</label></div>').append($name))
        .append($('<div class="form-group"><label>Email (optional; always encrypted, never shared)</label></div>').append($email))
        .append($('<div class="form-group"><label>Url (optional; must start with "http://" or "https://")</label></div>').append($url))
        .append($('<div class="form-group"><label>Message (supports some Markdown/HTML)</label></div>').append($message));
    if (comment) {
        $replyTo.val(comment._id);
    }
    const serialize_form = form => JSON.stringify(
        Array.from(new FormData(form).entries())
            .reduce((m, [ key, value ]) => Object.assign(m, { [key]: value }), {})
    );
    $form.submit(function (e) {
        e.preventDefault();
        hideForm();
        var postAction = $form.attr('action');
        var postBody = serialize_form($form.get(0));
        console.log(postBody);
        var retries = 5;

        function postIt() {
            var post = $.post(postAction, postBody, "json");
            post.done(function () {
                alert("Comment successfully posted. It should appear on this page in a minute or so.");
            });
            post.error(function () {
                var message = "Failed to post comment";
                if (post.responseText)
                    message += ": " + post.responseText;
                
                if (--retries > 0) {
                    console.log(message);
                    postIt();
                } else {
                    alert(message);
                }
            });
        }

        postIt();
    });

    function createComment() {
        return normalizeComment({
            date: moment().format(),
            _id: "_",
            replyTo: comment ? comment._id : undefined,
            authorName: $name.val(),
            authorEmailMD5: $authorEmailMD5.val(),
            authorUri: $url.val(),
            message: $message.val()
        });
    };

    function recreatePreview() {
        var email = $email.val();
        if (email && email.indexOf("@") !== -1) {
            var data = new TextEncoder().encode($email.val());
            window.crypto.subtle.importKey("jwk", jwk, { name: "RSA-OAEP", hash: { name: "SHA-1" } }, false, ["encrypt"]).then(function (encryptionKey) {
                return window.crypto.subtle.encrypt({ name: "RSA-OAEP" }, encryptionKey, data)
                    .then(function (encrypted) {
                        var array = new Uint8Array(encrypted);
                        var text = base64js.fromByteArray(array);
                        $authorEmailEncrypted.val(text);
                        return text;
                    });
            });
            $authorEmailMD5.val(md5($email.val().replace(/^ +| +$/g, '').toLowerCase()));
        } else {
            $authorEmailMD5.val("");
            $authorEmailEncrypted.val("");
        }

        var $newPreview = $comment(false, createComment());
        // Turn off permalink and anchor
        var $anchor = $newPreview.find('.comment-date a');
        $anchor.replaceWith($('<span/>').text($anchor.text()));
        $newPreview.find('.comment-anchor').remove();
        $previewDiv.empty();
        $previewDiv.append($newPreview);
    };

    recreatePreview();
    $name.on('change keyup input paste', recreatePreview);
    $email.on('change keyup input paste', recreatePreview);
    $url.on('change keyup input paste', recreatePreview);
    $message.on('change keyup input paste', recreatePreview);

    $form.append($('<h3>Preview:</h3>'), $previewDiv, $buttonBar);
    return {
        $form: $('<div class="comment-form"/>').append($form),
        onShow: function() { grecaptcha.render($recaptcha[0]); }
    };
}

function $replyButton(comment) {
    var $button;
    if (comment)
        $button = $('<button class="btn btn-primary comment-reply"><i class="fa fa-reply"></i> Reply</button>');
    else
        $button = $('<button class="btn btn-primary comment-new"><i class="fa fa-plus-square"></i> New Comment</button>');
    return $button;
}

var now = moment();
function $comment(includeForm, comment) {
    var message = sanitizeHtml(markdownConverter.makeHtml(comment.message), sanitizeOptions);
    var $commentDiv = $('<div class="comment"/>');
    var publicationDate = moment(comment.date);
    var $author = $('<div class="comment-author"/>').append($('<span class="comment-author-name"/>').text(comment.authorName));
    if (comment.authorUri !== "")
        $author.append($('<span> • </span>'), $('<a class="comment-author-uri" rel="nofollow noopener ugc"/>').attr('href', comment.authorUri).text(comment.authorUri));
    var $headerDiv = $('<div class="comment-header"/>').append(
        $('<div class="comment-author-profile" style="float:left;"/>').append($('<img class="comment-author-profile-image" src="' + avatarUri(comment.authorEmailMD5) + '"/>')),
        $author,
        $('<div class="comment-date" />').append(
            $('<a/>').attr('href', '#' + commentId(comment._id)).attr('title', 'permalink').text(publicationDate.from(now) + ' (' + publicationDate.format('YYYY-MM-DD hh:mm:ss a') + ')')
        )
    );
    if (comment.replyTo !== "") {
        var parent = comments.filter(function (x) { return x._id === comment.replyTo })[0];
        $headerDiv.append($('<div/>').append($('<a/>').attr('href', '#' + commentId(comment.replyTo)).text('In reply to ' + parent.authorName)));
    }

    $commentDiv.append($('<div class="comment-anchor"/>').attr('id', commentId(comment._id)),
        $headerDiv,
        $('<div class="comment-message" style="clear:both;"/>').html(message)
    );

    var $commentContainer = $('<div class="comment-container"/>').append($commentDiv);
    if (includeForm)
        $commentContainer.append($expandCollapseForm(comment));
    var childComments = filterComments(comment._id);
    for (var i = 0; i != childComments.length; ++i) {
        var child = childComments[i];
        $commentContainer.append($comment(includeForm, child));
    }

    return $commentContainer;
}

function normalizeComment(x) {
    var uri = x.authorUri;
    if (!uri || (!uri.startsWith("http://") && !uri.startsWith("https://")))
        uri = "";
    return {
            _id: x._id,
            authorName: x.authorName || "Anonymous",
            authorEmailMD5: x.authorEmailMD5 || "",
            authorUri: uri,
            message: x.message || "",
            replyTo: x.replyTo || "",
            date: x.date,
            timestamp: moment(x.date).valueOf()
    };
}

function $expandCollapseForm(comment) {
    var $button = $replyButton(comment);
    var formObj = $commentForm(hideForm, comment);
    var $form = formObj.$form.addClass("comment-hidden");
    var onShow = formObj.onShow;
    function showForm() {
        $button.addClass("comment-hidden");
        if (onShow) {
            onShow();
            onShow = null;
        }
        $form.removeClass("comment-hidden");
    }
    function hideForm() {
        $form.addClass("comment-hidden");
        $button.removeClass("comment-hidden");
    }
    $button.click(showForm);
    return $('<div/>').append($button, $form);
}

function recaptchaLoaded() {
    var req = new XMLHttpRequest();
    req.addEventListener("load", function () {
        var $commentDiv = $('#comments');
        if (req.status === 404 || req.status === 200) {
            if (req.status === 404) {
                comments = [];
            } else {
                comments = JSON.parse(req.responseText).map(normalizeComment);
            }
            var commentCounter = document.getElementById('comment-counter');
            commentCounter.innerText = comments.length + " " + commentCounter.innerText;
            var toplevelComments = filterComments("");
            for (var i = 0; i != toplevelComments.length; ++i) {
                var comment = toplevelComments[i];
                $commentDiv.append($comment(true, comment));
            }
            if (comments.length !== 0) {
                $commentDiv.append($expandCollapseForm());
            }
        }
        $commentDiv.prepend($expandCollapseForm());
    });
    req.open('GET', "https://comments.stephencleary.com/" + postId + ".json");
    req.send();
}
</script>

<script src="https://www.google.com/recaptcha/api.js?onload=recaptchaLoaded&amp;render=explicit"></script>



<!-- Moment -->
<script type="text/javascript">
    (function($) {
        $(function () {
            $('time').each(function (_, e) {
                var startOfToday = moment().startOf('day');
                var publicationDate = moment($(e).attr('datetime'), 'YYYY-MM-DD');
                var difference = startOfToday.diff(publicationDate, 'days');
                var text = difference === 0 ? 'Today' :
                    difference === 1 ? 'Yesterday' :
                    publicationDate.from(startOfToday);
                $(e).text(function(_, oldText) { return text + ' (' + oldText + ')'; });
            });
        });
    })(window.jQuery);
</script>




</body>
</html>