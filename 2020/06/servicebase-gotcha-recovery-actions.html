<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Win32 Service Gotcha: Recovery Actions</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="ServiceBase will not allow Service Control Manager (SCM) recovery actions by default." />
    <link rel="canonical" href="https://blog.stephencleary.com/2020/06/servicebase-gotcha-recovery-actions.html" />
    
    <link rel="alternate" type="application/rss+xml" title="Stephen Cleary (the blog)" href="http://feeds.feedburner.com/NitoPrograms" />
    
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/bootswatch/3.2.0/spacelab/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" />
    <style type="text/css">/* Layout Styles */
/* ----------------------------------------------------------*/

body {
    padding-top: 50px;
}

.affix {
    top: 70px;
    bottom: 0;
    overflow-y: auto;
}

.navbar-brand {
    font-weight: bold;
}

.navbar-brand-container.active>a, .navbar-brand-container.active>a:hover, .navbar-brand-container.active>a:focus {
    color: #3399f3;
    background-color: transparent;
}

.sidebar {
    margin-top: 20px;
}

.sidenavitem {
    height: auto;
}

.sidebar img {
    /* Responsive images */
    display: inline-block;
    height: auto;
    max-width: 100%;
}

@media(max-width:767px) {
    .affix {
        position: static;
    }
}

div .vertical-margins {
    margin-top: 10px;
    margin-bottom: 10px;
}

.page-header {
    margin-top: 20px;
}

.center {
    text-align: center;
}

.project-icon {
    height: 128px;
    width: 128px;
}

.list-group-item h2 {
    margin-top: 10px;
}

/* Fixes for Google Custom Search in a Bootstrap page */
/* ----------------------------------------------------------*/
.google, .google *, .google *:before, .google *:after {
    -webkit-box-sizing: content-box;
    -moz-box-sizing: content-box;
    box-sizing: content-box;
}

.google table {
    border-collapse: separate;
}

.gsc-input-box {
    height: auto !important;
}

/* Fixes for Amazon widget in Bootstrap page */
.amzn_wdgt * {
    -webkit-box-sizing: content-box;
    -moz-box-sizing: content-box;
    box-sizing: content-box;
}

/* Post styles */
/* ----------------------------------------------------------*/

code {
    background-color: #F2F3F9;
    color: inherit;
}

.post img {
    /* Responsive images */
    display: inline-block;
    height: auto;
    max-width: 100%;
}

.post .table {
    table-layout: fixed;
}

.post .table code {
    white-space: normal;
}

.post .yes {
    color: #008000;
}

.post .no {
    color: #FF0000;
}

/* Syntax highlighting styles */
/* ----------------------------------------------------------*/

.highlight  { background: #ffffff; }
.highlight .c { color: #008000 } /* Comment */
.highlight .k { color: #0000ff } /* Keyword */
.highlight .cm { color: #008000 } /* Comment.Multiline */
.highlight .cp { color: #0000ff } /* Comment.Preproc */
.highlight .c1 { color: #008000 } /* Comment.Single */
.highlight .cs { color: #008000 } /* Comment.Special */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gh { font-weight: bold } /* Generic.Heading */
.highlight .gp { font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { font-weight: bold } /* Generic.Subheading */
.highlight .kc { color: #0000ff } /* Keyword.Constant */
.highlight .kd { color: #0000ff } /* Keyword.Declaration */
.highlight .kn { color: #0000ff } /* Keyword.Namespace */
.highlight .kp { color: #0000ff } /* Keyword.Pseudo */
.highlight .kr { color: #0000ff } /* Keyword.Reserved */
.highlight .kt { color: #2b91af } /* Keyword.Type */
.highlight .s { color: #a31515 } /* Literal.String */
.highlight .nc { color: #2b91af } /* Name.Class */
.highlight .ow { color: #0000ff } /* Operator.Word */
.highlight .sb { color: #a31515 } /* Literal.String.Backtick */
.highlight .sc { color: #a31515 } /* Literal.String.Char */
.highlight .sd { color: #a31515 } /* Literal.String.Doc */
.highlight .s2 { color: #a31515 } /* Literal.String.Double */
.highlight .se { color: #a31515 } /* Literal.String.Escape */
.highlight .sh { color: #a31515 } /* Literal.String.Heredoc */
.highlight .si { color: #a31515 } /* Literal.String.Interpol */
.highlight .sx { color: #a31515 } /* Literal.String.Other */
.highlight .sr { color: #a31515 } /* Literal.String.Regex */
.highlight .s1 { color: #a31515 } /* Literal.String.Single */
.highlight .ss { color: #a31515 } /* Literal.String.Symbol */

/* Comments */
/* ----------------------------------------------------------*/

.comment-container {
    margin-top: 1em;
}

.comment-container > .comment-container {
    margin-left: 2em;
}

.comment-container > .comment-container > .comment-container > .comment-container > .comment-container {
    margin-left: 0;
}

/* Correct anchor links in comments (they are offset by the height of the fixed header) */
.comment-anchor {
    display: block;
    position: relative;
    top: -60px;
    visibility: hidden;
}

img.comment-author-profile-image {
    height: 80px;
    width: 80px;
    margin-right: 10px;
}

.comment-message {
    overflow-x: auto;
}

.comment-form {
    border: 1px solid black;
    padding: 1em;
}

.comment-new {
    margin-top: 1em;
    margin-bottom: 1em;
}

.comment-new, .comment-reply {
    margin-left: 1em;
}

.comment-hidden {
    display: none;
}

.comment-form-buttonbar {
    margin-top: 1em;
}
</style>
    
    <meta name="application-name" content="Stephen Cleary" />
    <link rel="search" type="application/opensearchdescription+xml" href="https://stephencleary.com/opensearch.xml" title="Cleary Search">
    <link rel="apple-touch-icon" sizes="57x57" href="https://stephencleary.com/icons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="https://stephencleary.com/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://stephencleary.com/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://stephencleary.com/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="https://stephencleary.com/icons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="https://stephencleary.com/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="https://stephencleary.com/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://stephencleary.com/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" href="https://stephencleary.com/icons/apple-touch-icon.png"/>
    <link rel="apple-touch-icon-precomposed" href="https://stephencleary.com/icons/apple-touch-icon-precomposed.png"/>
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-196x196.png" sizes="196x196">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-32x32.png" sizes="32x32">
    
    <meta name="google-site-verification" content="L8q0fpGSwpNSD0OGFI07hyMujSpORrV4tAaNx_Js7oQ" />
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <div class="navbar-brand-container"><a class="navbar-brand" href="https://stephencleary.com">Stephen Cleary</a></div>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
            <li  class="active"  ><a href="https://blog.stephencleary.com">Blog</a></li>
            <li ><a href="https://stephencleary.com/videos/">Videos</a></li>
            <li  ><a href="https://stephencleary.com/projects/">Projects</a></li>
            <li  ><a href="https://stephencleary.com/publications/">Publications</a></li>
            <li  ><a href="https://stephencleary.com/book/">Book</a></li>
            <li  ><a href="https://stephencleary.com/contact/">Contact</a></li>
            <li><a href="http://feeds.feedburner.com/NitoPrograms"><i class="fa fa-rss-square fa-lg"></i></a></li>
            <li  ><a href="https://stephencleary.com/search/"><i class="fa fa-search"></i></a></li>
        </ul>
    </div>
</nav>

    <div class="container-fluid">
        <div class="col-sm-8 col-sm-offset-2 col-md-6 col-md-offset-3">
            <div class="post">

  <header>
      <div class="page-header">
          <h1>Win32 Service Gotcha: Recovery Actions</h1>
          <small><time datetime="2020-06-18">Jun 18, 2020</time> &bull; <a id="comment-counter" href="#comments">Comments</a></small>
      </div>
  </header>

  <header>
    <div class="alert alert-info" markdown="1">
        <i class="fa fa-hand-o-right fa-2x pull-left"></i>
        
        <div>Has this blog been helpful? Please consider <a href="https://github.com/sponsors/StephenCleary" class="alert-link">supporting this blog (and my open-source libraries).</a> Thanks!</div>
        <div><i>For a limited time, GitHub will match your support.</i></div>
    </div>
  </header>

  <article>
  <h2 id="win32-services-and-recovery-actions">Win32 Services and Recovery Actions</h2>

<p>This blog post doesn’t have to do with <code>BackgroundService</code> specifically, but it is an issue that can come up with .NET Core workers that are run as Win32 Services. In some ways, this blog post has more to do with <a href="/2013/10/managed-services-roundup.html">managed services</a>, but I decided to put it with the <code>BackgroundService</code> series because it is a problem with <code>BackgroundService</code>s run as Win32 services.</p>

<h2 id="background-recovery-actions">Background: Recovery Actions</h2>

<p>The Win32 Service Control Manager (SCM) is responsible for starting and stopping services on Windows machines. It’s also responsible for restarting Win32 services when they fail:</p>

<p class="center"><a href="/assets/win32-service-recovery.png"><img src="/assets/win32-service-recovery.png" alt="Win32 Service Recovery Action Settings" /></a></p>

<p>However, it can be a bit confusing to think about what “fail” actually <em>means</em>.</p>

<h2 id="background-win32-service-failure">Background: Win32 Service Failure</h2>

<p>It’s pretty clear that if a Win32 application crashes, that indicates “failure”. Normally, Win32 services communicate with the SCM and let it know what their state is. The most common states are “stopped” and “started”, along with transitional states like “stopping” and “starting”. So, if a Win32 application exits (or crashes) without telling the SCM it is “stopped”, then the SCM treats that as a failure.</p>

<p>What’s much less clear is how exit codes are handled.</p>

<p>The first thing to keep in mind is that each Win32 service has its own exit code. A single Win32 process can contain <em>multiple</em> different Win32 services within that single process, and each of those Win32 services has its <em>own</em> exit code. As far as I can tell, the exit code of the process itself is completely ignored.</p>

<p>What’s more, if the Win32 service does report that it is “stopped” to the SCM, the SCM will ignore the Win32 service exit code, too! The SCM assumes that if the service has reported it is “stopped”, then the service has stopped successfully, and there is no need to restart the service.</p>

<p>This means that if you have a Win32 service and it reports a non-zero exit code (either for the process exit code or the Win32 service exit code), and if that Win32 service exits cleanly after setting its non-zero exit code, then that exit code will be ignored and the service will not be restarted.</p>

<h2 id="tip-honoring-win32-service-exit-codes">Tip: Honoring Win32 Service Exit Codes</h2>

<p>There is <a href="https://docs.microsoft.com/en-us/windows/win32/api/winsvc/ns-winsvc-service_failure_actions_flag">a flag</a> you can set that will cause SCM to honor the Win32 service exit code, treating a non-zero code as a “failure” and running its recovery actions. You can turn this flag on at the command line as such:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">sc failureflag &quot;My Service&quot; 1</code></pre></figure>

<p>Setting that flag checks this checkbox, which has the rather difficult-to-understand wording of “Enable actions for stops with errors.”:</p>

<p class="center"><a href="/assets/win32-service-recovery-highlight.png"><img src="/assets/win32-service-recovery-highlight.png" alt="Win32 Service Recovery Action Settings" /></a></p>

<h2 id="win32-service-exit-codes-and-servicebase">Win32 Service Exit Codes and ServiceBase</h2>

<p>For .NET applications, the <code>Environment.ExitCode</code> property manages the exit code for the <em>process</em>. As far as I know, this value is always ignored when the process is run as a service. The Win32 service exit code is managed by the <code>ServiceBase.ExitCode</code> property. Remember, there can be multiple Win32 services in a single process.</p>

<h2 id="win32-service-exit-codes-and-windowsservicelifetime">Win32 Service Exit Codes and WindowsServiceLifetime</h2>

<p>In <a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/windows-service">.NET Core applications that are run as Win32 services</a>, it’s normal to call <code>IHostBuilder.UseWindowsService()</code>, which installs a <code>WindowsServiceLifetime</code> as the <code>IHostLifetime</code>, instead of the default <code>ConsoleLifetime</code>.</p>

<p><code>WindowsServiceLifetime</code> lets the SCM control the starting and stopping of the .NET Core application. It <a href="https://github.com/dotnet/extensions/blob/4becf241089932aa1f1e7f3ab4155a437fd3dba1/src/Hosting/WindowsServices/src/WindowsServiceLifetime.cs#L14">derives from <code>ServiceBase</code></a>. Since <a href="https://github.com/aspnet/Hosting/issues/1401">multiple <code>IHostLifetime</code> instances aren’t supported</a>, this means that .NET Core workers do not naturally support multiple Win32 services in a single process. It may be possible to support that by creating a new type that derives from <code>ServiceBase</code> and <code>IHostedService</code>, along with some kind of coordinating <code>IHostLifetime</code> implementation, but I’m not aware of anyone doing that yet. For now, all the .NET Core Win32 services I know of use <code>WindowsServiceLifetime</code>.</p>

<p>One important note is that <code>WindowsServiceLifetime</code> stops cleanly. If the .NET Core application is shutdown, then <code>WindowsServiceLifetime</code> reports to the SCM that the service is “stopped”, and this means that the SCM will not restart the service.</p>

<p>You can write code that will set the Win32 service exit code on failure by accessing <code>ServiceBase.ExitCode</code> as such:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">MyBackgroundService</span> <span class="p">:</span> <span class="n">BackgroundService</span>
<span class="p">{</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="n">IHostLifetime</span> <span class="n">_hostLifetime</span><span class="p">;</span>
  <span class="k">public</span> <span class="nf">MyBackgroundService</span><span class="p">(</span><span class="n">IHostLifetime</span> <span class="n">hostLifetime</span><span class="p">)</span> <span class="p">=&gt;</span>
      <span class="n">_hostLifetime</span> <span class="p">=</span> <span class="n">hostLifetime</span><span class="p">;</span>

  <span class="k">protected</span> <span class="k">override</span> <span class="n">Task</span> <span class="nf">ExecuteAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">stoppingToken</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">try</span>
    <span class="p">{</span>
      <span class="c1">// Implementation</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">_hostLifetime</span> <span class="k">is</span> <span class="n">ServiceBase</span> <span class="n">serviceLifetime</span><span class="p">)</span>
        <span class="n">serviceLifetime</span><span class="p">.</span><span class="n">ExitCode</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="n">Environment</span><span class="p">.</span><span class="n">ExitCode</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>However, as noted above, you have to also set the <code>failureflag</code> on the service, or else the SCM will ignore the non-zero exit code.</p>

<p>If desired, you can write a custom <code>WindowsServiceLifetime</code> that will treat non-zero <code>Environment.ExitCode</code> values as non-zero Win32 service exit codes:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">MyWindowsServiceLifetime</span> <span class="p">:</span> <span class="n">WindowsServiceLifetime</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="nf">MyWindowsServiceLifetime</span><span class="p">(</span><span class="n">IHostApplicationLifetime</span> <span class="n">hostApplicationLifetime</span><span class="p">,</span> <span class="n">IHostEnvironment</span> <span class="n">environment</span><span class="p">,</span> <span class="n">ILoggerFactory</span> <span class="n">loggerFactory</span><span class="p">,</span> <span class="n">IOptions</span><span class="p">&lt;</span><span class="n">HostOptions</span><span class="p">&gt;</span> <span class="n">options</span><span class="p">)</span>
      <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="n">hostApplicationLifetime</span><span class="p">,</span> <span class="n">loggerFactory</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="p">}</span>

  <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnStop</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="c1">// Take the process ExitCode if there isn&#39;t one for our Win32 service</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ExitCode</span> <span class="p">==</span> <span class="m">0</span> <span class="p">&amp;&amp;</span> <span class="n">Environment</span><span class="p">.</span><span class="n">ExitCode</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
      <span class="n">ExitCode</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="n">ExitCode</span><span class="p">;</span>
    
    <span class="k">base</span><span class="p">.</span><span class="n">OnStop</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>This can be installed by adding this service (<code>services.AddSingleton&lt;IHostLifetime, MyWindowsServiceLifetime&gt;()</code>) after calling <code>UseWindowsService</code>; the .NET Core dependency injection will just take the last registered <code>IHostLifetime</code>.</p>

<h2 id="crashing-windowsservicelifetime">Crashing WindowsServiceLifetime</h2>

<p>It is also possible to create a custom derived <code>WindowsServiceLifetime</code> that can detect application failures and will prevent <code>ServiceBase</code> from sending the “stopped” message to the SCM. That way, your service will be restarted regardless of the <code>failureflag</code> setting, because any failures will cause the process to crash.</p>

<p>We don’t want to crash the process immediately; instead, we want to shut down the .NET Core host and then terminate, so that the SCM knows the process failed. The <code>WindowsServiceLifetime</code> type has <a href="https://github.com/dotnet/extensions/blob/4becf241089932aa1f1e7f3ab4155a437fd3dba1/src/Hosting/WindowsServices/src/WindowsServiceLifetime.cs#L105">some similar behavior</a>: if the SCM requests the service to stop, then it will shut down the .NET Core host and wait for it to stop. We can do the same thing in our custom lifetime type:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">MyWindowsServiceLifetime</span> <span class="p">:</span> <span class="n">WindowsServiceLifetime</span>
<span class="p">{</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="n">IHostApplicationLifetime</span> <span class="n">_hostApplicationLifetime</span><span class="p">;</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="n">ManualResetEventSlim</span> <span class="n">_shutdownComplete</span><span class="p">;</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="n">CancellationTokenRegistration</span> <span class="n">_applicationStoppedRegistration</span><span class="p">;</span>

  <span class="k">public</span> <span class="nf">MyWindowsServiceLifetime</span><span class="p">(</span><span class="n">IHostApplicationLifetime</span> <span class="n">hostApplicationLifetime</span><span class="p">,</span> <span class="n">IHostEnvironment</span> <span class="n">environment</span><span class="p">,</span> <span class="n">ILoggerFactory</span> <span class="n">loggerFactory</span><span class="p">,</span> <span class="n">IOptions</span><span class="p">&lt;</span><span class="n">HostOptions</span><span class="p">&gt;</span> <span class="n">options</span><span class="p">)</span>
      <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="n">hostApplicationLifetime</span><span class="p">,</span> <span class="n">loggerFactory</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">_hostApplicationLifetime</span> <span class="p">=</span> <span class="n">hostApplicationLifetime</span><span class="p">;</span>
    <span class="n">_shutdownComplete</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ManualResetEventSlim</span><span class="p">();</span>
    <span class="n">_applicationStoppedRegistration</span> <span class="p">=</span> <span class="n">hostApplicationLifetime</span><span class="p">.</span><span class="n">ApplicationStopped</span><span class="p">.</span><span class="n">Register</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">_shutdownComplete</span><span class="p">.</span><span class="n">Set</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnStop</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="c1">// Take the process ExitCode if there isn&#39;t one for our Win32 service</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ExitCode</span> <span class="p">==</span> <span class="m">0</span> <span class="p">&amp;&amp;</span> <span class="n">Environment</span><span class="p">.</span><span class="n">ExitCode</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
      <span class="n">ExitCode</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="n">ExitCode</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">ExitCode</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// Wait for application to shut down.</span>
      <span class="n">_hostApplicationLifetime</span><span class="p">.</span><span class="n">StopApplication</span><span class="p">();</span>
      <span class="n">_shutdownComplete</span><span class="p">.</span><span class="n">Wait</span><span class="p">();</span>

      <span class="c1">// Terminate app. Do not call base.OnStop().</span>
      <span class="n">Environment</span><span class="p">.</span><span class="n">Exit</span><span class="p">(</span><span class="n">ExitCode</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// If we&#39;re exiting normally, just let WindowsServiceLifetime do its job.</span>
    <span class="k">base</span><span class="p">.</span><span class="n">OnStop</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">(</span><span class="kt">bool</span> <span class="n">disposing</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">disposing</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">_shutdownComplete</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span>
      <span class="n">_applicationStoppedRegistration</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">base</span><span class="p">.</span><span class="n">Dispose</span><span class="p">(</span><span class="n">disposing</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>This kind of <code>MyWindowsServiceLifetime</code> implementation will work whether or not you set the <code>failureflag</code> on your service.</p>

  </article>
    
    <footer class="hidden-print">
        
            <ul class="pager">
                <li class="previous"><a href="/2020/06/backgroundservice-gotcha-application-lifetime.html" title="BackgroundService Gotcha: Application Lifetime">&larr; Previous in BackgroundService Gotchas</a></li>
                
            </ul>
        
        
        <ul class="pager">
            <li class="previous"><a href="/2020/06/a-new-pattern-for-exception-logging.html" title="A New Pattern for Exception Logging">&larr; Previous Post</a></li>
            <li class="next"><a href="/2021/01/asynchronous-messaging-1-basic-distributed-architecture.html" title="Asynchronous Messaging, Part 1: Basic Distributed Architecture">Next Post &rarr;</a></li>
        </ul>

        <div id="comments"></div>
    </footer>
</div>
        </div>
        <div class="col-sm-2 col-md-3 col-md-offset-0 col-lg-2 col-lg-offset-1 affix hidden-print" data-spy="affix" role="navigation">
            
                <div class="panel panel-primary">
                    <div class="panel-heading">BackgroundService Gotchas</div>
                    <div class="panel-body sidenav">
                        <ul class="nav nav-pills nav-stacked">
                                    <li class="sidenavitem"><a href="/2020/05/backgroundservice-gotcha-startup.html">Synchronous Starts</a></li>
                                    <li class="sidenavitem"><a href="/2020/05/backgroundservice-gotcha-silent-failure.html">Silent Failures</a></li>
                                    <li class="sidenavitem"><a href="/2020/06/backgroundservice-gotcha-application-lifetime.html">Application Lifetime</a></li>
                                    <li class="active sidenavitem"><a href="/2020/06/servicebase-gotcha-recovery-actions.html">Service Recovery Actions</a></li>
                        </ul>
                    </div>
                </div>
            
        </div>
        <div class="col-sm-2 sidebar hidden-print">
            <div class="panel panel-default">
                <div class="panel-heading">About Stephen Cleary</div>
                <div class="panel-body">
                    <div class="center"><img src="https://stephencleary.com/www.assets/Me-large.jpg"/></div>
                    <div class="center vertical-margins">Stephen Cleary is a <a href="https://stephencleary.com/god/">Christian</a>, husband, father, and programmer living in Northern Michigan.</div>
                    <div class="center"><a href="http://mvp.microsoft.com/en-us/mvp/Stephen%20Cleary-5000058"><img class="mvp-logo" src="https://stephencleary.com/www.assets/MVP.png"/></a></div>
                </div>
            </div>
            <div class="panel panel-primary">
                <div class="panel-heading">My book</div>
                <div class="panel-body center">
                    <div><a href="https://stephencleary.com/book/"><img src="https://stephencleary.com/www.assets/Book-2nd-small.jpg"/></a></div>
                    <div>Available from <a href="http://www.jdoqocy.com/click-7489747-11290546?url=http%3A%2F%2Fshop.oreilly.com%2Fproduct%2F0636920266624.do%3Fcmp%3Daf-code-books-video-product_cj_0636920266624_%25zp&cjsku=0636920266624">O'Reilly (Safari)</a>, <a href="https://amzn.to/2kYzcEY">Amazon (print/Kindle)</a>, or <a href="https://www.ebooks.com/cj.asp?IID=209766469&cjsku=209766469">eBooks.com (PDF/epub)</a>.</div>
                    <div>Also available in <a href="https://www.labirint.ru/books/745595/">Russian</a> and <a href="https://item.jd.com/12769567.html">Chinese</a>.</div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Advertisement</div>
                <div><a href="https://brave.com/ste083">Don't like ads? Browse privately and ad-free with Brave!</a></div>
                <div class="panel-body">
                    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2749292939902134" data-ad-slot="7584809820" data-ad-format="auto"></ins>
                </div>
            </div>
            
            <div class="panel panel-primary">
                <div class="panel-heading">Popular Posts</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2012/02/async-and-await.html">Async/await Intro</a></li>
                        <li><a href="/2013/11/there-is-no-thread.html">There Is No Thread</a></li>
                        <li><a href="/2012/07/dont-block-on-async-code.html">Don't Block on Async Code</a></li>
                    </ul>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Series</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2016/02/react-redux-todomvc.html">React/Redux TodoMVC</a></li>
                        <li><a href="/2014/04/a-tour-of-task-part-0-overview.html">A Tour of Task</a></li>
                        <li><a href="/2013/10/taskrun-etiquette-and-proper-usage.html">Task.Run Etiquette</a></li>
                        <li><a href="/2013/05/taskrun-vs-backgroundworker-intro.html">Task.Run vs. BackgroundWorker</a></li>
                        <li><a href="/2013/01/async-oop-0-introduction.html">Async OOP</a></li>
                        <li><a href="/2009/04/tcpip-net-sockets-faq.html">TCP/IP .NET Sockets FAQ</a></li>
                        <li><a href="/2013/10/managed-services-roundup.html">Managed Services</a></li>
                        <li><a href="/2009/08/how-to-implement-idisposable-and.html">IDisposable and Finalizers</a></li>
                        <li><a href="/2011/02/option-parsing-introduction.html">Option Parsing</a></li>
                    </ul>
                </div>
            </div>
            
        </div>
    </div>

    <div class="google">
        <gcse:searchresults></gcse:searchresults>
    </div>
    
    <!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
<script type="text/javascript">window.jQuery || document.write('<script src="/lib/jquery-2.1.1.min.js"><\/script>')</script>

<!-- Bootstrap -->
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script type="text/javascript">window.jQuery.fn.modal || document.write('<script src="/lib/bootstrap.min.js"><\/script>')</script>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('body').css('color') !== 'rgb(102, 102, 102)') {
                $('head').prepend('<link rel="stylesheet" href="/lib/bootstrap.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Font Awesome -->
<span id="facheck" class="fa" style="display:none"></span>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('#facheck').css('fontFamily') !== 'FontAwesome') {
                $('head').prepend('<link rel="stylesheet" href="/lib/font-awesome.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Scroll the sidebar into view (if necessary) -->

<script src="/lib/jquery.scrollTo.min.js"></script>
<script type="text/javascript">
    (function ($) {
        $(function () {
            var container = $('.affix').filter(function() { return $(this).css('position') == 'fixed'; });
            var target = container.find('.active');
            container.scrollTo(target, { offset: - (container.height() / 2 - target.height() / 2) });
        });
    })(window.jQuery);
</script>


<!-- Moment -->
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.6.0/moment.min.js"></script>
<script type="text/javascript">window.moment || document.write('<script src="/lib/moment.min.js"><\/script>')</script>

<!-- Google analytics -->
<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-8910661-5', 'stephencleary.com');
    ga('send', 'pageview');
</script>

<!-- Show appropriate elements based on time -->
<script type="text/javascript">
    (function ($) {
        $(function () {
            var targets = $('[data-hide-after]');
            targets.each(function () {
                var $item = $(this);
                if (moment() < moment($item.attr('data-hide-after'))) {
                    $item.removeClass('hidden');
                }
            });
        });
    })(window.jQuery);
</script>








<script src="/lib/uuid-v3-3.2.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/showdown@1.8.6/dist/showdown.min.js" integrity="sha256-dwhppIrxD8qC6lNulndZgtIm4XBU9zoMd9OUoXzIDAE=" crossorigin="anonymous"></script>
<script src="/lib/sanitize-html-1.18.2.min.js"></script>
<script src="/lib/autosize.min.js"></script>
<script src="/lib/base64js.min.js"></script>
<script src="/lib/md5.min.js"></script>

<script type="text/javascript">

var pageUrl = "https://blog.stephencleary.com" + "/2020/06/servicebase-gotcha-recovery-actions.html";

// (unnecessary) 1) If the URL starts with http://, replace with https://

// 2) Take the URL path (not including scheme and domain).
var url = document.createElement('a');
url.href = pageUrl; //'https://developer.mozilla.org:8080/en-US/search?q=URL#search-results-close-container';
var path = url.pathname;

// 3) Path: If the path ends with .html or any two- to six-character [A-Za-z0-9] extension, strip it.
if (path.endsWith(".html"))
    path = path.substr(0, path.length - 5);
else
    path = path.replace(/\.[A-Za-z0-9]{2,6}$/, "");

// 4) Path: For each UTF-16 code unit, if it's not in the whitelist [A-Za-z0-9-_;.~()], then replace it with _.
path = path.replace(/[^-A-Za-z0-9_;.~()]/g, "_");

// 5) Path: Trim leading and trailing _ characters.
path = path.replace(/^_+|_+$/g, "");

// 6) Calculate the V3 URL GUID for the URL.
var guid = uuidv3(pageUrl, uuidv3.URL);

// 7) Combine the path and lowercase-hyphenated GUID, separated by '-'.
var postId = path + "-" + guid;

var nofollowLinkExtension = {
    type: 'output',
    regex: /(<a[^<]+<\/a>)/g,
    replace: (match, $1, $2) => {
        var result = $('<div/>').append($($1).attr('rel', 'nofollow noopener')).html();
        return result;
    }
};
showdown.extension('nofollowLink', nofollowLinkExtension);

var comments;
var markdownConverter = new showdown.Converter({
    omitExtraWLInCodeBlocks: true,
    noHeaderId: true,
    headerLevelStart: 3,
    simplifiedAutoLink: true,
    excludeTrailingPunctuationFromURLs: true,
    literalMidWordUnderscores: true,
    strikethrough: true,
    smoothLivePreview: true,
    disableForced4SpacesIndentedSublists: true,
    extensions: ['nofollowLink']
});
var sanitizeOptions = {
    allowedTags: [ 'blockquote', 'p', 'a', 'ul', 'ol', 'nl', 'li', 'b', 'i', 'strong', 'em', 'strike', 'code', 'br', 'div', 'pre', 'img' ],
    allowedAttributes: {
        a: [
            'href',
            {
                name: 'rel',
                multiple: true,
                values: ['nofollow', 'noopener']
            }
        ],
        img: [ 'src' ]
    },
    allowedIframeHostnames: []
};

function fixedEncodeURIComponent(str) {
  return encodeURIComponent(str).replace(/[!'()*]/g, function(c) {
    return '%' + c.charCodeAt(0).toString(16);
  });
}

function filterComments(replyTo) {
    return comments
        .filter(function (x) { return x.replyTo === replyTo; })
        .sort(function (a, b) { return a.timestamp - b.timestamp; });
}

function avatarUri(authorEmailMD5) {
    if (authorEmailMD5 === "")
        return "https://www.gravatar.com/avatar/?d=mp&f=y";
    else
        return "https://www.gravatar.com/avatar/" + authorEmailMD5 + "?d=retro";
}

var jwk = {"kty":"RSA","alg":"RSA-OAEP","n":"wviXqUJGtV8hZrvJMcTbyzm7MmiJSqsAfWI_7pCyAhXXzz5C9F3NtXp79CCUMqkOck6IbNKUntPtGNOGwtoc5LTJNKLhx3TPi4TJyKUSfNr3pAdLpMRNeeRXCHFyyVsDb6z8ueixlKzdbDpZhV05bam49PurMHfeexJ3EJy2NpdFviykRJxtrERi6ckBe96VMlT_pHHIWLN5EwOK54DvNn1DYjiFK5ux5WRCFatZByzytrFvIllZRctNXZ8oTuMjQwKLY2bUrURblbIvLfX-9Yd7uVgdUSFE7-vSel9-DMyp_NQ-NRXrQbJG7IAYhSGSx-TPepCDPbFpMq3yC0iET7wF7-OQOb-Kwej_TKVJv-z4SbN-cpCqaMr5Q9scyGih7xr1YrOhe3TMs_cbgjtxsZbzkOqcuRreON_sGb9nlDpSIFCo6aH47GeMkA23Hk3HXAPyYQ7AfWhU9daiPcySiAFnfkrg2QvFNJmMSZ-bo4Co-JkjiqKw-LEpOw6Ed9LK4walxWUAqPGcT4_Uys3TH9XVex9_rEmigHXiJY3_Lwi6mTSkW10-zen5UXxqnyHpMxlmumohT96OyLyhEPeaaq8FrTYMCX8TiMOst3jF5QCNP-LFz21yeUEAr5_3-FKV2mjWEU9iW0dOOVTII2rlD0WtCkqkDwZtakQ1ynGdW1E","e":"AQAB"};

function commentId(id) { return "comment-" + id; }

function $commentForm(hideForm, comment) {
    var $previewDiv = $('<div/>');
    var $authorEmailEncrypted = $('<input type="hidden" name="fields[authorEmailEncrypted]">');
    var $authorEmailMD5 = $('<input type="hidden" name="fields[authorEmailMD5]">');
    var $email = $('<input type="email" name="email" class="form-control" placeholder="Email">');
    var $name = $('<input type="text" name="fields[authorName]" class="form-control" placeholder="Name">');
    var $url = $('<input type="url" name="fields[authorUri]" class="form-control" placeholder="Url">');
    var $message = $('<textarea name="fields[message]" class="form-control" placeholder="Message"/></textarea>');
    autosize($message);
    var $replyTo = $('<input type="hidden" name="fields[replyTo]">').val("");
    var $recaptcha = $('<div class="g-recaptcha" data-sitekey="6LfSaV8UAAAAAEFq-7HeUDiSQCkCtLtO_yc_SOi_"></div>');
    var $buttonBar = $('<div class="comment-form-buttonbar"/>').append($('<button type="submit" class="btn btn-primary pull-right">Submit</button>'), $recaptcha);
    var $form = $('<form method="POST" action="https://stephencleary-comments.herokuapp.com/v2/entry/StephenCleary/comments.stephencleary.com/master"/>')
        .append($('<input type="hidden" name="fields[postId]">').val(postId))
        .append($('<input type="hidden" name="fields[postUri]">').val(location.href.replace(/#.*/, '')))
        .append($('<input type="hidden" name="options[reCaptcha][siteKey]" value="6LfSaV8UAAAAAEFq-7HeUDiSQCkCtLtO_yc_SOi_">'))
        .append($('<input type="hidden" name="options[reCaptcha][secret]" value="rlAivB9udiXQ8MQx3HNJ2Cw/qA2OJI1noljbySzRpNLKmdaS7LtDRT4T3hZcQswRl5sajt5dr+Txj46K2oEGH2HiStNdMMxCchBg0T6YcbZoAP7Zvax+6/C293ClnzMYq8Ozk4bMDbXEHC11FvHR2eaBKqTgAmQSQ3+N2NU5Aaw4Cqfgsj55Br+lKyK0Ydll6SF9+IjQnGJ6S9QV7rHopROdV3RCaeSsSrhsqyGjhvPRgSdl23npJbZt8R0e4oGd6ogH+VDhkj+S3LFPL+R7h6BiHuUDNuJheaJKYTJtjWt80esZgFYywTyTWnqkNBHxOXyH8+AN4PGI0trvlXzdsGvNYRP+dlV6AQyShI3zimSmB4mqcAnuNhGNvLIsfgTKRT1gmxgG1uxUMPjRq1L3R2wQMSQ1/cEuX2wiLI3UrtT8N+QUEptMQ1jsR7rg28OxqIVhbd2+LeAS90PxbxJ9h3mKAxQ493TmCIxRLbh9RNLl+jy8NsRwz2RikzKLJDZsfB7n/Z30nSDZkOTtT7fMzS3g4eJzT0sZStFQsW7Gis6MVs8hXUYgiuIseALKvAzmobnlycD/rqlCpZ5rYC2xQToc4ZDczfZ0bCP8/R5Op4J8LhI4l0JfR1pZSD9V9xTyQ6MTuTT63Ra72ANxn/0idxveWPJS7WMKbKoGmuTNji4=">'))
        .append($replyTo)
        .append($authorEmailEncrypted)
        .append($authorEmailMD5)
        .append($('<div class="form-group"><label>Name (optional)</label></div>').append($name))
        .append($('<div class="form-group"><label>Email (optional; always encrypted, never shared)</label></div>').append($email))
        .append($('<div class="form-group"><label>Url (optional; must start with "http://" or "https://")</label></div>').append($url))
        .append($('<div class="form-group"><label>Message (supports some Markdown/HTML)</label></div>').append($message));
    if (comment) {
        $replyTo.val(comment._id);
    }
    $form.submit(function (e) {
        e.preventDefault();
        hideForm();
        var postAction = $form.attr('action');
        var postBody = $form.serialize();
        var retries = 5;

        function postIt() {
            var post = $.post(postAction, postBody, "json");
            post.done(function () {
                alert("Comment successfully posted. It should appear on this page in a minute or so.");
            });
            post.error(function () {
                var message = "Failed to post comment";
                if (post.responseText)
                    message += ": " + post.responseText;
                
                if (--retries > 0) {
                    console.log(message);
                    postIt();
                } else {
                    alert(message);
                }
            });
        }

        postIt();
    });

    function createComment() {
        return normalizeComment({
            date: moment().format(),
            _id: "_",
            replyTo: comment ? comment._id : undefined,
            authorName: $name.val(),
            authorEmailMD5: $authorEmailMD5.val(),
            authorUri: $url.val(),
            message: $message.val()
        });
    };

    function recreatePreview() {
        var email = $email.val();
        if (email && email.indexOf("@") !== -1) {
            var data = new TextEncoder().encode($email.val());
            window.crypto.subtle.importKey("jwk", jwk, { name: "RSA-OAEP", hash: { name: "SHA-1" } }, false, ["encrypt"]).then(function (encryptionKey) {
                return window.crypto.subtle.encrypt({ name: "RSA-OAEP" }, encryptionKey, data)
                    .then(function (encrypted) {
                        var array = new Uint8Array(encrypted);
                        var text = base64js.fromByteArray(array);
                        $authorEmailEncrypted.val(text);
                        return text;
                    });
            });
            $authorEmailMD5.val(md5($email.val().replace(/^ +| +$/g, '').toLowerCase()));
        } else {
            $authorEmailMD5.val("");
            $authorEmailEncrypted.val("");
        }

        var $newPreview = $comment(false, createComment());
        // Turn off permalink and anchor
        var $anchor = $newPreview.find('.comment-date a');
        $anchor.replaceWith($('<span/>').text($anchor.text()));
        $newPreview.find('.comment-anchor').remove();
        $previewDiv.empty();
        $previewDiv.append($newPreview);
    };

    recreatePreview();
    $name.on('change keyup input paste', recreatePreview);
    $email.on('change keyup input paste', recreatePreview);
    $url.on('change keyup input paste', recreatePreview);
    $message.on('change keyup input paste', recreatePreview);

    $form.append($('<h3>Preview:</h3>'), $previewDiv, $buttonBar);
    return {
        $form: $('<div class="comment-form"/>').append($form),
        onShow: function() { grecaptcha.render($recaptcha[0]); }
    };
}

function $replyButton(comment) {
    var $button;
    if (comment)
        $button = $('<button class="btn btn-primary comment-reply"><i class="fa fa-reply"></i> Reply</button>');
    else
        $button = $('<button class="btn btn-primary comment-new"><i class="fa fa-plus-square"></i> New Comment</button>');
    return $button;
}

var now = moment();
function $comment(includeForm, comment) {
    var message = sanitizeHtml(markdownConverter.makeHtml(comment.message), sanitizeOptions);
    var $commentDiv = $('<div class="comment"/>');
    var publicationDate = moment(comment.date);
    var $author = $('<div class="comment-author"/>').append($('<span class="comment-author-name"/>').text(comment.authorName));
    if (comment.authorUri !== "")
        $author.append($('<span> • </span>'), $('<a class="comment-author-uri" rel="nofollow noopener"/>').attr('href', comment.authorUri).text(comment.authorUri));
    var $headerDiv = $('<div class="comment-header"/>').append(
        $('<div class="comment-author-profile" style="float:left;"/>').append($('<img class="comment-author-profile-image" src="' + avatarUri(comment.authorEmailMD5) + '"/>')),
        $author,
        $('<div class="comment-date" />').append(
            $('<a/>').attr('href', '#' + commentId(comment._id)).attr('title', 'permalink').text(publicationDate.from(now) + ' (' + publicationDate.format('YYYY-MM-DD hh:mm:ss a') + ')')
        )
    );
    if (comment.replyTo !== "") {
        var parent = comments.filter(function (x) { return x._id === comment.replyTo })[0];
        $headerDiv.append($('<div/>').append($('<a/>').attr('href', '#' + commentId(comment.replyTo)).text('In reply to ' + parent.authorName)));
    }

    $commentDiv.append($('<div class="comment-anchor"/>').attr('id', commentId(comment._id)),
        $headerDiv,
        $('<div class="comment-message" style="clear:both;"/>').html(message)
    );

    var $commentContainer = $('<div class="comment-container"/>').append($commentDiv);
    if (includeForm)
        $commentContainer.append($expandCollapseForm(comment));
    var childComments = filterComments(comment._id);
    for (var i = 0; i != childComments.length; ++i) {
        var child = childComments[i];
        $commentContainer.append($comment(includeForm, child));
    }

    return $commentContainer;
}

function normalizeComment(x) {
    var uri = x.authorUri;
    if (!uri || (!uri.startsWith("http://") && !uri.startsWith("https://")))
        uri = "";
    return {
            _id: x._id,
            authorName: x.authorName || "Anonymous",
            authorEmailMD5: x.authorEmailMD5 || "",
            authorUri: uri,
            message: x.message || "",
            replyTo: x.replyTo || "",
            date: x.date,
            timestamp: moment(x.date).valueOf()
    };
}

function $expandCollapseForm(comment) {
    var $button = $replyButton(comment);
    var formObj = $commentForm(hideForm, comment);
    var $form = formObj.$form.addClass("comment-hidden");
    var onShow = formObj.onShow;
    function showForm() {
        $button.addClass("comment-hidden");
        if (onShow) {
            onShow();
            onShow = null;
        }
        $form.removeClass("comment-hidden");
    }
    function hideForm() {
        $form.addClass("comment-hidden");
        $button.removeClass("comment-hidden");
    }
    $button.click(showForm);
    return $('<div/>').append($button, $form);
}

function recaptchaLoaded() {
    var req = new XMLHttpRequest();
    req.addEventListener("load", function () {
        var $commentDiv = $('#comments');
        if (req.status === 404 || req.status === 200) {
            if (req.status === 404) {
                comments = [];
            } else {
                comments = JSON.parse(req.responseText).map(normalizeComment);
            }
            var commentCounter = document.getElementById('comment-counter');
            commentCounter.innerText = comments.length + " " + commentCounter.innerText;
            var toplevelComments = filterComments("");
            for (var i = 0; i != toplevelComments.length; ++i) {
                var comment = toplevelComments[i];
                $commentDiv.append($comment(true, comment));
            }
            if (comments.length !== 0) {
                $commentDiv.append($expandCollapseForm());
            }
        }
        $commentDiv.prepend($expandCollapseForm());
    });
    req.open('GET', "https://comments.stephencleary.com/" + postId + ".json");
    req.send();
}
</script>

<script src="https://www.google.com/recaptcha/api.js?onload=recaptchaLoaded&amp;render=explicit"></script>



<!-- Google AdSense -->
<script src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- Moment -->
<script type="text/javascript">
    (function($) {
        $(function () {
            $('time').each(function (_, e) {
                var startOfToday = moment().startOf('day');
                var publicationDate = moment($(e).attr('datetime'), 'YYYY-MM-DD');
                var difference = startOfToday.diff(publicationDate, 'days');
                var text = difference === 0 ? 'Today' :
                    difference === 1 ? 'Yesterday' :
                    publicationDate.from(startOfToday);
                $(e).text(function(_, oldText) { return text + ' (' + oldText + ')'; });
            });
        });
    })(window.jQuery);
</script>




</body>
</html>