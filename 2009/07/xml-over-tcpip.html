<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>XML over TCP/IP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="XML is a popular choice when designing communications protocols, since XML parsers are ubiquitous. The phrase “XML over TCP” makes a good executive summary, but this FAQ entry is concerned with how to actually make it work. One should always write an application protocol specification document to clearly define the actual communication." />
    <link rel="canonical" href="https://blog.stephencleary.com/2009/07/xml-over-tcpip.html" />
    
    <link rel="alternate" type="application/rss+xml" title="Stephen Cleary (the blog)" href="http://feeds.feedburner.com/NitoPrograms" />
    
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/bootswatch/3.2.0/spacelab/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" />
    <style type="text/css">/* Layout Styles */
/* ----------------------------------------------------------*/

body {
    padding-top: 50px;
}

.affix {
    top: 70px;
    bottom: 0;
    overflow-y: auto;
}

.navbar-brand {
    font-weight: bold;
}

.navbar-brand-container.active>a, .navbar-brand-container.active>a:hover, .navbar-brand-container.active>a:focus {
    color: #3399f3;
    background-color: transparent;
}

.sidebar {
    margin-top: 20px;
}

.sidenavitem {
    height: auto;
}

.sidebar img {
    /* Responsive images */
    display: inline-block;
    height: auto;
    max-width: 100%;
}

@media(max-width:767px) {
    .affix {
        position: static;
    }
}

div .vertical-margins {
    margin-top: 10px;
    margin-bottom: 10px;
}

.page-header {
    margin-top: 20px;
}

.center {
    text-align: center;
}

.project-icon {
    height: 128px;
    width: 128px;
}

.list-group-item h2 {
    margin-top: 10px;
}

/* Fixes for Google Custom Search in a Bootstrap page */
/* ----------------------------------------------------------*/
.google, .google *, .google *:before, .google *:after {
    -webkit-box-sizing: content-box;
    -moz-box-sizing: content-box;
    box-sizing: content-box;
}

.google table {
    border-collapse: separate;
}

.gsc-input-box {
    height: auto !important;
}

/* Fixes for Amazon widget in Bootstrap page */
.amzn_wdgt * {
    -webkit-box-sizing: content-box;
    -moz-box-sizing: content-box;
    box-sizing: content-box;
}

/* Post styles */
/* ----------------------------------------------------------*/

code {
    background-color: #F2F3F9;
    color: inherit;
}

.post img {
    /* Responsive images */
    display: inline-block;
    height: auto;
    max-width: 100%;
}

.post .table {
    table-layout: fixed;
}

.post .table code {
    white-space: normal;
}

.post .yes {
    color: #008000;
}

.post .no {
    color: #FF0000;
}

/* Syntax highlighting styles */
/* ----------------------------------------------------------*/

.highlight  { background: #ffffff; }
.highlight .c { color: #008000 } /* Comment */
.highlight .k { color: #0000ff } /* Keyword */
.highlight .cm { color: #008000 } /* Comment.Multiline */
.highlight .cp { color: #0000ff } /* Comment.Preproc */
.highlight .c1 { color: #008000 } /* Comment.Single */
.highlight .cs { color: #008000 } /* Comment.Special */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gh { font-weight: bold } /* Generic.Heading */
.highlight .gp { font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { font-weight: bold } /* Generic.Subheading */
.highlight .kc { color: #0000ff } /* Keyword.Constant */
.highlight .kd { color: #0000ff } /* Keyword.Declaration */
.highlight .kn { color: #0000ff } /* Keyword.Namespace */
.highlight .kp { color: #0000ff } /* Keyword.Pseudo */
.highlight .kr { color: #0000ff } /* Keyword.Reserved */
.highlight .kt { color: #2b91af } /* Keyword.Type */
.highlight .s { color: #a31515 } /* Literal.String */
.highlight .nc { color: #2b91af } /* Name.Class */
.highlight .ow { color: #0000ff } /* Operator.Word */
.highlight .sb { color: #a31515 } /* Literal.String.Backtick */
.highlight .sc { color: #a31515 } /* Literal.String.Char */
.highlight .sd { color: #a31515 } /* Literal.String.Doc */
.highlight .s2 { color: #a31515 } /* Literal.String.Double */
.highlight .se { color: #a31515 } /* Literal.String.Escape */
.highlight .sh { color: #a31515 } /* Literal.String.Heredoc */
.highlight .si { color: #a31515 } /* Literal.String.Interpol */
.highlight .sx { color: #a31515 } /* Literal.String.Other */
.highlight .sr { color: #a31515 } /* Literal.String.Regex */
.highlight .s1 { color: #a31515 } /* Literal.String.Single */
.highlight .ss { color: #a31515 } /* Literal.String.Symbol */

/* Comments */
/* ----------------------------------------------------------*/

.comment-container {
    margin-top: 1em;
}

.comment-container > .comment-container {
    margin-left: 2em;
}

.comment-container > .comment-container > .comment-container > .comment-container > .comment-container {
    margin-left: 0;
}

/* Correct anchor links in comments (they are offset by the height of the fixed header) */
.comment-anchor {
    display: block;
    position: relative;
    top: -60px;
    visibility: hidden;
}

img.comment-author-profile-image {
    height: 80px;
    width: 80px;
    margin-right: 10px;
}

.comment-message {
    overflow-x: auto;
}

.comment-form {
    border: 1px solid black;
    padding: 1em;
}

.comment-new {
    margin-top: 1em;
    margin-bottom: 1em;
}

.comment-new, .comment-reply {
    margin-left: 1em;
}

.comment-hidden {
    display: none;
}

.comment-form-buttonbar {
    margin-top: 1em;
}
</style>
    
    <meta name="application-name" content="Stephen Cleary" />
    <link rel="search" type="application/opensearchdescription+xml" href="https://stephencleary.com/opensearch.xml" title="Cleary Search">
    <link rel="apple-touch-icon" sizes="57x57" href="https://stephencleary.com/icons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="https://stephencleary.com/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://stephencleary.com/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://stephencleary.com/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="https://stephencleary.com/icons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="https://stephencleary.com/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="https://stephencleary.com/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://stephencleary.com/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" href="https://stephencleary.com/icons/apple-touch-icon.png"/>
    <link rel="apple-touch-icon-precomposed" href="https://stephencleary.com/icons/apple-touch-icon-precomposed.png"/>
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-196x196.png" sizes="196x196">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-32x32.png" sizes="32x32">
    
    <meta name="google-site-verification" content="L8q0fpGSwpNSD0OGFI07hyMujSpORrV4tAaNx_Js7oQ" />
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <div class="navbar-brand-container"><a class="navbar-brand" href="https://stephencleary.com">Stephen Cleary</a></div>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
            <li  class="active"  ><a href="https://blog.stephencleary.com">Blog</a></li>
            <li  ><a href="https://stephencleary.com/book/">Book</a></li>
            <li  ><a href="https://stephencleary.com/projects/">Projects</a></li>
            <li  ><a href="https://stephencleary.com/publications/">Publications</a></li>
            <li  ><a href="https://stephencleary.com/contact/">Contact</a></li>
            <li  ><a href="https://stephencleary.com/contract/">Hire Me</a></li>
            <li><a href="http://feeds.feedburner.com/NitoPrograms"><i class="fa fa-rss-square fa-lg"></i></a></li>
            <li  ><a href="https://stephencleary.com/search/"><i class="fa fa-search"></i></a></li>
        </ul>
    </div>
</nav>

    <div class="container-fluid">
        <div class="col-sm-8 col-sm-offset-2 col-md-6 col-md-offset-3">
            <div class="post">

  <header>
      <div class="page-header">
          <h1>XML over TCP/IP</h1>
          <small><time datetime="2009-07-01">Jul 1, 2009</time> &bull; <a id="comment-counter" href="#comments">Comments</a></small>
      </div>
  </header>

  <article>
  <p>XML is a popular choice when designing communications protocols, since XML parsers are ubiquitous. The phrase “XML over TCP” makes a good executive summary, but this FAQ entry is concerned with how to actually make it work. One should always write an application protocol specification document to clearly define the actual communication.</p>

<p>Anyone designing an XML protocol should have a good understanding of the terms. Familiarization with the <a href="http://www.w3.org/TR/2008/REC-xml-20081126/">XML standard</a> is a bonus; this FAQ entry will define most terms along the way, but the official definitions are in the relevant standards.</p>

<p>When used as a communications protocol, XML does not usually use processing instructions or entities (except for the normal “escaping entities” such as &lt;, etc.). It also does not normally use XSDs or DTDs; XML used for communication is well-formed but not valid (see the XML standard for the definitions of these terms).</p>

<p>This FAQ entry is laid out in a sequence of steps, but they do not necessarily have to be done in this sequence; in fact, the last step is often done first. However, they each <em>must</em> be addressed in an application protocol specification, so they should be viewed more as a “checklist” than a “timeline”. This advice should be considered additional to the general advice given in <a href="/2009/06/application-protocol-specifications.html">Application Protocol Specifications</a>.</p>

<h2 id="step-1-encoding">Step 1: Encoding</h2>

<p>XML documents are just a sequence of Unicode characters. However, TCP/IP works with streams of bytes. A translation must be made between Unicode characters and byte sequences, and this translation is called the <em>encoding</em>.</p>

<div class="alert alert-info">
  <p><i class="fa fa-hand-o-right fa-2x pull-left"></i></p>

  <p><strong>Encoding:</strong> The translation used when converting a Unicode string to or from a byte sequence. The most common encodings are UTF-16 (which uses 2 bytes for most characters; it is recognizable because every other byte is “00” for normal English text) and UTF-8 (which uses 1 byte for normal English characters, but most characters take 2 or more bytes).</p>
</div>

<p>The encoding may be detected one of several ways (if it is not specified in the application protocol document). A byte order mark may be used to detect the encoding in some situations.</p>

<div class="alert alert-info">
  <p><i class="fa fa-hand-o-right fa-2x pull-left"></i></p>

  <p><strong>Byte Order Mark (BOM):</strong> A special Unicode character that is sometimes inserted at the beginning of a document as it is encoded. The UTF-16 encoding has little-endian and big-endian versions, so it requires a BOM. UTF-8, however, does not require a BOM.</p>
</div>

<p>The XML file itself may include a prolog, which may specify the encoding being used. This is more difficult to work with, since the prolog itself must be interpreted heuristically by guessing at the encoding. Note that if an XML prolog exists that specifies an incorrect encoding, Microsoft’s XML parsers may get confused (this often happens when reading XML from a string or writing XML to a string).</p>

<div class="alert alert-info">
  <p><i class="fa fa-hand-o-right fa-2x pull-left"></i></p>

  <p><strong>XML Prolog:</strong> The <code>&lt;?xml ... ?&gt;</code> element at the beginning of some XML files, specifying the XML version and (optionally) the encoding used.</p>
</div>

<p>Normally, the application protocol document specifies the encoding; this is simpler than dealing with automatically detecting the encoding. If it does specify the encoding, it should also specify whether a BOM should be present, or if a prolog is allowed to specify the encoding. A common choice is “UTF-8 without BOM or prolog”, which makes the encoding always UTF-8 without a byte order mark or XML prolog.</p>

<h2 id="working-with-the-systemtextencoding-class">Working with the System.Text.Encoding class</h2>

<p>The encoding for an output may be specified by using the XmlWriterSettings class. This is the preferred way to create XmlWriters. Encodings for inputs may also be forced; this is done if the remote side sends incorrect XML prologs, causing problems with XmlReaders.</p>

<p>Always translate XML to and from byte arrays, not strings. The System.String class actually uses an encoding itself (UTF-16). Using strings as an intermediary between byte arrays and XML classes may cause problems because of this additional encoding; encoding the string to and from a byte array will not update the XML prolog. An encoding may be given to an XmlWriterSettings class, but as the <a href="http://msdn.microsoft.com/en-us/library/system.xml.xmlwritersettings.encoding.aspx?WT.mc_id=DT-MVP-5000058">documentation for XmlWriterSettings.Encoding</a> states, any encoding on a stream will override that setting. For this reason, it is better to use XmlWriters with a MemoryStream, which does not have an encoding.</p>

<p>Each instance of an Encoding object must make another choice: whether to throw an exception on invalid input bytes or silently replace them (with the Unicode replacement character U+FFFD, which looks like ‘?’ in a diamond). The default is to silently replace, but this is not generally recommended when implementing application protocols. The example code in this FAQ entry will always use encodings that throw exceptions.</p>

<p>The following sample code takes an XElement and an Encoding, and translates the XML to a byte array (not including an XML prolog):</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">byte</span><span class="p">[]</span> <span class="nf">ConvertXmlToByteArray</span><span class="p">(</span><span class="n">XElement</span> <span class="n">xml</span><span class="p">,</span> <span class="n">Encoding</span> <span class="n">encoding</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">MemoryStream</span> <span class="n">stream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryStream</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">XmlWriterSettings</span> <span class="n">settings</span> <span class="p">=</span> <span class="k">new</span> <span class="n">XmlWriterSettings</span><span class="p">();</span>
        <span class="c1">// Add formatting and other writer options here if desired</span>
        <span class="n">settings</span><span class="p">.</span><span class="n">Encoding</span> <span class="p">=</span> <span class="n">encoding</span><span class="p">;</span>
        <span class="n">settings</span><span class="p">.</span><span class="n">OmitXmlDeclaration</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span> <span class="c1">// No prolog</span>
        <span class="k">using</span> <span class="p">(</span><span class="n">XmlWriter</span> <span class="n">writer</span> <span class="p">=</span> <span class="n">XmlWriter</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">settings</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">xml</span><span class="p">.</span><span class="n">Save</span><span class="p">(</span><span class="n">writer</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">stream</span><span class="p">.</span><span class="n">ToArray</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>When reading XML from a byte array, one may either use an XmlReader or a StreamReader. Using an XmlReader allows incoming XML to use any encoding; however, it will get confused if the XML has an incorrect encoding specified in its prolog. Using a StreamReader will force the byte array to be interpreted according to a particular encoding, but does not allow any other encodings.</p>

<p>If the application protocol specification does not specify an encoding, then the XmlReader must be used. Incorrect XML prologs cannot be allowed. The following sample code allows any encoding:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">XElement</span> <span class="nf">ConvertByteArrayToXml</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Interpret the byte array allowing any encoding</span>
    <span class="n">XmlReaderSettings</span> <span class="n">settings</span> <span class="p">=</span> <span class="k">new</span> <span class="n">XmlReaderSettings</span><span class="p">();</span>
    <span class="c1">// Add validation and other reader options here if desired</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">MemoryStream</span> <span class="n">stream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryStream</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">XmlReader</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">XmlReader</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">settings</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">XElement</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span><span class="n">reader</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>If the application protocol specification does specify a particular encoding, then using a StreamReader will allow incorrect XML prologs. The following sample code forces a specific encoding:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">XElement</span> <span class="nf">ConvertByteArrayToXml</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">data</span><span class="p">,</span> <span class="n">Encoding</span> <span class="n">encoding</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Interpret the byte array according to a specific encoding</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">MemoryStream</span> <span class="n">stream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryStream</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">StreamReader</span> <span class="n">reader</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StreamReader</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="k">false</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">XElement</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span><span class="n">reader</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The default <a href="http://msdn.microsoft.com/en-us/library/system.text.encoding.unicode.aspx?WT.mc_id=DT-MVP-5000058">Encoding.Unicode</a> (UTF-16 little endian), <a href="http://msdn.microsoft.com/en-us/library/system.text.encoding.bigendianunicode.aspx?WT.mc_id=DT-MVP-5000058">Encoding.BigEndianUnicode</a> (UTF-16 big endian), and <a href="http://msdn.microsoft.com/en-us/library/system.text.encoding.utf8.aspx?WT.mc_id=DT-MVP-5000058">Encoding.UTF8</a> instances always write out BOMs and never throw on errors. A better choice is to create instances of <a href="http://msdn.microsoft.com/en-us/library/system.text.unicodeencoding.aspx?WT.mc_id=DT-MVP-5000058">UnicodeEncoding</a> (UTF-16) or <a href="http://msdn.microsoft.com/en-us/library/system.text.utf8encoding.aspx?WT.mc_id=DT-MVP-5000058">UTF8Encoding</a> that are more suitable for application protocols. For example, “new UTF8Encoding(false, true)” will create a UTF-8 encoding without BOM that throws on invalid characters.</p>

<h2 id="step-2-message-framing">Step 2: Message Framing</h2>

<p><a href="/2009/04/message-framing.html">Message framing</a> is highly recommended for XML messages. Technically, message framing is not strictly necessary, but reading XML from a socket without message framing is extremely difficult (the message must be considered complete when the root node is closed).</p>

<p>When sending, message framing is actually applied after the encoding, so the message framing wraps a byte array. Similarly, when receiving, message framing is applied directly to the received data, and each message (consisting of a byte array) is then passed through the encoding to produce XML.</p>

<h2 id="step-3-keepalives">Step 3: Keepalives</h2>

<p><a href="/2009/05/detection-of-half-open-dropped.html">Keepalive messages</a> are usually necessary. Having a keepalive message defined in the application protocol specification often removes the need for separate timers when implementing the protocol.</p>

<p>XML keepalive messages (e.g., <code>&lt;keepalive/&gt;</code>) are not normally used. Usually, a keepalive message may be sent by using the message framing to send an empty (zero-length) message.</p>

<h2 id="step-4-messages">Step 4: Messages</h2>

<p>Once the encoding, message framing, and keepalive options have all been chosen, then there is a framework over which XML messages may be exchanged. For each XML message, the following information should be included:</p>

<ul>
  <li>When the message is meaningful (e.g., a “Response” should only be sent in response to a “Request”).</li>
  <li>Which attributes and elements are required and which are optional. This includes complex relations (e.g., a “Log” element must contain at least one “Message” element and exactly one “Source” element). Be sure to use terms with specific definitions (“at least one”, “exactly one”, etc).</li>
  <li>The format of non-string data such as dates, booleans, and integers. Often, this type of “formatting data” is defined globally near the top of the application protocol specification, and applies to each possible message type.</li>
</ul>

<p>Many protocols are based on a request/response or subscription/event model. One thing to watch out for is if the protocol elements begin looking like generic or object-oriented function calls, as though one side is accessing a remote object (e.g., <code>&lt;CallMethod ObjectID='37' MethodName='GetData'/&gt;</code>). At this point, the protocol will devolve into something eventually looking like SOAP. There’s nothing wrong with SOAP, but there’s no need to re-invent the wheel. If that level of abstraction is truly necessary, then just use SOAP instead of creating a separate protocol.</p>

<h2 id="recommendations">Recommendations</h2>

<p>A choice must be made for encoding, message framing, and keepalives.</p>

<ul>
  <li>The encoding is usually “any” or “UTF-8 without BOM or prolog”, but could be anything.</li>
  <li>A common choice for message framing is “4-byte (un)signed little-endian integer length prefix”. Delimeter-based message framing may also be used for XML by appointing illegal XML characters to be the delimiters, and scanning for them during decoding (however, this is very difficult to do if the encoding is “any”).</li>
  <li>Since most XML protocols use length prefixing, most of them also choose “length prefix of 0 with no message” for keepalives.</li>
</ul>

<p>One final note: nothing helps track down interfacing errors like verbose logging. It’s recommended to log the byte arrays sent and received as well as the actual XML messages. Logging is your friend. :)</p>

  </article>
    
    <footer class="hidden-print">
        <div class="alert alert-info" markdown="1">
            <i class="fa fa-hand-o-right fa-2x pull-left"></i>
            
            <div>Has this blog been helpful? Please consider <a href="https://github.com/sponsors/StephenCleary" class="alert-link">supporting this blog (and my open-source libraries).</a> Thanks!</div>
        </div>

        
            <ul class="pager">
                <li class="previous"><a href="/2009/06/application-protocol-specifications.html" title="Application Protocol Specifications">&larr; Previous in TCP/IP .NET Sockets FAQ</a></li>
                <li class="next"><a href="/2009/05/socket-operations.html" title="Socket Operations">Next in TCP/IP .NET Sockets FAQ &rarr;</a></li>
            </ul>
        
        
        <ul class="pager">
            <li class="previous"><a href="/2009/06/application-protocol-specifications.html" title="Application Protocol Specifications">&larr; Previous Post</a></li>
            <li class="next"><a href="/2009/07/nitoweakreference-and.html" title="Nito.WeakReference and Nito.WeakCollection">Next Post &rarr;</a></li>
        </ul>

        <div id="comments"></div>
    </footer>
</div>
        </div>
        <div class="col-sm-2 col-md-3 col-md-offset-0 col-lg-2 col-lg-offset-1 affix hidden-print" data-spy="affix" role="navigation">
            
                <div class="panel panel-primary">
                    <div class="panel-heading">TCP/IP .NET Sockets FAQ</div>
                    <div class="panel-body sidenav">
                        <ul class="nav nav-pills nav-stacked">
                                    <li class="sidenavitem"><a href="/2009/04/tcpip-net-sockets-faq.html">Overview</a></li>
                                    <li class="sidenavitem"><a href="/2009/04/message-framing.html">Message Framing</a></li>
                                    <li class="sidenavitem"><a href="/2009/05/detection-of-half-open-dropped.html">Half-Open Connections</a></li>
                                    <li class="sidenavitem"><a href="/2009/06/application-protocol-specifications.html">Application Protocol Specifications</a></li>
                                    <li class="active sidenavitem"><a href="/2009/07/xml-over-tcpip.html">XML</a></li>
                                    <li class="sidenavitem"><a href="/2009/05/socket-operations.html">Socket Operations</a></li>
                                    <li class="sidenavitem"><a href="/2009/05/error-handling.html">Error Handling</a></li>
                                    <li class="sidenavitem"><a href="/2009/05/using-socket-as-client-socket.html">Client Sockets</a></li>
                                    <li class="sidenavitem"><a href="/2009/05/using-socket-as-server-listening-socket.html">Server Sockets</a></li>
                                    <li class="sidenavitem"><a href="/2009/06/using-socket-as-connected-socket.html">Connected Sockets</a></li>
                                    <li class="sidenavitem"><a href="/2009/05/tcpip-resources.html">Resources</a></li>
                                    <li class="sidenavitem"><a href="/2009/05/getting-local-ip-address.html">The Local IP Address</a></li>
                                    <li class="sidenavitem"><a href="/2009/04/sample-code-length-prefix-message.html">Length-Prefix Example</a></li>
                                    <li class="sidenavitem"><a href="/2009/05/getting-local-ip-addresses.html">Local IP Addresses Example</a></li>
                        </ul>
                    </div>
                </div>
            
        </div>
        <div class="col-sm-2 sidebar hidden-print">
            <div class="panel panel-default">
                <div class="panel-heading">About Stephen Cleary</div>
                <div class="panel-body">
                    <div class="center"><img src="https://stephencleary.com/www.assets/Me-large.jpg"/></div>
                    <div class="center vertical-margins">Stephen Cleary is a <a href="https://stephencleary.com/god/">Christian</a>, husband, father, and programmer living in Northern Michigan.</div>
                    <div class="center"><a href="http://mvp.microsoft.com/en-us/mvp/Stephen%20Cleary-5000058"><img class="mvp-logo" src="https://stephencleary.com/www.assets/MVP.png"/></a></div>
                </div>
            </div>
            <div class="panel panel-primary">
                <div class="panel-heading">My book</div>
                <div class="panel-body center">
                    <div><a href="https://stephencleary.com/book/"><img src="https://stephencleary.com/www.assets/Book-2nd-small.jpg"/></a></div>
                    <div>Available from <a href="https://www.amazon.com/dp/149205450x/ref=as_li_ss_tl?&ref=pd_sl_a04BABB1D18C7F2658168FF785&linkCode=sl1&tag=stepheclearys-20&linkId=fb22bb126d6e60f305fecddf3d4ecbd8" rel="nofollow">Amazon (print/Kindle)</a>, <a href="https://learning.oreilly.com/library/view/concurrency-in-c/9781492054498/" rel="nofollow">O'Reilly (Safari)</a>, or <a href="https://www.ebooks.com/cj.asp?IID=209766469&cjsku=209766469" rel="nofollow">eBooks.com (PDF/epub)</a>.</div>
                    <div>Also available in <a href="https://www.labirint.ru/books/745595/" rel="nofollow">Russian</a>, <a href="https://item.jd.com/12769567.html" rel="nofollow">Chinese</a>, and <a href="https://www.aladin.co.kr/shop/wproduct.aspx?ItemId=270818316" rel="nofollow">Korean</a>.</div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Advertisement</div>
                <div><a href="https://stephencleary.com/contract/">Hire me if you need in-depth assistance!</a></div>
                <div class="panel-body">
                    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2749292939902134" data-ad-slot="7584809820" data-ad-format="auto"></ins>
                </div>
            </div>
            
            <div class="panel panel-primary">
                <div class="panel-heading">Popular Posts</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2012/02/async-and-await.html">Async/await Intro</a></li>
                        <li><a href="/2013/11/there-is-no-thread.html">There Is No Thread</a></li>
                        <li><a href="/2012/07/dont-block-on-async-code.html">Don't Block on Async Code</a></li>
                    </ul>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Series</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2016/02/react-redux-todomvc.html">React/Redux TodoMVC</a></li>
                        <li><a href="/2014/04/a-tour-of-task-part-0-overview.html">A Tour of Task</a></li>
                        <li><a href="/2013/10/taskrun-etiquette-and-proper-usage.html">Task.Run Etiquette</a></li>
                        <li><a href="/2013/05/taskrun-vs-backgroundworker-intro.html">Task.Run vs. BackgroundWorker</a></li>
                        <li><a href="/2013/01/async-oop-0-introduction.html">Async OOP</a></li>
                        <li><a href="/2009/04/tcpip-net-sockets-faq.html">TCP/IP .NET Sockets FAQ</a></li>
                        <li><a href="/2013/10/managed-services-roundup.html">Managed Services</a></li>
                        <li><a href="/2009/08/how-to-implement-idisposable-and.html">IDisposable and Finalizers</a></li>
                        <li><a href="/2011/02/option-parsing-introduction.html">Option Parsing</a></li>
                    </ul>
                </div>
            </div>
            
        </div>
    </div>

    <div class="google">
        <gcse:searchresults></gcse:searchresults>
    </div>
    
    <!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
<script type="text/javascript">window.jQuery || document.write('<script src="/lib/jquery-2.1.1.min.js"><\/script>')</script>

<!-- Bootstrap -->
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script type="text/javascript">window.jQuery.fn.modal || document.write('<script src="/lib/bootstrap.min.js"><\/script>')</script>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('body').css('color') !== 'rgb(102, 102, 102)') {
                $('head').prepend('<link rel="stylesheet" href="/lib/bootstrap.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Font Awesome -->
<span id="facheck" class="fa" style="display:none"></span>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('#facheck').css('fontFamily') !== 'FontAwesome') {
                $('head').prepend('<link rel="stylesheet" href="/lib/font-awesome.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Scroll the sidebar into view (if necessary) -->

<script src="/lib/jquery.scrollTo.min.js"></script>
<script type="text/javascript">
    (function ($) {
        $(function () {
            var container = $('.affix').filter(function() { return $(this).css('position') == 'fixed'; });
            var target = container.find('.active');
            container.scrollTo(target, { offset: - (container.height() / 2 - target.height() / 2) });
        });
    })(window.jQuery);
</script>


<!-- Moment -->
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.6.0/moment.min.js"></script>
<script type="text/javascript">window.moment || document.write('<script src="/lib/moment.min.js"><\/script>')</script>

<!-- Google analytics -->
<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-8910661-5', 'stephencleary.com');
    ga('send', 'pageview');
</script>

<!-- Show appropriate elements based on time -->
<script type="text/javascript">
    (function ($) {
        $(function () {
            var targets = $('[data-hide-after]');
            targets.each(function () {
                var $item = $(this);
                if (moment() < moment($item.attr('data-hide-after'))) {
                    $item.removeClass('hidden');
                }
            });
        });
    })(window.jQuery);
</script>




<!-- Email obfuscation -->
<script type="text/javascript">
    (function($) {
        $(function() {
            var x = 'an',
                y = 'steph',
                email = 'mailto:' + y + 'en' + x + 'dm' + x + 'dy@' + 'gma' + 'il.' + 'com';
            $('.email-link').attr('href', email);
        });
    })(window.jQuery);
</script>



<script src="/lib/uuid-v3-3.2.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/showdown@1.8.6/dist/showdown.min.js" integrity="sha256-dwhppIrxD8qC6lNulndZgtIm4XBU9zoMd9OUoXzIDAE=" crossorigin="anonymous"></script>
<script src="/lib/sanitize-html-1.18.2.min.js"></script>
<script src="/lib/autosize.min.js"></script>
<script src="/lib/base64js.min.js"></script>
<script src="/lib/md5.min.js"></script>

<script type="text/javascript">

var pageUrl = "https://blog.stephencleary.com" + "/2009/07/xml-over-tcpip.html";

// (unnecessary) 1) If the URL starts with http://, replace with https://

// 2) Take the URL path (not including scheme and domain).
var url = document.createElement('a');
url.href = pageUrl; //'https://developer.mozilla.org:8080/en-US/search?q=URL#search-results-close-container';
var path = url.pathname;

// 3) Path: If the path ends with .html or any two- to six-character [A-Za-z0-9] extension, strip it.
if (path.endsWith(".html"))
    path = path.substr(0, path.length - 5);
else
    path = path.replace(/\.[A-Za-z0-9]{2,6}$/, "");

// 4) Path: For each UTF-16 code unit, if it's not in the whitelist [A-Za-z0-9-_;.~()], then replace it with _.
path = path.replace(/[^-A-Za-z0-9_;.~()]/g, "_");

// 5) Path: Trim leading and trailing _ characters.
path = path.replace(/^_+|_+$/g, "");

// 6) Calculate the V3 URL GUID for the URL.
var guid = uuidv3(pageUrl, uuidv3.URL);

// 7) Combine the path and lowercase-hyphenated GUID, separated by '-'.
var postId = path + "-" + guid;

var nofollowLinkExtension = {
    type: 'output',
    regex: /(<a[^<]+<\/a>)/g,
    replace: (match, $1, $2) => {
        var result = $('<div/>').append($($1).attr('rel', 'nofollow noopener ugc')).html();
        return result;
    }
};
showdown.extension('nofollowLink', nofollowLinkExtension);

var comments;
var markdownConverter = new showdown.Converter({
    omitExtraWLInCodeBlocks: true,
    noHeaderId: true,
    headerLevelStart: 3,
    simplifiedAutoLink: true,
    excludeTrailingPunctuationFromURLs: true,
    literalMidWordUnderscores: true,
    strikethrough: true,
    smoothLivePreview: true,
    disableForced4SpacesIndentedSublists: true,
    extensions: ['nofollowLink']
});
var sanitizeOptions = {
    allowedTags: [ 'blockquote', 'p', 'a', 'ul', 'ol', 'nl', 'li', 'b', 'i', 'strong', 'em', 'strike', 'code', 'br', 'div', 'pre', 'img' ],
    allowedAttributes: {
        a: [
            'href',
            {
                name: 'rel',
                multiple: true,
                values: ['nofollow', 'noopener', 'ugc']
            }
        ],
        img: [ 'src' ]
    },
    allowedIframeHostnames: []
};

function fixedEncodeURIComponent(str) {
  return encodeURIComponent(str).replace(/[!'()*]/g, function(c) {
    return '%' + c.charCodeAt(0).toString(16);
  });
}

function filterComments(replyTo) {
    return comments
        .filter(function (x) { return x.replyTo === replyTo; })
        .sort(function (a, b) { return a.timestamp - b.timestamp; });
}

function avatarUri(authorEmailMD5) {
    if (authorEmailMD5 === "")
        return "https://www.gravatar.com/avatar/?d=mp&f=y";
    else
        return "https://www.gravatar.com/avatar/" + authorEmailMD5 + "?d=retro";
}

var jwk = {"kty":"RSA","alg":"RSA-OAEP","n":"wviXqUJGtV8hZrvJMcTbyzm7MmiJSqsAfWI_7pCyAhXXzz5C9F3NtXp79CCUMqkOck6IbNKUntPtGNOGwtoc5LTJNKLhx3TPi4TJyKUSfNr3pAdLpMRNeeRXCHFyyVsDb6z8ueixlKzdbDpZhV05bam49PurMHfeexJ3EJy2NpdFviykRJxtrERi6ckBe96VMlT_pHHIWLN5EwOK54DvNn1DYjiFK5ux5WRCFatZByzytrFvIllZRctNXZ8oTuMjQwKLY2bUrURblbIvLfX-9Yd7uVgdUSFE7-vSel9-DMyp_NQ-NRXrQbJG7IAYhSGSx-TPepCDPbFpMq3yC0iET7wF7-OQOb-Kwej_TKVJv-z4SbN-cpCqaMr5Q9scyGih7xr1YrOhe3TMs_cbgjtxsZbzkOqcuRreON_sGb9nlDpSIFCo6aH47GeMkA23Hk3HXAPyYQ7AfWhU9daiPcySiAFnfkrg2QvFNJmMSZ-bo4Co-JkjiqKw-LEpOw6Ed9LK4walxWUAqPGcT4_Uys3TH9XVex9_rEmigHXiJY3_Lwi6mTSkW10-zen5UXxqnyHpMxlmumohT96OyLyhEPeaaq8FrTYMCX8TiMOst3jF5QCNP-LFz21yeUEAr5_3-FKV2mjWEU9iW0dOOVTII2rlD0WtCkqkDwZtakQ1ynGdW1E","e":"AQAB"};

function commentId(id) { return "comment-" + id; }

function $commentForm(hideForm, comment) {
    var $previewDiv = $('<div/>');
    var $authorEmailEncrypted = $('<input type="hidden" name="authorEmailEncrypted">');
    var $authorEmailMD5 = $('<input type="hidden" name="authorEmailMD5">');
    var $email = $('<input type="email" name="email" class="form-control" placeholder="Email">');
    var $name = $('<input type="text" name="authorName" class="form-control" placeholder="Name">');
    var $url = $('<input type="url" name="authorUri" class="form-control" placeholder="Url">');
    var $message = $('<textarea name="message" class="form-control" placeholder="Message"/></textarea>');
    autosize($message);
    var $replyTo = $('<input type="hidden" name="replyTo">').val("");
    var $recaptcha = $('<div class="g-recaptcha" data-sitekey="6LfSaV8UAAAAAEFq-7HeUDiSQCkCtLtO_yc_SOi_"></div>');
    var $buttonBar = $('<div class="comment-form-buttonbar"/>').append($('<button type="submit" class="btn btn-primary pull-right">Submit</button>'), $recaptcha);
    var $form = $('<form method="POST" action="https://blogcomments.azurewebsites.net/api/Function1"/>')
        .append($('<input type="hidden" name="postId">').val(postId))
        .append($('<input type="hidden" name="postUri">').val(location.href.replace(/#.*/, '')))
        .append($replyTo)
        .append($authorEmailEncrypted)
        .append($authorEmailMD5)
        .append($('<div class="form-group"><label>Name (optional)</label></div>').append($name))
        .append($('<div class="form-group"><label>Email (optional; always encrypted, never shared)</label></div>').append($email))
        .append($('<div class="form-group"><label>Url (optional; must start with "http://" or "https://")</label></div>').append($url))
        .append($('<div class="form-group"><label>Message (supports some Markdown/HTML)</label></div>').append($message));
    if (comment) {
        $replyTo.val(comment._id);
    }
    const serialize_form = form => JSON.stringify(
        Array.from(new FormData(form).entries())
            .reduce((m, [ key, value ]) => Object.assign(m, { [key]: value }), {})
    );
    $form.submit(function (e) {
        e.preventDefault();
        hideForm();
        var postAction = $form.attr('action');
        var postBody = serialize_form($form.get(0));
        console.log(postBody);
        var retries = 5;

        function postIt() {
            var post = $.post(postAction, postBody, "json");
            post.done(function () {
                alert("Comment successfully posted. It should appear on this page in a minute or so.");
            });
            post.error(function () {
                var message = "Failed to post comment";
                if (post.responseText)
                    message += ": " + post.responseText;
                
                if (--retries > 0) {
                    console.log(message);
                    postIt();
                } else {
                    alert(message);
                }
            });
        }

        postIt();
    });

    function createComment() {
        return normalizeComment({
            date: moment().format(),
            _id: "_",
            replyTo: comment ? comment._id : undefined,
            authorName: $name.val(),
            authorEmailMD5: $authorEmailMD5.val(),
            authorUri: $url.val(),
            message: $message.val()
        });
    };

    function recreatePreview() {
        var email = $email.val();
        if (email && email.indexOf("@") !== -1) {
            var data = new TextEncoder().encode($email.val());
            window.crypto.subtle.importKey("jwk", jwk, { name: "RSA-OAEP", hash: { name: "SHA-1" } }, false, ["encrypt"]).then(function (encryptionKey) {
                return window.crypto.subtle.encrypt({ name: "RSA-OAEP" }, encryptionKey, data)
                    .then(function (encrypted) {
                        var array = new Uint8Array(encrypted);
                        var text = base64js.fromByteArray(array);
                        $authorEmailEncrypted.val(text);
                        return text;
                    });
            });
            $authorEmailMD5.val(md5($email.val().replace(/^ +| +$/g, '').toLowerCase()));
        } else {
            $authorEmailMD5.val("");
            $authorEmailEncrypted.val("");
        }

        var $newPreview = $comment(false, createComment());
        // Turn off permalink and anchor
        var $anchor = $newPreview.find('.comment-date a');
        $anchor.replaceWith($('<span/>').text($anchor.text()));
        $newPreview.find('.comment-anchor').remove();
        $previewDiv.empty();
        $previewDiv.append($newPreview);
    };

    recreatePreview();
    $name.on('change keyup input paste', recreatePreview);
    $email.on('change keyup input paste', recreatePreview);
    $url.on('change keyup input paste', recreatePreview);
    $message.on('change keyup input paste', recreatePreview);

    $form.append($('<h3>Preview:</h3>'), $previewDiv, $buttonBar);
    return {
        $form: $('<div class="comment-form"/>').append($form),
        onShow: function() { grecaptcha.render($recaptcha[0]); }
    };
}

function $replyButton(comment) {
    var $button;
    if (comment)
        $button = $('<button class="btn btn-primary comment-reply"><i class="fa fa-reply"></i> Reply</button>');
    else
        $button = $('<button class="btn btn-primary comment-new"><i class="fa fa-plus-square"></i> New Comment</button>');
    return $button;
}

var now = moment();
function $comment(includeForm, comment) {
    var message = sanitizeHtml(markdownConverter.makeHtml(comment.message), sanitizeOptions);
    var $commentDiv = $('<div class="comment"/>');
    var publicationDate = moment(comment.date);
    var $author = $('<div class="comment-author"/>').append($('<span class="comment-author-name"/>').text(comment.authorName));
    if (comment.authorUri !== "")
        $author.append($('<span> • </span>'), $('<a class="comment-author-uri" rel="nofollow noopener ugc"/>').attr('href', comment.authorUri).text(comment.authorUri));
    var $headerDiv = $('<div class="comment-header"/>').append(
        $('<div class="comment-author-profile" style="float:left;"/>').append($('<img class="comment-author-profile-image" src="' + avatarUri(comment.authorEmailMD5) + '"/>')),
        $author,
        $('<div class="comment-date" />').append(
            $('<a/>').attr('href', '#' + commentId(comment._id)).attr('title', 'permalink').text(publicationDate.from(now) + ' (' + publicationDate.format('YYYY-MM-DD hh:mm:ss a') + ')')
        )
    );
    if (comment.replyTo !== "") {
        var parent = comments.filter(function (x) { return x._id === comment.replyTo })[0];
        $headerDiv.append($('<div/>').append($('<a/>').attr('href', '#' + commentId(comment.replyTo)).text('In reply to ' + parent.authorName)));
    }

    $commentDiv.append($('<div class="comment-anchor"/>').attr('id', commentId(comment._id)),
        $headerDiv,
        $('<div class="comment-message" style="clear:both;"/>').html(message)
    );

    var $commentContainer = $('<div class="comment-container"/>').append($commentDiv);
    if (includeForm)
        $commentContainer.append($expandCollapseForm(comment));
    var childComments = filterComments(comment._id);
    for (var i = 0; i != childComments.length; ++i) {
        var child = childComments[i];
        $commentContainer.append($comment(includeForm, child));
    }

    return $commentContainer;
}

function normalizeComment(x) {
    var uri = x.authorUri;
    if (!uri || (!uri.startsWith("http://") && !uri.startsWith("https://")))
        uri = "";
    return {
            _id: x._id,
            authorName: x.authorName || "Anonymous",
            authorEmailMD5: x.authorEmailMD5 || "",
            authorUri: uri,
            message: x.message || "",
            replyTo: x.replyTo || "",
            date: x.date,
            timestamp: moment(x.date).valueOf()
    };
}

function $expandCollapseForm(comment) {
    var $button = $replyButton(comment);
    var formObj = $commentForm(hideForm, comment);
    var $form = formObj.$form.addClass("comment-hidden");
    var onShow = formObj.onShow;
    function showForm() {
        $button.addClass("comment-hidden");
        if (onShow) {
            onShow();
            onShow = null;
        }
        $form.removeClass("comment-hidden");
    }
    function hideForm() {
        $form.addClass("comment-hidden");
        $button.removeClass("comment-hidden");
    }
    $button.click(showForm);
    return $('<div/>').append($button, $form);
}

function recaptchaLoaded() {
    var req = new XMLHttpRequest();
    req.addEventListener("load", function () {
        var $commentDiv = $('#comments');
        if (req.status === 404 || req.status === 200) {
            if (req.status === 404) {
                comments = [];
            } else {
                comments = JSON.parse(req.responseText).map(normalizeComment);
            }
            var commentCounter = document.getElementById('comment-counter');
            commentCounter.innerText = comments.length + " " + commentCounter.innerText;
            var toplevelComments = filterComments("");
            for (var i = 0; i != toplevelComments.length; ++i) {
                var comment = toplevelComments[i];
                $commentDiv.append($comment(true, comment));
            }
            if (comments.length !== 0) {
                $commentDiv.append($expandCollapseForm());
            }
        }
        $commentDiv.prepend($expandCollapseForm());
    });
    req.open('GET', "https://comments.stephencleary.com/" + postId + ".json");
    req.send();
}
</script>

<script src="https://www.google.com/recaptcha/api.js?onload=recaptchaLoaded&amp;render=explicit"></script>



<!-- Google AdSense -->
<script src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- Moment -->
<script type="text/javascript">
    (function($) {
        $(function () {
            $('time').each(function (_, e) {
                var startOfToday = moment().startOf('day');
                var publicationDate = moment($(e).attr('datetime'), 'YYYY-MM-DD');
                var difference = startOfToday.diff(publicationDate, 'days');
                var text = difference === 0 ? 'Today' :
                    difference === 1 ? 'Yesterday' :
                    publicationDate.from(startOfToday);
                $(e).text(function(_, oldText) { return text + ' (' + oldText + ')'; });
            });
        });
    })(window.jQuery);
</script>




</body>
</html>