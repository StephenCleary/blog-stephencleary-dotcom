<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Threadsafe Events</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Disclaimer: This blog entry only deals with the common case of instance events; static events are ignored. Furthermore, the contents of this blog entry are 100% my own opinion. However, it is the opinion of someone who has specialized in multithreading for 13 years." />
    <link rel="canonical" href="https://blog.stephencleary.com/2009/06/threadsafe-events.html" />
    
    <link rel="alternate" type="application/rss+xml" title="Stephen Cleary (the blog)" href="http://feeds.feedburner.com/NitoPrograms" />
    
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/bootswatch/3.2.0/spacelab/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" />
    <style type="text/css">/* Layout Styles */
/* ----------------------------------------------------------*/

body {
    padding-top: 50px;
}

.affix {
    top: 70px;
    bottom: 0;
    overflow-y: auto;
}

.navbar-brand {
    font-weight: bold;
}

.navbar-brand-container.active>a, .navbar-brand-container.active>a:hover, .navbar-brand-container.active>a:focus {
    color: #3399f3;
    background-color: transparent;
}

.sidebar {
    margin-top: 20px;
}

.sidenavitem {
    height: auto;
}

.sidebar img {
    /* Responsive images */
    display: inline-block;
    height: auto;
    max-width: 100%;
}

@media(max-width:767px) {
    .affix {
        position: static;
    }
}

div .vertical-margins {
    margin-top: 10px;
    margin-bottom: 10px;
}

.page-header {
    margin-top: 20px;
}

.center {
    text-align: center;
}

.project-icon {
    height: 128px;
    width: 128px;
}

.list-group-item h2 {
    margin-top: 10px;
}

/* Fixes for Google Custom Search in a Bootstrap page */
/* ----------------------------------------------------------*/
.google, .google *, .google *:before, .google *:after {
    -webkit-box-sizing: content-box;
    -moz-box-sizing: content-box;
    box-sizing: content-box;
}

.google table {
    border-collapse: separate;
}

.gsc-input-box {
    height: auto !important;
}

/* Fixes for Amazon widget in Bootstrap page */
.amzn_wdgt * {
    -webkit-box-sizing: content-box;
    -moz-box-sizing: content-box;
    box-sizing: content-box;
}

/* Post styles */
/* ----------------------------------------------------------*/

code {
    background-color: #F2F3F9;
    color: inherit;
}

.post img {
    /* Responsive images */
    display: inline-block;
    height: auto;
    max-width: 100%;
}

.post .table {
    table-layout: fixed;
}

.post .table code {
    white-space: normal;
}

.post .yes {
    color: #008000;
}

.post .no {
    color: #FF0000;
}

/* Syntax highlighting styles */
/* ----------------------------------------------------------*/

.highlight  { background: #ffffff; }
.highlight .c { color: #008000 } /* Comment */
.highlight .k { color: #0000ff } /* Keyword */
.highlight .cm { color: #008000 } /* Comment.Multiline */
.highlight .cp { color: #0000ff } /* Comment.Preproc */
.highlight .c1 { color: #008000 } /* Comment.Single */
.highlight .cs { color: #008000 } /* Comment.Special */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gh { font-weight: bold } /* Generic.Heading */
.highlight .gp { font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { font-weight: bold } /* Generic.Subheading */
.highlight .kc { color: #0000ff } /* Keyword.Constant */
.highlight .kd { color: #0000ff } /* Keyword.Declaration */
.highlight .kn { color: #0000ff } /* Keyword.Namespace */
.highlight .kp { color: #0000ff } /* Keyword.Pseudo */
.highlight .kr { color: #0000ff } /* Keyword.Reserved */
.highlight .kt { color: #2b91af } /* Keyword.Type */
.highlight .s { color: #a31515 } /* Literal.String */
.highlight .nc { color: #2b91af } /* Name.Class */
.highlight .ow { color: #0000ff } /* Operator.Word */
.highlight .sb { color: #a31515 } /* Literal.String.Backtick */
.highlight .sc { color: #a31515 } /* Literal.String.Char */
.highlight .sd { color: #a31515 } /* Literal.String.Doc */
.highlight .s2 { color: #a31515 } /* Literal.String.Double */
.highlight .se { color: #a31515 } /* Literal.String.Escape */
.highlight .sh { color: #a31515 } /* Literal.String.Heredoc */
.highlight .si { color: #a31515 } /* Literal.String.Interpol */
.highlight .sx { color: #a31515 } /* Literal.String.Other */
.highlight .sr { color: #a31515 } /* Literal.String.Regex */
.highlight .s1 { color: #a31515 } /* Literal.String.Single */
.highlight .ss { color: #a31515 } /* Literal.String.Symbol */

/* Comments */
/* ----------------------------------------------------------*/

.comment-container {
    margin-top: 1em;
}

.comment-container > .comment-container {
    margin-left: 2em;
}

.comment-container > .comment-container > .comment-container > .comment-container > .comment-container {
    margin-left: 0;
}

/* Correct anchor links in comments (they are offset by the height of the fixed header) */
.comment-anchor {
    display: block;
    position: relative;
    top: -60px;
    visibility: hidden;
}

img.comment-author-profile-image {
    height: 80px;
    width: 80px;
    margin-right: 10px;
}

.comment-message {
    overflow-x: auto;
}

.comment-form {
    border: 1px solid black;
    padding: 1em;
}

.comment-new {
    margin-top: 1em;
    margin-bottom: 1em;
}

.comment-new, .comment-reply {
    margin-left: 1em;
}

.comment-hidden {
    display: none;
}

.comment-form-buttonbar {
    margin-top: 1em;
}
</style>
    
    <meta name="application-name" content="Stephen Cleary" />
    <link rel="search" type="application/opensearchdescription+xml" href="https://stephencleary.com/opensearch.xml" title="Cleary Search">
    <link rel="apple-touch-icon" sizes="57x57" href="https://stephencleary.com/icons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="https://stephencleary.com/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://stephencleary.com/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://stephencleary.com/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="https://stephencleary.com/icons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="https://stephencleary.com/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="https://stephencleary.com/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://stephencleary.com/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" href="https://stephencleary.com/icons/apple-touch-icon.png"/>
    <link rel="apple-touch-icon-precomposed" href="https://stephencleary.com/icons/apple-touch-icon-precomposed.png"/>
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-196x196.png" sizes="196x196">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-32x32.png" sizes="32x32">
    
    <meta name="google-site-verification" content="L8q0fpGSwpNSD0OGFI07hyMujSpORrV4tAaNx_Js7oQ" />
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <div class="navbar-brand-container"><a class="navbar-brand" href="https://stephencleary.com">Stephen Cleary</a></div>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
            <li  class="active"  ><a href="https://blog.stephencleary.com">Blog</a></li>
            <li ><a href="https://stephencleary.com/videos/">Videos</a></li>
            <li  ><a href="https://stephencleary.com/projects/">Projects</a></li>
            <li  ><a href="https://stephencleary.com/publications/">Publications</a></li>
            <li  ><a href="https://stephencleary.com/book/">Book</a></li>
            <li  ><a href="https://stephencleary.com/contact/">Contact</a></li>
            <li><a href="http://feeds.feedburner.com/NitoPrograms"><i class="fa fa-rss-square fa-lg"></i></a></li>
            <li  ><a href="https://stephencleary.com/search/"><i class="fa fa-search"></i></a></li>
        </ul>
    </div>
</nav>

    <div class="container-fluid">
        <div class="col-sm-8 col-sm-offset-2 col-md-6 col-md-offset-3">
            <div class="post">

  <header>
      <div class="page-header">
          <h1>Threadsafe Events</h1>
          <small><time datetime="2009-06-19">Jun 19, 2009</time> &bull; <a id="comment-counter" href="#comments">Comments</a></small>
      </div>
  </header>

  <header>
    <div class="alert alert-info" markdown="1">
        <i class="fa fa-hand-o-right fa-2x pull-left"></i>
        
        <div>Has this blog been helpful? Please consider <a href="https://github.com/sponsors/StephenCleary" class="alert-link">supporting this blog (and my open-source libraries).</a> Thanks!</div>
        <div><i>For a limited time, GitHub will match your support.</i></div>
    </div>
  </header>

  <article>
  <p>Disclaimer: <em>This blog entry only deals with the common case of instance events; static events are ignored. Furthermore, the contents of this blog entry are 100% my own opinion. However, it is the opinion of someone who has specialized in multithreading for 13 years.</em></p>

<p>When writing components in a multithreaded world, one question that commonly crops up is, “how do I make my events threadsafe?” The asker is usually concerned with threadsafe subscription and unsubscription, but threadsafe raising must also be taken into consideration.</p>

<h2 id="the-wrong-solution-1-from-the-c-language-specification">The Wrong Solution #1, from the C# Language Specification</h2>

<p>The C# language authors attempted to make event subscription and unsubscription threadsafe by default. To do so, they allow (but do not require) locking on <code>this</code>, which is generally considered bad. This code:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">event</span> <span class="n">MyEventHandler</span> <span class="n">MyEvent</span><span class="p">;</span></code></pre></figure>

<p>Logically becomes this code:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="n">MyEventHandler</span> <span class="n">__MyEvent</span><span class="p">;</span>
<span class="k">public</span> <span class="k">event</span> <span class="n">MyEventHandler</span> <span class="n">MyEvent</span>
<span class="p">{</span>
    <span class="k">add</span>
    <span class="p">{</span>
        <span class="k">lock</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">__MyEvent</span> <span class="p">+=</span> <span class="k">value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">remove</span>
    <span class="p">{</span>
        <span class="k">lock</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">__MyEvent</span> <span class="p">-=</span> <span class="k">value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Chris Burrows, a Microsoft developer on the C# compiler team, explains why this is bad in his blog post <a href="http://blogs.msdn.com/cburrows/archive/2008/02/18/field-like-events-considered-harmful.aspx">Field-like Events Considered Harmful</a>. His blog post covers the reasoning thoroughly, so it won’t be repeated here.</p>

<div class="alert alert-info">
  <p><i class="fa fa-hand-o-right fa-2x pull-left"></i></p>

  <p><strong>Minor rant:</strong> The Java language fell into the same trap; see <a href="http://wiki.apidesign.org/wiki/Java_Monitor" class="alert-link">Practical API Design’s Java Monitor page</a>. Why is it that some language designers believe they can declaratively solve multithreading problems? If the solution was really as simple as that, then why haven’t other people already figured it out? Multithreaded programming has consumed some of the brightest minds for decades, and it’s <em>hard</em>. Language designers can’t make multithreading complexities go away by sprinkling some magical fairy powder, even if they name the powder <code>MethodImplOptions.Synchronized</code>. In fact, most of the time they’re just making it worse.</p>
</div>

<p>Pretend for a minute that locking on <code>this</code> is OK. It actually <em>would</em> work, after all; it just raises the likelihood of unexpected deadlocks. It’s also possible that a future C# compiler may lock on a super-secret private field instead of <code>this</code>. However, even if the <em>implementation</em> is OK, the <em>design</em> is still flawed. The problem becomes clear when one ponders how to raise the event in a threadsafe manner.</p>

<p>This is the standard, simple, and logical event-raising code:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">MyEvent</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">MyEvent</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>If there are multiple threads subscribing to and unsubscribing from an event, then the built-in field-like event locking works <em>only</em> for subscribing and unsubscribing. The event raising code exposes a problem: if another thread unsubscribes from the event after the <code>if</code> statement but before the event is raised, then this code may result in a NullReferenceException!</p>

<p>So, it turns out that “thread-safe” events weren’t really thread-safe. Moving on…</p>

<h2 id="the-wrong-solution-2-from-the-framework-design-guidelines-and-msdn">The Wrong Solution #2, from the Framework Design Guidelines and MSDN</h2>

<p>One solution to the problem described above is to make a copy of the event delegate before testing it. The event raising code becomes:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">MyEventHandler</span> <span class="n">myEvent</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">MyEvent</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">myEvent</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">myEvent</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>This is the solution used by <a href="http://msdn.microsoft.com/en-us/library/w369ty8x.aspx">MSDN examples</a> and recommended by the semi-standard <a href="http://www.amazon.com/gp/product/0321545613?ie=UTF8&amp;tag=stepheclearys-20&amp;linkCode=as2&amp;camp=1789&amp;creative=390957&amp;creativeASIN=0321545613">Framework Design Guidelines</a> (my 2nd edition has it on page 157, but the relevant section of the book is available online <a href="http://blogs.msdn.com/brada/archive/2005/01/14/353132.aspx">here</a>).</p>

<p>This solution is simple, obvious, and wrong. [By the way, I’m not dissing Framework Design Guidelines. They have lots of good advice, and I don’t mean to be critical of the book in general. They’re just mistaken in this particular recommendataion.]</p>

<p>Programmers without a strong background in multithreaded programming may not immediately detect why this solution is wrong. Delegates are immutable reference types, so the local variable copy is atomic; no problem there. The problem exists in the memory model: it is possible that an out-of-date value for the delegate field is held in one processor’s cache. Without going into a painful level of detail, in order to ensure that one is reading the current value of a non-volatile field, one must either issue a memory barrier or wrap the copy operation within a lock (and it must be the same lock acquired by the event add/remove methods).</p>

<p>In short, this solution does prevent the NullReferenceException race condition; but it introduces <em>another</em> race condition in its place (raising an unsubscribed event handler).</p>

<h2 id="the-wrong-solution-3-from-jon-skeet">The Wrong Solution #3, from Jon Skeet</h2>

<p>[OK, let me say this first: Jon Skeet is an awesome programmer. I highly recommend his book <a href="http://www.amazon.com/gp/product/1933988363?ie=UTF8&amp;tag=stepheclearys-20&amp;linkCode=as2&amp;camp=1789&amp;creative=390957&amp;creativeASIN=1933988363">C# in Depth</a> to <em>anyone and everyone using C#</em> (I own the first edition and will buy the 2nd as soon as it comes out; he’s writing it now and I’m so excited!). I follow his blog. I highly respect the man, and I can’t believe my first mention of him on my blog is in a negative light… However, he did come up with a wrong solution for thread-safe events. To give him credit, though, he ended his paper recommending the right solution!]</p>

<p>Jon Skeet has a great treatment of this subject in his paper <a href="http://www.yoda.arachsys.com/csharp/events.html">Delegates and Events</a> (you may wish to skip to the section titled “Thread-safe events”). He covers everything that I’ve described above, but then proceeds on to propose another wrong solution. He dislikes the memory barrier solution (as do I), and attempts to solve it by wrapping the copy operation within the lock. As Jon points out, the event add/remove methods <em>may</em> lock <code>this</code> or they could lock something else (remember, a future C# compiler may choose to lock on a super-secret private field instead). So, the default add/remove methods have to be replaced with ones that perform an explicit lock, as such:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="kt">object</span> <span class="n">myEventLock</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">();</span>
<span class="k">private</span> <span class="n">MyEventHandler</span> <span class="n">myEvent</span><span class="p">;</span>
<span class="k">public</span> <span class="n">MyEventHandler</span> <span class="n">MyEvent</span>
<span class="p">{</span>
    <span class="k">add</span>
    <span class="p">{</span>
        <span class="k">lock</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">myEventLock</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">myEvent</span> <span class="p">+=</span> <span class="k">value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">remove</span>
    <span class="p">{</span>
        <span class="k">lock</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">myEventLock</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">myEvent</span> <span class="p">-=</span> <span class="k">value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">virtual</span> <span class="nf">OnMyEvent</span><span class="p">(</span><span class="n">MyEventArgs</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">MyEventHandler</span> <span class="n">localMyEvent</span><span class="p">;</span>
    <span class="k">lock</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">myEventLock</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">localMyEvent</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">myEvent</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">localMyEvent</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">localMyEvent</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>That’s a fair amount of code for a single event! Some people have even written helper objects to reduce the amount of code. Before jumping on that bandwagon, though, remember that this solution is also wrong.</p>

<p>There is <em>still</em> a race condition.</p>

<p>Specifically, it is possible that the value of <code>myEvent</code> is modified after it has been read into <code>localMyEvent</code> but before it is raised. This can result in an unsubscribed handler being invoked, which could be problematic. So, this solution does solve the last solution’s problem (with the memory model and processor cache), but it turns out there was an underlying race condition anyway (this same problem does affect the other two solutions above, too).</p>

<h2 id="the-wrong-solution-4-from-nobody-but-just-in-case-you-were-thinking-about-it">The Wrong Solution #4, from Nobody (but just in case you were thinking about it!)</h2>

<p>A natural response is to extend the <code>lock</code> statement in Jon’s code to include raising the event. That does prevent the race condition problem from all the solutions described above, but it introduces a more serious problem.</p>

<p>If this solution is used, then an event handler cannot wait on another thread that is attempting to subscribe or unsubscribe a handler to the same event. In other words, it’s the original “unexpected deadlock” story (the same reason why locking on <code>this</code> is bad). Jon does make a note of this in <a href="http://www.yoda.arachsys.com/csharp/events.html">Delegates and Events</a>.</p>

<p>To my knowledge, no one has proposed this as a solution. In general, the community seems to favor solutions that fail “loudly” (with exceptions) instead of failing “silently” (with a deadlock).</p>

<h2 id="why-all-solutions-are-wrong-by-stephen-cleary-thats-me">Why All Solutions are Wrong, by Stephen Cleary (that’s me!)</h2>

<p>“Callbacks” (usually events in C#) have always been problematic for multithreaded programming. This is because a good rule of thumb for component design is: <strong>Do your best to allow the event handler to do <em>anything.</em></strong> Since “communicate with another thread that is attempting to take any lock” is one example of “anything”, a natural corollary of this rule is: <strong>Never hold locks during callbacks.</strong></p>

<p>This is the reasoning behind why locking on exposed objects (such as <code>this</code>) is considered bad practice (see <a href="http://msdn.microsoft.com/en-us/library/c5kehkcz.aspx">MSDN: lock Statement</a>). Holding that lock while raising an event (such as solution 4 does) makes the bad practice even worse.</p>

<p>To review, all the solutions above fail in one of two situations.</p>

<p>Solutions 1-3 above all fail the same use case:</p>

<ul>
  <li>Thread A will raise the event.</li>
  <li>Thread B subscribes a handler to the event. The handler code depends on a resource.</li>
  <li>Thread A begins to raise the event. Immediately before the delegate is invoked, Thread A is preempted by Thread B.</li>
  <li>Thread B no longer needs the event notification, so it unsubscribes the handler from the event and disposes of the resource.</li>
  <li>Thread A proceeds to raise the event (that has been unsubscribed). The handler code depends on a resource that has now been disposed.</li>
</ul>

<p>Solution 4 fails this use case:</p>

<ul>
  <li>Thread A will raise the event.</li>
  <li>Thread B subscribes a handler to the event. The handler code communicates with Thread C.</li>
  <li>Thread A begins to raise the event. Immediately before the delegate is invoked, Thread A is preempted by Thread C.</li>
  <li>Thread C subscribes a handler to the event. Thread C blocks.</li>
  <li>Thread A proceeds to raise the event. The handler code cannot communicate with Thread C because it is blocked.</li>
</ul>

<p>A general-purpose “thread-safe event” solution does not exist - at least, not using the synchronization primitives we currently have at our disposal. The implementation <em>must</em> either have a race condition or deadlock possibility. A lock can prevent contention (solving the race condition), but only if it is held during the raising of the event (possibly causing deadlock). Alternatively, an unadorned raised event does not have the possibility of a deadlock, but loses the guarantees of the lock (causing a race condition).</p>

<p>A <em>general-purpose</em> solution does not exist, but it <em>is</em> possible to solve the problem for a specific event by imposing special requirements on the user. Some of the solutions above may work if one places restrictions on the event handlers.</p>

<p>Solution 3 (and solution 2 in Microsoft’s current implementations) works if the event handler is coded to handle the situation where it is invoked after it has unsubscribed from the event. It is not difficult to write a handler this way; <a href="/2009/04/asynchronous-callback-contexts.html">asynchronous callback contexts</a> would help with the implementation. The drawback is that each event handler must include multithread-awareness code, which complicates the method.</p>

<p>Solution 4 may also be made to work if the event handler does not block on a thread that subscribes to or unsubscribes from that same event. For simplicity, APIs that take this route often just state that event handlers may not block. The drawback is that this can be difficult to guarantee, since many objects hide their locking logic from their callers.</p>

<h2 id="conclusion">Conclusion</h2>

<p>A general-purpose solution does not exist, and all other solutions have serious drawbacks (placing severe restrictions on the actions available to the event handler).</p>

<p>For this reason, I recommend the same approach that Jon Skeet ends up recommending at the end of <a href="http://www.yoda.arachsys.com/csharp/events.html">Delegates and Events</a>: “don’t do that”, i.e., don’t use events in a multithreaded fashion. If an event exists on an object, then only one thread should be able to subscribe to or unsubscribe from that event, and it’s the same thread that will raise the event.</p>

<p>One nice side effect of this approach is that the code becomes much simpler:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">event</span> <span class="n">MyEventHandler</span> <span class="n">MyEvent</span><span class="p">;</span>

<span class="k">protected</span> <span class="k">virtual</span> <span class="nf">OnMyEvent</span><span class="p">(</span><span class="n">MyEventArgs</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">MyEvent</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">MyEvent</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Efficiency freaks can go one step further and explicitly implement the backing field, add handler, and remove handler. By removing the default locking (which is useless), the code is more explicit but also more efficient:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="n">MyEventHandler</span> <span class="n">myEvent</span><span class="p">;</span>
<span class="k">public</span> <span class="k">event</span> <span class="n">MyEventHandler</span> <span class="n">MyEvent</span>
<span class="p">{</span>
    <span class="k">add</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">myEvent</span> <span class="p">+=</span> <span class="k">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">remove</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">myEvent</span> <span class="p">-=</span> <span class="k">value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">virtual</span> <span class="nf">OnMyEvent</span><span class="p">(</span><span class="n">MyEventArgs</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">myEvent</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">myEvent</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Another side effect is that this type of event handling forces one towards <a href="http://msdn.microsoft.com/en-us/library/hkasytyf.aspx">Event-Based Asynchronous Programming</a> (or something very similar to it). EBAP is a logical conclusion for asynchronous object design, yielding maximal reusability. EBAP is also more consistent with regards to normal object concurrency restrictions: “Public static members of this type are thread safe. Any instance members are not guaranteed to be thread safe.” Events that can only be accessed by one thread follow this common pattern; the event, as an instance member, is not guaranteed to be thread safe.</p>

<p>A third side effect takes longer to realize: more correct communication among threads. Instead of various threads directly subscribing to events (which would be run on another thread anyway), one must implement some form of thread communication. This forces the programmer to more clearly state the requirements from each thread’s perspective, and this in turn results in less buggy multithreading code. Usually, more appropriate ways for thread communciation are found. The event subscription model is naturally discarded as a thread communication method (due to its inherent unsuitability) in favor of much more proven design patterns. This will eventually result in more correct multithreading code, though the process requires a minor redesign.</p>

<h2 id="a-final-note">A Final Note</h2>

<p>As of this writing, it is still popular to promote solution 2 (copy the delegate before raising the event). However, I strongly discourage this practice; it makes the code more obscure, and provides a false sense of security because it <em>does not solve the problem!</em> It is far better to simply not have “thread-safe events”.</p>


  </article>
    
    <footer class="hidden-print">
        
        
        <ul class="pager">
            <li class="previous"><a href="/2009/06/using-socket-as-connected-socket.html" title="Using Socket as a Connected Socket">&larr; Previous Post</a></li>
            <li class="next"><a href="/2009/06/application-protocol-specifications.html" title="Application Protocol Specifications">Next Post &rarr;</a></li>
        </ul>

        <div id="comments"></div>
    </footer>
</div>
        </div>
        <div class="col-sm-2 col-md-3 col-md-offset-0 col-lg-2 col-lg-offset-1 affix hidden-print" data-spy="affix" role="navigation">
            
            
        </div>
        <div class="col-sm-2 sidebar hidden-print">
            <div class="panel panel-default">
                <div class="panel-heading">About Stephen Cleary</div>
                <div class="panel-body">
                    <div class="center"><img src="https://stephencleary.com/www.assets/Me-large.jpg"/></div>
                    <div class="center vertical-margins">Stephen Cleary is a <a href="https://stephencleary.com/god/">Christian</a>, husband, father, and programmer living in Northern Michigan.</div>
                    <div class="center"><a href="http://mvp.microsoft.com/en-us/mvp/Stephen%20Cleary-5000058"><img class="mvp-logo" src="https://stephencleary.com/www.assets/MVP.png"/></a></div>
                </div>
            </div>
            <div class="panel panel-primary">
                <div class="panel-heading">My book</div>
                <div class="panel-body center">
                    <div><a href="https://stephencleary.com/book/"><img src="https://stephencleary.com/www.assets/Book-2nd-small.jpg"/></a></div>
                    <div>Available from <a href="http://www.jdoqocy.com/click-7489747-11290546?url=http%3A%2F%2Fshop.oreilly.com%2Fproduct%2F0636920266624.do%3Fcmp%3Daf-code-books-video-product_cj_0636920266624_%25zp&cjsku=0636920266624">O'Reilly (Safari)</a>, <a href="https://amzn.to/2kYzcEY">Amazon (print/Kindle)</a>, or <a href="http://www.tkqlhce.com/click-7489733-13660345?url=https%3A%2F%2Fwww.ebooks.com%2Fcj.asp%3FIID%3D209766469&cjsku=209766469">eBooks.com (PDF/epub)</a>.</div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Advertisement</div>
                <div><a href="https://brave.com/ste083">Don't like ads? Browse privately and ad-free with Brave!</a></div>
                <div class="panel-body">
                    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2749292939902134" data-ad-slot="7584809820" data-ad-format="auto"></ins>
                </div>
            </div>
            
            <div class="panel panel-primary">
                <div class="panel-heading">Popular Posts</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2012/02/async-and-await.html">Async/await Intro</a></li>
                        <li><a href="/2013/11/there-is-no-thread.html">There Is No Thread</a></li>
                        <li><a href="/2012/07/dont-block-on-async-code.html">Don't Block on Async Code</a></li>
                    </ul>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Series</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2016/02/react-redux-todomvc.html">React/Redux TodoMVC</a></li>
                        <li><a href="/2014/04/a-tour-of-task-part-0-overview.html">A Tour of Task</a></li>
                        <li><a href="/2013/10/taskrun-etiquette-and-proper-usage.html">Task.Run Etiquette</a></li>
                        <li><a href="/2013/05/taskrun-vs-backgroundworker-intro.html">Task.Run vs. BackgroundWorker</a></li>
                        <li><a href="/2013/01/async-oop-0-introduction.html">Async OOP</a></li>
                        <li><a href="/2009/04/tcpip-net-sockets-faq.html">TCP/IP .NET Sockets FAQ</a></li>
                        <li><a href="/2013/10/managed-services-roundup.html">Managed Services</a></li>
                        <li><a href="/2009/08/how-to-implement-idisposable-and.html">IDisposable and Finalizers</a></li>
                        <li><a href="/2011/02/option-parsing-introduction.html">Option Parsing</a></li>
                    </ul>
                </div>
            </div>
            
        </div>
    </div>

    <div class="google">
        <gcse:searchresults></gcse:searchresults>
    </div>
    
    <!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
<script type="text/javascript">window.jQuery || document.write('<script src="/lib/jquery-2.1.1.min.js"><\/script>')</script>

<!-- Bootstrap -->
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script type="text/javascript">window.jQuery.fn.modal || document.write('<script src="/lib/bootstrap.min.js"><\/script>')</script>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('body').css('color') !== 'rgb(102, 102, 102)') {
                $('head').prepend('<link rel="stylesheet" href="/lib/bootstrap.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Font Awesome -->
<span id="facheck" class="fa" style="display:none"></span>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('#facheck').css('fontFamily') !== 'FontAwesome') {
                $('head').prepend('<link rel="stylesheet" href="/lib/font-awesome.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Scroll the sidebar into view (if necessary) -->


<!-- Moment -->
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.6.0/moment.min.js"></script>
<script type="text/javascript">window.moment || document.write('<script src="/lib/moment.min.js"><\/script>')</script>

<!-- Google analytics -->
<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-8910661-5', 'stephencleary.com');
    ga('send', 'pageview');
</script>

<!-- Show appropriate elements based on time -->
<script type="text/javascript">
    (function ($) {
        $(function () {
            var targets = $('[data-hide-after]');
            targets.each(function () {
                var $item = $(this);
                if (moment() < moment($item.attr('data-hide-after'))) {
                    $item.removeClass('hidden');
                }
            });
        });
    })(window.jQuery);
</script>








<script src="/lib/uuid-v3-3.2.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/showdown@1.8.6/dist/showdown.min.js" integrity="sha256-dwhppIrxD8qC6lNulndZgtIm4XBU9zoMd9OUoXzIDAE=" crossorigin="anonymous"></script>
<script src="/lib/sanitize-html-1.18.2.min.js"></script>
<script src="/lib/autosize.min.js"></script>
<script src="/lib/base64js.min.js"></script>
<script src="/lib/md5.min.js"></script>

<script type="text/javascript">

var pageUrl = "https://blog.stephencleary.com" + "/2009/06/threadsafe-events.html";

// (unnecessary) 1) If the URL starts with http://, replace with https://

// 2) Take the URL path (not including scheme and domain).
var url = document.createElement('a');
url.href = pageUrl; //'https://developer.mozilla.org:8080/en-US/search?q=URL#search-results-close-container';
var path = url.pathname;

// 3) Path: If the path ends with .html or any two- to six-character [A-Za-z0-9] extension, strip it.
if (path.endsWith(".html"))
    path = path.substr(0, path.length - 5);
else
    path = path.replace(/\.[A-Za-z0-9]{2,6}$/, "");

// 4) Path: For each UTF-16 code unit, if it's not in the whitelist [A-Za-z0-9-_;.~()], then replace it with _.
path = path.replace(/[^-A-Za-z0-9_;.~()]/g, "_");

// 5) Path: Trim leading and trailing _ characters.
path = path.replace(/^_+|_+$/g, "");

// 6) Calculate the V3 URL GUID for the URL.
var guid = uuidv3(pageUrl, uuidv3.URL);

// 7) Combine the path and lowercase-hyphenated GUID, separated by '-'.
var postId = path + "-" + guid;

var nofollowLinkExtension = {
    type: 'output',
    regex: /(<a[^<]+<\/a>)/g,
    replace: (match, $1, $2) => {
        var result = $('<div/>').append($($1).attr('rel', 'nofollow noopener')).html();
        return result;
    }
};
showdown.extension('nofollowLink', nofollowLinkExtension);

var comments;
var markdownConverter = new showdown.Converter({
    omitExtraWLInCodeBlocks: true,
    noHeaderId: true,
    headerLevelStart: 3,
    simplifiedAutoLink: true,
    excludeTrailingPunctuationFromURLs: true,
    literalMidWordUnderscores: true,
    strikethrough: true,
    smoothLivePreview: true,
    disableForced4SpacesIndentedSublists: true,
    extensions: ['nofollowLink']
});
var sanitizeOptions = {
    allowedTags: [ 'blockquote', 'p', 'a', 'ul', 'ol', 'nl', 'li', 'b', 'i', 'strong', 'em', 'strike', 'code', 'br', 'div', 'pre', 'img' ],
    allowedAttributes: {
        a: [
            'href',
            {
                name: 'rel',
                multiple: true,
                values: ['nofollow', 'noopener']
            }
        ],
        img: [ 'src' ]
    },
    allowedIframeHostnames: []
};

function fixedEncodeURIComponent(str) {
  return encodeURIComponent(str).replace(/[!'()*]/g, function(c) {
    return '%' + c.charCodeAt(0).toString(16);
  });
}

function filterComments(replyTo) {
    return comments
        .filter(function (x) { return x.replyTo === replyTo; })
        .sort(function (a, b) { return a.timestamp - b.timestamp; });
}

function avatarUri(authorEmailMD5) {
    if (authorEmailMD5 === "")
        return "https://www.gravatar.com/avatar/?d=mp&f=y";
    else
        return "https://www.gravatar.com/avatar/" + authorEmailMD5 + "?d=retro";
}

var jwk = {"kty":"RSA","alg":"RSA-OAEP","n":"wviXqUJGtV8hZrvJMcTbyzm7MmiJSqsAfWI_7pCyAhXXzz5C9F3NtXp79CCUMqkOck6IbNKUntPtGNOGwtoc5LTJNKLhx3TPi4TJyKUSfNr3pAdLpMRNeeRXCHFyyVsDb6z8ueixlKzdbDpZhV05bam49PurMHfeexJ3EJy2NpdFviykRJxtrERi6ckBe96VMlT_pHHIWLN5EwOK54DvNn1DYjiFK5ux5WRCFatZByzytrFvIllZRctNXZ8oTuMjQwKLY2bUrURblbIvLfX-9Yd7uVgdUSFE7-vSel9-DMyp_NQ-NRXrQbJG7IAYhSGSx-TPepCDPbFpMq3yC0iET7wF7-OQOb-Kwej_TKVJv-z4SbN-cpCqaMr5Q9scyGih7xr1YrOhe3TMs_cbgjtxsZbzkOqcuRreON_sGb9nlDpSIFCo6aH47GeMkA23Hk3HXAPyYQ7AfWhU9daiPcySiAFnfkrg2QvFNJmMSZ-bo4Co-JkjiqKw-LEpOw6Ed9LK4walxWUAqPGcT4_Uys3TH9XVex9_rEmigHXiJY3_Lwi6mTSkW10-zen5UXxqnyHpMxlmumohT96OyLyhEPeaaq8FrTYMCX8TiMOst3jF5QCNP-LFz21yeUEAr5_3-FKV2mjWEU9iW0dOOVTII2rlD0WtCkqkDwZtakQ1ynGdW1E","e":"AQAB"};

function commentId(id) { return "comment-" + id; }

function $commentForm(hideForm, comment) {
    var $previewDiv = $('<div/>');
    var $authorEmailEncrypted = $('<input type="hidden" name="fields[authorEmailEncrypted]">');
    var $authorEmailMD5 = $('<input type="hidden" name="fields[authorEmailMD5]">');
    var $email = $('<input type="email" name="email" class="form-control" placeholder="Email">');
    var $name = $('<input type="text" name="fields[authorName]" class="form-control" placeholder="Name">');
    var $url = $('<input type="url" name="fields[authorUri]" class="form-control" placeholder="Url">');
    var $message = $('<textarea name="fields[message]" class="form-control" placeholder="Message"/></textarea>');
    autosize($message);
    var $replyTo = $('<input type="hidden" name="fields[replyTo]">').val("");
    var $recaptcha = $('<div class="g-recaptcha" data-sitekey="6LfSaV8UAAAAAEFq-7HeUDiSQCkCtLtO_yc_SOi_"></div>');
    var $buttonBar = $('<div class="comment-form-buttonbar"/>').append($('<button type="submit" class="btn btn-primary pull-right">Submit</button>'), $recaptcha);
    var $form = $('<form method="POST" action="https://stephencleary-comments.herokuapp.com/v2/entry/StephenCleary/comments.stephencleary.com/master"/>')
        .append($('<input type="hidden" name="fields[postId]">').val(postId))
        .append($('<input type="hidden" name="fields[postUri]">').val(location.href.replace(/#.*/, '')))
        .append($('<input type="hidden" name="options[reCaptcha][siteKey]" value="6LfSaV8UAAAAAEFq-7HeUDiSQCkCtLtO_yc_SOi_">'))
        .append($('<input type="hidden" name="options[reCaptcha][secret]" value="rlAivB9udiXQ8MQx3HNJ2Cw/qA2OJI1noljbySzRpNLKmdaS7LtDRT4T3hZcQswRl5sajt5dr+Txj46K2oEGH2HiStNdMMxCchBg0T6YcbZoAP7Zvax+6/C293ClnzMYq8Ozk4bMDbXEHC11FvHR2eaBKqTgAmQSQ3+N2NU5Aaw4Cqfgsj55Br+lKyK0Ydll6SF9+IjQnGJ6S9QV7rHopROdV3RCaeSsSrhsqyGjhvPRgSdl23npJbZt8R0e4oGd6ogH+VDhkj+S3LFPL+R7h6BiHuUDNuJheaJKYTJtjWt80esZgFYywTyTWnqkNBHxOXyH8+AN4PGI0trvlXzdsGvNYRP+dlV6AQyShI3zimSmB4mqcAnuNhGNvLIsfgTKRT1gmxgG1uxUMPjRq1L3R2wQMSQ1/cEuX2wiLI3UrtT8N+QUEptMQ1jsR7rg28OxqIVhbd2+LeAS90PxbxJ9h3mKAxQ493TmCIxRLbh9RNLl+jy8NsRwz2RikzKLJDZsfB7n/Z30nSDZkOTtT7fMzS3g4eJzT0sZStFQsW7Gis6MVs8hXUYgiuIseALKvAzmobnlycD/rqlCpZ5rYC2xQToc4ZDczfZ0bCP8/R5Op4J8LhI4l0JfR1pZSD9V9xTyQ6MTuTT63Ra72ANxn/0idxveWPJS7WMKbKoGmuTNji4=">'))
        .append($replyTo)
        .append($authorEmailEncrypted)
        .append($authorEmailMD5)
        .append($('<div class="form-group"><label>Name (optional)</label></div>').append($name))
        .append($('<div class="form-group"><label>Email (optional; always encrypted, never shared)</label></div>').append($email))
        .append($('<div class="form-group"><label>Url (optional; must start with "http://" or "https://")</label></div>').append($url))
        .append($('<div class="form-group"><label>Message (supports some Markdown/HTML)</label></div>').append($message));
    if (comment) {
        $replyTo.val(comment._id);
    }
    $form.submit(function (e) {
        e.preventDefault();
        hideForm();
        var postAction = $form.attr('action');
        var postBody = $form.serialize();
        var retries = 5;

        function postIt() {
            var post = $.post(postAction, postBody, "json");
            post.done(function () {
                alert("Comment successfully posted. It should appear on this page in a minute or so.");
            });
            post.error(function () {
                var message = "Failed to post comment";
                if (post.responseText)
                    message += ": " + post.responseText;
                
                if (--retries > 0) {
                    console.log(message);
                    postIt();
                } else {
                    alert(message);
                }
            });
        }

        postIt();
    });

    function createComment() {
        return normalizeComment({
            date: moment().format(),
            _id: "_",
            replyTo: comment ? comment._id : undefined,
            authorName: $name.val(),
            authorEmailMD5: $authorEmailMD5.val(),
            authorUri: $url.val(),
            message: $message.val()
        });
    };

    function recreatePreview() {
        var email = $email.val();
        if (email && email.indexOf("@") !== -1) {
            var data = new TextEncoder().encode($email.val());
            window.crypto.subtle.importKey("jwk", jwk, { name: "RSA-OAEP", hash: { name: "SHA-1" } }, false, ["encrypt"]).then(function (encryptionKey) {
                return window.crypto.subtle.encrypt({ name: "RSA-OAEP" }, encryptionKey, data)
                    .then(function (encrypted) {
                        var array = new Uint8Array(encrypted);
                        var text = base64js.fromByteArray(array);
                        $authorEmailEncrypted.val(text);
                        return text;
                    });
            });
            $authorEmailMD5.val(md5($email.val().replace(/^ +| +$/g, '').toLowerCase()));
        } else {
            $authorEmailMD5.val("");
            $authorEmailEncrypted.val("");
        }

        var $newPreview = $comment(false, createComment());
        // Turn off permalink and anchor
        var $anchor = $newPreview.find('.comment-date a');
        $anchor.replaceWith($('<span/>').text($anchor.text()));
        $newPreview.find('.comment-anchor').remove();
        $previewDiv.empty();
        $previewDiv.append($newPreview);
    };

    recreatePreview();
    $name.on('change keyup input paste', recreatePreview);
    $email.on('change keyup input paste', recreatePreview);
    $url.on('change keyup input paste', recreatePreview);
    $message.on('change keyup input paste', recreatePreview);

    $form.append($('<h3>Preview:</h3>'), $previewDiv, $buttonBar);
    return {
        $form: $('<div class="comment-form"/>').append($form),
        onShow: function() { grecaptcha.render($recaptcha[0]); }
    };
}

function $replyButton(comment) {
    var $button;
    if (comment)
        $button = $('<button class="btn btn-primary comment-reply"><i class="fa fa-reply"></i> Reply</button>');
    else
        $button = $('<button class="btn btn-primary comment-new"><i class="fa fa-plus-square"></i> New Comment</button>');
    return $button;
}

var now = moment();
function $comment(includeForm, comment) {
    var message = sanitizeHtml(markdownConverter.makeHtml(comment.message), sanitizeOptions);
    var $commentDiv = $('<div class="comment"/>');
    var publicationDate = moment(comment.date);
    var $author = $('<div class="comment-author"/>').append($('<span class="comment-author-name"/>').text(comment.authorName));
    if (comment.authorUri !== "")
        $author.append($('<span> • </span>'), $('<a class="comment-author-uri" rel="nofollow noopener"/>').attr('href', comment.authorUri).text(comment.authorUri));
    var $headerDiv = $('<div class="comment-header"/>').append(
        $('<div class="comment-author-profile" style="float:left;"/>').append($('<img class="comment-author-profile-image" src="' + avatarUri(comment.authorEmailMD5) + '"/>')),
        $author,
        $('<div class="comment-date" />').append(
            $('<a/>').attr('href', '#' + commentId(comment._id)).attr('title', 'permalink').text(publicationDate.from(now) + ' (' + publicationDate.format('YYYY-MM-DD hh:mm:ss a') + ')')
        )
    );
    if (comment.replyTo !== "") {
        var parent = comments.filter(function (x) { return x._id === comment.replyTo })[0];
        $headerDiv.append($('<div/>').append($('<a/>').attr('href', '#' + commentId(comment.replyTo)).text('In reply to ' + parent.authorName)));
    }

    $commentDiv.append($('<div class="comment-anchor"/>').attr('id', commentId(comment._id)),
        $headerDiv,
        $('<div class="comment-message" style="clear:both;"/>').html(message)
    );

    var $commentContainer = $('<div class="comment-container"/>').append($commentDiv);
    if (includeForm)
        $commentContainer.append($expandCollapseForm(comment));
    var childComments = filterComments(comment._id);
    for (var i = 0; i != childComments.length; ++i) {
        var child = childComments[i];
        $commentContainer.append($comment(includeForm, child));
    }

    return $commentContainer;
}

function normalizeComment(x) {
    var uri = x.authorUri;
    if (!uri || (!uri.startsWith("http://") && !uri.startsWith("https://")))
        uri = "";
    return {
            _id: x._id,
            authorName: x.authorName || "Anonymous",
            authorEmailMD5: x.authorEmailMD5 || "",
            authorUri: uri,
            message: x.message || "",
            replyTo: x.replyTo || "",
            date: x.date,
            timestamp: moment(x.date).valueOf()
    };
}

function $expandCollapseForm(comment) {
    var $button = $replyButton(comment);
    var formObj = $commentForm(hideForm, comment);
    var $form = formObj.$form.addClass("comment-hidden");
    var onShow = formObj.onShow;
    function showForm() {
        $button.addClass("comment-hidden");
        if (onShow) {
            onShow();
            onShow = null;
        }
        $form.removeClass("comment-hidden");
    }
    function hideForm() {
        $form.addClass("comment-hidden");
        $button.removeClass("comment-hidden");
    }
    $button.click(showForm);
    return $('<div/>').append($button, $form);
}

function recaptchaLoaded() {
    var req = new XMLHttpRequest();
    req.addEventListener("load", function () {
        var $commentDiv = $('#comments');
        if (req.status === 404 || req.status === 200) {
            if (req.status === 404) {
                comments = [];
            } else {
                comments = JSON.parse(req.responseText).map(normalizeComment);
            }
            var commentCounter = document.getElementById('comment-counter');
            commentCounter.innerText = comments.length + " " + commentCounter.innerText;
            var toplevelComments = filterComments("");
            for (var i = 0; i != toplevelComments.length; ++i) {
                var comment = toplevelComments[i];
                $commentDiv.append($comment(true, comment));
            }
            if (comments.length !== 0) {
                $commentDiv.append($expandCollapseForm());
            }
        }
        $commentDiv.prepend($expandCollapseForm());
    });
    req.open('GET', "https://comments.stephencleary.com/" + postId + ".json");
    req.send();
}
</script>

<script src="https://www.google.com/recaptcha/api.js?onload=recaptchaLoaded&amp;render=explicit"></script>



<!-- Google AdSense -->
<script src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- Moment -->
<script type="text/javascript">
    (function($) {
        $(function () {
            $('time').each(function (_, e) {
                var startOfToday = moment().startOf('day');
                var publicationDate = moment($(e).attr('datetime'), 'YYYY-MM-DD');
                var difference = startOfToday.diff(publicationDate, 'days');
                var text = difference === 0 ? 'Today' :
                    difference === 1 ? 'Yesterday' :
                    publicationDate.from(startOfToday);
                $(e).text(function(_, oldText) { return text + ' (' + oldText + ')'; });
            });
        });
    })(window.jQuery);
</script>




</body>
</html>