<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>A Few Words on Task.Id (and TaskScheduler.Id)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="There are some Id properties in TPL types (notably Task.Id and TaskScheduler.Id); these “identifiers” follow the same pattern. I believe their primary use case is for ETW events, though they may have other uses." />
    <link rel="canonical" href="http://blog.stephencleary.com/2013/03/a-few-words-on-taskid-and.html" />
    
    <link rel="alternate" type="application/rss+xml" title="Stephen Cleary (the blog)" href="http://feeds.feedburner.com/NitoPrograms" />
    
    <link href="//netdna.bootstrapcdn.com/bootswatch/3.2.0/spacelab/bootstrap.min.css" rel="stylesheet" />
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="http://stephencleary.com/css/main.css" />
    <meta name="application-name" content="Stephen Cleary" />
    <link rel="apple-touch-icon" sizes="57x57" href="http://stephencleary.com/icons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="http://stephencleary.com/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="http://stephencleary.com/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="http://stephencleary.com/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="http://stephencleary.com/icons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="http://stephencleary.com/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="http://stephencleary.com/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="http://stephencleary.com/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" href="http://stephencleary.com/icons/apple-touch-icon.png"/>
    <link rel="apple-touch-icon-precomposed" href="http://stephencleary.com/icons/apple-touch-icon-precomposed.png"/>
    <link rel="icon" type="image/png" href="http://stephencleary.com/icons/favicon-196x196.png" sizes="196x196">
    <link rel="icon" type="image/png" href="http://stephencleary.com/icons/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="http://stephencleary.com/icons/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="http://stephencleary.com/icons/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="http://stephencleary.com/icons/favicon-32x32.png" sizes="32x32">
    
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <div class="navbar-brand-container"><a class="navbar-brand" href="http://stephencleary.com">Stephen Cleary</a></div>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
            <li  class="active"  ><a href="http://blog.stephencleary.com">Blog</a></li>
            <li  ><a href="http://stephencleary.com/projects/">Projects</a></li>
            <li  ><a href="http://stephencleary.com/publications/">Publications</a></li>
            <li  ><a href="http://stephencleary.com/contact/">Contact</a></li>
            <li><a href="http://feeds.feedburner.com/NitoPrograms"><i class="fa fa-rss-square fa-lg"></i></a></li>
            <li  ><a href="http://stephencleary.com/search/"><i class="fa fa-search"></i></a></li>
        </ul>
    </div>
</nav>

    <div class="container-fluid">
        <div class="col-sm-8 col-sm-offset-2 col-md-6 col-md-offset-3">
            <div class="post">

  <header>
      <div class="page-header">
          <h1>A Few Words on Task.Id (and TaskScheduler.Id)</h1>
          <small><time datetime="2013-03-21">Mar 21, 2013</time> &bull; <a data-disqus-identifier="/2013/03/a-few-words-on-taskid-and" href="#disqus_thread">Comments</a></small>
      </div>
  </header>

  <article>
  <p>There are some <code>Id</code> properties in TPL types (notably <code>Task.Id</code> and <code>TaskScheduler.Id</code>); these “identifiers” follow the same pattern. I believe their primary use case is for <a href="http://msdn.microsoft.com/en-us/library/ee517329.aspx">ETW events</a>, though they may have other uses.</p>

<h2 id="generated-on-demand">Generated On-Demand</h2>

<p>Identifiers are generated on-demand. So if you don’t read the properties and don’t have ETW tracing on, then your tasks (and task schedulers) won’t actually <em>have</em> identifiers. They generate them right when they need them.</p>

<h2 id="invalidunassigned-value">Invalid/Unassigned Value</h2>

<p>The value <code>0</code> is never used. This is technically undocumented, but it’s pretty safe to assume. The ETW events all produce plain <code>int</code>s for task and task scheduler identifiers, and <a href="http://msdn.microsoft.com/en-us/library/ee517329.aspx">some ETW events</a> need a value for “none” (e.g., <code>OriginatingTaskId</code> needs to support a value meaning “there was no originating task”).</p>

<p>This means you’ll never actually see a zero value as an identifier. A task (or task scheduler) can internally have a zero identifier (meaning “unassigned”) but will generate an actual identifier if that value is ever read.</p>

<p>Incidentally, <code>Task.CurrentId</code> is a bit different than <code>TaskScheduler.Current.Id</code>. <code>Task.CurrentId</code> will return <code>null</code> when there is no task currently executing. <code>TaskScheduler.Current.Id</code> will return the (real) identifier of the “current” <code>TaskScheduler</code>; if there’s no task executing, the “current” scheduler is the default (thread pool) scheduler.</p>

<p>But either way, you won’t see a zero value.</p>

<h2 id="per-type">Per-Type</h2>

<p>Identifiers have meaning only for a particular type. For example, the first assigned <code>Task</code> identifier is one, and the first assigned <code>TaskScheduler</code> identifier is one. So the identifier “one” has no meaning by itself; the identifiers are not allocated from a shared pool or anything like that.</p>

<h2 id="not-quite-unique">Not Quite Unique</h2>

<p>The “identifiers” are not unique. They’re pretty close (they’ll repeat very rarely), but they’re not actually <em>unique</em>.</p>

<div class="alert alert-danger">
  <p><i class="fa fa-exclamation-triangle fa-2x pull-left"></i></p>

  <p>The MSDN documentation states the identifiers are unique. The MSDN documentation is wrong.</p>
</div>

<p>This can be easily proven with a simple test (also on <a href="https://gist.github.com/StephenCleary/5108676">gist</a>) where we first create one <code>Task</code> and then repeatedly create additional <code>Task</code> instances until we find one where the identifiers are the same (though the task instances are different):</p>

<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">task</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TaskCompletionSource</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;(</span><span class="k">null</span><span class="p">).</span><span class="n">Task</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">taskId</span> <span class="p">=</span> <span class="n">task</span><span class="p">.</span><span class="n">Id</span><span class="p">;</span>

        <span class="n">Task</span> <span class="n">other</span><span class="p">;</span>
        <span class="k">do</span>
        <span class="p">{</span>
            <span class="n">other</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TaskCompletionSource</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;(</span><span class="k">null</span><span class="p">).</span><span class="n">Task</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Saw Id of 0!&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">Id</span> <span class="p">!=</span> <span class="n">task</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>

       <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Id collision!&quot;</span><span class="p">);</span>
       <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;  task.Id == other.Id: &quot;</span> <span class="p">+</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">other</span><span class="p">.</span><span class="n">Id</span><span class="p">));</span>
       <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;  task == other: &quot;</span> <span class="p">+</span> <span class="p">(</span><span class="n">task</span> <span class="p">==</span> <span class="n">other</span><span class="p">));</span>
       <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>This program takes about 3 minutes on my machine to observe an identifier collision. The output is:</p>

<pre><code>Id collision!
  task.Id == other.Id: True
  task == other: False
</code></pre>

<p>Note that <code>Saw Id of 0!</code> is <em>not</em> in the output; the task identifiers worked their way through all possible <code>int</code> values but skipped over zero.</p>

<p>Probably no one will write a program that has four billion <code>Task</code> instances simultaneously, but it’s not uncommon for a few <code>Task</code> instances to be long-lived and most of them short-lived. So if you have a long-lived <code>Task</code> instance in a long-running program, be aware that its identifier may be reused while the long-lived task is still alive. Note that this <em>is</em> the common case! The example program above illustrates this: it only has one long-lived task; all the other tasks are eligible for garbage collection shortly after they’re created.</p>

<p>So, be aware that identifiers are not strictly unique. Some developers have attempted to “attach” data to a task using a concurrent dictionary with task identifiers as the key. But this will not work for most long-running programs.</p>

<div class="alert alert-info">
  <p><i class="fa fa-hand-o-right fa-2x pull-left"></i></p>

  <p>When developers try to attach data to tasks, they’re usually trying to figure out some kind of “ambient context” for asynchronous operations. <a href="/2013/04/implicit-async-context-asynclocal.html" class="alert-link">I cover the correct way to do that in a separate post.</a> If you really, seriously do need to attach data to tasks and you can’t derive from <code>Task</code> for whatever reason, you can use <a href="http://connectedproperties.codeplex.com/" class="alert-link">Connected Properties</a>.</p>
</div>

<h2 id="identifiers-in-nitoasyncex">Identifiers in Nito.AsyncEx</h2>

<p>I have a number of types in my <a href="http://nitoasyncex.codeplex.com">AsyncEx library</a> where I need a similar sort of semi-unique identifier (primarily for logging purposes). So I follow the same pattern as the built-in framework identifiers: generated on demand, zero as an invalid/unassigned value, and allocated by-type. I use a <a href="http://nitoasyncex.codeplex.com/SourceControl/changeset/view/f74db7311ea1#Source/Nito.AsyncEx (NET4, Win8, SL4, WP75)/Internal/IdManager.cs">helper class called IdManager</a> (not exposed in the public API) to satisfy this pattern.</p>

<p>You’re welcome to use this type in your own code if you need to. The design may appear a little unusual to .NET developers because it uses a <em>generic tag type</em>. Conceptually, <code>IdManager&lt;Tag&gt;</code> actually defines a <em>set</em> of types, each with their own “namespace” for identifiers. The generic parameter <code>Tag</code> is completely unused by <code>IdManager&lt;Tag&gt;</code>; its only purpose is to partition the static members.</p>

<p>This is a common code pattern in C++, a language which has much greater support for generic programming than C#. This kind of pattern is not at all common in the .NET world, and in fact StyleCop will complain about this class. But it makes perfect sense if you think about generic arguments as actual <em>arguments</em> that you pass to the <em>type</em>.</p>


  </article>
    
    <footer>
        
        
        
        <ul class="pager">
            <li class="previous"><a href="/2013/03/async-oop-7-design.html" title="Async OOP 7: Design">&larr; Previous Post</a></li>
            <li class="next"><a href="/2013/03/taskcurrentid-in-async-methods.html" title="Task.CurrentId in Async Methods">Next Post &rarr;</a></li>
        </ul>

        <div id="disqus_thread"></div>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </footer>
</div>
        </div>
        <div class="col-sm-2 col-md-3 col-md-offset-0 col-lg-2 col-lg-offset-1 affix" data-spy="affix" role="navigation">
            
            
        </div>
        <div class="col-sm-2 sidebar">
            <div class="panel panel-default">
                <div class="panel-heading">About Stephen Cleary</div>
                <div class="panel-body">
                    <div class="center"><img src="http://stephencleary.com/www.assets/Me-large.jpg"/></div>
                    <div class="center vertical-margins">Stephen Cleary is a <a href="http://www.landmarkbaptist.ws/salvation">Christian</a>, <a href="http://picasaweb.google.com/stephenandmandy">husband, father,</a> and programmer living in Northern Michigan.</div>
                    <div class="center"><a href="http://mvp.microsoft.com/en-us/mvp/Stephen%20Cleary-5000058"><img class="mvp-logo" src="http://stephencleary.com/www.assets/MVP.png"/></a></div>
                </div>
            </div>
            <div class="panel panel-primary">
                <div class="panel-heading">My book</div>
                <div class="panel-body center">
                    <div><a href="http://tinyurl.com/ConcurrencyCookbook"><img src="http://stephencleary.com/www.assets/Book-small.jpg"/></a></div>
                    <div>Available from <a href="http://tinyurl.com/ConcurrencyCookbook">O'Reilly</a> or <a href="http://tinyurl.com/ConcurrencyCookbookAmazon">Amazon</a>.</div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Advertisement</div>
                <div class="panel-body">
                    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2749292939902134" data-ad-slot="7584809820" data-ad-format="auto"></ins>
                </div>
            </div>
            
            <div class="panel panel-primary">
                <div class="panel-heading">Popular Posts</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2012/02/async-and-await.html">Async/await Intro</a></li>
                        <li><a href="/2013/11/there-is-no-thread.html">There Is No Thread</a></li>
                        <li><a href="/2012/07/dont-block-on-async-code.html">Don't Block on Async Code</a></li>
                    </ul>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Series</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2014/04/a-tour-of-task-part-0-overview.html">A Tour of Task</a></li>
                        <li><a href="/2013/10/taskrun-etiquette-and-proper-usage.html">Task.Run Etiquette</a></li>
                        <li><a href="/2013/05/taskrun-vs-backgroundworker-intro.html">Task.Run vs. BackgroundWorker</a></li>
                        <li><a href="/2013/01/async-oop-0-introduction.html">Async OOP</a></li>
                        <li><a href="/2009/04/tcpip-net-sockets-faq.html">TCP/IP .NET Sockets FAQ</a></li>
                        <li><a href="/2013/10/managed-services-roundup.html">Managed Services</a></li>
                        <li><a href="/2009/08/how-to-implement-idisposable-and.html">IDisposable and Finalizers</a></li>
                        <li><a href="/2011/02/option-parsing-introduction.html">Option Parsing</a></li>
                    </ul>
                </div>
            </div>
            
        </div>
    </div>

    <div class="google">
        <gcse:searchresults></gcse:searchresults>
    </div>
    
    <!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
<script type="text/javascript">window.jQuery || document.write('<script src="/lib/jquery-2.1.1.min.js"><\/script>')</script>

<!-- Bootstrap -->
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script type="text/javascript">window.jQuery.fn.modal || document.write('<script src="/lib/bootstrap.min.js"><\/script>')</script>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('body').css('color') !== 'rgb(102, 102, 102)') {
                $('head').prepend('<link rel="stylesheet" href="/lib/bootstrap.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Font Awesome -->
<span id="facheck" class="fa" style="display:none"></span>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('#facheck').css('fontFamily') !== 'FontAwesome') {
                $('head').prepend('<link rel="stylesheet" href="/lib/font-awesome.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Scroll the sidebar into view (if necessary) -->


<!-- Google analytics -->
<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-8910661-5', 'stephencleary.com');
    ga('send', 'pageview');
</script>







<!-- Disqus variables -->
<script type="text/javascript">
    var disqus_shortname = 'stephencleary';
    var disqus_identifier = "/2013/03/a-few-words-on-taskid-and";
    var disqus_title = "A Few Words on Task.Id (and TaskScheduler.Id)";
    var disqus_url = "http://blog.stephencleary.com/2013/03/a-few-words-on-taskid-and.html";
</script>

<!-- Disqus comment counter -->
<script type="text/javascript">
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
    }());
</script>

<!-- Disqus comment section -->
<script type="text/javascript">
    (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>



<!-- Google AdSense -->
<script src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- Moment -->
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.6.0/moment.min.js"></script>
<script type="text/javascript">window.moment || document.write('<script src="/lib/moment.min.js"><\/script>')</script>
<script type="text/javascript">
    (function($) {
        $(function() {
            $('time').each(function (_, e) {
                var text = moment($(e).attr('datetime'), 'YYYY-MM-DD').fromNow();
                $(e).text(function(_, oldText) { return text + ' (' + oldText + ')'; });
            });
        });
    })(window.jQuery);
</script>

</body>
</html>