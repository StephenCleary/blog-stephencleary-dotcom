<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Introduction to Dataflow, Part 1</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="So far, we’ve been learning quite a bit about the core async / await support that was added to C# in VS2012. Today, we’ll start with a conceptual overview of the first large, useful library built with async in mind: TPL Dataflow." />
    <link rel="canonical" href="https://blog.stephencleary.com/2012/09/introduction-to-dataflow-part-1.html" />
    
    <link rel="alternate" type="application/rss+xml" title="Stephen Cleary (the blog)" href="http://feeds.feedburner.com/NitoPrograms" />
    
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/bootswatch/3.2.0/spacelab/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" />
    <style type="text/css">/* Layout Styles */
/* ----------------------------------------------------------*/

body {
    padding-top: 50px;
}

.affix {
    top: 70px;
    bottom: 0;
    overflow-y: auto;
}

.navbar-brand {
    font-weight: bold;
}

.navbar-brand-container.active>a, .navbar-brand-container.active>a:hover, .navbar-brand-container.active>a:focus {
    color: #3399f3;
    background-color: transparent;
}

.sidebar {
    margin-top: 20px;
}

.sidenavitem {
    height: auto;
}

.sidebar img {
    /* Responsive images */
    display: inline-block;
    height: auto;
    max-width: 100%;
}

@media(max-width:767px) {
    .affix {
        position: static;
    }
}

div .vertical-margins {
    margin-top: 10px;
    margin-bottom: 10px;
}

.page-header {
    margin-top: 20px;
}

.center {
    text-align: center;
}

.project-icon {
    height: 128px;
    width: 128px;
}

.list-group-item h2 {
    margin-top: 10px;
}

/* Fixes for Google Custom Search in a Bootstrap page */
/* ----------------------------------------------------------*/
.google, .google *, .google *:before, .google *:after {
    -webkit-box-sizing: content-box;
    -moz-box-sizing: content-box;
    box-sizing: content-box;
}

.google table {
    border-collapse: separate;
}

.gsc-input-box {
    height: auto !important;
}

/* Fixes for Amazon widget in Bootstrap page */
.amzn_wdgt * {
    -webkit-box-sizing: content-box;
    -moz-box-sizing: content-box;
    box-sizing: content-box;
}

/* Post styles */
/* ----------------------------------------------------------*/

code {
    background-color: #F2F3F9;
    color: inherit;
}

.post img {
    /* Responsive images */
    display: inline-block;
    height: auto;
    max-width: 100%;
}

.post .table {
    table-layout: fixed;
}

.post .table code {
    white-space: normal;
}

.post .yes {
    color: #008000;
}

.post .no {
    color: #FF0000;
}

/* Syntax highlighting styles */
/* ----------------------------------------------------------*/

.highlight  { background: #ffffff; }
.highlight .c { color: #008000 } /* Comment */
.highlight .k { color: #0000ff } /* Keyword */
.highlight .cm { color: #008000 } /* Comment.Multiline */
.highlight .cp { color: #0000ff } /* Comment.Preproc */
.highlight .c1 { color: #008000 } /* Comment.Single */
.highlight .cs { color: #008000 } /* Comment.Special */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gh { font-weight: bold } /* Generic.Heading */
.highlight .gp { font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { font-weight: bold } /* Generic.Subheading */
.highlight .kc { color: #0000ff } /* Keyword.Constant */
.highlight .kd { color: #0000ff } /* Keyword.Declaration */
.highlight .kn { color: #0000ff } /* Keyword.Namespace */
.highlight .kp { color: #0000ff } /* Keyword.Pseudo */
.highlight .kr { color: #0000ff } /* Keyword.Reserved */
.highlight .kt { color: #2b91af } /* Keyword.Type */
.highlight .s { color: #a31515 } /* Literal.String */
.highlight .nc { color: #2b91af } /* Name.Class */
.highlight .ow { color: #0000ff } /* Operator.Word */
.highlight .sb { color: #a31515 } /* Literal.String.Backtick */
.highlight .sc { color: #a31515 } /* Literal.String.Char */
.highlight .sd { color: #a31515 } /* Literal.String.Doc */
.highlight .s2 { color: #a31515 } /* Literal.String.Double */
.highlight .se { color: #a31515 } /* Literal.String.Escape */
.highlight .sh { color: #a31515 } /* Literal.String.Heredoc */
.highlight .si { color: #a31515 } /* Literal.String.Interpol */
.highlight .sx { color: #a31515 } /* Literal.String.Other */
.highlight .sr { color: #a31515 } /* Literal.String.Regex */
.highlight .s1 { color: #a31515 } /* Literal.String.Single */
.highlight .ss { color: #a31515 } /* Literal.String.Symbol */

/* Comments */
/* ----------------------------------------------------------*/

.comment-container {
    margin-top: 10px;
}

.comment-container > .comment-container {
    margin-left: 2em;
}

.comment-container > .comment-container > .comment-container > .comment-container > .comment-container {
    margin-left: 0;
}

/* Correct anchor links in comments (they are offset by the height of the fixed header) */
.comment-anchor {
    display: block;
    position: relative;
    top: -60px;
    visibility: hidden;
}

.comment-author-profile-image {
    height: 80px;
    width: 80px;
    margin-right: 10px;
}
</style>
    
    <meta name="application-name" content="Stephen Cleary" />
    <link rel="search" type="application/opensearchdescription+xml" href="https://stephencleary.com/opensearch.xml" title="Cleary Search">
    <link rel="apple-touch-icon" sizes="57x57" href="https://stephencleary.com/icons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="https://stephencleary.com/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://stephencleary.com/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://stephencleary.com/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="https://stephencleary.com/icons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="https://stephencleary.com/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="https://stephencleary.com/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://stephencleary.com/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" href="https://stephencleary.com/icons/apple-touch-icon.png"/>
    <link rel="apple-touch-icon-precomposed" href="https://stephencleary.com/icons/apple-touch-icon-precomposed.png"/>
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-196x196.png" sizes="196x196">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-32x32.png" sizes="32x32">
    
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <div class="navbar-brand-container"><a class="navbar-brand" href="https://stephencleary.com">Stephen Cleary</a></div>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
            <li  class="active"  ><a href="https://blog.stephencleary.com">Blog</a></li>
            <li ><a href="https://stephencleary.com/videos/">Videos</a></li>
            <li  ><a href="https://stephencleary.com/projects/">Projects</a></li>
            <li  ><a href="https://stephencleary.com/publications/">Publications</a></li>
            <li  ><a href="https://stephencleary.com/book/">Book</a></li>
            <li  ><a href="https://stephencleary.com/contact/">Contact</a></li>
            <li><a href="http://feeds.feedburner.com/NitoPrograms"><i class="fa fa-rss-square fa-lg"></i></a></li>
            <li  ><a href="https://stephencleary.com/search/"><i class="fa fa-search"></i></a></li>
        </ul>
    </div>
</nav>

    <div class="container-fluid">
        <div class="col-sm-8 col-sm-offset-2 col-md-6 col-md-offset-3">
            <div class="post">

  <header>
      <div class="page-header">
          <h1>Introduction to Dataflow, Part 1</h1>
          <small><time datetime="2012-09-20">Sep 20, 2012</time> &bull; <a id="comment-counter" href="#comments">Comments</a></small>
      </div>
  </header>

  <article>
  <p>So far, we’ve been learning quite a bit about the core <code>async</code> / <code>await</code> support that was added to C# in VS2012. Today, we’ll start with a conceptual overview of the first large, useful library built with <code>async</code> in mind: <a href="http://msdn.microsoft.com/en-us/devlabs/gg585582.aspx">TPL Dataflow</a>.</p>

<p>TPL Dataflow allows you to easily create a <em>mesh</em> through which your data flows. The simplest meshes are pipelines (very similar to pipelines in PowerShell). More complex meshes can split and join the data flows, and even contain data flow loops!</p>

<p>Every mesh is composed of a number of <em>blocks</em> which are linked together. TPL Dataflow provides quite a few blocks which address different needs; we will just use the most basic blocks for our examples, but you can see the <a href="http://www.microsoft.com/en-us/download/details.aspx?id=14782">Introduction to TPL Dataflow document</a> for a full description of the different types of blocks.</p>

<h2 id="the-block">The Block</h2>

<p>A block is a part of a dataflow mesh through which data can flow. The block usually processes the data in some way, but it doesn’t have to.</p>

<p>Blocks themselves have components: usually a <em>buffer</em> component and a <em>task</em> component. Buffers hold data (either data that has been sent to this block but which has not yet been processed, or data that has been processed and is waiting to leave the block).</p>

<p>Different block types have different configurations of buffers and tasks. Some blocks have multiple buffers (e.g., “join” blocks). Tasks have two purposes. Most blocks use a task to push data out of the block; some blocks also use a task to do the processing of the data.</p>

<h2 id="basic-data-flow">Basic Data Flow</h2>

<p>You can push data to a block by calling <a href="http://msdn.microsoft.com/en-us/library/hh194836.aspx"><code>Post(item)</code></a> or <a href="http://msdn.microsoft.com/en-us/library/system.threading.tasks.dataflow.dataflowblock.sendasync.aspx"><code>await SendAsync(item)</code></a>. Normally, you could just use <code>Post(item)</code> to (synchronously) place the data into the block’s input buffer. However, it’s possible to throttle a block by limiting its buffer size; in this case, you could use <code>SendAsync</code> to (asynchronously) wait for space to be available and then place the data into the block’s input buffer.</p>

<p>Getting data out at first appears pretty easy: you can call <a href="http://msdn.microsoft.com/en-us/library/system.threading.tasks.dataflow.dataflowblock.receive.aspx"><code>Receive</code></a>, <a href="http://msdn.microsoft.com/en-us/library/hh194808.aspx"><code>TryReceive</code></a>, or <a href="http://msdn.microsoft.com/en-us/library/system.threading.tasks.dataflow.dataflowblock.receiveasync.aspx"><code>ReceiveAsync</code></a> to retrieve the next item, and there’s an <a href="http://msdn.microsoft.com/en-us/library/system.threading.tasks.dataflow.dataflowblock.outputavailableasync.aspx"><code>OutputAvailableAsync</code></a> that lets you know when the next item is ready to be retrieved. However, there are a couple of “gotchas”:</p>

<ol>
  <li>When a block finishes processing, <code>Receive</code> and <code>await ReceiveAsync</code> will both throw exceptions. This is not ideal.</li>
  <li><code>OutputAvailableAsync</code> is not very useful if there are multiple receivers reading from the same block.</li>
</ol>

<p>From a procedural perspective, it would be great if we had a <code>Tuple&lt;bool, T&gt; TryReceiveAsync</code> that would either retrieve the item or return false, rather than raising an exception.</p>

<p>But if you look at the problem from a <em>dataflow</em> perspective, there is already a solution: <a href="http://msdn.microsoft.com/en-us/library/hh194684.aspx"><code>ActionBlock&lt;T&gt;</code></a> will execute a callback for any data pushed to it. This is the “dataflowish” way of getting the results out of a dataflow mesh: just <em>link</em> your block to an <code>ActionBlock</code>.</p>

<h2 id="linking">Linking</h2>

<p>You can connect two blocks by linking them together. The actual negotiation of data transfer is fairly complex (to allow scenarios such as “join” blocks) - but you usually don’t have to think about it. Just link from source to target (<a href="http://msdn.microsoft.com/en-us/library/hh160311.aspx"><code>source.LinkTo(target);</code></a>), and the library takes care of propagating the data.</p>

<p>There’s no limit to what you can link. It is possible to have a loop in your dataflow mesh.</p>

<p>There are several options you have when setting up a link. You can have the link disengage after so many data items, or specify a filter so only certain data items will be propagated along the link, etc.</p>

<p>A lot of my dataflow “meshes” end up being “pipelines”, so one option I use more than others is <a href="http://msdn.microsoft.com/en-us/library/system.threading.tasks.dataflow.dataflowlinkoptions.propagatecompletion.aspx"><code>PropagateCompletion</code></a>, which propagates completion as well as data items.</p>

<h2 id="completion">Completion</h2>

<p>Eventually, you’re going to finish sending data to your dataflow mesh, and you’re going to want to know when the mesh is done processing it. Each block supports an asynchronous form of completion: you call <a href="http://msdn.microsoft.com/en-us/library/system.threading.tasks.dataflow.idataflowblock.complete.aspx"><code>Complete</code></a> and some time later, the block’s <a href="http://msdn.microsoft.com/en-us/library/system.threading.tasks.dataflow.idataflowblock.completion.aspx"><code>Completion</code></a> task will complete.</p>

<div class="alert alert-info">
  <p><i class="fa fa-hand-o-right fa-2x pull-left"></i></p>

  <p>Side note: you should <em>always</em> assume that <code>Completion</code> might be signaled asynchronously, even if there are no data items to process.</p>
</div>

<p>If you have a simple dataflow mesh (like a pipeline), then you can tell the blocks to propagate their completion when you link them together. Then when you’re finished, you can just complete the first block and await the completion of the last block.</p>

<p>If your dataflow mesh is more complex, then you may have to propagate completion manually. The common tools for this are <a href="http://msdn.microsoft.com/en-us/library/hh160384.aspx"><code>Task.WhenAll</code></a> and <a href="http://msdn.microsoft.com/en-us/library/system.threading.tasks.task.continuewith.aspx"><code>Task.ContinueWith</code></a>. If you do have to do this, I recommend that you wrap your dataflow mesh into a separate class (possibly exposing the blocks as properties) and implement your own <code>Complete</code> and <code>Completion</code> members just like a dataflow block does.</p>

<div class="alert alert-info">
  <p><i class="fa fa-hand-o-right fa-2x pull-left"></i></p>

  <p>Update (2014-12-01): For more details, see Chapter 4 in my <a href="https://stephencleary.com/book/" class="alert-link">Concurrency Cookbook</a>.</p>
</div>

  </article>
    
    <footer class="hidden-print">
        
        
        <ul class="pager">
            <li class="previous"><a href="/2012/09/an-async-horror-story.html" title="An Async Horror Story">&larr; Previous Post</a></li>
            <li class="next"><a href="/2012/09/introduction-to-dataflow-part-2.html" title="Introduction to Dataflow, Part 2">Next Post &rarr;</a></li>
        </ul>

        <div>Note: Comments are temporarily read-only. If you wish to make a comment, please email me directly.</div>
        <div id="comments"></div>
    </footer>
</div>
        </div>
        <div class="col-sm-2 col-md-3 col-md-offset-0 col-lg-2 col-lg-offset-1 affix hidden-print" data-spy="affix" role="navigation">
            
            
        </div>
        <div class="col-sm-2 sidebar hidden-print">
            <div class="panel panel-default">
                <div class="panel-heading">About Stephen Cleary</div>
                <div class="panel-body">
                    <div class="center"><img src="https://stephencleary.com/www.assets/Me-large.jpg"/></div>
                    <div class="center vertical-margins">Stephen Cleary is a <a href="https://stephencleary.com/god/">Christian</a>, husband, father, and programmer living in Northern Michigan.</div>
                    <div class="center"><a href="http://mvp.microsoft.com/en-us/mvp/Stephen%20Cleary-5000058"><img class="mvp-logo" src="https://stephencleary.com/www.assets/MVP.png"/></a></div>
                </div>
            </div>
            <div class="panel panel-primary">
                <div class="panel-heading">My book</div>
                <div class="panel-body center">
                    <div><a href="https://stephencleary.com/book/"><img src="https://stephencleary.com/www.assets/Book-small.jpg"/></a></div>
                    <div>Available from <a href="http://tinyurl.com/ConcurrencyCookbook">O'Reilly</a> or <a href="http://tinyurl.com/ConcurrencyCookbookAmazon">Amazon</a>.</div>
                    <div data-hide-after="2015-09-18 05-0700" class="hidden"><b><a href="http://tinyurl.com/ConcurrencyCookbook">Ebook is 50% off right now at O'Reilly</a> - use discount code <i>B2S5</i></b></div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Advertisement</div>
                <div class="panel-body">
                    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2749292939902134" data-ad-slot="7584809820" data-ad-format="auto"></ins>
                </div>
            </div>
            
            <div class="panel panel-primary">
                <div class="panel-heading">Popular Posts</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2012/02/async-and-await.html">Async/await Intro</a></li>
                        <li><a href="/2013/11/there-is-no-thread.html">There Is No Thread</a></li>
                        <li><a href="/2012/07/dont-block-on-async-code.html">Don't Block on Async Code</a></li>
                    </ul>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Series</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2016/02/react-redux-todomvc.html">React/Redux TodoMVC</a></li>
                        <li><a href="/2014/04/a-tour-of-task-part-0-overview.html">A Tour of Task</a></li>
                        <li><a href="/2013/10/taskrun-etiquette-and-proper-usage.html">Task.Run Etiquette</a></li>
                        <li><a href="/2013/05/taskrun-vs-backgroundworker-intro.html">Task.Run vs. BackgroundWorker</a></li>
                        <li><a href="/2013/01/async-oop-0-introduction.html">Async OOP</a></li>
                        <li><a href="/2009/04/tcpip-net-sockets-faq.html">TCP/IP .NET Sockets FAQ</a></li>
                        <li><a href="/2013/10/managed-services-roundup.html">Managed Services</a></li>
                        <li><a href="/2009/08/how-to-implement-idisposable-and.html">IDisposable and Finalizers</a></li>
                        <li><a href="/2011/02/option-parsing-introduction.html">Option Parsing</a></li>
                    </ul>
                </div>
            </div>
            
        </div>
    </div>

    <div class="google">
        <gcse:searchresults></gcse:searchresults>
    </div>
    
    <!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
<script type="text/javascript">window.jQuery || document.write('<script src="/lib/jquery-2.1.1.min.js"><\/script>')</script>

<!-- Bootstrap -->
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script type="text/javascript">window.jQuery.fn.modal || document.write('<script src="/lib/bootstrap.min.js"><\/script>')</script>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('body').css('color') !== 'rgb(102, 102, 102)') {
                $('head').prepend('<link rel="stylesheet" href="/lib/bootstrap.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Font Awesome -->
<span id="facheck" class="fa" style="display:none"></span>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('#facheck').css('fontFamily') !== 'FontAwesome') {
                $('head').prepend('<link rel="stylesheet" href="/lib/font-awesome.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Scroll the sidebar into view (if necessary) -->


<!-- Moment -->
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.6.0/moment.min.js"></script>
<script type="text/javascript">window.moment || document.write('<script src="/lib/moment.min.js"><\/script>')</script>

<!-- Google analytics -->
<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-8910661-5', 'stephencleary.com');
    ga('send', 'pageview');
</script>

<!-- Show appropriate elements based on time -->
<script type="text/javascript">
    (function ($) {
        $(function () {
            var targets = $('[data-hide-after]');
            targets.each(function () {
                var $item = $(this);
                if (moment() < moment($item.attr('data-hide-after'))) {
                    $item.removeClass('hidden');
                }
            });
        });
    })(window.jQuery);
</script>








<script src="/lib/uuid-v3-3.2.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/showdown@1.8.6/dist/showdown.min.js" integrity="sha256-dwhppIrxD8qC6lNulndZgtIm4XBU9zoMd9OUoXzIDAE=" crossorigin="anonymous"></script>
<script src="/lib/sanitize-html-1.18.2.min.js"></script>

<script type="text/javascript">

var pageUrl = "https://blog.stephencleary.com" + "/2012/09/introduction-to-dataflow-part-1.html";

// (unnecessary) 1) If the URL starts with http://, replace with https://

// 2) Take the URL path (not including scheme and domain).
var url = document.createElement('a');
url.href = pageUrl; //'https://developer.mozilla.org:8080/en-US/search?q=URL#search-results-close-container';
var path = url.pathname;

// 3) Path: If the path ends with .html or any two- to six-character [A-Za-z0-9] extension, strip it.
if (path.endsWith(".html"))
    path = path.substr(0, path.length - 5);
else
    path = path.replace(/\.[A-Za-z0-9]{2,6}$/, "");

// 4) Path: For each UTF-16 code unit, if it's not in the whitelist [A-Za-z0-9-_;.~()], then replace it with _.
path = path.replace(/[^-A-Za-z0-9_;.~()]/g, "_");

// 5) Path: Trim leading and trailing _ characters.
path = path.replace(/^_+|_+$/g, "");

// 6) Calculate the V3 URL GUID for the URL.
var guid = uuidv3(pageUrl, uuidv3.URL);

// 7) Combine the path and lowercase-hyphenated GUID, separated by '-'.
var postId = path + "-" + guid;

var nofollowLinkExtension = {
    type: 'output',
    regex: /(<a[^<]+<\/a>)/g,
    replace: (match, $1, $2) => {
        var result = $('<div/>').append($($1).attr('rel', 'nofollow noopener')).html();
        return result;
    }
};
showdown.extension('nofollowLink', nofollowLinkExtension);

var comments;
var markdownConverter = new showdown.Converter({
    omitExtraWLInCodeBlocks: true,
    noHeaderId: true,
    headerLevelStart: 3,
    simplifiedAutoLink: true,
    excludeTrailingPunctuationFromURLs: true,
    literalMidWordUnderscores: true,
    strikethrough: true,
    smoothLivePreview: true,
    disableForced4SpacesIndentedSublists: true,
    extensions: ['nofollowLink']
});
var sanitizeOptions = {
    allowedTags: [ 'blockquote', 'p', 'a', 'ul', 'ol', 'nl', 'li', 'b', 'i', 'strong', 'em', 'strike', 'code', 'br', 'div', 'pre', 'img' ],
    allowedAttributes: {
        a: [
            'href',
            {
                name: 'rel',
                multiple: true,
                values: ['nofollow', 'noopener']
            }
        ],
        img: [ 'src' ]
    },
    allowedIframeHostnames: []
};

function fixedEncodeURIComponent(str) {
  return encodeURIComponent(str).replace(/[!'()*]/g, function(c) {
    return '%' + c.charCodeAt(0).toString(16);
  });
}

function filterComments(replyTo) {
    return comments
        .filter(function (x) { return x.replyTo === replyTo; })
        .sort(function (a, b) { return a.timestamp - b.timestamp; });
}

function avatarUri(comment) {
    if (comment.authorEmailMD5 === "")
        return "https://www.gravatar.com/avatar/?d=mp&f=y";
    else
        return "https://www.gravatar.com/avatar/" + comment.authorEmailMD5 + "?d=retro";
}

function commentId(id) { return "comment-" + id; }

var now = moment();
function $comment(comment) {
    var message = sanitizeHtml(markdownConverter.makeHtml(comment.message), sanitizeOptions);
    var $commentDiv = $('<div class="comment"/>');
    var publicationDate = moment(comment.date);
    var $author = $('<div class="comment-author"/>').append($('<span class="comment-author-name"/>').text(comment.authorName));
    if (comment.authorUri !== "")
        $author.append($('<span> • </span>'), $('<a class="comment-author-uri" rel="nofollow noopener"/>').attr('href', comment.authorUri).text(comment.authorUri));
    var $headerDiv = $('<div class="comment-header"/>').append(
        $('<div class="comment-author-profile" style="float:left;"/>').append($('<img class="comment-author-profile-image" src="' + avatarUri(comment) + '"/>')),
        $author,
        $('<div class="comment-date" />').append(
            $('<a/>').attr('href', '#' + commentId(comment._id)).attr('title', 'permalink').text(publicationDate.from(now) + ' (' + publicationDate.format('YYYY-MM-DD hh:mm:ss a') + ')')
        )
    );
    if (comment.replyTo !== "") {
        var parent = comments.filter(function (x) { return x._id === comment.replyTo })[0];
        $headerDiv.append($('<div/>').append($('<a/>').attr('href', '#' + commentId(comment.replyTo)).text('In reply to ' + parent.authorName)));
    }

    $commentDiv.append($('<div class="comment-anchor"/>').attr('id', commentId(comment._id)),
        $headerDiv,
        $('<div class="comment-message" style="clear:both;"/>').html(message)
    );

    var $commentContainer = $('<div class="comment-container"/>').append($commentDiv);
    var childComments = filterComments(comment._id);
    for (var i = 0; i != childComments.length; ++i) {
        var child = childComments[i];
        $commentContainer.append($comment(child));
    }

    return $commentContainer;
}

var req = new XMLHttpRequest();
req.addEventListener("load", function () {
    comments = JSON.parse(req.responseText);
    var commentCounter = document.getElementById('comment-counter');
    commentCounter.innerText = comments.length + " " + commentCounter.innerText;
    var $commentDiv = $('#comments');
    var toplevelComments = filterComments("");
    for (var i = 0; i != toplevelComments.length; ++i) {
        var comment = toplevelComments[i];
        $commentDiv.append($comment(comment));
    }
});
req.open('GET', "https://comments.stephencleary.com/" + postId + ".json");
req.send();
</script>

<!-- TODO-COMMENTS -->

<!-- Disqus variables -->
<!-- script type="text/javascript">
    var disqus_shortname = 'stephencleary';
    var disqus_identifier = "/2012/09/introduction-to-dataflow-part-1";
    var disqus_title = "Introduction to Dataflow, Part 1";
    var disqus_url = "https://blog.stephencleary.com/2012/09/introduction-to-dataflow-part-1.html";
</script -->

<!-- Disqus comment counter -->
<!-- script type="text/javascript">
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
    }());
</script -->

<!-- Disqus comment section -->
<!-- script type="text/javascript">
    (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script -->



<!-- Google AdSense -->
<script src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- Moment -->
<script type="text/javascript">
    (function($) {
        $(function () {
            $('time').each(function (_, e) {
                var startOfToday = moment().startOf('day');
                var publicationDate = moment($(e).attr('datetime'), 'YYYY-MM-DD');
                var difference = startOfToday.diff(publicationDate, 'days');
                var text = difference === 0 ? 'Today' :
                    difference === 1 ? 'Yesterday' :
                    publicationDate.from(startOfToday);
                $(e).text(function(_, oldText) { return text + ' (' + oldText + ')'; });
            });
        });
    })(window.jQuery);
</script>




</body>
</html>