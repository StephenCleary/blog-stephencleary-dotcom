<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Returning Early from ASP.NET Requests</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <link rel="canonical" href="https://blog.stephencleary.com/2012/12/returning-early-from-aspnet-requests.html" />
    
    <link rel="alternate" type="application/rss+xml" title="Stephen Cleary (the blog)" href="http://feeds.feedburner.com/NitoPrograms" />
    
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/bootswatch/3.2.0/spacelab/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" />
    <style type="text/css">/* Layout Styles */
/* ----------------------------------------------------------*/

body {
    padding-top: 50px;
}

.affix {
    top: 70px;
    bottom: 0;
    overflow-y: auto;
}

.navbar-brand {
    font-weight: bold;
}

.navbar-brand-container.active>a, .navbar-brand-container.active>a:hover, .navbar-brand-container.active>a:focus {
    color: #3399f3;
    background-color: transparent;
}

.sidebar {
    margin-top: 20px;
}

.sidenavitem {
    height: auto;
}

.sidebar img {
    /* Responsive images */
    display: inline-block;
    height: auto;
    max-width: 100%;
}

@media(max-width:767px) {
    .affix {
        position: static;
    }
}

div .vertical-margins {
    margin-top: 10px;
    margin-bottom: 10px;
}

.page-header {
    margin-top: 20px;
}

.center {
    text-align: center;
}

.project-icon {
    height: 128px;
    width: 128px;
}

.list-group-item h2 {
    margin-top: 10px;
}

/* Fixes for Google Custom Search in a Bootstrap page */
/* ----------------------------------------------------------*/
.google, .google *, .google *:before, .google *:after {
    -webkit-box-sizing: content-box;
    -moz-box-sizing: content-box;
    box-sizing: content-box;
}

.google table {
    border-collapse: separate;
}

.gsc-input-box {
    height: auto !important;
}

/* Fixes for Amazon widget in Bootstrap page */
.amzn_wdgt * {
    -webkit-box-sizing: content-box;
    -moz-box-sizing: content-box;
    box-sizing: content-box;
}

/* Post styles */
/* ----------------------------------------------------------*/

code {
    background-color: #F2F3F9;
    color: inherit;
}

.post img {
    /* Responsive images */
    display: inline-block;
    height: auto;
    max-width: 100%;
}

.post .table {
    table-layout: fixed;
}

.post .table code {
    white-space: normal;
}

.post .yes {
    color: #008000;
}

.post .no {
    color: #FF0000;
}

/* Syntax highlighting styles */
/* ----------------------------------------------------------*/

.highlight  { background: #ffffff; }
.highlight .c { color: #008000 } /* Comment */
.highlight .k { color: #0000ff } /* Keyword */
.highlight .cm { color: #008000 } /* Comment.Multiline */
.highlight .cp { color: #0000ff } /* Comment.Preproc */
.highlight .c1 { color: #008000 } /* Comment.Single */
.highlight .cs { color: #008000 } /* Comment.Special */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gh { font-weight: bold } /* Generic.Heading */
.highlight .gp { font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { font-weight: bold } /* Generic.Subheading */
.highlight .kc { color: #0000ff } /* Keyword.Constant */
.highlight .kd { color: #0000ff } /* Keyword.Declaration */
.highlight .kn { color: #0000ff } /* Keyword.Namespace */
.highlight .kp { color: #0000ff } /* Keyword.Pseudo */
.highlight .kr { color: #0000ff } /* Keyword.Reserved */
.highlight .kt { color: #2b91af } /* Keyword.Type */
.highlight .s { color: #a31515 } /* Literal.String */
.highlight .nc { color: #2b91af } /* Name.Class */
.highlight .ow { color: #0000ff } /* Operator.Word */
.highlight .sb { color: #a31515 } /* Literal.String.Backtick */
.highlight .sc { color: #a31515 } /* Literal.String.Char */
.highlight .sd { color: #a31515 } /* Literal.String.Doc */
.highlight .s2 { color: #a31515 } /* Literal.String.Double */
.highlight .se { color: #a31515 } /* Literal.String.Escape */
.highlight .sh { color: #a31515 } /* Literal.String.Heredoc */
.highlight .si { color: #a31515 } /* Literal.String.Interpol */
.highlight .sx { color: #a31515 } /* Literal.String.Other */
.highlight .sr { color: #a31515 } /* Literal.String.Regex */
.highlight .s1 { color: #a31515 } /* Literal.String.Single */
.highlight .ss { color: #a31515 } /* Literal.String.Symbol */

/* Comments */
/* ----------------------------------------------------------*/

.comment-container {
    margin-top: 1em;
}

.comment-container > .comment-container {
    margin-left: 2em;
}

.comment-container > .comment-container > .comment-container > .comment-container > .comment-container {
    margin-left: 0;
}

/* Correct anchor links in comments (they are offset by the height of the fixed header) */
.comment-anchor {
    display: block;
    position: relative;
    top: -60px;
    visibility: hidden;
}

img.comment-author-profile-image {
    height: 80px;
    width: 80px;
    margin-right: 10px;
}

.comment-message {
    overflow-x: auto;
}

.comment-form {
    border: 1px solid black;
    padding: 1em;
}

.comment-new {
    margin-top: 1em;
    margin-bottom: 1em;
}

.comment-new, .comment-reply {
    margin-left: 1em;
}

.comment-hidden {
    display: none;
}

.comment-form-buttonbar {
    margin-top: 1em;
}
</style>
    
    <meta name="application-name" content="Stephen Cleary" />
    <link rel="search" type="application/opensearchdescription+xml" href="https://stephencleary.com/opensearch.xml" title="Cleary Search">
    <link rel="apple-touch-icon" sizes="57x57" href="https://stephencleary.com/icons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="https://stephencleary.com/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://stephencleary.com/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://stephencleary.com/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="https://stephencleary.com/icons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="https://stephencleary.com/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="https://stephencleary.com/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://stephencleary.com/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" href="https://stephencleary.com/icons/apple-touch-icon.png"/>
    <link rel="apple-touch-icon-precomposed" href="https://stephencleary.com/icons/apple-touch-icon-precomposed.png"/>
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-196x196.png" sizes="196x196">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-32x32.png" sizes="32x32">
    
    <meta name="google-site-verification" content="L8q0fpGSwpNSD0OGFI07hyMujSpORrV4tAaNx_Js7oQ" />
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <div class="navbar-brand-container"><a class="navbar-brand" href="https://stephencleary.com">Stephen Cleary</a></div>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
            <li  class="active"  ><a href="https://blog.stephencleary.com">Blog</a></li>
            <li  ><a href="https://stephencleary.com/book/">Book</a></li>
            <li  ><a href="https://stephencleary.com/projects/">Projects</a></li>
            <li  ><a href="https://stephencleary.com/publications/">Publications</a></li>
            <li  ><a href="https://stephencleary.com/contact/">Contact</a></li>
            <li><a href="http://feeds.feedburner.com/NitoPrograms"><i class="fa fa-rss-square fa-lg"></i></a></li>
            <li  ><a href="https://stephencleary.com/search/"><i class="fa fa-search"></i></a></li>
        </ul>
    </div>
</nav>

    <div class="container-fluid">
        <div class="col-sm-8 col-sm-offset-2 col-md-6 col-md-offset-3">
            <div class="post">

  <header>
      <div class="page-header">
          <h1>Returning Early from ASP.NET Requests</h1>
          <small><time datetime="2012-12-13">Dec 13, 2012</time> &bull; <a id="comment-counter" href="#comments">Comments</a></small>
      </div>
  </header>

  <header>
    <div class="alert alert-info" markdown="1">
        <i class="fa fa-hand-o-right fa-2x pull-left"></i>
        
        <div>Has this blog been helpful? Please consider <a href="https://github.com/sponsors/StephenCleary" class="alert-link">supporting this blog (and my open-source libraries).</a> Thanks!</div>
        <div><i>For a limited time, GitHub will match your support.</i></div>
    </div>
  </header>

  <article>
  <div class="alert alert-info">
  <p><i class="fa fa-hand-o-right fa-2x pull-left"></i></p>

  <p><strong>Update, 2021-02-22:</strong> There is more information in <a href="/2021/01/asynchronous-messaging-1-basic-distributed-architecture.html" class="alert-link">a whole series of posts on Asynchronous Messaging</a>, which is the <em>proper</em> solution for request-extrinsic code.</p>
</div>

<p>I have great reservations about writing this blog post. Pretty much everything I’m going to describe here is a bad idea and you should strongly avoid putting it into production, but there <em>are</em> just a few situations where this technique can be really helpful.</p>

<p>As I described in <a href="/2012/08/async-doesnt-change-http-protocol.html">Async Doesn’t Change the HTTP Protocol</a>, in the ASP.NET worldview you only get one “response” for each “request”. You can’t return early just by using an <code>await</code>. However, in some situations you have enough information to generate the response but the actual request processing may take some more time. That’s were today’s solution comes in.</p>

<h2 id="not-recommended">Not Recommended</h2>

<p>The solution in this blog post is not recommended. Before putting it into production, you <strong>need</strong> to understand <strong>why</strong> it’s not recommended.</p>

<p>ASP.NET executes your web site (or web application) in an AppDomain, separated from other web sites (or web applications) on the same server. There are <a href="https://docs.microsoft.com/en-us/archive/blogs/tess/asp-net-case-study-lost-session-variables-and-appdomain-recycles?WT.mc_id=DT-MVP-5000058">many</a> <a href="https://docs.microsoft.com/en-us/archive/blogs/johan/common-reasons-why-your-application-pool-may-unexpectedly-recycle?WT.mc_id=DT-MVP-5000058">reasons</a> why this AppDomain may be shut down; modern versions of IIS <a href="http://www.iis.net/configreference/system.applicationhost/applicationpools/add/recycling">recycle the entire process</a> every 29 hours by default just to keep things clean. Also, you have to take into consideration unmanaged shutdowns: hard drive failures, hurricanes, etc.</p>

<p>Consider what happens if you generate (and return) the response but you’re still working on the request. If you lose your AppDomain for any reason, that in-progress work is <em>lost</em>. The client thinks it was completed, but it really wasn’t. As long as the request is incomplete, the responsibility is on the client. When you complete the request (by sending a response), you have accepted the full responsibility of that request. If you haven’t already committed the changes, you need to be absolutely sure that they <em>will</em> be committed.</p>

<h2 id="proper-solutions">Proper Solutions</h2>

<p>The correct solutions are all complicated: you need to put the additional work in a safe place, like an Azure queue, database, or persistent messaging system (Azure message bus, MSMQ, WebSphere MQ, etc). And each of those solutions brings a whole scope of additional work: setup and configuration, dead-letter queues, poison messages, etc.</p>

<p>But that’s the correct way to do it, because <em>you can’t drop the ball!</em> You store the additional work in the safe place and then return a response after the work is safely stored. Personally, I like distributed systems (like Azure queues) because it’s not just safely stored on the hard drive - it’s safely stored on <em>six</em> hard drives, three of which are in a <em>different geographic location.</em> This gives you more protection from more problems (like hard drive failures and hurricanes).</p>

<div class="alert alert-info">
  <p><i class="fa fa-hand-o-right fa-2x pull-left"></i></p>

  <p><strong>Update, 2021-02-22:</strong> I have <a href="/2021/01/asynchronous-messaging-1-basic-distributed-architecture.html" class="alert-link">a whole series of posts on asynchronous messaging</a>, which is the proper solution for request-extrinsic code.</p>
</div>

<h2 id="the-improper-solution">The Improper “Solution”</h2>

<p>The <em>unsafe</em> way to do it is to keep the work in memory. The simple way to do this is to just toss the work into <code>Task.Run</code>. Unfortunately, ASP.NET has no idea if you have queued work like this, and it will feel free to take down your AppDomain when it thinks it’s idle.</p>

<p>The <em>slightly safer but still unsafe</em> way to do it is to keep the work in memory but register it with ASP.NET so that it will notify you when your AppDomain is going away. The code in this blog post uses <a href="http://haacked.com/archive/2011/10/16/the-dangers-of-implementing-recurring-background-tasks-in-asp-net.aspx">the technique described by Phil Haack</a> to register work with the ASP.NET runtime. It’s important to note the <strong>limitations</strong> of this approach:</p>

<ul>
  <li>
    <s>By default, you only have 30 seconds total from the time the notification goes out to the time the AppDomain is yanked out from under you.</s>
    <p>As noted in the comments, the ASP.NET runtime will wait an arbitrary amount of time for your background tasks to complete. Still, it’s probably best not to keep them waiting…</p>
  </li>
  <li>You <em>may</em> not get notification at all. In an unmanaged shutdown (e.g., power loss), all bets are off.</li>
</ul>

<p>Still, this approach <em>can</em> be useful in a limited set of scenarios, so with great reservation let’s take a look at the code.</p>

<div class="alert alert-info">
  <p><i class="fa fa-hand-o-right fa-2x pull-left"></i></p>

  <p><strong>Update 2014-04:</strong> A newer version of this code is now <a href="https://github.com/StephenCleary/AspNetBackgroundTasks" class="alert-link">on GitHub</a> and available <a href="https://www.nuget.org/packages/Nito.AspNetBackgroundTasks/" class="alert-link">via NuGet</a>.</p>
</div>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Hosting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Nito.AsyncEx</span><span class="p">;</span>

<span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// A type that tracks background operations and notifies ASP.NET that they are still in progress.</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">BackgroundTaskManager</span> <span class="p">:</span> <span class="n">IRegisteredObject</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// A cancellation token that is set when ASP.NET is shutting down the app domain.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">CancellationTokenSource</span> <span class="n">shutdown</span><span class="p">;</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// A countdown event that is incremented each time a task is registered and decremented each time it completes. When it reaches zero, we are ready to shut down the app domain. </span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">AsyncCountdownEvent</span> <span class="n">count</span><span class="p">;</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// A task that completes after &lt;see cref=&quot;count&quot;/&gt; reaches zero and the object has been unregistered.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Task</span> <span class="n">done</span><span class="p">;</span>

    <span class="k">private</span> <span class="nf">BackgroundTaskManager</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Start the count at 1 and decrement it when ASP.NET notifies us we&#39;re shutting down.</span>
        <span class="n">shutdown</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CancellationTokenSource</span><span class="p">();</span>
        <span class="n">count</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AsyncCountdownEvent</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
        <span class="n">shutdown</span><span class="p">.</span><span class="n">Token</span><span class="p">.</span><span class="n">Register</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">count</span><span class="p">.</span><span class="n">Signal</span><span class="p">(),</span> <span class="n">useSynchronizationContext</span><span class="p">:</span> <span class="k">false</span><span class="p">);</span>

        <span class="c1">// Register the object and unregister it when the count reaches zero.</span>
        <span class="n">HostingEnvironment</span><span class="p">.</span><span class="n">RegisterObject</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="n">done</span> <span class="p">=</span> <span class="n">count</span><span class="p">.</span><span class="n">WaitAsync</span><span class="p">().</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">HostingEnvironment</span><span class="p">.</span><span class="n">UnregisterObject</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">ExecuteSynchronously</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="n">IRegisteredObject</span><span class="p">.</span><span class="n">Stop</span><span class="p">(</span><span class="kt">bool</span> <span class="n">immediate</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">shutdown</span><span class="p">.</span><span class="n">Cancel</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">immediate</span><span class="p">)</span>
            <span class="n">done</span><span class="p">.</span><span class="n">Wait</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Registers a task with the ASP.NET runtime.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name=&quot;task&quot;&gt;The task to register.&lt;/param&gt;</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">Register</span><span class="p">(</span><span class="n">Task</span> <span class="n">task</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">count</span><span class="p">.</span><span class="n">AddCount</span><span class="p">();</span>
        <span class="n">task</span><span class="p">.</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">count</span><span class="p">.</span><span class="n">Signal</span><span class="p">(),</span> <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">ExecuteSynchronously</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// The background task manager for this app domain.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">BackgroundTaskManager</span> <span class="n">instance</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BackgroundTaskManager</span><span class="p">();</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Gets a cancellation token that is set when ASP.NET is shutting down the app domain.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">CancellationToken</span> <span class="n">Shutdown</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">instance</span><span class="p">.</span><span class="n">shutdown</span><span class="p">.</span><span class="n">Token</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
    
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Executes an &lt;c&gt;async&lt;/c&gt; background operation, registering it with ASP.NET.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name=&quot;operation&quot;&gt;The background operation.&lt;/param&gt;</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;</span> <span class="n">operation</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">instance</span><span class="p">.</span><span class="n">Register</span><span class="p">(</span><span class="n">Task</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="n">operation</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Executes a background operation, registering it with ASP.NET.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name=&quot;operation&quot;&gt;The background operation.&lt;/param&gt;</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">(</span><span class="n">Action</span> <span class="n">operation</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">instance</span><span class="p">.</span><span class="n">Register</span><span class="p">(</span><span class="n">Task</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="n">operation</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p><code>BackgroundTaskManager</code> is a singleton that keeps track of background operations. It uses an <a href="http://nitoasyncex.codeplex.com/wikipage?title=AsyncCountdownEvent">AsyncCountdownEvent</a> from <a href="http://nitoasyncex.codeplex.com/">AsyncEx</a> as a counter of background operations (plus an extra count that is decremented when ASP.NET notifies us that the AppDomain is going down).</p>

<p>You can queue synchronous or asynchronous work by calling <code>Run</code>:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">BackgroundTaskManager</span><span class="p">.</span><span class="n">Run</span><span class="p">(()</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">20000</span><span class="p">);</span>
<span class="p">});</span>
<span class="n">BackgroundTaskManager</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="m">20000</span><span class="p">);</span>
<span class="p">});</span></code></pre></figure>

<p><code>BackgroundTaskManager</code> also publishes a <code>CancellationToken</code> that is canceled when ASP.NET notifies us that our AppDomain is shutting down. <code>async</code> code can use this to abort processing (when it is safe to do so):</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">BackgroundTaskManager</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="m">20000</span><span class="p">,</span> <span class="n">BackgroundTaskManager</span><span class="p">.</span><span class="n">Shutdown</span><span class="p">);</span>
<span class="p">});</span></code></pre></figure>

<p>One important note about background operations: <strong>exceptions are ignored!</strong> So if you want to catch errors and toss a “hail Mary” to ETW or the Event Log, you’ll need to do so with a <code>try ... catch</code> inside each operation. In the example above, if the AppDomain is recycled while the operation is doing the delay, the cancellation exception will be raised from the operation and then it will be ignored.</p>

<p>As a final reminder, do <strong>not</strong> put critical processing in a background operation like this. It works fine for the “easy” case (ASP.NET gets a gentle request to shut down the AppDomain and nicely notifies the background operations, which all complete or cancel well within the timeout window), but it can fall down if anything goes wrong (IIS is killed, or the background operations continue too long due to another process hogging the CPU, or there’s a power outage, etc).</p>


  </article>
    
    <footer class="hidden-print">
        
        
        <ul class="pager">
            <li class="previous"><a href="/2012/12/dont-block-in-asynchronous-code.html" title="Don&#39;t Block in Asynchronous Code">&larr; Previous Post</a></li>
            <li class="next"><a href="/2012/12/async-producer-consumer-queue-2-more.html" title="Async Producer-Consumer Queue 2: More Portability">Next Post &rarr;</a></li>
        </ul>

        <div id="comments"></div>
    </footer>
</div>
        </div>
        <div class="col-sm-2 col-md-3 col-md-offset-0 col-lg-2 col-lg-offset-1 affix hidden-print" data-spy="affix" role="navigation">
            
            
        </div>
        <div class="col-sm-2 sidebar hidden-print">
            <div class="panel panel-default">
                <div class="panel-heading">About Stephen Cleary</div>
                <div class="panel-body">
                    <div class="center"><img src="https://stephencleary.com/www.assets/Me-large.jpg"/></div>
                    <div class="center vertical-margins">Stephen Cleary is a <a href="https://stephencleary.com/god/">Christian</a>, husband, father, and programmer living in Northern Michigan.</div>
                    <div class="center"><a href="http://mvp.microsoft.com/en-us/mvp/Stephen%20Cleary-5000058"><img class="mvp-logo" src="https://stephencleary.com/www.assets/MVP.png"/></a></div>
                </div>
            </div>
            <div class="panel panel-primary">
                <div class="panel-heading">My book</div>
                <div class="panel-body center">
                    <div><a href="https://stephencleary.com/book/"><img src="https://stephencleary.com/www.assets/Book-2nd-small.jpg"/></a></div>
                    <div>Available from <a href="http://www.jdoqocy.com/click-7489747-11290546?url=http%3A%2F%2Fshop.oreilly.com%2Fproduct%2F0636920266624.do%3Fcmp%3Daf-code-books-video-product_cj_0636920266624_%25zp&cjsku=0636920266624">O'Reilly (Safari)</a>, <a href="https://amzn.to/2kYzcEY">Amazon (print/Kindle)</a>, or <a href="https://www.ebooks.com/cj.asp?IID=209766469&cjsku=209766469">eBooks.com (PDF/epub)</a>.</div>
                    <div>Also available in <a href="https://www.labirint.ru/books/745595/">Russian</a>, <a href="https://item.jd.com/12769567.html">Chinese</a>, and <a href="https://www.aladin.co.kr/m/mproduct.aspx?itemid=270818316">Korean</a>.</div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Advertisement</div>
                <div><a href="https://brave.com/ste083">Don't like ads? Browse privately and ad-free with Brave!</a></div>
                <div class="panel-body">
                    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2749292939902134" data-ad-slot="7584809820" data-ad-format="auto"></ins>
                </div>
            </div>
            
            <div class="panel panel-primary">
                <div class="panel-heading">Popular Posts</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2012/02/async-and-await.html">Async/await Intro</a></li>
                        <li><a href="/2013/11/there-is-no-thread.html">There Is No Thread</a></li>
                        <li><a href="/2012/07/dont-block-on-async-code.html">Don't Block on Async Code</a></li>
                    </ul>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Series</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2016/02/react-redux-todomvc.html">React/Redux TodoMVC</a></li>
                        <li><a href="/2014/04/a-tour-of-task-part-0-overview.html">A Tour of Task</a></li>
                        <li><a href="/2013/10/taskrun-etiquette-and-proper-usage.html">Task.Run Etiquette</a></li>
                        <li><a href="/2013/05/taskrun-vs-backgroundworker-intro.html">Task.Run vs. BackgroundWorker</a></li>
                        <li><a href="/2013/01/async-oop-0-introduction.html">Async OOP</a></li>
                        <li><a href="/2009/04/tcpip-net-sockets-faq.html">TCP/IP .NET Sockets FAQ</a></li>
                        <li><a href="/2013/10/managed-services-roundup.html">Managed Services</a></li>
                        <li><a href="/2009/08/how-to-implement-idisposable-and.html">IDisposable and Finalizers</a></li>
                        <li><a href="/2011/02/option-parsing-introduction.html">Option Parsing</a></li>
                    </ul>
                </div>
            </div>
            
        </div>
    </div>

    <div class="google">
        <gcse:searchresults></gcse:searchresults>
    </div>
    
    <!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
<script type="text/javascript">window.jQuery || document.write('<script src="/lib/jquery-2.1.1.min.js"><\/script>')</script>

<!-- Bootstrap -->
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script type="text/javascript">window.jQuery.fn.modal || document.write('<script src="/lib/bootstrap.min.js"><\/script>')</script>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('body').css('color') !== 'rgb(102, 102, 102)') {
                $('head').prepend('<link rel="stylesheet" href="/lib/bootstrap.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Font Awesome -->
<span id="facheck" class="fa" style="display:none"></span>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('#facheck').css('fontFamily') !== 'FontAwesome') {
                $('head').prepend('<link rel="stylesheet" href="/lib/font-awesome.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Scroll the sidebar into view (if necessary) -->


<!-- Moment -->
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.6.0/moment.min.js"></script>
<script type="text/javascript">window.moment || document.write('<script src="/lib/moment.min.js"><\/script>')</script>

<!-- Google analytics -->
<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-8910661-5', 'stephencleary.com');
    ga('send', 'pageview');
</script>

<!-- Show appropriate elements based on time -->
<script type="text/javascript">
    (function ($) {
        $(function () {
            var targets = $('[data-hide-after]');
            targets.each(function () {
                var $item = $(this);
                if (moment() < moment($item.attr('data-hide-after'))) {
                    $item.removeClass('hidden');
                }
            });
        });
    })(window.jQuery);
</script>








<script src="/lib/uuid-v3-3.2.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/showdown@1.8.6/dist/showdown.min.js" integrity="sha256-dwhppIrxD8qC6lNulndZgtIm4XBU9zoMd9OUoXzIDAE=" crossorigin="anonymous"></script>
<script src="/lib/sanitize-html-1.18.2.min.js"></script>
<script src="/lib/autosize.min.js"></script>
<script src="/lib/base64js.min.js"></script>
<script src="/lib/md5.min.js"></script>

<script type="text/javascript">

var pageUrl = "https://blog.stephencleary.com" + "/2012/12/returning-early-from-aspnet-requests.html";

// (unnecessary) 1) If the URL starts with http://, replace with https://

// 2) Take the URL path (not including scheme and domain).
var url = document.createElement('a');
url.href = pageUrl; //'https://developer.mozilla.org:8080/en-US/search?q=URL#search-results-close-container';
var path = url.pathname;

// 3) Path: If the path ends with .html or any two- to six-character [A-Za-z0-9] extension, strip it.
if (path.endsWith(".html"))
    path = path.substr(0, path.length - 5);
else
    path = path.replace(/\.[A-Za-z0-9]{2,6}$/, "");

// 4) Path: For each UTF-16 code unit, if it's not in the whitelist [A-Za-z0-9-_;.~()], then replace it with _.
path = path.replace(/[^-A-Za-z0-9_;.~()]/g, "_");

// 5) Path: Trim leading and trailing _ characters.
path = path.replace(/^_+|_+$/g, "");

// 6) Calculate the V3 URL GUID for the URL.
var guid = uuidv3(pageUrl, uuidv3.URL);

// 7) Combine the path and lowercase-hyphenated GUID, separated by '-'.
var postId = path + "-" + guid;

var nofollowLinkExtension = {
    type: 'output',
    regex: /(<a[^<]+<\/a>)/g,
    replace: (match, $1, $2) => {
        var result = $('<div/>').append($($1).attr('rel', 'nofollow noopener')).html();
        return result;
    }
};
showdown.extension('nofollowLink', nofollowLinkExtension);

var comments;
var markdownConverter = new showdown.Converter({
    omitExtraWLInCodeBlocks: true,
    noHeaderId: true,
    headerLevelStart: 3,
    simplifiedAutoLink: true,
    excludeTrailingPunctuationFromURLs: true,
    literalMidWordUnderscores: true,
    strikethrough: true,
    smoothLivePreview: true,
    disableForced4SpacesIndentedSublists: true,
    extensions: ['nofollowLink']
});
var sanitizeOptions = {
    allowedTags: [ 'blockquote', 'p', 'a', 'ul', 'ol', 'nl', 'li', 'b', 'i', 'strong', 'em', 'strike', 'code', 'br', 'div', 'pre', 'img' ],
    allowedAttributes: {
        a: [
            'href',
            {
                name: 'rel',
                multiple: true,
                values: ['nofollow', 'noopener']
            }
        ],
        img: [ 'src' ]
    },
    allowedIframeHostnames: []
};

function fixedEncodeURIComponent(str) {
  return encodeURIComponent(str).replace(/[!'()*]/g, function(c) {
    return '%' + c.charCodeAt(0).toString(16);
  });
}

function filterComments(replyTo) {
    return comments
        .filter(function (x) { return x.replyTo === replyTo; })
        .sort(function (a, b) { return a.timestamp - b.timestamp; });
}

function avatarUri(authorEmailMD5) {
    if (authorEmailMD5 === "")
        return "https://www.gravatar.com/avatar/?d=mp&f=y";
    else
        return "https://www.gravatar.com/avatar/" + authorEmailMD5 + "?d=retro";
}

var jwk = {"kty":"RSA","alg":"RSA-OAEP","n":"wviXqUJGtV8hZrvJMcTbyzm7MmiJSqsAfWI_7pCyAhXXzz5C9F3NtXp79CCUMqkOck6IbNKUntPtGNOGwtoc5LTJNKLhx3TPi4TJyKUSfNr3pAdLpMRNeeRXCHFyyVsDb6z8ueixlKzdbDpZhV05bam49PurMHfeexJ3EJy2NpdFviykRJxtrERi6ckBe96VMlT_pHHIWLN5EwOK54DvNn1DYjiFK5ux5WRCFatZByzytrFvIllZRctNXZ8oTuMjQwKLY2bUrURblbIvLfX-9Yd7uVgdUSFE7-vSel9-DMyp_NQ-NRXrQbJG7IAYhSGSx-TPepCDPbFpMq3yC0iET7wF7-OQOb-Kwej_TKVJv-z4SbN-cpCqaMr5Q9scyGih7xr1YrOhe3TMs_cbgjtxsZbzkOqcuRreON_sGb9nlDpSIFCo6aH47GeMkA23Hk3HXAPyYQ7AfWhU9daiPcySiAFnfkrg2QvFNJmMSZ-bo4Co-JkjiqKw-LEpOw6Ed9LK4walxWUAqPGcT4_Uys3TH9XVex9_rEmigHXiJY3_Lwi6mTSkW10-zen5UXxqnyHpMxlmumohT96OyLyhEPeaaq8FrTYMCX8TiMOst3jF5QCNP-LFz21yeUEAr5_3-FKV2mjWEU9iW0dOOVTII2rlD0WtCkqkDwZtakQ1ynGdW1E","e":"AQAB"};

function commentId(id) { return "comment-" + id; }

function $commentForm(hideForm, comment) {
    var $previewDiv = $('<div/>');
    var $authorEmailEncrypted = $('<input type="hidden" name="authorEmailEncrypted">');
    var $authorEmailMD5 = $('<input type="hidden" name="authorEmailMD5">');
    var $email = $('<input type="email" name="email" class="form-control" placeholder="Email">');
    var $name = $('<input type="text" name="authorName" class="form-control" placeholder="Name">');
    var $url = $('<input type="url" name="authorUri" class="form-control" placeholder="Url">');
    var $message = $('<textarea name="message" class="form-control" placeholder="Message"/></textarea>');
    autosize($message);
    var $replyTo = $('<input type="hidden" name="replyTo">').val("");
    var $recaptcha = $('<div class="g-recaptcha" data-sitekey="6LfSaV8UAAAAAEFq-7HeUDiSQCkCtLtO_yc_SOi_"></div>');
    var $buttonBar = $('<div class="comment-form-buttonbar"/>').append($('<button type="submit" class="btn btn-primary pull-right">Submit</button>'), $recaptcha);
    var $form = $('<form method="POST" action="https://blogcomments.azurewebsites.net/api/Function1"/>')
        .append($('<input type="hidden" name="postId">').val(postId))
        .append($('<input type="hidden" name="postUri">').val(location.href.replace(/#.*/, '')))
        .append($replyTo)
        .append($authorEmailEncrypted)
        .append($authorEmailMD5)
        .append($('<div class="form-group"><label>Name (optional)</label></div>').append($name))
        .append($('<div class="form-group"><label>Email (optional; always encrypted, never shared)</label></div>').append($email))
        .append($('<div class="form-group"><label>Url (optional; must start with "http://" or "https://")</label></div>').append($url))
        .append($('<div class="form-group"><label>Message (supports some Markdown/HTML)</label></div>').append($message));
    if (comment) {
        $replyTo.val(comment._id);
    }
    const serialize_form = form => JSON.stringify(
        Array.from(new FormData(form).entries())
            .reduce((m, [ key, value ]) => Object.assign(m, { [key]: value }), {})
    );
    $form.submit(function (e) {
        e.preventDefault();
        hideForm();
        var postAction = $form.attr('action');
        var postBody = serialize_form($form.get(0));
        console.log(postBody);
        var retries = 5;

        function postIt() {
            var post = $.post(postAction, postBody, "json");
            post.done(function () {
                alert("Comment successfully posted. It should appear on this page in a minute or so.");
            });
            post.error(function () {
                var message = "Failed to post comment";
                if (post.responseText)
                    message += ": " + post.responseText;
                
                if (--retries > 0) {
                    console.log(message);
                    postIt();
                } else {
                    alert(message);
                }
            });
        }

        postIt();
    });

    function createComment() {
        return normalizeComment({
            date: moment().format(),
            _id: "_",
            replyTo: comment ? comment._id : undefined,
            authorName: $name.val(),
            authorEmailMD5: $authorEmailMD5.val(),
            authorUri: $url.val(),
            message: $message.val()
        });
    };

    function recreatePreview() {
        var email = $email.val();
        if (email && email.indexOf("@") !== -1) {
            var data = new TextEncoder().encode($email.val());
            window.crypto.subtle.importKey("jwk", jwk, { name: "RSA-OAEP", hash: { name: "SHA-1" } }, false, ["encrypt"]).then(function (encryptionKey) {
                return window.crypto.subtle.encrypt({ name: "RSA-OAEP" }, encryptionKey, data)
                    .then(function (encrypted) {
                        var array = new Uint8Array(encrypted);
                        var text = base64js.fromByteArray(array);
                        $authorEmailEncrypted.val(text);
                        return text;
                    });
            });
            $authorEmailMD5.val(md5($email.val().replace(/^ +| +$/g, '').toLowerCase()));
        } else {
            $authorEmailMD5.val("");
            $authorEmailEncrypted.val("");
        }

        var $newPreview = $comment(false, createComment());
        // Turn off permalink and anchor
        var $anchor = $newPreview.find('.comment-date a');
        $anchor.replaceWith($('<span/>').text($anchor.text()));
        $newPreview.find('.comment-anchor').remove();
        $previewDiv.empty();
        $previewDiv.append($newPreview);
    };

    recreatePreview();
    $name.on('change keyup input paste', recreatePreview);
    $email.on('change keyup input paste', recreatePreview);
    $url.on('change keyup input paste', recreatePreview);
    $message.on('change keyup input paste', recreatePreview);

    $form.append($('<h3>Preview:</h3>'), $previewDiv, $buttonBar);
    return {
        $form: $('<div class="comment-form"/>').append($form),
        onShow: function() { grecaptcha.render($recaptcha[0]); }
    };
}

function $replyButton(comment) {
    var $button;
    if (comment)
        $button = $('<button class="btn btn-primary comment-reply"><i class="fa fa-reply"></i> Reply</button>');
    else
        $button = $('<button class="btn btn-primary comment-new"><i class="fa fa-plus-square"></i> New Comment</button>');
    return $button;
}

var now = moment();
function $comment(includeForm, comment) {
    var message = sanitizeHtml(markdownConverter.makeHtml(comment.message), sanitizeOptions);
    var $commentDiv = $('<div class="comment"/>');
    var publicationDate = moment(comment.date);
    var $author = $('<div class="comment-author"/>').append($('<span class="comment-author-name"/>').text(comment.authorName));
    if (comment.authorUri !== "")
        $author.append($('<span> • </span>'), $('<a class="comment-author-uri" rel="nofollow noopener"/>').attr('href', comment.authorUri).text(comment.authorUri));
    var $headerDiv = $('<div class="comment-header"/>').append(
        $('<div class="comment-author-profile" style="float:left;"/>').append($('<img class="comment-author-profile-image" src="' + avatarUri(comment.authorEmailMD5) + '"/>')),
        $author,
        $('<div class="comment-date" />').append(
            $('<a/>').attr('href', '#' + commentId(comment._id)).attr('title', 'permalink').text(publicationDate.from(now) + ' (' + publicationDate.format('YYYY-MM-DD hh:mm:ss a') + ')')
        )
    );
    if (comment.replyTo !== "") {
        var parent = comments.filter(function (x) { return x._id === comment.replyTo })[0];
        $headerDiv.append($('<div/>').append($('<a/>').attr('href', '#' + commentId(comment.replyTo)).text('In reply to ' + parent.authorName)));
    }

    $commentDiv.append($('<div class="comment-anchor"/>').attr('id', commentId(comment._id)),
        $headerDiv,
        $('<div class="comment-message" style="clear:both;"/>').html(message)
    );

    var $commentContainer = $('<div class="comment-container"/>').append($commentDiv);
    if (includeForm)
        $commentContainer.append($expandCollapseForm(comment));
    var childComments = filterComments(comment._id);
    for (var i = 0; i != childComments.length; ++i) {
        var child = childComments[i];
        $commentContainer.append($comment(includeForm, child));
    }

    return $commentContainer;
}

function normalizeComment(x) {
    var uri = x.authorUri;
    if (!uri || (!uri.startsWith("http://") && !uri.startsWith("https://")))
        uri = "";
    return {
            _id: x._id,
            authorName: x.authorName || "Anonymous",
            authorEmailMD5: x.authorEmailMD5 || "",
            authorUri: uri,
            message: x.message || "",
            replyTo: x.replyTo || "",
            date: x.date,
            timestamp: moment(x.date).valueOf()
    };
}

function $expandCollapseForm(comment) {
    var $button = $replyButton(comment);
    var formObj = $commentForm(hideForm, comment);
    var $form = formObj.$form.addClass("comment-hidden");
    var onShow = formObj.onShow;
    function showForm() {
        $button.addClass("comment-hidden");
        if (onShow) {
            onShow();
            onShow = null;
        }
        $form.removeClass("comment-hidden");
    }
    function hideForm() {
        $form.addClass("comment-hidden");
        $button.removeClass("comment-hidden");
    }
    $button.click(showForm);
    return $('<div/>').append($button, $form);
}

function recaptchaLoaded() {
    var req = new XMLHttpRequest();
    req.addEventListener("load", function () {
        var $commentDiv = $('#comments');
        if (req.status === 404 || req.status === 200) {
            if (req.status === 404) {
                comments = [];
            } else {
                comments = JSON.parse(req.responseText).map(normalizeComment);
            }
            var commentCounter = document.getElementById('comment-counter');
            commentCounter.innerText = comments.length + " " + commentCounter.innerText;
            var toplevelComments = filterComments("");
            for (var i = 0; i != toplevelComments.length; ++i) {
                var comment = toplevelComments[i];
                $commentDiv.append($comment(true, comment));
            }
            if (comments.length !== 0) {
                $commentDiv.append($expandCollapseForm());
            }
        }
        $commentDiv.prepend($expandCollapseForm());
    });
    req.open('GET', "https://comments.stephencleary.com/" + postId + ".json");
    req.send();
}
</script>

<script src="https://www.google.com/recaptcha/api.js?onload=recaptchaLoaded&amp;render=explicit"></script>



<!-- Google AdSense -->
<script src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- Moment -->
<script type="text/javascript">
    (function($) {
        $(function () {
            $('time').each(function (_, e) {
                var startOfToday = moment().startOf('day');
                var publicationDate = moment($(e).attr('datetime'), 'YYYY-MM-DD');
                var difference = startOfToday.diff(publicationDate, 'days');
                var text = difference === 0 ? 'Today' :
                    difference === 1 ? 'Yesterday' :
                    publicationDate.from(startOfToday);
                $(e).text(function(_, oldText) { return text + ' (' + oldText + ')'; });
            });
        });
    })(window.jQuery);
</script>




</body>
</html>