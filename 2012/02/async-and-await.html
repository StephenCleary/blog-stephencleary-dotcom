<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Async and Await</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Most people have already heard about the new “async” and “await” functionality coming in Visual Studio 11. This is Yet Another Introductory Post." />
    <link rel="canonical" href="https://blog.stephencleary.com/2012/02/async-and-await.html" />
    
    <link rel="alternate" type="application/rss+xml" title="Stephen Cleary (the blog)" href="http://feeds.feedburner.com/NitoPrograms" />
    
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/bootswatch/3.2.0/spacelab/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" />
    <style type="text/css">/* Layout Styles */
/* ----------------------------------------------------------*/

body {
    padding-top: 50px;
}

.affix {
    top: 70px;
    bottom: 0;
    overflow-y: auto;
}

.navbar-brand {
    font-weight: bold;
}

.navbar-brand-container.active>a, .navbar-brand-container.active>a:hover, .navbar-brand-container.active>a:focus {
    color: #3399f3;
    background-color: transparent;
}

.sidebar {
    margin-top: 20px;
}

.sidenavitem {
    height: auto;
}

.sidebar img {
    /* Responsive images */
    display: inline-block;
    height: auto;
    max-width: 100%;
}

@media(max-width:767px) {
    .affix {
        position: static;
    }
}

div .vertical-margins {
    margin-top: 10px;
    margin-bottom: 10px;
}

.page-header {
    margin-top: 20px;
}

.center {
    text-align: center;
}

.project-icon {
    height: 128px;
    width: 128px;
}

.list-group-item h2 {
    margin-top: 10px;
}

/* Fixes for Google Custom Search in a Bootstrap page */
/* ----------------------------------------------------------*/
.google, .google *, .google *:before, .google *:after {
    -webkit-box-sizing: content-box;
    -moz-box-sizing: content-box;
    box-sizing: content-box;
}

.google table {
    border-collapse: separate;
}

.gsc-input-box {
    height: auto !important;
}

/* Fixes for Amazon widget in Bootstrap page */
.amzn_wdgt * {
    -webkit-box-sizing: content-box;
    -moz-box-sizing: content-box;
    box-sizing: content-box;
}

/* Post styles */
/* ----------------------------------------------------------*/

code {
    background-color: #F2F3F9;
    color: inherit;
}

.post img {
    /* Responsive images */
    display: inline-block;
    height: auto;
    max-width: 100%;
}

.post .table {
    table-layout: fixed;
}

.post .table code {
    white-space: normal;
}

.post .yes {
    color: #008000;
}

.post .no {
    color: #FF0000;
}

/* Syntax highlighting styles */
/* ----------------------------------------------------------*/

.highlight  { background: #ffffff; }
.highlight .c { color: #008000 } /* Comment */
.highlight .k { color: #0000ff } /* Keyword */
.highlight .cm { color: #008000 } /* Comment.Multiline */
.highlight .cp { color: #0000ff } /* Comment.Preproc */
.highlight .c1 { color: #008000 } /* Comment.Single */
.highlight .cs { color: #008000 } /* Comment.Special */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gh { font-weight: bold } /* Generic.Heading */
.highlight .gp { font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { font-weight: bold } /* Generic.Subheading */
.highlight .kc { color: #0000ff } /* Keyword.Constant */
.highlight .kd { color: #0000ff } /* Keyword.Declaration */
.highlight .kn { color: #0000ff } /* Keyword.Namespace */
.highlight .kp { color: #0000ff } /* Keyword.Pseudo */
.highlight .kr { color: #0000ff } /* Keyword.Reserved */
.highlight .kt { color: #2b91af } /* Keyword.Type */
.highlight .s { color: #a31515 } /* Literal.String */
.highlight .nc { color: #2b91af } /* Name.Class */
.highlight .ow { color: #0000ff } /* Operator.Word */
.highlight .sb { color: #a31515 } /* Literal.String.Backtick */
.highlight .sc { color: #a31515 } /* Literal.String.Char */
.highlight .sd { color: #a31515 } /* Literal.String.Doc */
.highlight .s2 { color: #a31515 } /* Literal.String.Double */
.highlight .se { color: #a31515 } /* Literal.String.Escape */
.highlight .sh { color: #a31515 } /* Literal.String.Heredoc */
.highlight .si { color: #a31515 } /* Literal.String.Interpol */
.highlight .sx { color: #a31515 } /* Literal.String.Other */
.highlight .sr { color: #a31515 } /* Literal.String.Regex */
.highlight .s1 { color: #a31515 } /* Literal.String.Single */
.highlight .ss { color: #a31515 } /* Literal.String.Symbol */

/* Comments */
/* ----------------------------------------------------------*/

.comment-container {
    margin-top: 1em;
}

.comment-container > .comment-container {
    margin-left: 2em;
}

.comment-container > .comment-container > .comment-container > .comment-container > .comment-container {
    margin-left: 0;
}

/* Correct anchor links in comments (they are offset by the height of the fixed header) */
.comment-anchor {
    display: block;
    position: relative;
    top: -60px;
    visibility: hidden;
}

img.comment-author-profile-image {
    height: 80px;
    width: 80px;
    margin-right: 10px;
}

.comment-message {
    overflow-x: auto;
}

.comment-form {
    border: 1px solid black;
    padding: 1em;
}

.comment-new {
    margin-top: 1em;
    margin-bottom: 1em;
}

.comment-new, .comment-reply {
    margin-left: 1em;
}

.comment-hidden {
    display: none;
}

.comment-form-buttonbar {
    margin-top: 1em;
}
</style>
    
    <meta name="application-name" content="Stephen Cleary" />
    <link rel="search" type="application/opensearchdescription+xml" href="https://stephencleary.com/opensearch.xml" title="Cleary Search">
    <link rel="apple-touch-icon" sizes="57x57" href="https://stephencleary.com/icons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="https://stephencleary.com/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://stephencleary.com/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://stephencleary.com/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="https://stephencleary.com/icons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="https://stephencleary.com/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="https://stephencleary.com/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://stephencleary.com/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" href="https://stephencleary.com/icons/apple-touch-icon.png"/>
    <link rel="apple-touch-icon-precomposed" href="https://stephencleary.com/icons/apple-touch-icon-precomposed.png"/>
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-196x196.png" sizes="196x196">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-32x32.png" sizes="32x32">
    
    <meta name="google-site-verification" content="L8q0fpGSwpNSD0OGFI07hyMujSpORrV4tAaNx_Js7oQ" />
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <div class="navbar-brand-container"><a class="navbar-brand" href="https://stephencleary.com">Stephen Cleary</a></div>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
            <li  class="active"  ><a href="https://blog.stephencleary.com">Blog</a></li>
            <li ><a href="https://stephencleary.com/videos/">Videos</a></li>
            <li  ><a href="https://stephencleary.com/projects/">Projects</a></li>
            <li  ><a href="https://stephencleary.com/publications/">Publications</a></li>
            <li  ><a href="https://stephencleary.com/book/">Book</a></li>
            <li  ><a href="https://stephencleary.com/contact/">Contact</a></li>
            <li><a href="http://feeds.feedburner.com/NitoPrograms"><i class="fa fa-rss-square fa-lg"></i></a></li>
            <li  ><a href="https://stephencleary.com/search/"><i class="fa fa-search"></i></a></li>
        </ul>
    </div>
</nav>

    <div class="container-fluid">
        <div class="col-sm-8 col-sm-offset-2 col-md-6 col-md-offset-3">
            <div class="post">

  <header>
      <div class="page-header">
          <h1>Async and Await</h1>
          <small><time datetime="2012-02-02">Feb 2, 2012</time> &bull; <a id="comment-counter" href="#comments">Comments</a></small>
      </div>
  </header>

  <header>
    <div class="alert alert-info" markdown="1">
        <i class="fa fa-hand-o-right fa-2x pull-left"></i>
        
        <div>Has this blog been helpful? Please consider <a href="https://github.com/sponsors/StephenCleary" class="alert-link">supporting this blog (and my open-source libraries).</a> Thanks!</div>
        <div><i>For a limited time, GitHub will match your support.</i></div>
    </div>
  </header>

  <article>
  <p>Most people have already heard about the new “async” and “await” functionality coming in Visual Studio 11. This is Yet Another Introductory Post.</p>

<p>First, the punchline: Async will fundamentally change the way most code is written.</p>

<p>Yup, I believe async/await will have a bigger impact than LINQ. Understanding async will be a basic necessity just a few short years from now.</p>

<h2 id="introducing-the-keywords">Introducing the Keywords</h2>

<p>Let’s dive right in. I’ll use some concepts that I’ll expound on later on - just hold on for this first part.</p>

<p>Asynchronous methods look something like this:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">DoSomethingAsync</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">// In the Real World, we would actually do something...</span>
  <span class="c1">// For this example, we&#39;re just going to (asynchronously) wait 100ms.</span>
  <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>The “async” keyword enables the “await” keyword in that method and changes how method results are handled. <em>That’s all the async keyword does!</em> It does not run this method on a thread pool thread, or do any other kind of magic. The async keyword <em>only</em> enables the await keyword (and manages the method results).</p>

<p>The beginning of an async method is executed just like any other method. That is, it runs synchronously until it hits an “await” (or throws an exception).</p>

<p>The “await” keyword is where things can get asynchronous. Await is like a unary operator: it takes a single argument, an <strong>awaitable</strong> (an “awaitable” is an asynchronous operation). Await examines that awaitable to see if it has already completed; if the awaitable has already completed, then the method just continues running (synchronously, just like a regular method).</p>

<p>If “await” sees that the awaitable has not completed, then it acts asynchronously. It tells the awaitable to run the remainder of the method when it completes, and then <em>returns</em> from the async method.</p>

<p>Later on, when the awaitable completes, it will execute the remainder of the async method. If you’re awaiting a built-in awaitable (such as a task), then the remainder of the async method will execute on a “context” that was captured before the “await” returned.</p>

<p>I like to think of “await” as an “asynchronous wait”. That is to say, the async <em>method</em> pauses until the awaitable is complete (so it <em>waits</em>), but the actual <em>thread</em> is not blocked (so it’s <em>asynchronous</em>).</p>

<h2 id="awaitables">Awaitables</h2>

<p>As I mentioned, “await” takes a single argument - an “awaitable” - which is an asynchronous operation. There are two awaitable types already common in the .NET framework: Task&lt;T&gt; and Task.</p>

<p>There are also other awaitable types: special methods such as “Task.Yield” return awaitables that are not Tasks, and the WinRT runtime (coming in Windows 8) has an unmanaged awaitable type. You can also create your own awaitable (usually for performance reasons), or use extension methods to make a non-awaitable type awaitable.</p>

<p>That’s all I’m going to say about making your own awaitables. I’ve only had to write a couple of awaitables in the entire time I’ve used async/await. If you want to know more about writing your own awaitables, see the <a href="https://devblogs.microsoft.com/pfxteam/">Parallel Team Blog</a> or <a href="http://codeblog.jonskeet.uk/">Jon Skeet’s Blog</a>.</p>

<p>One important point about awaitables is this: it is the <em>type</em> that is awaitable, not the method returning the type. In other words, you can await the result of an async method that returns Task … <em>because the method returns Task, not because it’s async</em>. So you can also await the result of a <em>non-async</em> method that returns Task:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">NewStuffAsync</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">// Use await and have fun with the new stuff.</span>
  <span class="k">await</span> <span class="p">...</span>
<span class="p">}</span>

<span class="k">public</span> <span class="n">Task</span> <span class="nf">MyOldTaskParallelLibraryCode</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">// Note that this is not an async method, so we can&#39;t use await in here.</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">ComposeAsync</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">// We can await Tasks, regardless of where they come from.</span>
  <span class="k">await</span> <span class="nf">NewStuffAsync</span><span class="p">();</span>
  <span class="k">await</span> <span class="nf">MyOldTaskParallelLibraryCode</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<div class="alert alert-info">
  <p><i class="fa fa-hand-o-right fa-2x pull-left"></i></p>

  <p>Tip: If you have a very simple asynchronous method, you may be able to write it without using the await keyword (e.g., returning a task from another method). However, be aware that there are <a href="/2016/12/eliding-async-await.html">pitfalls when eliding <code>async</code> and <code>await</code></a>.</p>
</div>

<h2 id="return-types">Return Types</h2>

<p>Async methods can return Task&lt;T&gt;, Task, or void. In almost all cases, you want to return Task&lt;T&gt; or Task, and return void only when you have to.</p>

<p>Why return Task&lt;T&gt; or Task? Because they’re awaitable, and void is not. So if you have an async method returning Task&lt;T&gt; or Task, then you can pass the result to await. With a void method, you don’t have anything to pass to await.</p>

<p>You have to return void when you have async event handlers.</p>

<div class="alert alert-info">
  <p><i class="fa fa-hand-o-right fa-2x pull-left"></i></p>

  <p>You can also use async void for other “top-level” kinds of actions - e.g., a single “static async void MainAsync()” for Console programs. However, this use of async void has its own problem; see <a href="/2012/02/async-console-programs.html" class="alert-link">Async Console Programs</a>. The primary use case for async void methods is event handlers.</p>
</div>

<h2 id="returning-values">Returning Values</h2>

<p>Async methods returning Task or void do not have a return value. Async methods returning Task&lt;T&gt; must return a value of type T:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">CalculateAnswer</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="m">100</span><span class="p">);</span> <span class="c1">// (Probably should be longer...)</span>

  <span class="c1">// Return a type of &quot;int&quot;, not &quot;Task&lt;int&gt;&quot;</span>
  <span class="k">return</span> <span class="m">42</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>This is a bit odd to get used to, but there are <a href="/2011/09/async-ctp-why-do-keywords-work-that-way.html">good reasons</a> behind this design.</p>

<h2 id="context">Context</h2>

<p>In the overview, I mentioned that when you await a built-in awaitable, then the awaitable will capture the current “context” and later apply it to the remainder of the async method. What exactly is that “context”?</p>

<p>Simple answer:</p>

<ol>
  <li>If you’re on a UI thread, then it’s a UI context.</li>
  <li>If you’re responding to an ASP.NET request, then it’s an ASP.NET request context.</li>
  <li>Otherwise, it’s usually a thread pool context.</li>
</ol>

<p>Complex answer:</p>

<ol>
  <li>If SynchronizationContext.Current is not null, then it’s the current SynchronizationContext. (UI and ASP.NET request contexts are SynchronizationContext contexts).</li>
  <li>Otherwise, it’s the current TaskScheduler (TaskScheduler.Default is the thread pool context).</li>
</ol>

<p>What does this mean in the real world? For one thing, capturing (and restoring) the UI/ASP.NET context is done transparently:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="c1">// WinForms example (it works exactly the same for WPF).</span>
<span class="k">private</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">DownloadFileButton_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Since we asynchronously wait, the UI thread is not blocked by the file download.</span>
  <span class="k">await</span> <span class="nf">DownloadFileAsync</span><span class="p">(</span><span class="n">fileNameTextBox</span><span class="p">.</span><span class="n">Text</span><span class="p">);</span>

  <span class="c1">// Since we resume on the UI context, we can directly access UI elements.</span>
  <span class="n">resultTextBox</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="s">&quot;File downloaded!&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ASP.NET example</span>
<span class="k">protected</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">MyButton_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Since we asynchronously wait, the ASP.NET thread is not blocked by the file download.</span>
  <span class="c1">// This allows the thread to handle other requests while we&#39;re waiting.</span>
  <span class="k">await</span> <span class="nf">DownloadFileAsync</span><span class="p">(...);</span>

  <span class="c1">// Since we resume on the ASP.NET context, we can access the current request.</span>
  <span class="c1">// We may actually be on another *thread*, but we have the same ASP.NET request context.</span>
  <span class="n">Response</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&quot;File downloaded!&quot;</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>This is great for event handlers, but it turns out to not be what you want for most other code (which is, really, most of the async code you’ll be writing).</p>

<h2 id="avoiding-context">Avoiding Context</h2>

<p>Most of the time, you don’t <em>need</em> to sync back to the “main” context. Most async methods will be designed with composition in mind: they await other operations, and each one represents an asynchronous operation itself (which can be composed by others). In this case, you want to tell the awaiter to <em>not</em> capture the current context by calling <strong>ConfigureAwait</strong> and passing false, e.g.:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">DownloadFileAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">fileName</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Use HttpClient or whatever to download the file contents.</span>
  <span class="kt">var</span> <span class="n">fileContents</span> <span class="p">=</span> <span class="k">await</span> <span class="n">DownloadFileContentsAsync</span><span class="p">(</span><span class="n">fileName</span><span class="p">).</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>

  <span class="c1">// Note that because of the ConfigureAwait(false), we are not on the original context here.</span>
  <span class="c1">// Instead, we&#39;re running on the thread pool.</span>

  <span class="c1">// Write the file contents out to a disk file.</span>
  <span class="k">await</span> <span class="nf">WriteToDiskAsync</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">fileContents</span><span class="p">).</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>

  <span class="c1">// The second call to ConfigureAwait(false) is not *required*, but it is Good Practice.</span>
<span class="p">}</span>

<span class="c1">// WinForms example (it works exactly the same for WPF).</span>
<span class="k">private</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">DownloadFileButton_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Since we asynchronously wait, the UI thread is not blocked by the file download.</span>
  <span class="k">await</span> <span class="nf">DownloadFileAsync</span><span class="p">(</span><span class="n">fileNameTextBox</span><span class="p">.</span><span class="n">Text</span><span class="p">);</span>

  <span class="c1">// Since we resume on the UI context, we can directly access UI elements.</span>
  <span class="n">resultTextBox</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="s">&quot;File downloaded!&quot;</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>The important thing to note with this example is that each “level” of async method calls has its own context. DownloadFileButton_Click started in the UI context, and called DownloadFileAsync. DownloadFileAsync also started in the UI context, but then stepped out of its context by calling ConfigureAwait(false). The rest of DownloadFileAsync runs in the thread pool context. However, when DownloadFileAsync completes and DownloadFileButton_Click resumes, it <em>does</em> resume in the UI context.</p>

<p>A good rule of thumb is to use ConfigureAwait(false) unless you know you <em>do</em> need the context.</p>

<h2 id="async-composition">Async Composition</h2>

<p>So far, we’ve only considered serial composition: an async method waits for one operation at a time. It’s also possible to start several operations and await for one (or all) of them to complete. You can do this by starting the operations but not awaiting them until later:</p>

<pre><code>public async Task DoOperationsConcurrentlyAsync()
{
  Task[] tasks = new Task[3];
  tasks[0] = DoOperation0Async();
  tasks[1] = DoOperation1Async();
  tasks[2] = DoOperation2Async();

  // At this point, all three tasks are running at the same time.

  // Now, we await them all.
  await Task.WhenAll(tasks);
}

public async Task&lt;int&gt; GetFirstToRespondAsync()
{
  // Call two web services; take the first response.
  Task&lt;int&gt;[] tasks = new[] { WebService1Async(), WebService2Async() };

  // Await for the first one to respond.
  Task&lt;int&gt; firstTask = await Task.WhenAny(tasks);

  // Return the result.
  return await firstTask;
}
</code></pre>

<p>By using concurrent composition (Task.WhenAll or Task.WhenAny), you can perform simple concurrent operations. You can also use these methods along with Task.Run to do simple parallel computation. However, this is not a substitute for the Task Parallel Library - any advanced CPU-intensive parallel operations should be done with the TPL.</p>

<h2 id="guidelines">Guidelines</h2>

<p>Read the <a href="http://www.microsoft.com/download/en/details.aspx?id=19957">Task-based Asynchronous Pattern (TAP) document</a>. It is extremely well-written, and includes guidance on API design and the proper use of async/await (including cancellation and progress reporting).</p>

<p>There are many new await-friendly techniques that should be used instead of the old blocking techniques. If you have any of these Old examples in your new async code, you’re Doing It Wrong(TM):</p>

<div class="panel panel-default">

  <table class="table table-striped">
    <thead>
      <tr>
        <th>Old</th>
        <th>New</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>task.Wait</td>
        <td>await task</td>
        <td>Wait/await for a task to complete</td>
      </tr>
      <tr>
        <td>task.Result</td>
        <td>await task</td>
        <td>Get the result of a completed task</td>
      </tr>
      <tr>
        <td>Task.WaitAny</td>
        <td>await Task.WhenAny</td>
        <td>Wait/await for one of a collection of tasks to complete</td>
      </tr>
      <tr>
        <td>Task.WaitAll</td>
        <td>await Task.WhenAll</td>
        <td>Wait/await for every one of a collection of tasks to complete</td>
      </tr>
      <tr>
        <td>Thread.Sleep</td>
        <td>await Task.Delay</td>
        <td>Wait/await for a period of time</td>
      </tr>
      <tr>
        <td>Task constructor</td>
        <td>Task.Run or TaskFactory.StartNew</td>
        <td>Create a code-based task</td>
      </tr>
    </tbody>
  </table>

</div>

<h2 id="next-steps">Next Steps</h2>

<p>I have published an MSDN article <a href="http://msdn.microsoft.com/en-us/magazine/jj991977.aspx">Best Practices in Asynchronous Programming</a>, which further explains the “avoid async void”, “async all the way” and “configure context” guidelines.</p>

<p>The <a href="http://msdn.microsoft.com/en-us/library/hh191443.aspx">official MSDN documentation</a> is quite good; they include an online version of the <a href="http://msdn.microsoft.com/en-us/library/hh873175.aspx">Task-based Asynchronous Pattern document</a> which is excellent, covering the designs of asynchronous methods.</p>

<p>The async team has published an <a href="https://devblogs.microsoft.com/pfxteam/asyncawait-faq/">async/await FAQ</a> that is a great place to continue learning about async. They have pointers to the best blog posts and videos on there. Also, pretty much any blog post by <a href="https://devblogs.microsoft.com/pfxteam/author/toub/">Stephen Toub</a> is instructive!</p>

<p>Of course, another resource is my own blog.</p>

<div class="alert alert-info">
  <p><i class="fa fa-hand-o-right fa-2x pull-left"></i></p>

  <p>My <a href="https://stephencleary.com/book/" class="alert-link">Concurrency Cookbook</a> covers a wide range of use cases for <code>async</code> and <code>await</code>, and also covers situations when you should use the Task Parallel Library, Rx, or TPL Dataflow instead.</p>
</div>


  </article>
    
    <footer class="hidden-print">
        
        
        <ul class="pager">
            <li class="previous"><a href="/2011/12/out-for-bit.html" title="Out for a Bit">&larr; Previous Post</a></li>
            <li class="next"><a href="/2012/02/async-console-programs.html" title="Async Console Programs">Next Post &rarr;</a></li>
        </ul>

        <div id="comments"></div>
    </footer>
</div>
        </div>
        <div class="col-sm-2 col-md-3 col-md-offset-0 col-lg-2 col-lg-offset-1 affix hidden-print" data-spy="affix" role="navigation">
            
            
        </div>
        <div class="col-sm-2 sidebar hidden-print">
            <div class="panel panel-default">
                <div class="panel-heading">About Stephen Cleary</div>
                <div class="panel-body">
                    <div class="center"><img src="https://stephencleary.com/www.assets/Me-large.jpg"/></div>
                    <div class="center vertical-margins">Stephen Cleary is a <a href="https://stephencleary.com/god/">Christian</a>, husband, father, and programmer living in Northern Michigan.</div>
                    <div class="center"><a href="http://mvp.microsoft.com/en-us/mvp/Stephen%20Cleary-5000058"><img class="mvp-logo" src="https://stephencleary.com/www.assets/MVP.png"/></a></div>
                </div>
            </div>
            <div class="panel panel-primary">
                <div class="panel-heading">My book</div>
                <div class="panel-body center">
                    <div><a href="https://stephencleary.com/book/"><img src="https://stephencleary.com/www.assets/Book-2nd-small.jpg"/></a></div>
                    <div>Available from <a href="http://www.jdoqocy.com/click-7489747-11290546?url=http%3A%2F%2Fshop.oreilly.com%2Fproduct%2F0636920266624.do%3Fcmp%3Daf-code-books-video-product_cj_0636920266624_%25zp&cjsku=0636920266624">O'Reilly (Safari)</a>, <a href="https://amzn.to/2kYzcEY">Amazon (print/Kindle)</a>, or <a href="https://www.ebooks.com/cj.asp?IID=209766469&cjsku=209766469">eBooks.com (PDF/epub)</a>.</div>
                    <div>Also available in <a href="https://www.labirint.ru/books/745595/">Russian</a> and <a href="https://item.jd.com/12769567.html">Chinese</a>.</div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Advertisement</div>
                <div><a href="https://brave.com/ste083">Don't like ads? Browse privately and ad-free with Brave!</a></div>
                <div class="panel-body">
                    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2749292939902134" data-ad-slot="7584809820" data-ad-format="auto"></ins>
                </div>
            </div>
            
            <div class="panel panel-primary">
                <div class="panel-heading">Popular Posts</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2012/02/async-and-await.html">Async/await Intro</a></li>
                        <li><a href="/2013/11/there-is-no-thread.html">There Is No Thread</a></li>
                        <li><a href="/2012/07/dont-block-on-async-code.html">Don't Block on Async Code</a></li>
                    </ul>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Series</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2016/02/react-redux-todomvc.html">React/Redux TodoMVC</a></li>
                        <li><a href="/2014/04/a-tour-of-task-part-0-overview.html">A Tour of Task</a></li>
                        <li><a href="/2013/10/taskrun-etiquette-and-proper-usage.html">Task.Run Etiquette</a></li>
                        <li><a href="/2013/05/taskrun-vs-backgroundworker-intro.html">Task.Run vs. BackgroundWorker</a></li>
                        <li><a href="/2013/01/async-oop-0-introduction.html">Async OOP</a></li>
                        <li><a href="/2009/04/tcpip-net-sockets-faq.html">TCP/IP .NET Sockets FAQ</a></li>
                        <li><a href="/2013/10/managed-services-roundup.html">Managed Services</a></li>
                        <li><a href="/2009/08/how-to-implement-idisposable-and.html">IDisposable and Finalizers</a></li>
                        <li><a href="/2011/02/option-parsing-introduction.html">Option Parsing</a></li>
                    </ul>
                </div>
            </div>
            
        </div>
    </div>

    <div class="google">
        <gcse:searchresults></gcse:searchresults>
    </div>
    
    <!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
<script type="text/javascript">window.jQuery || document.write('<script src="/lib/jquery-2.1.1.min.js"><\/script>')</script>

<!-- Bootstrap -->
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script type="text/javascript">window.jQuery.fn.modal || document.write('<script src="/lib/bootstrap.min.js"><\/script>')</script>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('body').css('color') !== 'rgb(102, 102, 102)') {
                $('head').prepend('<link rel="stylesheet" href="/lib/bootstrap.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Font Awesome -->
<span id="facheck" class="fa" style="display:none"></span>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('#facheck').css('fontFamily') !== 'FontAwesome') {
                $('head').prepend('<link rel="stylesheet" href="/lib/font-awesome.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Scroll the sidebar into view (if necessary) -->


<!-- Moment -->
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.6.0/moment.min.js"></script>
<script type="text/javascript">window.moment || document.write('<script src="/lib/moment.min.js"><\/script>')</script>

<!-- Google analytics -->
<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-8910661-5', 'stephencleary.com');
    ga('send', 'pageview');
</script>

<!-- Show appropriate elements based on time -->
<script type="text/javascript">
    (function ($) {
        $(function () {
            var targets = $('[data-hide-after]');
            targets.each(function () {
                var $item = $(this);
                if (moment() < moment($item.attr('data-hide-after'))) {
                    $item.removeClass('hidden');
                }
            });
        });
    })(window.jQuery);
</script>








<script src="/lib/uuid-v3-3.2.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/showdown@1.8.6/dist/showdown.min.js" integrity="sha256-dwhppIrxD8qC6lNulndZgtIm4XBU9zoMd9OUoXzIDAE=" crossorigin="anonymous"></script>
<script src="/lib/sanitize-html-1.18.2.min.js"></script>
<script src="/lib/autosize.min.js"></script>
<script src="/lib/base64js.min.js"></script>
<script src="/lib/md5.min.js"></script>

<script type="text/javascript">

var pageUrl = "https://blog.stephencleary.com" + "/2012/02/async-and-await.html";

// (unnecessary) 1) If the URL starts with http://, replace with https://

// 2) Take the URL path (not including scheme and domain).
var url = document.createElement('a');
url.href = pageUrl; //'https://developer.mozilla.org:8080/en-US/search?q=URL#search-results-close-container';
var path = url.pathname;

// 3) Path: If the path ends with .html or any two- to six-character [A-Za-z0-9] extension, strip it.
if (path.endsWith(".html"))
    path = path.substr(0, path.length - 5);
else
    path = path.replace(/\.[A-Za-z0-9]{2,6}$/, "");

// 4) Path: For each UTF-16 code unit, if it's not in the whitelist [A-Za-z0-9-_;.~()], then replace it with _.
path = path.replace(/[^-A-Za-z0-9_;.~()]/g, "_");

// 5) Path: Trim leading and trailing _ characters.
path = path.replace(/^_+|_+$/g, "");

// 6) Calculate the V3 URL GUID for the URL.
var guid = uuidv3(pageUrl, uuidv3.URL);

// 7) Combine the path and lowercase-hyphenated GUID, separated by '-'.
var postId = path + "-" + guid;

var nofollowLinkExtension = {
    type: 'output',
    regex: /(<a[^<]+<\/a>)/g,
    replace: (match, $1, $2) => {
        var result = $('<div/>').append($($1).attr('rel', 'nofollow noopener')).html();
        return result;
    }
};
showdown.extension('nofollowLink', nofollowLinkExtension);

var comments;
var markdownConverter = new showdown.Converter({
    omitExtraWLInCodeBlocks: true,
    noHeaderId: true,
    headerLevelStart: 3,
    simplifiedAutoLink: true,
    excludeTrailingPunctuationFromURLs: true,
    literalMidWordUnderscores: true,
    strikethrough: true,
    smoothLivePreview: true,
    disableForced4SpacesIndentedSublists: true,
    extensions: ['nofollowLink']
});
var sanitizeOptions = {
    allowedTags: [ 'blockquote', 'p', 'a', 'ul', 'ol', 'nl', 'li', 'b', 'i', 'strong', 'em', 'strike', 'code', 'br', 'div', 'pre', 'img' ],
    allowedAttributes: {
        a: [
            'href',
            {
                name: 'rel',
                multiple: true,
                values: ['nofollow', 'noopener']
            }
        ],
        img: [ 'src' ]
    },
    allowedIframeHostnames: []
};

function fixedEncodeURIComponent(str) {
  return encodeURIComponent(str).replace(/[!'()*]/g, function(c) {
    return '%' + c.charCodeAt(0).toString(16);
  });
}

function filterComments(replyTo) {
    return comments
        .filter(function (x) { return x.replyTo === replyTo; })
        .sort(function (a, b) { return a.timestamp - b.timestamp; });
}

function avatarUri(authorEmailMD5) {
    if (authorEmailMD5 === "")
        return "https://www.gravatar.com/avatar/?d=mp&f=y";
    else
        return "https://www.gravatar.com/avatar/" + authorEmailMD5 + "?d=retro";
}

var jwk = {"kty":"RSA","alg":"RSA-OAEP","n":"wviXqUJGtV8hZrvJMcTbyzm7MmiJSqsAfWI_7pCyAhXXzz5C9F3NtXp79CCUMqkOck6IbNKUntPtGNOGwtoc5LTJNKLhx3TPi4TJyKUSfNr3pAdLpMRNeeRXCHFyyVsDb6z8ueixlKzdbDpZhV05bam49PurMHfeexJ3EJy2NpdFviykRJxtrERi6ckBe96VMlT_pHHIWLN5EwOK54DvNn1DYjiFK5ux5WRCFatZByzytrFvIllZRctNXZ8oTuMjQwKLY2bUrURblbIvLfX-9Yd7uVgdUSFE7-vSel9-DMyp_NQ-NRXrQbJG7IAYhSGSx-TPepCDPbFpMq3yC0iET7wF7-OQOb-Kwej_TKVJv-z4SbN-cpCqaMr5Q9scyGih7xr1YrOhe3TMs_cbgjtxsZbzkOqcuRreON_sGb9nlDpSIFCo6aH47GeMkA23Hk3HXAPyYQ7AfWhU9daiPcySiAFnfkrg2QvFNJmMSZ-bo4Co-JkjiqKw-LEpOw6Ed9LK4walxWUAqPGcT4_Uys3TH9XVex9_rEmigHXiJY3_Lwi6mTSkW10-zen5UXxqnyHpMxlmumohT96OyLyhEPeaaq8FrTYMCX8TiMOst3jF5QCNP-LFz21yeUEAr5_3-FKV2mjWEU9iW0dOOVTII2rlD0WtCkqkDwZtakQ1ynGdW1E","e":"AQAB"};

function commentId(id) { return "comment-" + id; }

function $commentForm(hideForm, comment) {
    var $previewDiv = $('<div/>');
    var $authorEmailEncrypted = $('<input type="hidden" name="fields[authorEmailEncrypted]">');
    var $authorEmailMD5 = $('<input type="hidden" name="fields[authorEmailMD5]">');
    var $email = $('<input type="email" name="email" class="form-control" placeholder="Email">');
    var $name = $('<input type="text" name="fields[authorName]" class="form-control" placeholder="Name">');
    var $url = $('<input type="url" name="fields[authorUri]" class="form-control" placeholder="Url">');
    var $message = $('<textarea name="fields[message]" class="form-control" placeholder="Message"/></textarea>');
    autosize($message);
    var $replyTo = $('<input type="hidden" name="fields[replyTo]">').val("");
    var $recaptcha = $('<div class="g-recaptcha" data-sitekey="6LfSaV8UAAAAAEFq-7HeUDiSQCkCtLtO_yc_SOi_"></div>');
    var $buttonBar = $('<div class="comment-form-buttonbar"/>').append($('<button type="submit" class="btn btn-primary pull-right">Submit</button>'), $recaptcha);
    var $form = $('<form method="POST" action="https://stephencleary-comments.herokuapp.com/v2/entry/StephenCleary/comments.stephencleary.com/master"/>')
        .append($('<input type="hidden" name="fields[postId]">').val(postId))
        .append($('<input type="hidden" name="fields[postUri]">').val(location.href.replace(/#.*/, '')))
        .append($('<input type="hidden" name="options[reCaptcha][siteKey]" value="6LfSaV8UAAAAAEFq-7HeUDiSQCkCtLtO_yc_SOi_">'))
        .append($('<input type="hidden" name="options[reCaptcha][secret]" value="rlAivB9udiXQ8MQx3HNJ2Cw/qA2OJI1noljbySzRpNLKmdaS7LtDRT4T3hZcQswRl5sajt5dr+Txj46K2oEGH2HiStNdMMxCchBg0T6YcbZoAP7Zvax+6/C293ClnzMYq8Ozk4bMDbXEHC11FvHR2eaBKqTgAmQSQ3+N2NU5Aaw4Cqfgsj55Br+lKyK0Ydll6SF9+IjQnGJ6S9QV7rHopROdV3RCaeSsSrhsqyGjhvPRgSdl23npJbZt8R0e4oGd6ogH+VDhkj+S3LFPL+R7h6BiHuUDNuJheaJKYTJtjWt80esZgFYywTyTWnqkNBHxOXyH8+AN4PGI0trvlXzdsGvNYRP+dlV6AQyShI3zimSmB4mqcAnuNhGNvLIsfgTKRT1gmxgG1uxUMPjRq1L3R2wQMSQ1/cEuX2wiLI3UrtT8N+QUEptMQ1jsR7rg28OxqIVhbd2+LeAS90PxbxJ9h3mKAxQ493TmCIxRLbh9RNLl+jy8NsRwz2RikzKLJDZsfB7n/Z30nSDZkOTtT7fMzS3g4eJzT0sZStFQsW7Gis6MVs8hXUYgiuIseALKvAzmobnlycD/rqlCpZ5rYC2xQToc4ZDczfZ0bCP8/R5Op4J8LhI4l0JfR1pZSD9V9xTyQ6MTuTT63Ra72ANxn/0idxveWPJS7WMKbKoGmuTNji4=">'))
        .append($replyTo)
        .append($authorEmailEncrypted)
        .append($authorEmailMD5)
        .append($('<div class="form-group"><label>Name (optional)</label></div>').append($name))
        .append($('<div class="form-group"><label>Email (optional; always encrypted, never shared)</label></div>').append($email))
        .append($('<div class="form-group"><label>Url (optional; must start with "http://" or "https://")</label></div>').append($url))
        .append($('<div class="form-group"><label>Message (supports some Markdown/HTML)</label></div>').append($message));
    if (comment) {
        $replyTo.val(comment._id);
    }
    $form.submit(function (e) {
        e.preventDefault();
        hideForm();
        var postAction = $form.attr('action');
        var postBody = $form.serialize();
        var retries = 5;

        function postIt() {
            var post = $.post(postAction, postBody, "json");
            post.done(function () {
                alert("Comment successfully posted. It should appear on this page in a minute or so.");
            });
            post.error(function () {
                var message = "Failed to post comment";
                if (post.responseText)
                    message += ": " + post.responseText;
                
                if (--retries > 0) {
                    console.log(message);
                    postIt();
                } else {
                    alert(message);
                }
            });
        }

        postIt();
    });

    function createComment() {
        return normalizeComment({
            date: moment().format(),
            _id: "_",
            replyTo: comment ? comment._id : undefined,
            authorName: $name.val(),
            authorEmailMD5: $authorEmailMD5.val(),
            authorUri: $url.val(),
            message: $message.val()
        });
    };

    function recreatePreview() {
        var email = $email.val();
        if (email && email.indexOf("@") !== -1) {
            var data = new TextEncoder().encode($email.val());
            window.crypto.subtle.importKey("jwk", jwk, { name: "RSA-OAEP", hash: { name: "SHA-1" } }, false, ["encrypt"]).then(function (encryptionKey) {
                return window.crypto.subtle.encrypt({ name: "RSA-OAEP" }, encryptionKey, data)
                    .then(function (encrypted) {
                        var array = new Uint8Array(encrypted);
                        var text = base64js.fromByteArray(array);
                        $authorEmailEncrypted.val(text);
                        return text;
                    });
            });
            $authorEmailMD5.val(md5($email.val().replace(/^ +| +$/g, '').toLowerCase()));
        } else {
            $authorEmailMD5.val("");
            $authorEmailEncrypted.val("");
        }

        var $newPreview = $comment(false, createComment());
        // Turn off permalink and anchor
        var $anchor = $newPreview.find('.comment-date a');
        $anchor.replaceWith($('<span/>').text($anchor.text()));
        $newPreview.find('.comment-anchor').remove();
        $previewDiv.empty();
        $previewDiv.append($newPreview);
    };

    recreatePreview();
    $name.on('change keyup input paste', recreatePreview);
    $email.on('change keyup input paste', recreatePreview);
    $url.on('change keyup input paste', recreatePreview);
    $message.on('change keyup input paste', recreatePreview);

    $form.append($('<h3>Preview:</h3>'), $previewDiv, $buttonBar);
    return {
        $form: $('<div class="comment-form"/>').append($form),
        onShow: function() { grecaptcha.render($recaptcha[0]); }
    };
}

function $replyButton(comment) {
    var $button;
    if (comment)
        $button = $('<button class="btn btn-primary comment-reply"><i class="fa fa-reply"></i> Reply</button>');
    else
        $button = $('<button class="btn btn-primary comment-new"><i class="fa fa-plus-square"></i> New Comment</button>');
    return $button;
}

var now = moment();
function $comment(includeForm, comment) {
    var message = sanitizeHtml(markdownConverter.makeHtml(comment.message), sanitizeOptions);
    var $commentDiv = $('<div class="comment"/>');
    var publicationDate = moment(comment.date);
    var $author = $('<div class="comment-author"/>').append($('<span class="comment-author-name"/>').text(comment.authorName));
    if (comment.authorUri !== "")
        $author.append($('<span> • </span>'), $('<a class="comment-author-uri" rel="nofollow noopener"/>').attr('href', comment.authorUri).text(comment.authorUri));
    var $headerDiv = $('<div class="comment-header"/>').append(
        $('<div class="comment-author-profile" style="float:left;"/>').append($('<img class="comment-author-profile-image" src="' + avatarUri(comment.authorEmailMD5) + '"/>')),
        $author,
        $('<div class="comment-date" />').append(
            $('<a/>').attr('href', '#' + commentId(comment._id)).attr('title', 'permalink').text(publicationDate.from(now) + ' (' + publicationDate.format('YYYY-MM-DD hh:mm:ss a') + ')')
        )
    );
    if (comment.replyTo !== "") {
        var parent = comments.filter(function (x) { return x._id === comment.replyTo })[0];
        $headerDiv.append($('<div/>').append($('<a/>').attr('href', '#' + commentId(comment.replyTo)).text('In reply to ' + parent.authorName)));
    }

    $commentDiv.append($('<div class="comment-anchor"/>').attr('id', commentId(comment._id)),
        $headerDiv,
        $('<div class="comment-message" style="clear:both;"/>').html(message)
    );

    var $commentContainer = $('<div class="comment-container"/>').append($commentDiv);
    if (includeForm)
        $commentContainer.append($expandCollapseForm(comment));
    var childComments = filterComments(comment._id);
    for (var i = 0; i != childComments.length; ++i) {
        var child = childComments[i];
        $commentContainer.append($comment(includeForm, child));
    }

    return $commentContainer;
}

function normalizeComment(x) {
    var uri = x.authorUri;
    if (!uri || (!uri.startsWith("http://") && !uri.startsWith("https://")))
        uri = "";
    return {
            _id: x._id,
            authorName: x.authorName || "Anonymous",
            authorEmailMD5: x.authorEmailMD5 || "",
            authorUri: uri,
            message: x.message || "",
            replyTo: x.replyTo || "",
            date: x.date,
            timestamp: moment(x.date).valueOf()
    };
}

function $expandCollapseForm(comment) {
    var $button = $replyButton(comment);
    var formObj = $commentForm(hideForm, comment);
    var $form = formObj.$form.addClass("comment-hidden");
    var onShow = formObj.onShow;
    function showForm() {
        $button.addClass("comment-hidden");
        if (onShow) {
            onShow();
            onShow = null;
        }
        $form.removeClass("comment-hidden");
    }
    function hideForm() {
        $form.addClass("comment-hidden");
        $button.removeClass("comment-hidden");
    }
    $button.click(showForm);
    return $('<div/>').append($button, $form);
}

function recaptchaLoaded() {
    var req = new XMLHttpRequest();
    req.addEventListener("load", function () {
        var $commentDiv = $('#comments');
        if (req.status === 404 || req.status === 200) {
            if (req.status === 404) {
                comments = [];
            } else {
                comments = JSON.parse(req.responseText).map(normalizeComment);
            }
            var commentCounter = document.getElementById('comment-counter');
            commentCounter.innerText = comments.length + " " + commentCounter.innerText;
            var toplevelComments = filterComments("");
            for (var i = 0; i != toplevelComments.length; ++i) {
                var comment = toplevelComments[i];
                $commentDiv.append($comment(true, comment));
            }
            if (comments.length !== 0) {
                $commentDiv.append($expandCollapseForm());
            }
        }
        $commentDiv.prepend($expandCollapseForm());
    });
    req.open('GET', "https://comments.stephencleary.com/" + postId + ".json");
    req.send();
}
</script>

<script src="https://www.google.com/recaptcha/api.js?onload=recaptchaLoaded&amp;render=explicit"></script>



<!-- Google AdSense -->
<script src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- Moment -->
<script type="text/javascript">
    (function($) {
        $(function () {
            $('time').each(function (_, e) {
                var startOfToday = moment().startOf('day');
                var publicationDate = moment($(e).attr('datetime'), 'YYYY-MM-DD');
                var difference = startOfToday.diff(publicationDate, 'days');
                var text = difference === 0 ? 'Today' :
                    difference === 1 ? 'Yesterday' :
                    publicationDate.from(startOfToday);
                $(e).text(function(_, oldText) { return text + ' (' + oldText + ')'; });
            });
        });
    })(window.jQuery);
</script>




</body>
</html>