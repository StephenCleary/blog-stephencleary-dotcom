<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Portable Class Library Enlightenment / Adaptation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <link rel="canonical" href="http://blog.stephencleary.com/2012/11/portable-class-library-enlightenment.html" />
    
    <link rel="alternate" type="application/rss+xml" title="Stephen Cleary (the blog)" href="http://feeds.feedburner.com/NitoPrograms" />
    
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/bootswatch/3.2.0/spacelab/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" />
    <link type="text/css" rel="stylesheet" href="http://stephencleary.com/css/main.css" />
    <meta name="application-name" content="Stephen Cleary" />
    <link rel="apple-touch-icon" sizes="57x57" href="http://stephencleary.com/icons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="http://stephencleary.com/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="http://stephencleary.com/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="http://stephencleary.com/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="http://stephencleary.com/icons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="http://stephencleary.com/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="http://stephencleary.com/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="http://stephencleary.com/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" href="http://stephencleary.com/icons/apple-touch-icon.png"/>
    <link rel="apple-touch-icon-precomposed" href="http://stephencleary.com/icons/apple-touch-icon-precomposed.png"/>
    <link rel="icon" type="image/png" href="http://stephencleary.com/icons/favicon-196x196.png" sizes="196x196">
    <link rel="icon" type="image/png" href="http://stephencleary.com/icons/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="http://stephencleary.com/icons/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="http://stephencleary.com/icons/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="http://stephencleary.com/icons/favicon-32x32.png" sizes="32x32">
    
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <div class="navbar-brand-container"><a class="navbar-brand" href="http://stephencleary.com">Stephen Cleary</a></div>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
            <li  class="active"  ><a href="http://blog.stephencleary.com">Blog</a></li>
            <li  ><a href="http://stephencleary.com/projects/">Projects</a></li>
            <li  ><a href="http://stephencleary.com/publications/">Publications</a></li>
            <li  ><a href="http://stephencleary.com/contact/">Contact</a></li>
            <li><a href="http://feeds.feedburner.com/NitoPrograms"><i class="fa fa-rss-square fa-lg"></i></a></li>
            <li  ><a href="http://stephencleary.com/search/"><i class="fa fa-search"></i></a></li>
        </ul>
    </div>
</nav>

    <div class="container-fluid">
        <div class="col-sm-8 col-sm-offset-2 col-md-6 col-md-offset-3">
            <div class="post">

  <header>
      <div class="page-header">
          <h1>Portable Class Library Enlightenment / Adaptation</h1>
          <small><time datetime="2012-11-15">Nov 15, 2012</time> &bull; <a data-disqus-identifier="/2012/11/portable-class-library-enlightenment" href="#disqus_thread">Comments</a></small>
      </div>
  </header>

  <article>
  <div class="alert alert-danger">
  <p><i class="fa fa-exclamation-triangle fa-2x pull-left"></i></p>

  <p><strong>Update, 2014-05-07:</strong> I have been giving it a lot of thought, and I have decided that the <a href="http://log.paulbetts.org/the-bait-and-switch-pcl-trick/" class="alert-link">Bait-and-Switch approach</a> described by Paul Betts is a better solution than the one described below. This blog post is retained for historical purposes.</p>
</div>

<p>I have a long-standing interest in <a href="http://msdn.microsoft.com/en-us/library/gg597391.aspx">portable class libraries (PCL)</a>, because most of my open-source contributions are widely-applicable libraries (including <a href="http://comparers.codeplex.com/">Comparers</a>, <a href="http://arraysegments.codeplex.com/">ArraySegments</a>, and of course <a href="http://nitoasyncex.codeplex.com/">AsyncEx</a>). This post is an explanation of a technique that I learned from Rx; it’s useful for any PCL that is actually a <em>library</em> (i.e., not a portable <em>application</em>).</p>

<div class="alert alert-info">
  <p><i class="fa fa-hand-o-right fa-2x pull-left"></i></p>

  <p>Portable class libraries are awesome. Now that NuGet supports them, every library writer should join in!</p>
</div>

<h2 id="the-problem">The Problem</h2>

<p>Portable Class Libraries enable you to create a single binary that runs on several (.NET) platforms. Unfortunately, it uses the “least common denominator” approach, which means your PCL is greatly constrained in what it can do. In order to “step outside” these restrictions, you need some way for a platform-specific assembly to provide functionality to your PCL core. The obvious answer is to use inversion of control, but how are the (platform-specific) implementations created and passed to your portable code?</p>

<h2 id="possible-solutions">Possible Solutions</h2>

<p>There are several ways to do this. <a href="http://blogs.msdn.com/b/dsplaisted/archive/2012/08/27/how-to-make-portable-class-libraries-work-for-you.aspx">Daniel Plaisted has a great blog post</a> that gives an overview of different solutions:</p>

<ol>
  <li>Manual dependency injection (passing interface implementations into constructors). Daniel’s classic “Disentaglement” demo uses this approach as he describes <a href="http://channel9.msdn.com/Events/Build/2012/3-004">in his //build/ talk</a>. This is OK if your PCL just has a few large classes (e.g., ViewModels) which are always the “entry point” to your PCL. It’s not so good if your PCL is more of a generic library.</li>
  <li>Real dependency injection. The disadvantage to this approach is that it restricts all users of a PCL to a specific DI provider.</li>
  <li>Service locator (static variables holding the interface implementations). This approach is described in <a href="http://msdn.microsoft.com/en-us/library/gg597391.aspx">the official MSDN documentation (section “Platform Abstraction”)</a>. This requires all code using the PCL to “wire up” its own implementations.</li>
  <li>Platform enlightenment / adaptation libraries (extra assemblies loaded via reflection). This is the approach described in this blog post.</li>
</ol>

<p>The first three approaches depend on the <em>consumer</em> of the library implementing the platform services (or at least instantiating them) and providing them to the portable library:</p>

<p class="center"><img src="/assets/Blog.png" alt="" /></p>

<p>This is fine if your PCL is just the core of a portable <em>application</em>, like Daniel’s “Disentanglement” application, where the PCL contains the logic but its “entry points” are just a handful of ViewModels.</p>

<p>But I’m not a fan of this. When I distribute a library, I want users to just add it via NuGet and start using it; requiring “startup” code is a big barrier to adoption.</p>

<p>AFAIK, the Rx team was the first to solve this problem. They describe their “Platform Enlightenment” approach well <a href="http://blogs.msdn.com/b/rxteam/archive/2012/08/15/reactive-extensions-v2-0-has-arrived.aspx">on their blog (section “Intermezzo - The refactored API surface”)</a>. Members of the PCL team have referred to this technique as “Platform Adaptation”.</p>

<p class="center"><img src="/assets/Blog%203.png" alt="" /></p>

<p>The “dashed arrow” in the diagram above means that the user application has a reference to the platform services library, but does not actually use it. The “magic arrow” does not exist at compile time (so there’s no actual reference there); this will be explained later.</p>

<h2 id="enabling-enlightenment--adaptation">Enabling Enlightenment / Adaptation</h2>

<p>You <em>could</em> choose to have all your “platform services” defined in a single interface, but I think it’s cleaner to group your platform services into multiple interfaces. In my code, I call these platform services “enlightenments”. Each “enlightenment” is an interface that has a platform-specific implementation <strong>and</strong> a default implementation.</p>

<p>Let’s start out with a simple enlightenment called “Bob”. We’ll create a portable class library (called “MyLibrary”) that will act as our Portable Core and define the “Bob” enlightenment interface:</p>

<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="c1">/// Provides Bob-related services.</span>
<span class="k">public</span> <span class="k">interface</span> <span class="n">IBobEnlightenment</span>
<span class="p">{</span>
    <span class="c1">/// Says &quot;hi&quot;</span>
    <span class="kt">string</span> <span class="nf">SayHi</span><span class="p">();</span>
<span class="p">}</span></code></pre></div>

<div class="alert alert-info">
  <p><i class="fa fa-hand-o-right fa-2x pull-left"></i></p>

  <p>As an aside, my enlightenment-related types are mostly <code>public</code>, but they are within a special namespace, which indicates to end-users that they are not part of the normal API.</p>
</div>

<p>Multiple enlightenment types means that it’s useful to have an “enlightenment provider” (also platform-specific, with a default backup), which just creates instances of the enlightenments. The <code>IEnlightenmentProvider</code> type is defined in the Portable Core:</p>

<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="c1">/// An enlightenment provider, which creates enlightenments on demand.</span>
<span class="k">public</span> <span class="k">interface</span> <span class="n">IEnlightenmentProvider</span>
<span class="p">{</span>
    <span class="c1">/// Creates an enlightenment of the specified type.</span>
    <span class="c1">/// &lt;typeparam name=&quot;T&quot;&gt;The type of enlightenment to create.&lt;/typeparam&gt;</span>
    <span class="n">T</span> <span class="n">CreateEnlightenment</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
<span class="p">}</span></code></pre></div>

<p>To consume the enlightenments, I use an “enlightenment manager” type, which I just call <code>Enlightenment</code> (also defined in the Portable Core):</p>

<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="c1">/// Provides static members to access enlightenments.</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">Enlightenment</span>
<span class="p">{</span>
    <span class="c1">/// Loads the &lt;c&gt;PlatformEnlightenmentProvider&lt;/c&gt; if it can be found; otherwise, returns an instance of &lt;see cref=&quot;DefaultEnlightenmentProvider&quot;/&gt;.</span>
    <span class="k">private</span> <span class="k">static</span> <span class="n">IEnlightenmentProvider</span> <span class="nf">CreateProvider</span><span class="p">();</span>

    <span class="c1">/// Cached instance of the platform enlightenment provider. This is an instance of the default enlightenment provider if the platform couldn&#39;t be found.</span>
    <span class="k">private</span> <span class="k">static</span> <span class="n">IEnlightenmentProvider</span> <span class="n">platform</span><span class="p">;</span>

    <span class="c1">/// Returns the platform enlightenment provider, if it could be found; otherwise, returns the default enlightenment provider.</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">IEnlightenmentProvider</span> <span class="n">Platform</span>
    <span class="p">{</span>
        <span class="k">get</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">platform</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="n">Interlocked</span><span class="p">.</span><span class="n">CompareExchange</span><span class="p">(</span><span class="k">ref</span> <span class="n">platform</span><span class="p">,</span> <span class="n">CreateProvider</span><span class="p">(),</span> <span class="k">null</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">platform</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">/// Cached instance of the Bob enlightenment.</span>
    <span class="k">private</span> <span class="k">static</span> <span class="n">IBobEnlightenment</span> <span class="n">bob</span><span class="p">;</span>

    <span class="c1">/// Returns the Bob enlightenment.</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">IBobEnlightenment</span> <span class="n">Bob</span>
    <span class="p">{</span>
        <span class="k">get</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bob</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="n">Interlocked</span><span class="p">.</span><span class="n">CompareExchange</span><span class="p">(</span><span class="k">ref</span> <span class="n">bob</span><span class="p">,</span> <span class="n">Platform</span><span class="p">.</span><span class="n">CreateEnlightenment</span><span class="p">&lt;</span><span class="n">IBobEnlightenment</span><span class="p">&gt;(),</span> <span class="k">null</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">bob</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="p">...</span> <span class="c1">// Other enlightenments just like Bob</span>
<span class="p">}</span></code></pre></div>

<p>(We’ll come back to the implementation of <code>CreateProvider</code> in a moment).</p>

<p>This setup means that from within my PCL Core, I can consume enlightenments easily:</p>

<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">MyPortableClass</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">MyPortableClass</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">word</span> <span class="p">=</span> <span class="n">Enlightenment</span><span class="p">.</span><span class="n">Bob</span><span class="p">.</span><span class="n">SayHi</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>Note that my enlightenment manager implementation is forcing some assumptions on both the enlightenment provider <em>and</em> every enlightenment: they are conceptually singletons, except that they <em>can</em> be constructed multiple times (due to race conditions); in that case, only one instance will be used and all extra instances will be discarded. These are not difficult assumptions to satisfy, but you do need to be aware of them.</p>

<h3 id="the-default-provider">The Default Provider</h3>

<p>Having a default implementation is important! If an application developer removes your platform-specific assembly from their project’s references, then you will end up at runtime with just your PCL core, and you need to handle that scenario gracefully.</p>

<p>In this case, you’ll need a default provider to step in and provide some kind of reasonable default behavior. I’m not a big fan of <code>NotSupportedException</code>, and I recommend avoiding it as much as possible, but in these cases it may just be necessary.</p>

<p>For our simple “Bob” enlightenment, let’s just return an empty string as our default behavior. Again in the Portable Core:</p>

<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="c1">/// The default enlightenment provider, used when the platform enlightenment provider could not be found.</span>
<span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">DefaultEnlightenmentProvider</span> <span class="p">:</span> <span class="n">IEnlightenmentProvider</span>
<span class="p">{</span>
    <span class="n">T</span> <span class="n">IEnlightenmentProvider</span><span class="p">.</span><span class="n">CreateEnlightenment</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">type</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">IBobEnlightenment</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">T</span><span class="p">)(</span><span class="kt">object</span><span class="p">)</span><span class="k">new</span> <span class="n">BobEnlightenment</span><span class="p">();</span>
        <span class="p">...</span> <span class="c1">// other enlightenments.</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="nf">NotImplementedException</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">/// The default Bob enlightenment, which does nothing.</span>
    <span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">BobEnlightenment</span> <span class="p">:</span> <span class="n">IBobEnlightenment</span>
    <span class="p">{</span>
        <span class="kt">string</span> <span class="n">IBobEnlightenment</span><span class="p">.</span><span class="n">SayHi</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>Usually, there’s some form of reflection going on in a default enlightenment instead of being this simple.</p>

<h3 id="the-platform-providers">The Platform Providers</h3>

<p>At this point, we create providers for each of the platforms that need one. So let’s assume that “Bob” wants to say hi from a specific provider, like .NET 4.5.</p>

<p>First, we create a .NET 4.5 assembly. I usually name the <em>project</em> something like “MyLibrary.Enlightenment (NET45)” but ensure the assembly name is just “MyLibrary.Enlightenment”. Then we reference our portable core and define the platform-specific enlightenment provider and enlightenments:</p>

<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="c1">/// The platform enlightenment provider for .NET 4.5.</span>
<span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">EnlightenmentProvider</span> <span class="p">:</span> <span class="n">IEnlightenmentProvider</span>
<span class="p">{</span>
    <span class="n">T</span> <span class="n">IEnlightenmentProvider</span><span class="p">.</span><span class="n">CreateEnlightenment</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">type</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">IBobEnlightenment</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">T</span><span class="p">)(</span><span class="kt">object</span><span class="p">)</span><span class="k">new</span> <span class="n">BobEnlightenment</span><span class="p">();</span>
        <span class="p">...</span> <span class="c1">// other enlightenments.</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="nf">NotImplementedException</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">BobEnlightenment</span> <span class="p">:</span> <span class="n">IBobEnlightenment</span>
    <span class="p">{</span>
        <span class="kt">string</span> <span class="n">IBobEnlightenment</span><span class="p">.</span><span class="n">SayHi</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="s">&quot;Hello from .NET 4.5!&quot;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<h3 id="the-secret-sauce">The Secret Sauce</h3>

<p>Now, let’s take a look at that <code>CreateProvider</code> method in the <code>Enlightenment</code> class. This is the “magic arrow” from my diagram:</p>

<p class="center"><img src="/assets/Blog%203.png" alt="" /></p>

<p>What we want to do is determine which assembly contains the platform-specific enlightenment provider, and create an instance of that type.</p>

<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="k">static</span> <span class="n">IEnlightenmentProvider</span> <span class="nf">CreateProvider</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Starting from our core assembly, determine the matching enlightenment assembly (with the same version/strong name if applicable)</span>
    <span class="kt">var</span> <span class="n">enlightenmentAssemblyName</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AssemblyName</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IEnlightenmentProvider</span><span class="p">).</span><span class="n">Assembly</span><span class="p">.</span><span class="n">FullName</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Name</span> <span class="p">=</span> <span class="s">&quot;MyLibrary.Enlightenment&quot;</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="c1">// Attempt to load the enlightenment provider from that assembly.</span>
    <span class="kt">var</span> <span class="n">enlightenmentProviderType</span> <span class="p">=</span> <span class="n">Type</span><span class="p">.</span><span class="n">GetType</span><span class="p">(</span><span class="s">&quot;MyLibrary.Internal.PlatformEnlightenment.EnlightenmentProvider, &quot;</span> <span class="p">+</span> <span class="n">enlightenmentAssemblyName</span><span class="p">.</span><span class="n">FullName</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">enlightenmentProviderType</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DefaultEnlightenmentProvider</span><span class="p">();</span>
    <span class="k">else</span>
        <span class="nf">return</span> <span class="p">(</span><span class="n">IEnlightenmentProvider</span><span class="p">)</span><span class="n">Activator</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">(</span><span class="n">enlightenmentProviderType</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>

<h3 id="distribution-notes">Distribution Notes</h3>

<p>NuGet is my distribution mechanism of choice. With the ability to <a href="http://docs.nuget.org/docs/release-notes/nuget-2.0">group dependencies by target frameworks</a> and with <a href="http://docs.nuget.org/docs/release-notes/nuget-2.1">full support for portable libraries</a> (including grouping dependencies by portable targets), you have a very flexible system for distributing a portable library. It’s easy to create a single package that contains your portable core along with all its platform enlightenments.</p>

<p>Both the portable core assembly and the appropriate platform enlightenment assembly should be included when the package is installed into a project for a specific platform. Only include the portable core assembly when the package is installed into a portable library project. This enables others to create portable libraries dependent on your portable library; when their portable library is installed into a project for a specific platform, your package will bring in your enlightenment assembly at that time.</p>

<p>Here’s a very simple example, if MyLibrary had a portable core supporting .NET 4.5 and Windows Store, with different enlightenment assemblies for each:</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;package&gt;</span>
 <span class="nt">&lt;metadata&gt;</span>
  <span class="nt">&lt;id&gt;</span>MyLibrary<span class="nt">&lt;/id&gt;</span>
 <span class="nt">&lt;/metadata&gt;</span>
 <span class="nt">&lt;files&gt;</span>
  <span class="c">&lt;!-- .NET 4.5 --&gt;</span>
  <span class="c">&lt;!-- Core + Enlightenment --&gt;</span>
  <span class="nt">&lt;file</span> <span class="na">src=</span><span class="s">&quot;MyLibrary\bin\Release\MyLibrary.dll&quot;</span> <span class="na">target=</span><span class="s">&quot;lib\net45&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;file</span> <span class="na">src=</span><span class="s">&quot;MyLibrary\bin\Release\MyLibrary.xml&quot;</span> <span class="na">target=</span><span class="s">&quot;lib\net45&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;file</span> <span class="na">src=</span><span class="s">&quot;MyLibrary.Enlightenment (NET45)\bin\Release\MyLibrary.Enlightenment.dll&quot;</span> <span class="na">target=</span><span class="s">&quot;lib\net45&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;file</span> <span class="na">src=</span><span class="s">&quot;MyLibrary.Enlightenment (NET45)\bin\Release\MyLibrary.Enlightenment.xml&quot;</span> <span class="na">target=</span><span class="s">&quot;lib\net45&quot;</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!-- Windows Store --&gt;</span>
  <span class="c">&lt;!-- Core + Enlightenment --&gt;</span>
  <span class="nt">&lt;file</span> <span class="na">src=</span><span class="s">&quot;MyLibrary\bin\Release\MyLibrary.dll&quot;</span> <span class="na">target=</span><span class="s">&quot;lib\win8&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;file</span> <span class="na">src=</span><span class="s">&quot;MyLibrary\bin\Release\MyLibrary.xml&quot;</span> <span class="na">target=</span><span class="s">&quot;lib\win8&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;file</span> <span class="na">src=</span><span class="s">&quot;MyLibrary.Enlightenment (Win8)\bin\Release\MyLibrary.Enlightenment.dll&quot;</span> <span class="na">target=</span><span class="s">&quot;lib\win8&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;file</span> <span class="na">src=</span><span class="s">&quot;MyLibrary.Enlightenment (Win8)\bin\Release\MyLibrary.Enlightenment.xml&quot;</span> <span class="na">target=</span><span class="s">&quot;lib\win8&quot;</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!-- Portable libraries: .NET 4.5, Windows Store --&gt;</span>
  <span class="c">&lt;!-- Core, no Enlightenment --&gt;</span>
  <span class="nt">&lt;file</span> <span class="na">src=</span><span class="s">&quot;MyLibrary\bin\Release\MyLibrary.dll&quot;</span> <span class="na">target=</span><span class="s">&quot;lib\portable-net45+win8&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;file</span> <span class="na">src=</span><span class="s">&quot;MyLibrary\bin\Release\MyLibrary.xml&quot;</span> <span class="na">target=</span><span class="s">&quot;lib\portable-net45+win8&quot;</span> <span class="nt">/&gt;</span>
 <span class="nt">&lt;/files&gt;</span>
<span class="nt">&lt;/package&gt;</span></code></pre></div>

<h3 id="its-best-to-be-sure">It’s Best to Be Sure</h3>

<p>Our <code>CreateProvider</code> should be able to load the enlightenment in normal situations. But we all know how other developers can mess things up, right? ;)  What if they’re doing some funky assembly loading from subdirectories so that we can’t find the enlightenment?</p>

<p>We can provide some level of assurance by allowing a single line of “startup” code. Of course, this is optional; <code>CreateProvider</code> does not <em>need</em> it in most cases, and we always have the default enlightenments to fall back on.</p>

<p>In each of my platform enlightenment assemblies, I define a single method in a normal namespace (i.e., not hidden from the user):</p>

<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="c1">/// Verifies platform enlightenment.</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">EnlightenmentVerification</span>
<span class="p">{</span>
    <span class="c1">/// Returns a value indicating whether the correct platform enlightenment provider has been loaded.</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">EnsureLoaded</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">Enlightenment</span><span class="p">.</span><span class="n">Platform</span> <span class="k">is</span> <span class="n">EnlightenmentProvider</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>This method simply checks to make sure its platform enlightenment is the one being used. Just to be sure.</p>

<h2 id="tips">Tips</h2>

<p>Use as many enlightenments as you need. I have a total of six enlightenments for my AsyncEx library. Some of them are nearly as simple as the “Bob” enlightenment; others are more complex.</p>

<p>If a platform would just use the default enlightenments anyway, then there’s no point in creating a platform enlightenment provider for it.</p>

<p>Only enlighten the behavior you need. My <code>Lazy&lt;T&gt;</code> enlightenment only has one constructor and two properties; it only supports one thread safety mode and is allowed to invoke its factory while holding a lock. This is significantly simpler than the Microsoft <code>Lazy&lt;T&gt;</code>, but my Portable Core doesn’t need any more than that.</p>

<p>I make my default enlightenments accessible to other enlightenment providers (they’re public nested classes). This enables a platform to decide to implement some enlightenments but return the default enlightenment for others.</p>

<p>Most default enlightenments need to use reflection. It’s best to use reflection only on startup and cache delegates for future use. I use the “compile <code>Expression</code> to a delegate” technique <a href="http://stackoverflow.com/questions/7932259/efficient-use-of-reflection-in-c-sharp/7932574#7932574">described by Eric Lippert in this SO answer</a>. Just be sure to watch your exceptions when doing the reflection!</p>

<p>Speaking of reflection, spend some time thinking about whether you <em>want</em> to upgrade behavior or not. This is particularly true for .NET 4.5, which is an in-place upgrade to .NET 4.0. As one example, I have an exception enlightenment on .NET 4.0 that will upgrade to <code>ExceptionDispatchInfo</code> via reflection if it’s running on .NET 4.5; since the .NET 4.0 equivalent is a hack, I always upgrade if I can. On the other hand, I have a tracing enlightenment on .NET 4.5 using ETW, but the tracing enlightenment on .NET 4.0 will use <code>TraceSource</code> even if .NET 4.5 is present; this ensures the end user always knows where to look for trace output based on their <em>target</em> platform, not what’s available at <em>runtime</em>.</p>

<p>Enlightenment assemblies can be difficult to test if they use reflection for upgrades. Ideally, you would test a combination of <em>target</em> platforms with <em>runtime</em> capabilities, and do that testing for both the platform-specific enlightenments and default enlightenments. Consider a distributed testing system.</p>

<p>If you use enlightenments the way I’ve described in this blog post, keep in mind that they are conceptually singletons. This means that if you’re enlightening a <em>type</em> (e.g., <code>Lazy&lt;T&gt;</code>), you first need to define a portable <em>interface</em> and then have your enlightenment act as a <em>factory</em>.</p>

<p>It’s perfectly fine to have your platform enlightenment assemblies be portable libraries themselves. My AsyncEx library uses the same portable assembly for enlightenment on .NET 4.5 and Windows Store.</p>

<p>If you’re modifying an existing library to have a portable core, you should keep open to refactoring. In particular, if you implement interfaces that aren’t available on some of your target platforms, those types may be a better fit for a “slightly less portable” additional assembly. I did this with the Dataflow types in my AsyncEx library; I have a “fully portable” core (Nito.AsyncEx.dll) and a “less portable” additional assembly (Nito.AsyncEx.Dataflow.dll). This is mostly transparent to users (at compile time) because both assemblies are distributed in the same NuGet package.</p>

<h2 id="references">References</h2>

<p>Daniel Plaisted’s blog post <a href="http://blogs.msdn.com/b/dsplaisted/archive/2012/08/27/how-to-make-portable-class-libraries-work-for-you.aspx">How to Make Portable Class Libraries Work for You</a>.</p>

<p>The <a href="http://blogs.msdn.com/b/rxteam/archive/2012/08/15/reactive-extensions-v2-0-has-arrived.aspx">original Rx team blog post describes their “Platform Enlightenment” (section “Intermezzo - The refactored API surface”)</a>.</p>

<p>The <a href="http://pclcontrib.codeplex.com/SourceControl/changeset/view/82200">Portable Class Libraries Contrib project has a “Platform Adaptation” implementation (under Source/Portable.Runtime/Adaptation)</a>.</p>


  </article>
    
    <footer>
        
        
        
        <ul class="pager">
            <li class="previous"><a href="/2012/11/async-producerconsumer-queue-using.html" title="Async Producer/Consumer Queue using Dataflow">&larr; Previous Post</a></li>
            <li class="next"><a href="/2012/12/dont-block-in-asynchronous-code.html" title="Don&#39;t Block in Asynchronous Code">Next Post &rarr;</a></li>
        </ul>

        <div id="disqus_thread"></div>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </footer>
</div>
        </div>
        <div class="col-sm-2 col-md-3 col-md-offset-0 col-lg-2 col-lg-offset-1 affix" data-spy="affix" role="navigation">
            
            
        </div>
        <div class="col-sm-2 sidebar">
            <div class="panel panel-default">
                <div class="panel-heading">About Stephen Cleary</div>
                <div class="panel-body">
                    <div class="center"><img src="http://stephencleary.com/www.assets/Me-large.jpg"/></div>
                    <div class="center vertical-margins">Stephen Cleary is a <a href="http://www.landmarkbaptist.ws/salvation">Christian</a>, <a href="http://picasaweb.google.com/stephenandmandy">husband, father,</a> and programmer living in Northern Michigan.</div>
                    <div class="center"><a href="http://mvp.microsoft.com/en-us/mvp/Stephen%20Cleary-5000058"><img class="mvp-logo" src="http://stephencleary.com/www.assets/MVP.png"/></a></div>
                </div>
            </div>
            <div class="panel panel-primary">
                <div class="panel-heading">My book</div>
                <div class="panel-body center">
                    <div><a href="http://tinyurl.com/ConcurrencyCookbook"><img src="http://stephencleary.com/www.assets/Book-small.jpg"/></a></div>
                    <div>Available from <a href="http://tinyurl.com/ConcurrencyCookbook">O'Reilly</a> or <a href="http://tinyurl.com/ConcurrencyCookbookAmazon">Amazon</a>.</div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Advertisement</div>
                <div class="panel-body">
                    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2749292939902134" data-ad-slot="7584809820" data-ad-format="auto"></ins>
                </div>
            </div>
            
            <div class="panel panel-primary">
                <div class="panel-heading">Popular Posts</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2012/02/async-and-await.html">Async/await Intro</a></li>
                        <li><a href="/2013/11/there-is-no-thread.html">There Is No Thread</a></li>
                        <li><a href="/2012/07/dont-block-on-async-code.html">Don't Block on Async Code</a></li>
                    </ul>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Series</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2014/04/a-tour-of-task-part-0-overview.html">A Tour of Task</a></li>
                        <li><a href="/2013/10/taskrun-etiquette-and-proper-usage.html">Task.Run Etiquette</a></li>
                        <li><a href="/2013/05/taskrun-vs-backgroundworker-intro.html">Task.Run vs. BackgroundWorker</a></li>
                        <li><a href="/2013/01/async-oop-0-introduction.html">Async OOP</a></li>
                        <li><a href="/2009/04/tcpip-net-sockets-faq.html">TCP/IP .NET Sockets FAQ</a></li>
                        <li><a href="/2013/10/managed-services-roundup.html">Managed Services</a></li>
                        <li><a href="/2009/08/how-to-implement-idisposable-and.html">IDisposable and Finalizers</a></li>
                        <li><a href="/2011/02/option-parsing-introduction.html">Option Parsing</a></li>
                    </ul>
                </div>
            </div>
            
        </div>
    </div>

    <div class="google">
        <gcse:searchresults></gcse:searchresults>
    </div>
    
    <!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
<script type="text/javascript">window.jQuery || document.write('<script src="/lib/jquery-2.1.1.min.js"><\/script>')</script>

<!-- Bootstrap -->
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script type="text/javascript">window.jQuery.fn.modal || document.write('<script src="/lib/bootstrap.min.js"><\/script>')</script>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('body').css('color') !== 'rgb(102, 102, 102)') {
                $('head').prepend('<link rel="stylesheet" href="/lib/bootstrap.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Font Awesome -->
<span id="facheck" class="fa" style="display:none"></span>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('#facheck').css('fontFamily') !== 'FontAwesome') {
                $('head').prepend('<link rel="stylesheet" href="/lib/font-awesome.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Scroll the sidebar into view (if necessary) -->


<!-- Google analytics -->
<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-8910661-5', 'stephencleary.com');
    ga('send', 'pageview');
</script>







<!-- Disqus variables -->
<script type="text/javascript">
    var disqus_shortname = 'stephencleary';
    var disqus_identifier = "/2012/11/portable-class-library-enlightenment";
    var disqus_title = "Portable Class Library Enlightenment / Adaptation";
    var disqus_url = "http://blog.stephencleary.com/2012/11/portable-class-library-enlightenment.html";
</script>

<!-- Disqus comment counter -->
<script type="text/javascript">
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
    }());
</script>

<!-- Disqus comment section -->
<script type="text/javascript">
    (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>



<!-- Google AdSense -->
<script src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- Moment -->
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.6.0/moment.min.js"></script>
<script type="text/javascript">window.moment || document.write('<script src="/lib/moment.min.js"><\/script>')</script>
<script type="text/javascript">
    (function($) {
        $(function() {
            $('time').each(function (_, e) {
                var text = moment($(e).attr('datetime'), 'YYYY-MM-DD').fromNow();
                $(e).text(function(_, oldText) { return text + ' (' + oldText + ')'; });
            });
        });
    })(window.jQuery);
</script>

</body>
</html>