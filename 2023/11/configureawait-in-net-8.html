<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>ConfigureAwait in .NET 8</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Changes in ConfigureAwait that are new with .NET 8.0." />
    <link rel="canonical" href="https://blog.stephencleary.com/2023/11/configureawait-in-net-8.html" />
    
    <link rel="alternate" type="application/rss+xml" title="Stephen Cleary (the blog)" href="http://feeds.feedburner.com/NitoPrograms" />
    
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/bootswatch/3.2.0/spacelab/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" />
    <style type="text/css">/* Layout Styles */
/* ----------------------------------------------------------*/

body {
    padding-top: 50px;
}

.affix {
    top: 70px;
    bottom: 0;
    overflow-y: auto;
}

.navbar-brand {
    font-weight: bold;
}

.navbar-brand-container.active>a, .navbar-brand-container.active>a:hover, .navbar-brand-container.active>a:focus {
    color: #3399f3;
    background-color: transparent;
}

.sidebar {
    margin-top: 20px;
}

.sidenavitem {
    height: auto;
}

.sidebar img {
    /* Responsive images */
    display: inline-block;
    height: auto;
    max-width: 100%;
}

@media(max-width:767px) {
    .affix {
        position: static;
    }
}

div .vertical-margins {
    margin-top: 10px;
    margin-bottom: 10px;
}

.page-header {
    margin-top: 20px;
}

.center {
    text-align: center;
}

.project-icon {
    height: 128px;
    width: 128px;
}

.list-group-item h2 {
    margin-top: 10px;
}

/* Fixes for Google Custom Search in a Bootstrap page */
/* ----------------------------------------------------------*/
.google, .google *, .google *:before, .google *:after {
    -webkit-box-sizing: content-box;
    -moz-box-sizing: content-box;
    box-sizing: content-box;
}

.google table {
    border-collapse: separate;
}

.gsc-input-box {
    height: auto !important;
}

/* Fixes for Amazon widget in Bootstrap page */
.amzn_wdgt * {
    -webkit-box-sizing: content-box;
    -moz-box-sizing: content-box;
    box-sizing: content-box;
}

/* Post styles */
/* ----------------------------------------------------------*/

code {
    background-color: #F2F3F9;
    color: inherit;
}

.post img {
    /* Responsive images */
    display: inline-block;
    height: auto;
    max-width: 100%;
}

.post .table {
    table-layout: fixed;
}

.post .table code {
    white-space: normal;
}

.post .yes {
    color: #008000;
}

.post .no {
    color: #FF0000;
}

/* Syntax highlighting styles */
/* ----------------------------------------------------------*/

.highlight  { background: #ffffff; }
.highlight .c { color: #008000 } /* Comment */
.highlight .k { color: #0000ff } /* Keyword */
.highlight .cm { color: #008000 } /* Comment.Multiline */
.highlight .cp { color: #0000ff } /* Comment.Preproc */
.highlight .c1 { color: #008000 } /* Comment.Single */
.highlight .cs { color: #008000 } /* Comment.Special */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gh { font-weight: bold } /* Generic.Heading */
.highlight .gp { font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { font-weight: bold } /* Generic.Subheading */
.highlight .kc { color: #0000ff } /* Keyword.Constant */
.highlight .kd { color: #0000ff } /* Keyword.Declaration */
.highlight .kn { color: #0000ff } /* Keyword.Namespace */
.highlight .kp { color: #0000ff } /* Keyword.Pseudo */
.highlight .kr { color: #0000ff } /* Keyword.Reserved */
.highlight .kt { color: #2b91af } /* Keyword.Type */
.highlight .s { color: #a31515 } /* Literal.String */
.highlight .nc { color: #2b91af } /* Name.Class */
.highlight .ow { color: #0000ff } /* Operator.Word */
.highlight .sb { color: #a31515 } /* Literal.String.Backtick */
.highlight .sc { color: #a31515 } /* Literal.String.Char */
.highlight .sd { color: #a31515 } /* Literal.String.Doc */
.highlight .s2 { color: #a31515 } /* Literal.String.Double */
.highlight .se { color: #a31515 } /* Literal.String.Escape */
.highlight .sh { color: #a31515 } /* Literal.String.Heredoc */
.highlight .si { color: #a31515 } /* Literal.String.Interpol */
.highlight .sx { color: #a31515 } /* Literal.String.Other */
.highlight .sr { color: #a31515 } /* Literal.String.Regex */
.highlight .s1 { color: #a31515 } /* Literal.String.Single */
.highlight .ss { color: #a31515 } /* Literal.String.Symbol */

/* Comments */
/* ----------------------------------------------------------*/

.comment-container {
    margin-top: 1em;
}

.comment-container > .comment-container {
    margin-left: 2em;
}

.comment-container > .comment-container > .comment-container > .comment-container > .comment-container {
    margin-left: 0;
}

/* Correct anchor links in comments (they are offset by the height of the fixed header) */
.comment-anchor {
    display: block;
    position: relative;
    top: -60px;
    visibility: hidden;
}

img.comment-author-profile-image {
    height: 80px;
    width: 80px;
    margin-right: 10px;
}

.comment-message {
    overflow-x: auto;
}

.comment-form {
    border: 1px solid black;
    padding: 1em;
}

.comment-new {
    margin-top: 1em;
    margin-bottom: 1em;
}

.comment-new, .comment-reply {
    margin-left: 1em;
}

.comment-hidden {
    display: none;
}

.comment-form-buttonbar {
    margin-top: 1em;
}
</style>
    
    <meta name="application-name" content="Stephen Cleary" />
    <link rel="search" type="application/opensearchdescription+xml" href="https://stephencleary.com/opensearch.xml" title="Cleary Search">
    <link rel="apple-touch-icon" sizes="57x57" href="https://stephencleary.com/icons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="https://stephencleary.com/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://stephencleary.com/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://stephencleary.com/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="https://stephencleary.com/icons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="https://stephencleary.com/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="https://stephencleary.com/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://stephencleary.com/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" href="https://stephencleary.com/icons/apple-touch-icon.png"/>
    <link rel="apple-touch-icon-precomposed" href="https://stephencleary.com/icons/apple-touch-icon-precomposed.png"/>
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-196x196.png" sizes="196x196">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-32x32.png" sizes="32x32">
    
    <meta name="google-site-verification" content="L8q0fpGSwpNSD0OGFI07hyMujSpORrV4tAaNx_Js7oQ" />
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <div class="navbar-brand-container"><a class="navbar-brand" href="https://stephencleary.com">Stephen Cleary</a></div>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
            <li  class="active"  ><a href="https://blog.stephencleary.com">Blog</a></li>
            <li  ><a href="https://stephencleary.com/book/">Book</a></li>
            <li  ><a href="https://stephencleary.com/projects/">Projects</a></li>
            <li  ><a href="https://stephencleary.com/publications/">Publications</a></li>
            <li  ><a href="https://stephencleary.com/contact/">Contact</a></li>
            <li  ><a href="https://stephencleary.com/contract/">Hire Me</a></li>
            <li><a href="http://feeds.feedburner.com/NitoPrograms"><i class="fa fa-rss-square fa-lg"></i></a></li>
            <li  ><a href="https://stephencleary.com/search/"><i class="fa fa-search"></i></a></li>
        </ul>
    </div>
</nav>

    <div class="container-fluid">
        <div class="col-sm-8 col-sm-offset-2 col-md-6 col-md-offset-3">
            <div class="post">

  <header>
      <div class="page-header">
          <h1>ConfigureAwait in .NET 8</h1>
          <small><time datetime="2023-11-09">Nov 9, 2023</time> &bull; <a id="comment-counter" href="#comments">Comments</a></small>
      </div>
  </header>

  <article>
  <p>I don’t often write “what’s new in .NET” posts, but .NET 8.0 has an interesting addition that I haven’t seen a lot of people talk about. <code>ConfigureAwait</code> is getting a pretty good overhaul/enhancement; let’s take a look!</p>

<h2 id="configureawaittrue-and-configureawaitfalse">ConfigureAwait(true) and ConfigureAwait(false)</h2>

<p>First, let’s review the semantics and history of the original <code>ConfigureAwait</code>, which takes a boolean argument named <code>continueOnCapturedContext</code>.</p>

<p>When <code>await</code> acts on a task (<code>Task</code>, <code>Task&lt;T&gt;</code>, <code>ValueTask</code>, or <code>ValueTask&lt;T&gt;</code>), its <a href="/2012/02/async-and-await.html">default behavior</a> is to capture a “context”; later, when the task completes, the <code>async</code> method resumes executing in that context. The “context” is <code>SynchronizationContext.Current</code> or <code>TaskScheduler.Current</code> (falling back on the thread pool context if none is provided). This default behavior of continuing on the captured context can be made explicit by using <code>ConfigureAwait(continueOnCapturedContext: true)</code>.</p>

<p><code>ConfigureAwait(continueOnCapturedContext: false)</code> is useful if you <em>don’t</em> want to resume on that context. When using <code>ConfigureAwait(false)</code>, the <code>async</code> method resumes on any available thread pool thread.</p>

<p>The history of <code>ConfigureAwait(false)</code> is interesting (at least to me). Originally, the community recommended using <code>ConfigureAwait(false)</code> everywhere you could, unless you <em>needed</em> the context. This is the position I <a href="https://learn.microsoft.com/en-us/archive/msdn-magazine/2013/march/async-await-best-practices-in-asynchronous-programming?WT.mc_id=DT-MVP-5000058#configure-context">recommended in my Async Best Practices article</a>. There were several discussions during that time frame over why the default was <code>true</code>, especially from frustrated library developers who had to use <code>ConfigureAwait(false)</code> a lot.</p>

<p>Over the years, though, the recommendation of “use <code>ConfigureAwait(false)</code> whenever you can” has been modified. The first (albeit minor) shift was instead of “use <code>ConfigureAwait(false)</code> whenever you can”, a simpler guideline arose: use <code>ConfigureAwait(false)</code> in library code and <em>don’t</em> use it in application code. This is an easier guideline to understand and follow. Still, the complaints about having to use <code>ConfigureAwait(false)</code> continued, with periodic requests to change the default on a project-wide level. These requests have always been rejected by the C# team for language consistency reasons.</p>

<p>More recently (specifically, since ASP.NET dropped their <code>SynchronizationContext</code> with ASP.NET Core and fixed all the places where sync-over-async was necessary), there has been a move away from <code>ConfigureAwait(false)</code>. As a library author, I fully understand how annoying it is to have <code>ConfigureAwait(false)</code> litter your codebase! Some library authors have just decided not to bother with <code>ConfigureAwait(false)</code>. For myself, I still use <code>ConfigureAwait(false)</code> in my libraries, but I understand the frustration.</p>

<div class="alert alert-info">
  <p><i class="fa fa-hand-o-right fa-2x pull-left"></i></p>

  <p>An earlier version of this post incorrectly claimed that the Entity Framework Core team had decided not to use <code>ConfigureAwait(false)</code>. This was only true in early versions of Entity Framework Core. Entity Framework Core <a href="https://github.com/dotnet/efcore/pull/21110" class="alert-link">added <code>ConfigureAwait(false)</code> in version 5.0.0</a> and continues to use <code>ConfigureAwait(false)</code> as of this writing (2023-11-11).</p>
</div>

<p>Since we’re on the topic of <code>ConfigureAwait(false)</code>, I’d like to note a few common misconceptions:</p>

<ol>
  <li><code>ConfigureAwait(false)</code> is not a good way to avoid deadlocks. That’s not its purpose, and it’s a questionable solution at best. In order to avoid deadlocks when doing direct blocking, you’d have to make sure <em>all</em> the asynchronous code uses <code>ConfigureAwait(false)</code>, including code in libraries and the runtime. It’s just not a very maintainable solution. There are <a href="https://learn.microsoft.com/en-us/archive/msdn-magazine/2015/july/async-programming-brownfield-async-development?WT.mc_id=DT-MVP-5000058">better solutions available</a>.</li>
  <li><code>ConfigureAwait</code> configures the <code>await</code>, not the task. E.g., the <code>ConfigureAwait(false)</code> in <code>SomethingAsync().ConfigureAwait(false).GetAwaiter().GetResult()</code> does exactly nothing. Similarly, the <code>await</code> in <code>var task = SomethingAsync(); task.ConfigureAwait(false); await task;</code> still continues on the captured context, completely ignoring the <code>ConfigureAwait(false)</code>. I’ve seen both of these mistakes over the years.</li>
  <li><code>ConfigureAwait(false)</code> does not mean “run the rest of this method on a thread pool thread” or “run the rest of this method on a different thread”. It only takes effect if the <code>await</code> yields control and then later resumes the <code>async</code> method. Specifically, <code>await</code> will <em>not</em> yield control if its task is already complete; in that case, the <code>ConfigureAwait</code> has no effect because the <code>await</code> continues synchronously.</li>
</ol>

<p>OK, now that we’ve refreshed our understanding of <code>ConfigureAwait(false)</code>, let’s take a look at how <code>ConfigureAwait</code> is getting some enhancements in .NET 8. None of the existing behavior is changed; <code>await</code> without any <code>ConfigureAwait</code> at all still has the default behavior of <code>ConfigureAwait(true)</code>, and <code>ConfigureAwait(false)</code> still has the same behavior, too. But there’s a <em>new</em> <code>ConfigureAwait</code> coming into town!</p>

<h2 id="configureawaitconfigureawaitoptions">ConfigureAwait(ConfigureAwaitOptions)</h2>

<p>There are several new options available for <code>ConfigureAwait</code>. <a href="https://learn.microsoft.com/en-us/dotnet/api/system.threading.tasks.configureawaitoptions?view=net-8.0"><code>ConfigureAwaitOptions</code></a> is a new type that provides all the different ways to configure awaitables:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">namespace</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="na">[Flags]</span>
<span class="k">public</span> <span class="k">enum</span> <span class="n">ConfigureAwaitOptions</span>
<span class="p">{</span>
    <span class="n">None</span> <span class="p">=</span> <span class="m">0</span><span class="n">x0</span><span class="p">,</span>
    <span class="n">ContinueOnCapturedContext</span> <span class="p">=</span> <span class="m">0</span><span class="n">x1</span><span class="p">,</span>
    <span class="n">SuppressThrowing</span> <span class="p">=</span> <span class="m">0</span><span class="n">x2</span><span class="p">,</span>
    <span class="n">ForceYielding</span> <span class="p">=</span> <span class="m">0</span><span class="n">x4</span><span class="p">,</span>
<span class="p">}</span></code></pre></figure>

<p>First, a quick note: this is a <code>Flags</code> enum; any combination of these options can be used together.</p>

<p>The next thing I want to point out is that <code>ConfigureAwait(ConfigureAwaitOptions)</code> is only available on <code>Task</code> and <code>Task&lt;T&gt;</code>, at least for .NET 8. It wasn’t added to <code>ValueTask</code> / <code>ValueTask&lt;T&gt;</code> yet. It’s possible that a future release of .NET may add <code>ConfigureAwait(ConfigureAwaitOptions)</code> for value tasks, but as of now it’s only available on reference tasks, so you’ll need to call <code>AsTask</code> if you want to use these new options on value tasks.</p>

<p>Now, let’s consider each of these options in turn.</p>

<h3 id="configureawaitoptionsnone-and-configureawaitoptionscontinueoncapturedcontext">ConfigureAwaitOptions.None and ConfigureAwaitOptions.ContinueOnCapturedContext</h3>

<p>These two are going to be pretty familiar, except with one twist.</p>

<p><code>ConfigureAwaitOptions.ContinueOnCapturedContext</code> - as you might guess from the name - is the same as <code>ConfigureAwait(continueOnCapturedContext: true)</code>. In other words, the <code>await</code> will capture the context and resume executing the <code>async</code> method on that context.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Task</span> <span class="n">task</span> <span class="p">=</span> <span class="p">...;</span>

<span class="c1">// These all do the same thing</span>
<span class="k">await</span> <span class="n">task</span><span class="p">;</span>
<span class="k">await</span> <span class="n">task</span><span class="p">.</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="n">continueOnCapturedContext</span><span class="p">:</span> <span class="k">true</span><span class="p">);</span>
<span class="k">await</span> <span class="n">task</span><span class="p">.</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="n">ConfigureAwaitOptions</span><span class="p">.</span><span class="n">ContinueOnCapturedContext</span><span class="p">);</span></code></pre></figure>

<p><code>ConfigureAwaitOptions.None</code> is the same as <code>ConfigureAwait(continueOnCapturedContext: false)</code>. In other words, <code>await</code> will behave perfectly normally, except that it will <em>not</em> capture the context; assuming the <code>await</code> does yield (i.e, the task is not already complete), then the <code>async</code> method will resume executing on any available thread pool thread.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Task</span> <span class="n">task</span> <span class="p">=</span> <span class="p">...;</span>

<span class="c1">// These do the same thing</span>
<span class="k">await</span> <span class="n">task</span><span class="p">.</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="n">continueOnCapturedContext</span><span class="p">:</span> <span class="k">false</span><span class="p">);</span>
<span class="k">await</span> <span class="n">task</span><span class="p">.</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="n">ConfigureAwaitOptions</span><span class="p">.</span><span class="n">None</span><span class="p">);</span></code></pre></figure>

<p>Here’s the twist: with the new options, the default is to <em>not</em> capture the context! Unless you explicitly include <code>ContinueOnCapturedContext</code> in your flags, the context will <em>not</em> be captured. Of course, the default behavior of <code>await</code> itself is unchanged: without any <code>ConfigureAwait</code> at all, <code>await</code> will behave as though <code>ConfigureAwait(true)</code> or <code>ConfigureAwait(ConfigureAwaitOptions.ContinueOnCapturedContext)</code> was used.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Task</span> <span class="n">task</span> <span class="p">=</span> <span class="p">...;</span>

<span class="c1">// Default behavior (no ConfigureAwait): continue on the captured context.</span>
<span class="k">await</span> <span class="n">task</span><span class="p">;</span>

<span class="c1">// Default flag option (None): do not continue on the captured context.</span>
<span class="k">await</span> <span class="n">task</span><span class="p">.</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="n">ConfigureAwaitOptions</span><span class="p">.</span><span class="n">None</span><span class="p">);</span></code></pre></figure>

<p>So, that’s something to keep in mind as you start using this new <code>ConfigureAwaitOptions</code> enum.</p>

<h3 id="configureawaitoptionssuppressthrowing">ConfigureAwaitOptions.SuppressThrowing</h3>

<p>The <code>SuppressThrowing</code> flag suppresses exceptions that would otherwise occur when <code>await</code>ing a task. Under normal conditions, <code>await</code> will observe task exceptions by re-raising them at the point of the <code>await</code>. Normally, this is exactly the behavior you want, but there are some situations where you just want to wait for the task to complete and you don’t care whether it completes successfully or with an exception. <code>SuppressThrowing</code> allows you to wait for the completion of a task without observing its result.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Task</span> <span class="n">task</span> <span class="p">=</span> <span class="p">...;</span>

<span class="c1">// These do the same thing</span>
<span class="k">await</span> <span class="n">task</span><span class="p">.</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="n">ConfigureAwaitOptions</span><span class="p">.</span><span class="n">SuppressThrowing</span><span class="p">);</span>
<span class="k">try</span> <span class="p">{</span> <span class="k">await</span> <span class="n">task</span><span class="p">.</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span> <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span> <span class="p">}</span></code></pre></figure>

<p>I expect this will be most useful alongside cancellation. There are some cases where some code needs to cancel a task and then wait for the existing task to complete before starting a replacement task. <code>SuppressThrowing</code> would be useful in that scenario: the code can <code>await</code> with <code>SuppressThrowing</code>, and the method will continue when the task completes, whether it was successful, canceled, or finished with an exception.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="c1">// Cancel the old task and wait for it to complete, ignoring exceptions.</span>
<span class="n">_cts</span><span class="p">.</span><span class="n">Cancel</span><span class="p">();</span>
<span class="k">await</span> <span class="n">_task</span><span class="p">.</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="n">ConfigureAwaitOptions</span><span class="p">.</span><span class="n">SuppressThrowing</span><span class="p">);</span>

<span class="c1">// Start the new task.</span>
<span class="n">_cts</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CancellationTokenSource</span><span class="p">();</span>
<span class="n">_task</span> <span class="p">=</span> <span class="n">SomethingAsync</span><span class="p">(</span><span class="n">_cts</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span></code></pre></figure>

<p>If you <code>await</code> with the <code>SuppressThrowing</code> flag, then the exception <em>is</em> considered “observed”, so <code>TaskScheduler.UnobservedTaskException</code> is not raised. The assumption is that you are awaiting the task and deliberately discarding the exception, so it’s not considered unobserved.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">TaskScheduler</span><span class="p">.</span><span class="n">UnobservedTaskException</span> <span class="p">+=</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;never printed&quot;</span><span class="p">);</span> <span class="p">};</span>

<span class="n">Task</span> <span class="n">task</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="n">FromException</span><span class="p">(</span><span class="k">new</span> <span class="n">InvalidOperationException</span><span class="p">());</span>
<span class="k">await</span> <span class="n">task</span><span class="p">.</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="n">ConfigureAwaitOptions</span><span class="p">.</span><span class="n">SuppressThrowing</span><span class="p">);</span>
<span class="n">task</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

<span class="n">GC</span><span class="p">.</span><span class="n">Collect</span><span class="p">();</span>
<span class="n">GC</span><span class="p">.</span><span class="n">WaitForPendingFinalizers</span><span class="p">();</span>
<span class="n">GC</span><span class="p">.</span><span class="n">Collect</span><span class="p">();</span>

<span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span></code></pre></figure>

<p>There’s another consideration for this flag as well. When used with a plain <code>Task</code>, the semantics are clear: if the task faults, the exception is just ignored. However, the same semantics don’t quite work for <code>Task&lt;T&gt;</code>, because in that case the <code>await</code> expression needs to return a value (of type <code>T</code>). It’s not clear what value of <code>T</code> would be appropriate to return in the case of an ignored exception, so the current behavior is to throw an <code>ArgumentOutOfRangeException</code> at runtime. To help catch this at compile time, a new warning <a href="https://github.com/dotnet/roslyn-analyzers/pull/6669">was added</a>: <code>CA2261</code> <code>The ConfigureAwaitOptions.SuppressThrowing is only supported with the non-generic Task</code>. This rule defaults to a warning, but I’d suggest making it an error, since it will always fail at runtime.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Task</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">task</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="n">FromResult</span><span class="p">(</span><span class="m">13</span><span class="p">);</span>

<span class="c1">// Causes CA2261 warning at build time and ArgumentOutOfRangeException at runtime.</span>
<span class="k">await</span> <span class="n">task</span><span class="p">.</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="n">ConfigureAwaitOptions</span><span class="p">.</span><span class="n">SuppressThrowing</span><span class="p">);</span></code></pre></figure>

<p>As a final note, this is one flag that also affects synchronous blocking in addition to <code>await</code>. Specifically, you can call <code>.GetAwaiter().GetResult()</code> to block on the awaiter returned from <code>ConfigureAwait</code>. The <code>SuppressThrowing</code> flag will cause exceptions to be ignored whether using <code>await</code> or <code>GetAwaiter().GetResult()</code>. Previously, when <code>ConfigureAwait</code> only took a boolean parameter, you could say “ConfigureAwait configures the await”; but now you have to be more specific: “ConfigureAwait returns a configured awaitable”. And it is now possible that the configured awaitable modifies the behavior of blocking code in addition to the behavior of the <code>await</code>. <code>ConfigureAwait</code> is perhaps a slight misnomer now, but it is still <em>primarily</em> intended for configuring <code>await</code>. Of course, blocking on asynchronous code still isn’t recommended.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Task</span> <span class="n">task</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="n">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">InvalidOperationException</span><span class="p">());</span>

<span class="c1">// Synchronously blocks on the task (not recommended). Does not throw an exception.</span>
<span class="n">task</span><span class="p">.</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="n">ConfigureAwaitOptions</span><span class="p">.</span><span class="n">SuppressThrowing</span><span class="p">).</span><span class="n">GetAwaiter</span><span class="p">().</span><span class="n">GetResult</span><span class="p">();</span></code></pre></figure>

<h3 id="configureawaitoptionsforceyielding">ConfigureAwaitOptions.ForceYielding</h3>

<p>The final flag is the <code>ForceYielding</code> flag. I expect this flag will be rarely used, but when you need it, you need it!</p>

<p><code>ForceYielding</code> is similar to <code>Task.Yield</code>. <code>Yield</code> returns a special awaitable that always claims to be not completed, but schedules its continuations immediately. What this means is that the <code>await</code> always acts asynchronously, yielding to its caller, and then the <code>async</code> method continues executing as soon as possible. The <a href="% post_url 2012-02-02-async-and-await %">normal behavior for <code>await</code></a> is to check if its awaitable is complete, and if it is, then continue executing synchronously; <code>ForceYielding</code> prevents that synchronous behavior, forcing the <code>await</code> to behave asynchronously.</p>

<p>For myself, I find forcing asynchronous behavior most useful in unit testing. It can also be used to avoid stack dives in some cases. It may also be useful when implementing asynchronous coordination primitives, such as the ones in my AsyncEx library. Essentially, anywhere where you want to force <code>await</code> to behave asynchronously, you can use <code>ForceYielding</code> to accomplish that.</p>

<p>One point that I find interesting is that <code>await</code> with <code>ForceYielding</code> makes the <code>await</code> behave like it does in JavaScript. In JavaScript, <code>await</code> <em>always</em> yields, even if you pass it a resolved promise. In C#, you can now <code>await</code> a completed task with <code>ForceYielding</code>, and <code>await</code> will behave as though it’s not completed, just like JavaScript’s <code>await</code>.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="n">CurrentManagedThreadId</span><span class="p">);</span> <span class="c1">// main thread</span>
  <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
  <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="n">CurrentManagedThreadId</span><span class="p">);</span> <span class="c1">// main thread</span>
  <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">.</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="n">ConfigureAwaitOptions</span><span class="p">.</span><span class="n">ForceYielding</span><span class="p">);</span>
  <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="n">CurrentManagedThreadId</span><span class="p">);</span> <span class="c1">// thread pool thread</span>
<span class="p">}</span></code></pre></figure>

<p>Note that <code>ForceYielding</code> by itself also implies <em>not</em> continuing on the captured context, so it is the same as saying “schedule the rest of this method to the thread pool” or “switch to a thread pool thread”.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="c1">// ForceYielding forces await to behave asynchronously.</span>
<span class="c1">// Lack of ContinueOnCapturedContext means the method continues on a thread pool thread.</span>
<span class="c1">// Therefore, code after this statement will *always* run on a thread pool thread.</span>
<span class="k">await</span> <span class="n">task</span><span class="p">.</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="n">ConfigureAwaitOptions</span><span class="p">.</span><span class="n">ForceYielding</span><span class="p">);</span></code></pre></figure>

<p><code>Task.Yield</code> <em>will</em> resume on the captured context, so it’s not <em>exactly</em> like <code>ForceYielding</code> by itself. It’s actually like <code>ForceYielding</code> with <code>ContinueOnCapturedContext</code>.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="c1">// These do the same thing</span>
<span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">Yield</span><span class="p">();</span>
<span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">.</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="n">ConfigureAwaitOptions</span><span class="p">.</span><span class="n">ForceYielding</span> <span class="p">|</span> <span class="n">ConfigureAwaitOptions</span><span class="p">.</span><span class="n">ContinueOnCapturedContext</span><span class="p">);</span></code></pre></figure>

<p>Of course, the real value of <code>ForceYielding</code> is that it can be applied to any task at all. Previously, in the situations where yielding was required, you had to either add a <em>separate</em> <code>await Task.Yield();</code> statement or create a custom awaitable. That’s no longer necessary now that <code>ForceYielding</code> can be applied to any task.</p>

<h2 id="further-reading">Further Reading</h2>

<p>It’s great to see the .NET team still making improvements in <code>async</code>/<code>await</code>, all these years later!</p>

<p>If you’re interested in more of the history and design discussion behind <code>ConfigureAwaitOptions</code>, check out the <a href="https://github.com/dotnet/runtime/pull/87067">pull request</a>. At one point there <a href="https://github.com/dotnet/runtime/issues/22144#issuecomment-1561983918">was</a> a <code>ForceAsynchronousContinuation</code> that was dropped before release. It had a more obscure use case, essentially overriding <code>await</code>’s <a href="/2012/12/dont-block-in-asynchronous-code.html">default behavior of scheduling the <code>async</code> method continuation with <code>ExecuteSynchronously</code></a>. Perhaps a future update will add that back in, or perhaps a future update will add <code>ConfigureAwaitOptions</code> support to value tasks. We’ll just have to see what the future holds!</p>

  </article>
    
    <footer class="hidden-print">
        <div class="alert alert-info" markdown="1">
            <i class="fa fa-hand-o-right fa-2x pull-left"></i>
            
            <div>Has this been helpful? You can show your appreciation by <a href="https://github.com/sponsors/StephenCleary?frequency=one-time&amount=5" class="alert-link">leaving a "coffee" tip.</a> Thanks!</div>
        </div>

        
        
        <ul class="pager">
            <li class="previous"><a href="/2023/10/padding-for-overlaid-structs.html" title="Padding for Overlaid Structs">&larr; Previous Post</a></li>
            
        </ul>

        <div id="comments"></div>
    </footer>
</div>
        </div>
        <div class="col-sm-2 col-md-3 col-md-offset-0 col-lg-2 col-lg-offset-1 affix hidden-print" data-spy="affix" role="navigation">
            
            
        </div>
        <div class="col-sm-2 sidebar hidden-print">
            <div class="panel panel-default">
                <div class="panel-heading">About Stephen Cleary</div>
                <div class="panel-body">
                    <div class="center"><img src="https://stephencleary.com/www.assets/Me-large.jpg"/></div>
                    <div class="center vertical-margins">Stephen Cleary is a <a href="https://stephencleary.com/god/">Christian</a>, husband, father, and programmer living in Northern Michigan.</div>
                    <div class="center"><a href="http://mvp.microsoft.com/en-us/mvp/Stephen%20Cleary-5000058"><img class="mvp-logo" src="https://stephencleary.com/www.assets/MVP.png"/></a></div>
                </div>
            </div>
            <div class="panel panel-primary">
                <div class="panel-heading">My book</div>
                <div class="panel-body center">
                    <div><a href="https://stephencleary.com/book/"><img src="https://stephencleary.com/www.assets/Book-2nd-small.jpg"/></a></div>
                    <div>Available from <a href="https://www.amazon.com/dp/149205450x/ref=as_li_ss_tl?&ref=pd_sl_a04BABB1D18C7F2658168FF785&linkCode=sl1&tag=stepheclearys-20&linkId=fb22bb126d6e60f305fecddf3d4ecbd8" rel="nofollow">Amazon (print/Kindle)</a>, <a href="https://learning.oreilly.com/library/view/concurrency-in-c/9781492054498/" rel="nofollow">O'Reilly (Safari)</a>, or <a href="https://www.ebooks.com/cj.asp?IID=209766469&cjsku=209766469" rel="nofollow">eBooks.com (PDF/epub)</a>.</div>
                    <div>Also available in <a href="https://www.labirint.ru/books/745595/" rel="nofollow">Russian</a>, <a href="https://item.jd.com/12769567.html" rel="nofollow">Chinese</a>, and <a href="https://www.aladin.co.kr/shop/wproduct.aspx?ItemId=270818316" rel="nofollow">Korean</a>.</div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Advertisement</div>
                <div><a href="https://stephencleary.com/contract/">Hire me if you need in-depth assistance!</a></div>
                <div class="panel-body">
                    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2749292939902134" data-ad-slot="7584809820" data-ad-format="auto"></ins>
                </div>
                <div>This page may contain affiliate links.</div>
            </div>
            
            <div class="panel panel-primary">
                <div class="panel-heading">Popular Posts</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2012/02/async-and-await.html">Async/await Intro</a></li>
                        <li><a href="/2013/11/there-is-no-thread.html">There Is No Thread</a></li>
                        <li><a href="/2012/07/dont-block-on-async-code.html">Don't Block on Async Code</a></li>
                    </ul>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Series</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2016/02/react-redux-todomvc.html">React/Redux TodoMVC</a></li>
                        <li><a href="/2014/04/a-tour-of-task-part-0-overview.html">A Tour of Task</a></li>
                        <li><a href="/2013/10/taskrun-etiquette-and-proper-usage.html">Task.Run Etiquette</a></li>
                        <li><a href="/2013/05/taskrun-vs-backgroundworker-intro.html">Task.Run vs. BackgroundWorker</a></li>
                        <li><a href="/2013/01/async-oop-0-introduction.html">Async OOP</a></li>
                        <li><a href="/2009/04/tcpip-net-sockets-faq.html">TCP/IP .NET Sockets FAQ</a></li>
                        <li><a href="/2013/10/managed-services-roundup.html">Managed Services</a></li>
                        <li><a href="/2009/08/how-to-implement-idisposable-and.html">IDisposable and Finalizers</a></li>
                        <li><a href="/2011/02/option-parsing-introduction.html">Option Parsing</a></li>
                    </ul>
                </div>
            </div>
            
        </div>
    </div>

    <div class="google">
        <gcse:searchresults></gcse:searchresults>
    </div>
    
    <!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
<script type="text/javascript">window.jQuery || document.write('<script src="/lib/jquery-2.1.1.min.js"><\/script>')</script>

<!-- Bootstrap -->
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script type="text/javascript">window.jQuery.fn.modal || document.write('<script src="/lib/bootstrap.min.js"><\/script>')</script>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('body').css('color') !== 'rgb(102, 102, 102)') {
                $('head').prepend('<link rel="stylesheet" href="/lib/bootstrap.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Font Awesome -->
<span id="facheck" class="fa" style="display:none"></span>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('#facheck').css('fontFamily') !== 'FontAwesome') {
                $('head').prepend('<link rel="stylesheet" href="/lib/font-awesome.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Scroll the sidebar into view (if necessary) -->


<!-- Moment -->
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.6.0/moment.min.js"></script>
<script type="text/javascript">window.moment || document.write('<script src="/lib/moment.min.js"><\/script>')</script>

<!-- Google analytics -->
<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-8910661-5', 'stephencleary.com');
    ga('send', 'pageview');
</script>

<!-- Show appropriate elements based on time -->
<script type="text/javascript">
    (function ($) {
        $(function () {
            var targets = $('[data-hide-after]');
            targets.each(function () {
                var $item = $(this);
                if (moment() < moment($item.attr('data-hide-after'))) {
                    $item.removeClass('hidden');
                }
            });
        });
    })(window.jQuery);
</script>




<!-- Email obfuscation -->
<script type="text/javascript">
    (function($) {
        $(function() {
            var x = 'an',
                y = 'steph',
                email = 'mailto:' + y + 'en' + x + 'dm' + x + 'dy@' + 'gma' + 'il.' + 'com';
            $('.email-link').attr('href', email);
        });
    })(window.jQuery);
</script>



<script src="/lib/uuid-v3-3.2.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/showdown@1.8.6/dist/showdown.min.js" integrity="sha256-dwhppIrxD8qC6lNulndZgtIm4XBU9zoMd9OUoXzIDAE=" crossorigin="anonymous"></script>
<script src="/lib/sanitize-html-1.18.2.min.js"></script>
<script src="/lib/autosize.min.js"></script>
<script src="/lib/base64js.min.js"></script>
<script src="/lib/md5.min.js"></script>

<script type="text/javascript">

var pageUrl = "https://blog.stephencleary.com" + "/2023/11/configureawait-in-net-8.html";

// (unnecessary) 1) If the URL starts with http://, replace with https://

// 2) Take the URL path (not including scheme and domain).
var url = document.createElement('a');
url.href = pageUrl; //'https://developer.mozilla.org:8080/en-US/search?q=URL#search-results-close-container';
var path = url.pathname;

// 3) Path: If the path ends with .html or any two- to six-character [A-Za-z0-9] extension, strip it.
if (path.endsWith(".html"))
    path = path.substr(0, path.length - 5);
else
    path = path.replace(/\.[A-Za-z0-9]{2,6}$/, "");

// 4) Path: For each UTF-16 code unit, if it's not in the whitelist [A-Za-z0-9-_;.~()], then replace it with _.
path = path.replace(/[^-A-Za-z0-9_;.~()]/g, "_");

// 5) Path: Trim leading and trailing _ characters.
path = path.replace(/^_+|_+$/g, "");

// 6) Calculate the V3 URL GUID for the URL.
var guid = uuidv3(pageUrl, uuidv3.URL);

// 7) Combine the path and lowercase-hyphenated GUID, separated by '-'.
var postId = path + "-" + guid;

var nofollowLinkExtension = {
    type: 'output',
    regex: /(<a[^<]+<\/a>)/g,
    replace: (match, $1, $2) => {
        var result = $('<div/>').append($($1).attr('rel', 'nofollow noopener ugc')).html();
        return result;
    }
};
showdown.extension('nofollowLink', nofollowLinkExtension);

var comments;
var markdownConverter = new showdown.Converter({
    omitExtraWLInCodeBlocks: true,
    noHeaderId: true,
    headerLevelStart: 3,
    simplifiedAutoLink: true,
    excludeTrailingPunctuationFromURLs: true,
    literalMidWordUnderscores: true,
    strikethrough: true,
    smoothLivePreview: true,
    disableForced4SpacesIndentedSublists: true,
    extensions: ['nofollowLink']
});
var sanitizeOptions = {
    allowedTags: [ 'blockquote', 'p', 'a', 'ul', 'ol', 'nl', 'li', 'b', 'i', 'strong', 'em', 'strike', 'code', 'br', 'div', 'pre', 'img' ],
    allowedAttributes: {
        a: [
            'href',
            {
                name: 'rel',
                multiple: true,
                values: ['nofollow', 'noopener', 'ugc']
            }
        ],
        img: [ 'src' ]
    },
    allowedIframeHostnames: []
};

function fixedEncodeURIComponent(str) {
  return encodeURIComponent(str).replace(/[!'()*]/g, function(c) {
    return '%' + c.charCodeAt(0).toString(16);
  });
}

function filterComments(replyTo) {
    return comments
        .filter(function (x) { return x.replyTo === replyTo; })
        .sort(function (a, b) { return a.timestamp - b.timestamp; });
}

function avatarUri(authorEmailMD5) {
    if (authorEmailMD5 === "")
        return "https://www.gravatar.com/avatar/?d=mp&f=y";
    else
        return "https://www.gravatar.com/avatar/" + authorEmailMD5 + "?d=retro";
}

var jwk = {"kty":"RSA","alg":"RSA-OAEP","n":"wviXqUJGtV8hZrvJMcTbyzm7MmiJSqsAfWI_7pCyAhXXzz5C9F3NtXp79CCUMqkOck6IbNKUntPtGNOGwtoc5LTJNKLhx3TPi4TJyKUSfNr3pAdLpMRNeeRXCHFyyVsDb6z8ueixlKzdbDpZhV05bam49PurMHfeexJ3EJy2NpdFviykRJxtrERi6ckBe96VMlT_pHHIWLN5EwOK54DvNn1DYjiFK5ux5WRCFatZByzytrFvIllZRctNXZ8oTuMjQwKLY2bUrURblbIvLfX-9Yd7uVgdUSFE7-vSel9-DMyp_NQ-NRXrQbJG7IAYhSGSx-TPepCDPbFpMq3yC0iET7wF7-OQOb-Kwej_TKVJv-z4SbN-cpCqaMr5Q9scyGih7xr1YrOhe3TMs_cbgjtxsZbzkOqcuRreON_sGb9nlDpSIFCo6aH47GeMkA23Hk3HXAPyYQ7AfWhU9daiPcySiAFnfkrg2QvFNJmMSZ-bo4Co-JkjiqKw-LEpOw6Ed9LK4walxWUAqPGcT4_Uys3TH9XVex9_rEmigHXiJY3_Lwi6mTSkW10-zen5UXxqnyHpMxlmumohT96OyLyhEPeaaq8FrTYMCX8TiMOst3jF5QCNP-LFz21yeUEAr5_3-FKV2mjWEU9iW0dOOVTII2rlD0WtCkqkDwZtakQ1ynGdW1E","e":"AQAB"};

function commentId(id) { return "comment-" + id; }

function $commentForm(hideForm, comment) {
    var $previewDiv = $('<div/>');
    var $authorEmailEncrypted = $('<input type="hidden" name="authorEmailEncrypted">');
    var $authorEmailMD5 = $('<input type="hidden" name="authorEmailMD5">');
    var $email = $('<input type="email" name="email" class="form-control" placeholder="Email">');
    var $name = $('<input type="text" name="authorName" class="form-control" placeholder="Name">');
    var $url = $('<input type="url" name="authorUri" class="form-control" placeholder="Url">');
    var $message = $('<textarea name="message" class="form-control" placeholder="Message"/></textarea>');
    autosize($message);
    var $replyTo = $('<input type="hidden" name="replyTo">').val("");
    var $recaptcha = $('<div class="g-recaptcha" data-sitekey="6LfSaV8UAAAAAEFq-7HeUDiSQCkCtLtO_yc_SOi_"></div>');
    var $buttonBar = $('<div class="comment-form-buttonbar"/>').append($('<button type="submit" class="btn btn-primary pull-right">Submit</button>'), $recaptcha);
    var $form = $('<form method="POST" action="https://blogcomments.azurewebsites.net/api/Function1"/>')
        .append($('<input type="hidden" name="postId">').val(postId))
        .append($('<input type="hidden" name="postUri">').val(location.href.replace(/#.*/, '')))
        .append($replyTo)
        .append($authorEmailEncrypted)
        .append($authorEmailMD5)
        .append($('<div class="form-group"><label>Name (optional)</label></div>').append($name))
        .append($('<div class="form-group"><label>Email (optional; always encrypted, never shared)</label></div>').append($email))
        .append($('<div class="form-group"><label>Url (optional; must start with "http://" or "https://")</label></div>').append($url))
        .append($('<div class="form-group"><label>Message (supports some Markdown/HTML)</label></div>').append($message));
    if (comment) {
        $replyTo.val(comment._id);
    }
    const serialize_form = form => JSON.stringify(
        Array.from(new FormData(form).entries())
            .reduce((m, [ key, value ]) => Object.assign(m, { [key]: value }), {})
    );
    $form.submit(function (e) {
        e.preventDefault();
        hideForm();
        var postAction = $form.attr('action');
        var postBody = serialize_form($form.get(0));
        console.log(postBody);
        var retries = 5;

        function postIt() {
            var post = $.post(postAction, postBody, "json");
            post.done(function () {
                alert("Comment successfully posted. It should appear on this page in a minute or so.");
            });
            post.error(function () {
                var message = "Failed to post comment";
                if (post.responseText)
                    message += ": " + post.responseText;
                
                if (--retries > 0) {
                    console.log(message);
                    postIt();
                } else {
                    alert(message);
                }
            });
        }

        postIt();
    });

    function createComment() {
        return normalizeComment({
            date: moment().format(),
            _id: "_",
            replyTo: comment ? comment._id : undefined,
            authorName: $name.val(),
            authorEmailMD5: $authorEmailMD5.val(),
            authorUri: $url.val(),
            message: $message.val()
        });
    };

    function recreatePreview() {
        var email = $email.val();
        if (email && email.indexOf("@") !== -1) {
            var data = new TextEncoder().encode($email.val());
            window.crypto.subtle.importKey("jwk", jwk, { name: "RSA-OAEP", hash: { name: "SHA-1" } }, false, ["encrypt"]).then(function (encryptionKey) {
                return window.crypto.subtle.encrypt({ name: "RSA-OAEP" }, encryptionKey, data)
                    .then(function (encrypted) {
                        var array = new Uint8Array(encrypted);
                        var text = base64js.fromByteArray(array);
                        $authorEmailEncrypted.val(text);
                        return text;
                    });
            });
            $authorEmailMD5.val(md5($email.val().replace(/^ +| +$/g, '').toLowerCase()));
        } else {
            $authorEmailMD5.val("");
            $authorEmailEncrypted.val("");
        }

        var $newPreview = $comment(false, createComment());
        // Turn off permalink and anchor
        var $anchor = $newPreview.find('.comment-date a');
        $anchor.replaceWith($('<span/>').text($anchor.text()));
        $newPreview.find('.comment-anchor').remove();
        $previewDiv.empty();
        $previewDiv.append($newPreview);
    };

    recreatePreview();
    $name.on('change keyup input paste', recreatePreview);
    $email.on('change keyup input paste', recreatePreview);
    $url.on('change keyup input paste', recreatePreview);
    $message.on('change keyup input paste', recreatePreview);

    $form.append($('<h3>Preview:</h3>'), $previewDiv, $buttonBar);
    return {
        $form: $('<div class="comment-form"/>').append($form),
        onShow: function() { grecaptcha.render($recaptcha[0]); }
    };
}

function $replyButton(comment) {
    var $button;
    if (comment)
        $button = $('<button class="btn btn-primary comment-reply"><i class="fa fa-reply"></i> Reply</button>');
    else
        $button = $('<button class="btn btn-primary comment-new"><i class="fa fa-plus-square"></i> New Comment</button>');
    return $button;
}

var now = moment();
function $comment(includeForm, comment) {
    var message = sanitizeHtml(markdownConverter.makeHtml(comment.message), sanitizeOptions);
    var $commentDiv = $('<div class="comment"/>');
    var publicationDate = moment(comment.date);
    var $author = $('<div class="comment-author"/>').append($('<span class="comment-author-name"/>').text(comment.authorName));
    if (comment.authorUri !== "")
        $author.append($('<span> • </span>'), $('<a class="comment-author-uri" rel="nofollow noopener ugc"/>').attr('href', comment.authorUri).text(comment.authorUri));
    var $headerDiv = $('<div class="comment-header"/>').append(
        $('<div class="comment-author-profile" style="float:left;"/>').append($('<img class="comment-author-profile-image" src="' + avatarUri(comment.authorEmailMD5) + '"/>')),
        $author,
        $('<div class="comment-date" />').append(
            $('<a/>').attr('href', '#' + commentId(comment._id)).attr('title', 'permalink').text(publicationDate.from(now) + ' (' + publicationDate.format('YYYY-MM-DD hh:mm:ss a') + ')')
        )
    );
    if (comment.replyTo !== "") {
        var parent = comments.filter(function (x) { return x._id === comment.replyTo })[0];
        $headerDiv.append($('<div/>').append($('<a/>').attr('href', '#' + commentId(comment.replyTo)).text('In reply to ' + parent.authorName)));
    }

    $commentDiv.append($('<div class="comment-anchor"/>').attr('id', commentId(comment._id)),
        $headerDiv,
        $('<div class="comment-message" style="clear:both;"/>').html(message)
    );

    var $commentContainer = $('<div class="comment-container"/>').append($commentDiv);
    if (includeForm)
        $commentContainer.append($expandCollapseForm(comment));
    var childComments = filterComments(comment._id);
    for (var i = 0; i != childComments.length; ++i) {
        var child = childComments[i];
        $commentContainer.append($comment(includeForm, child));
    }

    return $commentContainer;
}

function normalizeComment(x) {
    var uri = x.authorUri;
    if (!uri || (!uri.startsWith("http://") && !uri.startsWith("https://")))
        uri = "";
    return {
            _id: x._id,
            authorName: x.authorName || "Anonymous",
            authorEmailMD5: x.authorEmailMD5 || "",
            authorUri: uri,
            message: x.message || "",
            replyTo: x.replyTo || "",
            date: x.date,
            timestamp: moment(x.date).valueOf()
    };
}

function $expandCollapseForm(comment) {
    var $button = $replyButton(comment);
    var formObj = $commentForm(hideForm, comment);
    var $form = formObj.$form.addClass("comment-hidden");
    var onShow = formObj.onShow;
    function showForm() {
        $button.addClass("comment-hidden");
        if (onShow) {
            onShow();
            onShow = null;
        }
        $form.removeClass("comment-hidden");
    }
    function hideForm() {
        $form.addClass("comment-hidden");
        $button.removeClass("comment-hidden");
    }
    $button.click(showForm);
    return $('<div/>').append($button, $form);
}

function recaptchaLoaded() {
    var req = new XMLHttpRequest();
    req.addEventListener("load", function () {
        var $commentDiv = $('#comments');
        if (req.status === 404 || req.status === 200) {
            if (req.status === 404) {
                comments = [];
            } else {
                comments = JSON.parse(req.responseText).map(normalizeComment);
            }
            var commentCounter = document.getElementById('comment-counter');
            commentCounter.innerText = comments.length + " " + commentCounter.innerText;
            var toplevelComments = filterComments("");
            for (var i = 0; i != toplevelComments.length; ++i) {
                var comment = toplevelComments[i];
                $commentDiv.append($comment(true, comment));
            }
            if (comments.length !== 0) {
                $commentDiv.append($expandCollapseForm());
            }
        }
        $commentDiv.prepend($expandCollapseForm());
    });
    req.open('GET', "https://comments.stephencleary.com/" + postId + ".json");
    req.send();
}
</script>

<script src="https://www.google.com/recaptcha/api.js?onload=recaptchaLoaded&amp;render=explicit"></script>



<!-- Google AdSense -->
<script src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- Moment -->
<script type="text/javascript">
    (function($) {
        $(function () {
            $('time').each(function (_, e) {
                var startOfToday = moment().startOf('day');
                var publicationDate = moment($(e).attr('datetime'), 'YYYY-MM-DD');
                var difference = startOfToday.diff(publicationDate, 'days');
                var text = difference === 0 ? 'Today' :
                    difference === 1 ? 'Yesterday' :
                    publicationDate.from(startOfToday);
                $(e).text(function(_, oldText) { return text + ' (' + oldText + ')'; });
            });
        });
    })(window.jQuery);
</script>




</body>
</html>