<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Memory-Mapped Files and Overlaid Structs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Mapping files into memory and accessing them through structure references in C#." />
    <link rel="canonical" href="https://blog.stephencleary.com/2023/09/memory-mapped-files-overlaid-structs.html" />
    
    <link rel="alternate" type="application/rss+xml" title="Stephen Cleary (the blog)" href="http://feeds.feedburner.com/NitoPrograms" />
    
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/bootswatch/3.2.0/spacelab/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" />
    <style type="text/css">/* Layout Styles */
/* ----------------------------------------------------------*/

body {
    padding-top: 50px;
}

.affix {
    top: 70px;
    bottom: 0;
    overflow-y: auto;
}

.navbar-brand {
    font-weight: bold;
}

.navbar-brand-container.active>a, .navbar-brand-container.active>a:hover, .navbar-brand-container.active>a:focus {
    color: #3399f3;
    background-color: transparent;
}

.sidebar {
    margin-top: 20px;
}

.sidenavitem {
    height: auto;
}

.sidebar img {
    /* Responsive images */
    display: inline-block;
    height: auto;
    max-width: 100%;
}

@media(max-width:767px) {
    .affix {
        position: static;
    }
}

div .vertical-margins {
    margin-top: 10px;
    margin-bottom: 10px;
}

.page-header {
    margin-top: 20px;
}

.center {
    text-align: center;
}

.project-icon {
    height: 128px;
    width: 128px;
}

.list-group-item h2 {
    margin-top: 10px;
}

/* Fixes for Google Custom Search in a Bootstrap page */
/* ----------------------------------------------------------*/
.google, .google *, .google *:before, .google *:after {
    -webkit-box-sizing: content-box;
    -moz-box-sizing: content-box;
    box-sizing: content-box;
}

.google table {
    border-collapse: separate;
}

.gsc-input-box {
    height: auto !important;
}

/* Fixes for Amazon widget in Bootstrap page */
.amzn_wdgt * {
    -webkit-box-sizing: content-box;
    -moz-box-sizing: content-box;
    box-sizing: content-box;
}

/* Post styles */
/* ----------------------------------------------------------*/

code {
    background-color: #F2F3F9;
    color: inherit;
}

.post img {
    /* Responsive images */
    display: inline-block;
    height: auto;
    max-width: 100%;
}

.post .table {
    table-layout: fixed;
}

.post .table code {
    white-space: normal;
}

.post .yes {
    color: #008000;
}

.post .no {
    color: #FF0000;
}

/* Syntax highlighting styles */
/* ----------------------------------------------------------*/

.highlight  { background: #ffffff; }
.highlight .c { color: #008000 } /* Comment */
.highlight .k { color: #0000ff } /* Keyword */
.highlight .cm { color: #008000 } /* Comment.Multiline */
.highlight .cp { color: #0000ff } /* Comment.Preproc */
.highlight .c1 { color: #008000 } /* Comment.Single */
.highlight .cs { color: #008000 } /* Comment.Special */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gh { font-weight: bold } /* Generic.Heading */
.highlight .gp { font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { font-weight: bold } /* Generic.Subheading */
.highlight .kc { color: #0000ff } /* Keyword.Constant */
.highlight .kd { color: #0000ff } /* Keyword.Declaration */
.highlight .kn { color: #0000ff } /* Keyword.Namespace */
.highlight .kp { color: #0000ff } /* Keyword.Pseudo */
.highlight .kr { color: #0000ff } /* Keyword.Reserved */
.highlight .kt { color: #2b91af } /* Keyword.Type */
.highlight .s { color: #a31515 } /* Literal.String */
.highlight .nc { color: #2b91af } /* Name.Class */
.highlight .ow { color: #0000ff } /* Operator.Word */
.highlight .sb { color: #a31515 } /* Literal.String.Backtick */
.highlight .sc { color: #a31515 } /* Literal.String.Char */
.highlight .sd { color: #a31515 } /* Literal.String.Doc */
.highlight .s2 { color: #a31515 } /* Literal.String.Double */
.highlight .se { color: #a31515 } /* Literal.String.Escape */
.highlight .sh { color: #a31515 } /* Literal.String.Heredoc */
.highlight .si { color: #a31515 } /* Literal.String.Interpol */
.highlight .sx { color: #a31515 } /* Literal.String.Other */
.highlight .sr { color: #a31515 } /* Literal.String.Regex */
.highlight .s1 { color: #a31515 } /* Literal.String.Single */
.highlight .ss { color: #a31515 } /* Literal.String.Symbol */

/* Comments */
/* ----------------------------------------------------------*/

.comment-container {
    margin-top: 1em;
}

.comment-container > .comment-container {
    margin-left: 2em;
}

.comment-container > .comment-container > .comment-container > .comment-container > .comment-container {
    margin-left: 0;
}

/* Correct anchor links in comments (they are offset by the height of the fixed header) */
.comment-anchor {
    display: block;
    position: relative;
    top: -60px;
    visibility: hidden;
}

img.comment-author-profile-image {
    height: 80px;
    width: 80px;
    margin-right: 10px;
}

.comment-message {
    overflow-x: auto;
}

.comment-form {
    border: 1px solid black;
    padding: 1em;
}

.comment-new {
    margin-top: 1em;
    margin-bottom: 1em;
}

.comment-new, .comment-reply {
    margin-left: 1em;
}

.comment-hidden {
    display: none;
}

.comment-form-buttonbar {
    margin-top: 1em;
}
</style>
    
    <meta name="application-name" content="Stephen Cleary" />
    <link rel="search" type="application/opensearchdescription+xml" href="https://stephencleary.com/opensearch.xml" title="Cleary Search">
    <link rel="apple-touch-icon" sizes="57x57" href="https://stephencleary.com/icons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="https://stephencleary.com/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://stephencleary.com/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://stephencleary.com/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="https://stephencleary.com/icons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="https://stephencleary.com/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="https://stephencleary.com/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://stephencleary.com/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" href="https://stephencleary.com/icons/apple-touch-icon.png"/>
    <link rel="apple-touch-icon-precomposed" href="https://stephencleary.com/icons/apple-touch-icon-precomposed.png"/>
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-196x196.png" sizes="196x196">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-32x32.png" sizes="32x32">
    
    <meta name="google-site-verification" content="L8q0fpGSwpNSD0OGFI07hyMujSpORrV4tAaNx_Js7oQ" />
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <div class="navbar-brand-container"><a class="navbar-brand" href="https://stephencleary.com">Stephen Cleary</a></div>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
            <li  class="active"  ><a href="https://blog.stephencleary.com">Blog</a></li>
            <li  ><a href="https://stephencleary.com/book/">Book</a></li>
            <li  ><a href="https://stephencleary.com/projects/">Projects</a></li>
            <li  ><a href="https://stephencleary.com/publications/">Publications</a></li>
            <li  ><a href="https://stephencleary.com/contact/">Contact</a></li>
            <li  ><a href="https://stephencleary.com/contract/">Hire Me</a></li>
            <li><a href="http://feeds.feedburner.com/NitoPrograms"><i class="fa fa-rss-square fa-lg"></i></a></li>
            <li  ><a href="https://stephencleary.com/search/"><i class="fa fa-search"></i></a></li>
        </ul>
    </div>
</nav>

    <div class="container-fluid">
        <div class="col-sm-8 col-sm-offset-2 col-md-6 col-md-offset-3">
            <div class="post">

  <header>
      <div class="page-header">
          <h1>Memory-Mapped Files and Overlaid Structs</h1>
          <small><time datetime="2023-09-28">Sep 28, 2023</time> &bull; <a id="comment-counter" href="#comments">Comments</a></small>
      </div>
  </header>

  <article>
  <p>It has been a long, long time since I’ve used memory-mapped files - I think the last time was before .NET existed (!). Recently, I had a need to work with memory-mapped files in C#, and I gathered together a few resources that explain how to do it - specifically, how to map a file into memory and then “overlay” a structure on top of that memory. Since it took me a while to figure this out (and I learned about some cool upcoming features along the way), I thought I’d write this up into a proper post or two.</p>

<h2 id="memory-mapped-files">Memory-Mapped Files</h2>

<p>Memory-mapped files are a pretty cool technique, where instead of reading disk data into memory directly, you can <em>map</em> it into the memory space of your process very quickly. Once it’s mapped into your process memory, reading from that memory will read from the disk (as necessary), and writing to that memory will write out to the file (eventually). You can do cool things like create a huge file mapping (way larger than your memory), and it will Just Work, paging memory in and out of your process behind the scenes. There’s a ton of information about memory-mapped files out there; if you’re on Windows, I like <a href="https://www.amazon.com/Windows-Internals-Part-architecture-management/dp/0735684189?crid=1R9XTJDVYVT4R&amp;qid=1695906423&amp;linkCode=ll1&amp;tag=stepheclearys-20&amp;linkId=a9d94c8104abdd7c669e33fd6ea2d430&amp;language=en_US&amp;ref_=as_li_ss_tl" rel="nofollow">Windows Internals</a> - Part 1 covers the memory manager (including memory-mapped files), and Part 2 has a few additional details on how memory-mapped files interact with the cache manager.</p>

<p>In C#, mapping a file into memory isn’t terribly complex. First, you open the file (i.e., create a <code>FileStream</code> object). Then, you create a file mapping. Tip on the file mapping: if you’re mapping an existing file, you can pass <code>0</code> for the file length to just map the entire file. Finally, you create a view on that file mapping - and this is the step that actually maps the file into the memory space for your process. You <em>can</em> create a view over the entire file, but if you’re dealing with a very large file mapping, it’s common to create partial views as you need them.</p>

<p>This code will create a new file, a file mapping (specifying 1000 bytes as the length of the file; the file is immediately grown to this size), and a single view over the entire file:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">FileStream</span> <span class="n">file</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FileStream</span><span class="p">(</span><span class="s">@&quot;tmp.dat&quot;</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Create</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">ReadWrite</span><span class="p">,</span>
    <span class="n">FileShare</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="m">4096</span><span class="p">,</span> <span class="n">FileOptions</span><span class="p">.</span><span class="n">RandomAccess</span><span class="p">);</span>
<span class="k">using</span> <span class="nn">MemoryMappedFile</span> <span class="n">mapping</span> <span class="p">=</span> <span class="n">MemoryMappedFile</span><span class="p">.</span><span class="n">CreateFromFile</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="m">1000</span><span class="p">,</span>
    <span class="n">MemoryMappedFileAccess</span><span class="p">.</span><span class="n">ReadWrite</span><span class="p">,</span> <span class="n">HandleInheritability</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="n">leaveOpen</span><span class="p">:</span> <span class="k">true</span><span class="p">);</span>
<span class="k">using</span> <span class="nn">MemoryMappedViewAccessor</span> <span class="n">view</span> <span class="p">=</span> <span class="n">mapping</span><span class="p">.</span><span class="n">CreateViewAccessor</span><span class="p">();</span></code></pre></figure>

<p>At this point, you have a <code>view</code>, which is a handle (actually a pointer) to the part of your process’ memory that actually represents the file contents. What’s really nice about this code is that it’s portable; the same code works on Linux and Windows (and presumably Mac and mobile platforms, though I haven’t tried those). However, pointers aren’t a great interface, especially in a managed language like C#. <code>MemoryMappedViewAccessor</code> has a bunch of… well… <em>awkward</em> methods that are essentially “read a signed 16-bit integer at this offset”, “write an unsigned 32-bit integer at this offset”, etc. You can also copy a struct into and out of the view, but I don’t want to go through the trouble of doing a file mapping just to turn around and serialize a struct anyway.</p>

<p>For convenience, unmanaged languages commonly overlay a structure onto the mapped memory. This approach allows you to define the file structure as an actual <code>struct</code> and then read/write fields in that struct instead of serializing values to memory or view offsets. “Overlapped structures” might be a more common term than “overlaid structures”, but I want to avoid any confusion with <code>OVERLAPPED</code>, so I’m using the term “overlaid structures” in these posts.</p>

<p>If you’re in an unmanaged language like C++, you can just <code>reinterpret_cast</code> your file mapping view pointer to a structure pointer, and that’s it: you’ve got a struct at the same memory address as your file view! I found that there was much less information about overlaying structs in C#, though. So, let’s see how to do the same thing in C#!</p>

<h2 id="overlaid-structs">Overlaid Structs</h2>

<p>After a bit of experimentation, this is what I ended up with:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">sealed</span> <span class="k">unsafe</span> <span class="k">class</span> <span class="nc">Overlay</span> <span class="p">:</span> <span class="n">IDisposable</span>
<span class="p">{</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="n">MemoryMappedViewAccessor</span> <span class="n">_view</span><span class="p">;</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="kt">byte</span><span class="p">*</span> <span class="n">_pointer</span><span class="p">;</span>

  <span class="k">public</span> <span class="nf">Overlay</span><span class="p">(</span><span class="n">MemoryMappedViewAccessor</span> <span class="n">view</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">_view</span> <span class="p">=</span> <span class="n">view</span><span class="p">;</span>
    <span class="n">view</span><span class="p">.</span><span class="n">SafeMemoryMappedViewHandle</span><span class="p">.</span><span class="n">AcquirePointer</span><span class="p">(</span><span class="k">ref</span> <span class="n">_pointer</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span> <span class="p">=&gt;</span> <span class="n">_view</span><span class="p">.</span><span class="n">SafeMemoryMappedViewHandle</span><span class="p">.</span><span class="n">ReleasePointer</span><span class="p">();</span>

  <span class="k">public</span> <span class="k">ref</span> <span class="n">T</span> <span class="n">As</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">struct</span> <span class="err">=&gt; </span><span class="nc">ref</span> <span class="n">Unsafe</span><span class="p">.</span><span class="n">AsRef</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">_pointer</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>This is an <code>unsafe</code> type, but ideally this is the only place where <code>unsafe</code> is necessary.</p>

<p><code>Overlay</code> is mainly just a pointer - the pointer to the view of the file that has been mapped into your process’ memory. It also has a <code>MemoryMappedViewAccessor</code> member, but that’s just used to free the pointer when the <code>Overlay</code> instance is disposed.</p>

<p><code>Overlay</code> has a single notable member: <code>As&lt;T&gt;()</code>, which allows you to get a reference to a struct that overlays the mapped memory view.</p>

<div class="alert alert-info">
  <p><i class="fa fa-info-circle fa-2x pull-left"></i></p>

  <p>On Windows (at least), the <code>SafeMemoryMappedViewHandle</code> handle actually <em>is</em> a pointer, and the <code>AcquirePointer</code> and <code>ReleasePointer</code> calls increment and decrement a reference counter for that handle. <code>Overlay</code> could be designed very differently (and more efficiently) if it cast the <code>SafeMemoryMappedViewHandle</code> handle value to a pointer.</p>

  <p>However, on other platforms, I’m not sure if <code>SafeMemoryMappedViewHandle</code> is actually a pointer or not, so I’ve stuck with this safer implementation just to make sure the code is portable.</p>
</div>

<p>If you are OK with assuming <code>SafeMemoryMappedViewHandle</code> is a pointer, you can use this instead of <code>Overlay</code>:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">MemoryMappedViewAccessorExtensions</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">static</span> <span class="k">unsafe</span> <span class="k">ref</span> <span class="n">T</span> <span class="n">As</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">MemoryMappedViewAccessor</span> <span class="n">accessor</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">struct</span> <span class="err">=&gt;</span>
    <span class="k">ref</span> <span class="n">Unsafe</span><span class="p">.</span><span class="n">AsRef</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">accessor</span><span class="p">.</span><span class="n">SafeMemoryMappedViewHandle</span><span class="p">.</span><span class="n">DangerousGetHandle</span><span class="p">().</span><span class="n">ToPointer</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure>

<p>There’s a fair amount of “unsafe” and “dangerous” in that code, though, and it also makes some implementation assumptions (specifically, that <code>SafeMemoryMappedViewHandle</code>’s handle is an actual <em>pointer to memory</em>). So, for safety, I’m just sticking with <code>Overlay</code> with its explicit <code>AcquirePointer</code> and <code>ReleasePointer</code> calls.</p>

<h2 id="using-overlay">Using Overlay</h2>

<p>First, define your <code>struct</code> type, keeping in mind that the in-memory layout (including packing/padding) must reflect the on-disk file structure. Then, you can map a file just like the above code, create an <code>Overlay</code> type, and acquire a struct reference. At that point, you can read or write the struct as desired.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">struct</span> <span class="nc">Data</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="kt">int</span> <span class="n">First</span><span class="p">;</span>
  <span class="k">public</span> <span class="kt">int</span> <span class="n">Second</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">FileStream</span> <span class="n">file</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FileStream</span><span class="p">(</span><span class="s">@&quot;tmp.dat&quot;</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Create</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">ReadWrite</span><span class="p">,</span>
    <span class="n">FileShare</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="m">4096</span><span class="p">,</span> <span class="n">FileOptions</span><span class="p">.</span><span class="n">RandomAccess</span><span class="p">);</span>
<span class="k">using</span> <span class="nn">MemoryMappedFile</span> <span class="n">mapping</span> <span class="p">=</span> <span class="n">MemoryMappedFile</span><span class="p">.</span><span class="n">CreateFromFile</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="m">1000</span><span class="p">,</span>
    <span class="n">MemoryMappedFileAccess</span><span class="p">.</span><span class="n">ReadWrite</span><span class="p">,</span> <span class="n">HandleInheritability</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="n">leaveOpen</span><span class="p">:</span> <span class="k">true</span><span class="p">);</span>
<span class="k">using</span> <span class="nn">MemoryMappedViewAccessor</span> <span class="n">view</span> <span class="p">=</span> <span class="n">mapping</span><span class="p">.</span><span class="n">CreateViewAccessor</span><span class="p">();</span>
<span class="k">using</span> <span class="nn">Overlay</span> <span class="n">overlay</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Overlay</span><span class="p">(</span><span class="n">view</span><span class="p">);</span>
<span class="k">ref</span> <span class="n">Data</span> <span class="n">data</span> <span class="p">=</span> <span class="k">ref</span> <span class="n">overlay</span><span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">Data</span><span class="p">&gt;();</span>
<span class="n">data</span><span class="p">.</span><span class="n">First</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
<span class="n">data</span><span class="p">.</span><span class="n">Second</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span></code></pre></figure>

<p>Run the code above (works in LINQPad!), and you’ll end up with a <code>tmp.dat</code> file 1000 bytes long, with the first four bytes having the value of <code>First</code> (1) and the second four bytes having the value of <code>Second</code> (2). Note that since you’re reading/writing structures in memory, whatever endianness your machine is will determine the endianness of the binary file. Go ahead and pop it open in a hex editor (there’s an online one called <a href="https://hexed.it/">HexEd.it</a>), and take a look at the binary file itself.</p>

<h2 id="endianness">Endianness</h2>

<p>If you’re working with portable file formats, handling endianness is a necessity. Values in files on disk must be little-endian or big-endian, regardless of what processor happens to be reading or writing them. I recommend handling the differences in code with helpers, like this:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">OverlayHelpers</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">ReadBigEndian</span><span class="p">(</span><span class="kt">int</span> <span class="n">bigEndian</span><span class="p">)</span> <span class="p">=&gt;</span>
      <span class="n">BitConverter</span><span class="p">.</span><span class="n">IsLittleEndian</span> <span class="p">?</span> <span class="n">BinaryPrimitives</span><span class="p">.</span><span class="n">ReverseEndianness</span><span class="p">(</span><span class="n">bigEndian</span><span class="p">)</span> <span class="p">:</span> <span class="n">bigEndian</span><span class="p">;</span>
  <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">WriteBigEndian</span><span class="p">(</span><span class="k">out</span> <span class="kt">int</span> <span class="n">bigEndian</span><span class="p">,</span> <span class="kt">int</span> <span class="k">value</span><span class="p">)</span> <span class="p">=&gt;</span>
      <span class="n">bigEndian</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="n">IsLittleEndian</span> <span class="p">?</span> <span class="n">BinaryPrimitives</span><span class="p">.</span><span class="n">ReverseEndianness</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">:</span> <span class="k">value</span><span class="p">;</span>
  <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">ReadLittleEndian</span><span class="p">(</span><span class="kt">int</span> <span class="n">littleEndian</span><span class="p">)</span> <span class="p">=&gt;</span>
      <span class="n">BitConverter</span><span class="p">.</span><span class="n">IsLittleEndian</span> <span class="p">?</span> <span class="n">littleEndian</span> <span class="p">:</span> <span class="n">BinaryPrimitives</span><span class="p">.</span><span class="n">ReverseEndianness</span><span class="p">(</span><span class="n">littleEndian</span><span class="p">);</span>
  <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">WriteLittleEndian</span><span class="p">(</span><span class="k">out</span> <span class="kt">int</span> <span class="n">littleEndian</span><span class="p">,</span> <span class="kt">int</span> <span class="k">value</span><span class="p">)</span> <span class="p">=&gt;</span>
      <span class="n">littleEndian</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="n">IsLittleEndian</span> <span class="p">?</span> <span class="k">value</span> <span class="p">:</span> <span class="n">BinaryPrimitives</span><span class="p">.</span><span class="n">ReverseEndianness</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>The helpers above let you read/write big- or little-endian values, regardless of the endianness of the current machine. They can be used in your structure definitions as such:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">struct</span> <span class="nc">Data</span>
<span class="p">{</span>
  <span class="c1">// Layout</span>
  <span class="k">private</span> <span class="kt">int</span> <span class="n">_first</span><span class="p">;</span>
  <span class="k">private</span> <span class="kt">int</span> <span class="n">_second</span><span class="p">;</span>

  <span class="c1">// Convenience accessors</span>
  <span class="k">public</span> <span class="kt">int</span> <span class="n">First</span>
  <span class="p">{</span>
    <span class="k">readonly</span> <span class="k">get</span> <span class="p">=&gt;</span> <span class="n">OverlayHelpers</span><span class="p">.</span><span class="n">ReadBigEndian</span><span class="p">(</span><span class="n">_first</span><span class="p">);</span>
    <span class="k">set</span> <span class="p">=&gt;</span> <span class="n">OverlayHelpers</span><span class="p">.</span><span class="n">WriteBigEndian</span><span class="p">(</span><span class="k">out</span> <span class="n">_first</span><span class="p">,</span> <span class="k">value</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">public</span> <span class="kt">int</span> <span class="n">Second</span>
  <span class="p">{</span>
    <span class="k">readonly</span> <span class="k">get</span> <span class="p">=&gt;</span> <span class="n">OverlayHelpers</span><span class="p">.</span><span class="n">ReadBigEndian</span><span class="p">(</span><span class="n">_second</span><span class="p">);</span>
    <span class="k">set</span> <span class="p">=&gt;</span> <span class="n">OverlayHelpers</span><span class="p">.</span><span class="n">WriteBigEndian</span><span class="p">(</span><span class="k">out</span> <span class="n">_second</span><span class="p">,</span> <span class="k">value</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Now the same program as above will always write the “first” and “second” fields as 32-bit signed big-endian values:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="c1">// (this is the same code as above)</span>
<span class="k">using</span> <span class="nn">FileStream</span> <span class="n">file</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FileStream</span><span class="p">(</span><span class="s">@&quot;tmp.dat&quot;</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Create</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">ReadWrite</span><span class="p">,</span>
    <span class="n">FileShare</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="m">4096</span><span class="p">,</span> <span class="n">FileOptions</span><span class="p">.</span><span class="n">RandomAccess</span><span class="p">);</span>
<span class="k">using</span> <span class="nn">MemoryMappedFile</span> <span class="n">mapping</span> <span class="p">=</span> <span class="n">MemoryMappedFile</span><span class="p">.</span><span class="n">CreateFromFile</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="m">1000</span><span class="p">,</span>
    <span class="n">MemoryMappedFileAccess</span><span class="p">.</span><span class="n">ReadWrite</span><span class="p">,</span> <span class="n">HandleInheritability</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="n">leaveOpen</span><span class="p">:</span> <span class="k">true</span><span class="p">);</span>
<span class="k">using</span> <span class="nn">MemoryMappedViewAccessor</span> <span class="n">view</span> <span class="p">=</span> <span class="n">mapping</span><span class="p">.</span><span class="n">CreateViewAccessor</span><span class="p">();</span>
<span class="k">using</span> <span class="nn">Overlay</span> <span class="n">overlay</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Overlay</span><span class="p">(</span><span class="n">view</span><span class="p">);</span>
<span class="k">ref</span> <span class="n">Data</span> <span class="n">data</span> <span class="p">=</span> <span class="k">ref</span> <span class="n">overlay</span><span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">Data</span><span class="p">&gt;();</span>
<span class="n">data</span><span class="p">.</span><span class="n">First</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
<span class="n">data</span><span class="p">.</span><span class="n">Second</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span></code></pre></figure>

<p>Now, the code is completely portable: any .NET runtime that supports memory-mapped files (which AFAIK is all of them) will run this code, giving you the ability to define portable binary file formats using overlaid structures.</p>

<h2 id="a-word-of-warning-alignment">A Word of Warning: Alignment</h2>

<p>Since you’re overlaying structures directly into memory addresses, you have to handle all the alignment requirements yourself. Some more common architectures such as x86/x64 don’t care about alignment and allow you to, e.g., define an <code>int</code> field at an offset of <code>1</code>. Other architectures do not allow unaligned access at all.</p>

<p>As a general guideline, align your structure members by their own size. E.g., an <code>int</code> is 4 bytes, so it should be aligned on a 4-byte boundary. Put another way, the offset of an <code>int</code> field from the beginning of the <code>struct</code> should be evenly divisible by 4. Same for other types: <code>long</code> should be aligned on an 8-byte boundary, while <code>byte</code> should be aligned on a 1-byte boundary (i.e., anywhere).</p>

<h2 id="a-word-of-warning-exceptions">A Word of Warning: Exceptions</h2>

<p>Memory mapped files give you one kind of convenience by mapping files into memory, but the counterpoint is that I/O exceptions may not happen exactly when you expect them to.</p>

<p>When reading a file using normal I/O calls, if the read fails, then it fails right at that time. When using memory-mapped files, reads <em>from memory</em> may cause an I/O exception. This is true even if a previous read from that same memory succeeded.</p>

<p>Similarly, if you write to a file using normal I/O calls, any failures are reported immediately. With memory-mapped files, <em>memory</em> writes may cause an I/O exception. And since memory-mapped files are lazily flushed to disk, I/O exceptions may be delayed until the view is flushed (during disposal).</p>

<h2 id="next-time">Next Time</h2>

<p>I hope this has been helpful! If anyone out there knows a way to eliminate the <code>unsafe</code> code in <code>Overlay</code>, I’d love to hear it!</p>

<p>Next time I’m planning to write a bit about overlaying structures with holes in them, which is a useful technique when you have “header” or “container” structures that wrap other structures possibly of different types.</p>

  </article>
    
    <footer class="hidden-print">
        <div class="alert alert-info" markdown="1">
            <i class="fa fa-hand-o-right fa-2x pull-left"></i>
            
            <div>Has this blog been helpful? Please consider <a href="https://github.com/sponsors/StephenCleary" class="alert-link">supporting this blog (and my open-source libraries).</a> Thanks!</div>
        </div>

        
        
        <ul class="pager">
            <li class="previous"><a href="/2023/05/grounded-chatgpt.html" title="Grounded ChatGPT">&larr; Previous Post</a></li>
            
        </ul>

        <div id="comments"></div>
    </footer>
</div>
        </div>
        <div class="col-sm-2 col-md-3 col-md-offset-0 col-lg-2 col-lg-offset-1 affix hidden-print" data-spy="affix" role="navigation">
            
            
        </div>
        <div class="col-sm-2 sidebar hidden-print">
            <div class="panel panel-default">
                <div class="panel-heading">About Stephen Cleary</div>
                <div class="panel-body">
                    <div class="center"><img src="https://stephencleary.com/www.assets/Me-large.jpg"/></div>
                    <div class="center vertical-margins">Stephen Cleary is a <a href="https://stephencleary.com/god/">Christian</a>, husband, father, and programmer living in Northern Michigan.</div>
                    <div class="center"><a href="http://mvp.microsoft.com/en-us/mvp/Stephen%20Cleary-5000058"><img class="mvp-logo" src="https://stephencleary.com/www.assets/MVP.png"/></a></div>
                </div>
            </div>
            <div class="panel panel-primary">
                <div class="panel-heading">My book</div>
                <div class="panel-body center">
                    <div><a href="https://stephencleary.com/book/"><img src="https://stephencleary.com/www.assets/Book-2nd-small.jpg"/></a></div>
                    <div>Available from <a href="https://www.amazon.com/dp/149205450x/ref=as_li_ss_tl?&ref=pd_sl_a04BABB1D18C7F2658168FF785&linkCode=sl1&tag=stepheclearys-20&linkId=fb22bb126d6e60f305fecddf3d4ecbd8" rel="nofollow">Amazon (print/Kindle)</a>, <a href="https://learning.oreilly.com/library/view/concurrency-in-c/9781492054498/" rel="nofollow">O'Reilly (Safari)</a>, or <a href="https://www.ebooks.com/cj.asp?IID=209766469&cjsku=209766469" rel="nofollow">eBooks.com (PDF/epub)</a>.</div>
                    <div>Also available in <a href="https://www.labirint.ru/books/745595/" rel="nofollow">Russian</a>, <a href="https://item.jd.com/12769567.html" rel="nofollow">Chinese</a>, and <a href="https://www.aladin.co.kr/shop/wproduct.aspx?ItemId=270818316" rel="nofollow">Korean</a>.</div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Advertisement</div>
                <div><a href="https://stephencleary.com/contract/">Hire me if you need in-depth assistance!</a></div>
                <div class="panel-body">
                    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2749292939902134" data-ad-slot="7584809820" data-ad-format="auto"></ins>
                </div>
            </div>
            
            <div class="panel panel-primary">
                <div class="panel-heading">Popular Posts</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2012/02/async-and-await.html">Async/await Intro</a></li>
                        <li><a href="/2013/11/there-is-no-thread.html">There Is No Thread</a></li>
                        <li><a href="/2012/07/dont-block-on-async-code.html">Don't Block on Async Code</a></li>
                    </ul>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Series</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2016/02/react-redux-todomvc.html">React/Redux TodoMVC</a></li>
                        <li><a href="/2014/04/a-tour-of-task-part-0-overview.html">A Tour of Task</a></li>
                        <li><a href="/2013/10/taskrun-etiquette-and-proper-usage.html">Task.Run Etiquette</a></li>
                        <li><a href="/2013/05/taskrun-vs-backgroundworker-intro.html">Task.Run vs. BackgroundWorker</a></li>
                        <li><a href="/2013/01/async-oop-0-introduction.html">Async OOP</a></li>
                        <li><a href="/2009/04/tcpip-net-sockets-faq.html">TCP/IP .NET Sockets FAQ</a></li>
                        <li><a href="/2013/10/managed-services-roundup.html">Managed Services</a></li>
                        <li><a href="/2009/08/how-to-implement-idisposable-and.html">IDisposable and Finalizers</a></li>
                        <li><a href="/2011/02/option-parsing-introduction.html">Option Parsing</a></li>
                    </ul>
                </div>
            </div>
            
        </div>
    </div>

    <div class="google">
        <gcse:searchresults></gcse:searchresults>
    </div>
    
    <!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
<script type="text/javascript">window.jQuery || document.write('<script src="/lib/jquery-2.1.1.min.js"><\/script>')</script>

<!-- Bootstrap -->
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script type="text/javascript">window.jQuery.fn.modal || document.write('<script src="/lib/bootstrap.min.js"><\/script>')</script>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('body').css('color') !== 'rgb(102, 102, 102)') {
                $('head').prepend('<link rel="stylesheet" href="/lib/bootstrap.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Font Awesome -->
<span id="facheck" class="fa" style="display:none"></span>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('#facheck').css('fontFamily') !== 'FontAwesome') {
                $('head').prepend('<link rel="stylesheet" href="/lib/font-awesome.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Scroll the sidebar into view (if necessary) -->


<!-- Moment -->
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.6.0/moment.min.js"></script>
<script type="text/javascript">window.moment || document.write('<script src="/lib/moment.min.js"><\/script>')</script>

<!-- Google analytics -->
<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-8910661-5', 'stephencleary.com');
    ga('send', 'pageview');
</script>

<!-- Show appropriate elements based on time -->
<script type="text/javascript">
    (function ($) {
        $(function () {
            var targets = $('[data-hide-after]');
            targets.each(function () {
                var $item = $(this);
                if (moment() < moment($item.attr('data-hide-after'))) {
                    $item.removeClass('hidden');
                }
            });
        });
    })(window.jQuery);
</script>




<!-- Email obfuscation -->
<script type="text/javascript">
    (function($) {
        $(function() {
            var x = 'an',
                y = 'steph',
                email = 'mailto:' + y + 'en' + x + 'dm' + x + 'dy@' + 'gma' + 'il.' + 'com';
            $('.email-link').attr('href', email);
        });
    })(window.jQuery);
</script>



<script src="/lib/uuid-v3-3.2.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/showdown@1.8.6/dist/showdown.min.js" integrity="sha256-dwhppIrxD8qC6lNulndZgtIm4XBU9zoMd9OUoXzIDAE=" crossorigin="anonymous"></script>
<script src="/lib/sanitize-html-1.18.2.min.js"></script>
<script src="/lib/autosize.min.js"></script>
<script src="/lib/base64js.min.js"></script>
<script src="/lib/md5.min.js"></script>

<script type="text/javascript">

var pageUrl = "https://blog.stephencleary.com" + "/2023/09/memory-mapped-files-overlaid-structs.html";

// (unnecessary) 1) If the URL starts with http://, replace with https://

// 2) Take the URL path (not including scheme and domain).
var url = document.createElement('a');
url.href = pageUrl; //'https://developer.mozilla.org:8080/en-US/search?q=URL#search-results-close-container';
var path = url.pathname;

// 3) Path: If the path ends with .html or any two- to six-character [A-Za-z0-9] extension, strip it.
if (path.endsWith(".html"))
    path = path.substr(0, path.length - 5);
else
    path = path.replace(/\.[A-Za-z0-9]{2,6}$/, "");

// 4) Path: For each UTF-16 code unit, if it's not in the whitelist [A-Za-z0-9-_;.~()], then replace it with _.
path = path.replace(/[^-A-Za-z0-9_;.~()]/g, "_");

// 5) Path: Trim leading and trailing _ characters.
path = path.replace(/^_+|_+$/g, "");

// 6) Calculate the V3 URL GUID for the URL.
var guid = uuidv3(pageUrl, uuidv3.URL);

// 7) Combine the path and lowercase-hyphenated GUID, separated by '-'.
var postId = path + "-" + guid;

var nofollowLinkExtension = {
    type: 'output',
    regex: /(<a[^<]+<\/a>)/g,
    replace: (match, $1, $2) => {
        var result = $('<div/>').append($($1).attr('rel', 'nofollow noopener ugc')).html();
        return result;
    }
};
showdown.extension('nofollowLink', nofollowLinkExtension);

var comments;
var markdownConverter = new showdown.Converter({
    omitExtraWLInCodeBlocks: true,
    noHeaderId: true,
    headerLevelStart: 3,
    simplifiedAutoLink: true,
    excludeTrailingPunctuationFromURLs: true,
    literalMidWordUnderscores: true,
    strikethrough: true,
    smoothLivePreview: true,
    disableForced4SpacesIndentedSublists: true,
    extensions: ['nofollowLink']
});
var sanitizeOptions = {
    allowedTags: [ 'blockquote', 'p', 'a', 'ul', 'ol', 'nl', 'li', 'b', 'i', 'strong', 'em', 'strike', 'code', 'br', 'div', 'pre', 'img' ],
    allowedAttributes: {
        a: [
            'href',
            {
                name: 'rel',
                multiple: true,
                values: ['nofollow', 'noopener', 'ugc']
            }
        ],
        img: [ 'src' ]
    },
    allowedIframeHostnames: []
};

function fixedEncodeURIComponent(str) {
  return encodeURIComponent(str).replace(/[!'()*]/g, function(c) {
    return '%' + c.charCodeAt(0).toString(16);
  });
}

function filterComments(replyTo) {
    return comments
        .filter(function (x) { return x.replyTo === replyTo; })
        .sort(function (a, b) { return a.timestamp - b.timestamp; });
}

function avatarUri(authorEmailMD5) {
    if (authorEmailMD5 === "")
        return "https://www.gravatar.com/avatar/?d=mp&f=y";
    else
        return "https://www.gravatar.com/avatar/" + authorEmailMD5 + "?d=retro";
}

var jwk = {"kty":"RSA","alg":"RSA-OAEP","n":"wviXqUJGtV8hZrvJMcTbyzm7MmiJSqsAfWI_7pCyAhXXzz5C9F3NtXp79CCUMqkOck6IbNKUntPtGNOGwtoc5LTJNKLhx3TPi4TJyKUSfNr3pAdLpMRNeeRXCHFyyVsDb6z8ueixlKzdbDpZhV05bam49PurMHfeexJ3EJy2NpdFviykRJxtrERi6ckBe96VMlT_pHHIWLN5EwOK54DvNn1DYjiFK5ux5WRCFatZByzytrFvIllZRctNXZ8oTuMjQwKLY2bUrURblbIvLfX-9Yd7uVgdUSFE7-vSel9-DMyp_NQ-NRXrQbJG7IAYhSGSx-TPepCDPbFpMq3yC0iET7wF7-OQOb-Kwej_TKVJv-z4SbN-cpCqaMr5Q9scyGih7xr1YrOhe3TMs_cbgjtxsZbzkOqcuRreON_sGb9nlDpSIFCo6aH47GeMkA23Hk3HXAPyYQ7AfWhU9daiPcySiAFnfkrg2QvFNJmMSZ-bo4Co-JkjiqKw-LEpOw6Ed9LK4walxWUAqPGcT4_Uys3TH9XVex9_rEmigHXiJY3_Lwi6mTSkW10-zen5UXxqnyHpMxlmumohT96OyLyhEPeaaq8FrTYMCX8TiMOst3jF5QCNP-LFz21yeUEAr5_3-FKV2mjWEU9iW0dOOVTII2rlD0WtCkqkDwZtakQ1ynGdW1E","e":"AQAB"};

function commentId(id) { return "comment-" + id; }

function $commentForm(hideForm, comment) {
    var $previewDiv = $('<div/>');
    var $authorEmailEncrypted = $('<input type="hidden" name="authorEmailEncrypted">');
    var $authorEmailMD5 = $('<input type="hidden" name="authorEmailMD5">');
    var $email = $('<input type="email" name="email" class="form-control" placeholder="Email">');
    var $name = $('<input type="text" name="authorName" class="form-control" placeholder="Name">');
    var $url = $('<input type="url" name="authorUri" class="form-control" placeholder="Url">');
    var $message = $('<textarea name="message" class="form-control" placeholder="Message"/></textarea>');
    autosize($message);
    var $replyTo = $('<input type="hidden" name="replyTo">').val("");
    var $recaptcha = $('<div class="g-recaptcha" data-sitekey="6LfSaV8UAAAAAEFq-7HeUDiSQCkCtLtO_yc_SOi_"></div>');
    var $buttonBar = $('<div class="comment-form-buttonbar"/>').append($('<button type="submit" class="btn btn-primary pull-right">Submit</button>'), $recaptcha);
    var $form = $('<form method="POST" action="https://blogcomments.azurewebsites.net/api/Function1"/>')
        .append($('<input type="hidden" name="postId">').val(postId))
        .append($('<input type="hidden" name="postUri">').val(location.href.replace(/#.*/, '')))
        .append($replyTo)
        .append($authorEmailEncrypted)
        .append($authorEmailMD5)
        .append($('<div class="form-group"><label>Name (optional)</label></div>').append($name))
        .append($('<div class="form-group"><label>Email (optional; always encrypted, never shared)</label></div>').append($email))
        .append($('<div class="form-group"><label>Url (optional; must start with "http://" or "https://")</label></div>').append($url))
        .append($('<div class="form-group"><label>Message (supports some Markdown/HTML)</label></div>').append($message));
    if (comment) {
        $replyTo.val(comment._id);
    }
    const serialize_form = form => JSON.stringify(
        Array.from(new FormData(form).entries())
            .reduce((m, [ key, value ]) => Object.assign(m, { [key]: value }), {})
    );
    $form.submit(function (e) {
        e.preventDefault();
        hideForm();
        var postAction = $form.attr('action');
        var postBody = serialize_form($form.get(0));
        console.log(postBody);
        var retries = 5;

        function postIt() {
            var post = $.post(postAction, postBody, "json");
            post.done(function () {
                alert("Comment successfully posted. It should appear on this page in a minute or so.");
            });
            post.error(function () {
                var message = "Failed to post comment";
                if (post.responseText)
                    message += ": " + post.responseText;
                
                if (--retries > 0) {
                    console.log(message);
                    postIt();
                } else {
                    alert(message);
                }
            });
        }

        postIt();
    });

    function createComment() {
        return normalizeComment({
            date: moment().format(),
            _id: "_",
            replyTo: comment ? comment._id : undefined,
            authorName: $name.val(),
            authorEmailMD5: $authorEmailMD5.val(),
            authorUri: $url.val(),
            message: $message.val()
        });
    };

    function recreatePreview() {
        var email = $email.val();
        if (email && email.indexOf("@") !== -1) {
            var data = new TextEncoder().encode($email.val());
            window.crypto.subtle.importKey("jwk", jwk, { name: "RSA-OAEP", hash: { name: "SHA-1" } }, false, ["encrypt"]).then(function (encryptionKey) {
                return window.crypto.subtle.encrypt({ name: "RSA-OAEP" }, encryptionKey, data)
                    .then(function (encrypted) {
                        var array = new Uint8Array(encrypted);
                        var text = base64js.fromByteArray(array);
                        $authorEmailEncrypted.val(text);
                        return text;
                    });
            });
            $authorEmailMD5.val(md5($email.val().replace(/^ +| +$/g, '').toLowerCase()));
        } else {
            $authorEmailMD5.val("");
            $authorEmailEncrypted.val("");
        }

        var $newPreview = $comment(false, createComment());
        // Turn off permalink and anchor
        var $anchor = $newPreview.find('.comment-date a');
        $anchor.replaceWith($('<span/>').text($anchor.text()));
        $newPreview.find('.comment-anchor').remove();
        $previewDiv.empty();
        $previewDiv.append($newPreview);
    };

    recreatePreview();
    $name.on('change keyup input paste', recreatePreview);
    $email.on('change keyup input paste', recreatePreview);
    $url.on('change keyup input paste', recreatePreview);
    $message.on('change keyup input paste', recreatePreview);

    $form.append($('<h3>Preview:</h3>'), $previewDiv, $buttonBar);
    return {
        $form: $('<div class="comment-form"/>').append($form),
        onShow: function() { grecaptcha.render($recaptcha[0]); }
    };
}

function $replyButton(comment) {
    var $button;
    if (comment)
        $button = $('<button class="btn btn-primary comment-reply"><i class="fa fa-reply"></i> Reply</button>');
    else
        $button = $('<button class="btn btn-primary comment-new"><i class="fa fa-plus-square"></i> New Comment</button>');
    return $button;
}

var now = moment();
function $comment(includeForm, comment) {
    var message = sanitizeHtml(markdownConverter.makeHtml(comment.message), sanitizeOptions);
    var $commentDiv = $('<div class="comment"/>');
    var publicationDate = moment(comment.date);
    var $author = $('<div class="comment-author"/>').append($('<span class="comment-author-name"/>').text(comment.authorName));
    if (comment.authorUri !== "")
        $author.append($('<span> • </span>'), $('<a class="comment-author-uri" rel="nofollow noopener ugc"/>').attr('href', comment.authorUri).text(comment.authorUri));
    var $headerDiv = $('<div class="comment-header"/>').append(
        $('<div class="comment-author-profile" style="float:left;"/>').append($('<img class="comment-author-profile-image" src="' + avatarUri(comment.authorEmailMD5) + '"/>')),
        $author,
        $('<div class="comment-date" />').append(
            $('<a/>').attr('href', '#' + commentId(comment._id)).attr('title', 'permalink').text(publicationDate.from(now) + ' (' + publicationDate.format('YYYY-MM-DD hh:mm:ss a') + ')')
        )
    );
    if (comment.replyTo !== "") {
        var parent = comments.filter(function (x) { return x._id === comment.replyTo })[0];
        $headerDiv.append($('<div/>').append($('<a/>').attr('href', '#' + commentId(comment.replyTo)).text('In reply to ' + parent.authorName)));
    }

    $commentDiv.append($('<div class="comment-anchor"/>').attr('id', commentId(comment._id)),
        $headerDiv,
        $('<div class="comment-message" style="clear:both;"/>').html(message)
    );

    var $commentContainer = $('<div class="comment-container"/>').append($commentDiv);
    if (includeForm)
        $commentContainer.append($expandCollapseForm(comment));
    var childComments = filterComments(comment._id);
    for (var i = 0; i != childComments.length; ++i) {
        var child = childComments[i];
        $commentContainer.append($comment(includeForm, child));
    }

    return $commentContainer;
}

function normalizeComment(x) {
    var uri = x.authorUri;
    if (!uri || (!uri.startsWith("http://") && !uri.startsWith("https://")))
        uri = "";
    return {
            _id: x._id,
            authorName: x.authorName || "Anonymous",
            authorEmailMD5: x.authorEmailMD5 || "",
            authorUri: uri,
            message: x.message || "",
            replyTo: x.replyTo || "",
            date: x.date,
            timestamp: moment(x.date).valueOf()
    };
}

function $expandCollapseForm(comment) {
    var $button = $replyButton(comment);
    var formObj = $commentForm(hideForm, comment);
    var $form = formObj.$form.addClass("comment-hidden");
    var onShow = formObj.onShow;
    function showForm() {
        $button.addClass("comment-hidden");
        if (onShow) {
            onShow();
            onShow = null;
        }
        $form.removeClass("comment-hidden");
    }
    function hideForm() {
        $form.addClass("comment-hidden");
        $button.removeClass("comment-hidden");
    }
    $button.click(showForm);
    return $('<div/>').append($button, $form);
}

function recaptchaLoaded() {
    var req = new XMLHttpRequest();
    req.addEventListener("load", function () {
        var $commentDiv = $('#comments');
        if (req.status === 404 || req.status === 200) {
            if (req.status === 404) {
                comments = [];
            } else {
                comments = JSON.parse(req.responseText).map(normalizeComment);
            }
            var commentCounter = document.getElementById('comment-counter');
            commentCounter.innerText = comments.length + " " + commentCounter.innerText;
            var toplevelComments = filterComments("");
            for (var i = 0; i != toplevelComments.length; ++i) {
                var comment = toplevelComments[i];
                $commentDiv.append($comment(true, comment));
            }
            if (comments.length !== 0) {
                $commentDiv.append($expandCollapseForm());
            }
        }
        $commentDiv.prepend($expandCollapseForm());
    });
    req.open('GET', "https://comments.stephencleary.com/" + postId + ".json");
    req.send();
}
</script>

<script src="https://www.google.com/recaptcha/api.js?onload=recaptchaLoaded&amp;render=explicit"></script>



<!-- Google AdSense -->
<script src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- Moment -->
<script type="text/javascript">
    (function($) {
        $(function () {
            $('time').each(function (_, e) {
                var startOfToday = moment().startOf('day');
                var publicationDate = moment($(e).attr('datetime'), 'YYYY-MM-DD');
                var difference = startOfToday.diff(publicationDate, 'days');
                var text = difference === 0 ? 'Today' :
                    difference === 1 ? 'Yesterday' :
                    publicationDate.from(startOfToday);
                $(e).text(function(_, oldText) { return text + ' (' + oldText + ')'; });
            });
        });
    })(window.jQuery);
</script>




</body>
</html>