<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>A Tour of Task, Part 7: Continuations</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="An analysis of Task.ContinueWith, TaskFactory.ContinueWhenAny, TaskFactory.ContinueWhenAll, Task.WhenAll, and Task.WhenAny; and discussion of whether they should be used for asynchronous and/or parallel code." />
    <link rel="canonical" href="https://blog.stephencleary.com/2015/01/a-tour-of-task-part-7-continuations.html" />
    
    <link rel="alternate" type="application/rss+xml" title="Stephen Cleary (the blog)" href="http://feeds.feedburner.com/NitoPrograms" />
    
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/bootswatch/3.2.0/spacelab/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" />
    <style type="text/css">/* Layout Styles */
/* ----------------------------------------------------------*/

body {
    padding-top: 50px;
}

.affix {
    top: 70px;
    bottom: 0;
    overflow-y: auto;
}

.navbar-brand {
    font-weight: bold;
}

.navbar-brand-container.active>a, .navbar-brand-container.active>a:hover, .navbar-brand-container.active>a:focus {
    color: #3399f3;
    background-color: transparent;
}

.sidebar {
    margin-top: 20px;
}

.sidenavitem {
    height: auto;
}

.sidebar img {
    /* Responsive images */
    display: inline-block;
    height: auto;
    max-width: 100%;
}

@media(max-width:767px) {
    .affix {
        position: static;
    }
}

div .vertical-margins {
    margin-top: 10px;
    margin-bottom: 10px;
}

.page-header {
    margin-top: 20px;
}

.center {
    text-align: center;
}

.project-icon {
    height: 128px;
    width: 128px;
}

.list-group-item h2 {
    margin-top: 10px;
}

/* Fixes for Google Custom Search in a Bootstrap page */
/* ----------------------------------------------------------*/
.google, .google *, .google *:before, .google *:after {
    -webkit-box-sizing: content-box;
    -moz-box-sizing: content-box;
    box-sizing: content-box;
}

.google table {
    border-collapse: separate;
}

.gsc-input-box {
    height: auto !important;
}

/* Fixes for Amazon widget in Bootstrap page */
.amzn_wdgt * {
    -webkit-box-sizing: content-box;
    -moz-box-sizing: content-box;
    box-sizing: content-box;
}

/* Post styles */
/* ----------------------------------------------------------*/

code {
    background-color: #F2F3F9;
    color: inherit;
}

.post img {
    /* Responsive images */
    display: inline-block;
    height: auto;
    max-width: 100%;
}

.post .table {
    table-layout: fixed;
}

.post .table code {
    white-space: normal;
}

.post .yes {
    color: #008000;
}

.post .no {
    color: #FF0000;
}

/* Syntax highlighting styles */
/* ----------------------------------------------------------*/

.highlight  { background: #ffffff; }
.highlight .c { color: #008000 } /* Comment */
.highlight .k { color: #0000ff } /* Keyword */
.highlight .cm { color: #008000 } /* Comment.Multiline */
.highlight .cp { color: #0000ff } /* Comment.Preproc */
.highlight .c1 { color: #008000 } /* Comment.Single */
.highlight .cs { color: #008000 } /* Comment.Special */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gh { font-weight: bold } /* Generic.Heading */
.highlight .gp { font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { font-weight: bold } /* Generic.Subheading */
.highlight .kc { color: #0000ff } /* Keyword.Constant */
.highlight .kd { color: #0000ff } /* Keyword.Declaration */
.highlight .kn { color: #0000ff } /* Keyword.Namespace */
.highlight .kp { color: #0000ff } /* Keyword.Pseudo */
.highlight .kr { color: #0000ff } /* Keyword.Reserved */
.highlight .kt { color: #2b91af } /* Keyword.Type */
.highlight .s { color: #a31515 } /* Literal.String */
.highlight .nc { color: #2b91af } /* Name.Class */
.highlight .ow { color: #0000ff } /* Operator.Word */
.highlight .sb { color: #a31515 } /* Literal.String.Backtick */
.highlight .sc { color: #a31515 } /* Literal.String.Char */
.highlight .sd { color: #a31515 } /* Literal.String.Doc */
.highlight .s2 { color: #a31515 } /* Literal.String.Double */
.highlight .se { color: #a31515 } /* Literal.String.Escape */
.highlight .sh { color: #a31515 } /* Literal.String.Heredoc */
.highlight .si { color: #a31515 } /* Literal.String.Interpol */
.highlight .sx { color: #a31515 } /* Literal.String.Other */
.highlight .sr { color: #a31515 } /* Literal.String.Regex */
.highlight .s1 { color: #a31515 } /* Literal.String.Single */
.highlight .ss { color: #a31515 } /* Literal.String.Symbol */

/* Comments */
/* ----------------------------------------------------------*/

.comment-container {
    margin-top: 1em;
}

.comment-container > .comment-container {
    margin-left: 2em;
}

.comment-container > .comment-container > .comment-container > .comment-container > .comment-container {
    margin-left: 0;
}

/* Correct anchor links in comments (they are offset by the height of the fixed header) */
.comment-anchor {
    display: block;
    position: relative;
    top: -60px;
    visibility: hidden;
}

img.comment-author-profile-image {
    height: 80px;
    width: 80px;
    margin-right: 10px;
}

.comment-message {
    overflow-x: auto;
}

.comment-form {
    border: 1px solid black;
    padding: 1em;
}

.comment-new {
    margin-top: 1em;
    margin-bottom: 1em;
}

.comment-new, .comment-reply {
    margin-left: 1em;
}

.comment-hidden {
    display: none;
}

.comment-form-buttonbar {
    margin-top: 1em;
}
</style>
    
    <meta name="application-name" content="Stephen Cleary" />
    <link rel="search" type="application/opensearchdescription+xml" href="https://stephencleary.com/opensearch.xml" title="Cleary Search">
    <link rel="apple-touch-icon" sizes="57x57" href="https://stephencleary.com/icons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="https://stephencleary.com/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://stephencleary.com/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://stephencleary.com/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="https://stephencleary.com/icons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="https://stephencleary.com/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="https://stephencleary.com/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://stephencleary.com/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" href="https://stephencleary.com/icons/apple-touch-icon.png"/>
    <link rel="apple-touch-icon-precomposed" href="https://stephencleary.com/icons/apple-touch-icon-precomposed.png"/>
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-196x196.png" sizes="196x196">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="https://stephencleary.com/icons/favicon-32x32.png" sizes="32x32">
    
    <meta name="google-site-verification" content="L8q0fpGSwpNSD0OGFI07hyMujSpORrV4tAaNx_Js7oQ" />
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <div class="navbar-brand-container"><a class="navbar-brand" href="https://stephencleary.com">Stephen Cleary</a></div>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
            <li  class="active"  ><a href="https://blog.stephencleary.com">Blog</a></li>
            <li ><a href="https://stephencleary.com/videos/">Videos</a></li>
            <li  ><a href="https://stephencleary.com/projects/">Projects</a></li>
            <li  ><a href="https://stephencleary.com/publications/">Publications</a></li>
            <li  ><a href="https://stephencleary.com/book/">Book</a></li>
            <li  ><a href="https://stephencleary.com/contact/">Contact</a></li>
            <li><a href="http://feeds.feedburner.com/NitoPrograms"><i class="fa fa-rss-square fa-lg"></i></a></li>
            <li  ><a href="https://stephencleary.com/search/"><i class="fa fa-search"></i></a></li>
        </ul>
    </div>
</nav>

    <div class="container-fluid">
        <div class="col-sm-8 col-sm-offset-2 col-md-6 col-md-offset-3">
            <div class="post">

  <header>
      <div class="page-header">
          <h1>A Tour of Task, Part 7: Continuations</h1>
          <small><time datetime="2015-01-29">Jan 29, 2015</time> &bull; <a id="comment-counter" href="#comments">Comments</a></small>
      </div>
  </header>

  <header>
    <div class="alert alert-info" markdown="1">
        <i class="fa fa-hand-o-right fa-2x pull-left"></i>
        
        <div>Has this blog been helpful? Please consider <a href="https://github.com/sponsors/StephenCleary" class="alert-link">supporting this blog (and my open-source libraries).</a> Thanks!</div>
        <div><i>For a limited time, GitHub will match your support.</i></div>
    </div>
  </header>

  <article>
  <p>Recent posts have considered several members that wait for tasks to complete (<a href="/2014/10/a-tour-of-task-part-5-wait.html"><code>Wait</code>, <code>WaitAll</code>, <code>WaitAny</code></a>, <a href="/2014/12/a-tour-of-task-part-6-results.html"><code>Result</code>, and <code>GetAwaiter().GetResult()</code></a>). One common disadvantage that all of these have is that they synchronously <em>block</em> the calling thread while waiting for the task to complete.</p>

<p>Today’s post talks about <em>continuations</em>. A continuation is a delegate that you can attach to a task and tell the task “run this when you’re done.” When the task completes, it will then schedule its continuations. The task that a continuation attaches to is called the “antecedent” task.</p>

<p>Continuations are important because they don’t block any threads. Instead of (synchronously) waiting for a task to complete, a thread may just attach a continuation for the task to run whenever it does complete. This is the essence of asynchrony, and the <code>async</code>/<code>await</code> system uses continuations whenever it deals with tasks.</p>

<h2 id="continuewith">ContinueWith</h2>

<p>The most low-level way to attach continuations to a task is to use its <code>ContinueWith</code> method. There are quite a number of overloads, but the general idea is to attach a delegate as a continuation for the task:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Task</span> <span class="nf">ContinueWith</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;);</span>
<span class="n">Task</span> <span class="nf">ContinueWith</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;,</span> <span class="n">CancellationToken</span><span class="p">);</span>
<span class="n">Task</span> <span class="nf">ContinueWith</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;,</span> <span class="n">TaskContinuationOptions</span><span class="p">);</span>
<span class="n">Task</span> <span class="nf">ContinueWith</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;,</span> <span class="n">TaskScheduler</span><span class="p">);</span>
<span class="n">Task</span> <span class="nf">ContinueWith</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;,</span> <span class="n">CancellationToken</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">,</span> <span class="n">TaskScheduler</span><span class="p">);</span>
<span class="n">Task</span> <span class="nf">ContinueWith</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;,</span> <span class="kt">object</span><span class="p">);</span>
<span class="n">Task</span> <span class="nf">ContinueWith</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;,</span> <span class="kt">object</span><span class="p">,</span> <span class="n">CancellationToken</span><span class="p">);</span>
<span class="n">Task</span> <span class="nf">ContinueWith</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;,</span> <span class="kt">object</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">);</span>
<span class="n">Task</span> <span class="nf">ContinueWith</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;,</span> <span class="kt">object</span><span class="p">,</span> <span class="n">TaskScheduler</span><span class="p">);</span>
<span class="n">Task</span> <span class="nf">ContinueWith</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;,</span> <span class="kt">object</span><span class="p">,</span> <span class="n">CancellationToken</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">,</span> <span class="n">TaskScheduler</span><span class="p">);</span>

<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWith</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWith</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;,</span> <span class="n">CancellationToken</span><span class="p">);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWith</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;,</span> <span class="n">TaskContinuationOptions</span><span class="p">);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWith</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;,</span> <span class="n">TaskScheduler</span><span class="p">);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWith</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;,</span> <span class="n">CancellationToken</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">,</span> <span class="n">TaskScheduler</span><span class="p">);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWith</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="kt">object</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;,</span> <span class="kt">object</span><span class="p">);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWith</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="kt">object</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;,</span> <span class="kt">object</span><span class="p">,</span> <span class="n">CancellationToken</span><span class="p">);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWith</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="kt">object</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;,</span> <span class="kt">object</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWith</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="kt">object</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;,</span> <span class="kt">object</span><span class="p">,</span> <span class="n">TaskScheduler</span><span class="p">);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWith</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="kt">object</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;,</span> <span class="kt">object</span><span class="p">,</span> <span class="n">CancellationToken</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">,</span> <span class="n">TaskScheduler</span><span class="p">);</span></code></pre></figure>

<p>Whew, that’s a lot of overloads! Let’s break it down a little. First, the overloads containing an <code>object</code> parameter just pass that value through to the continuation delegate; this is just an optimization to avoid an extra allocation in some cases, so we can ignore those overloads for now:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Task</span> <span class="nf">ContinueWith</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;);</span>
<span class="n">Task</span> <span class="nf">ContinueWith</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;,</span> <span class="n">CancellationToken</span><span class="p">);</span>
<span class="n">Task</span> <span class="nf">ContinueWith</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;,</span> <span class="n">TaskContinuationOptions</span><span class="p">);</span>
<span class="n">Task</span> <span class="nf">ContinueWith</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;,</span> <span class="n">TaskScheduler</span><span class="p">);</span>
<span class="n">Task</span> <span class="nf">ContinueWith</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;,</span> <span class="n">CancellationToken</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">,</span> <span class="n">TaskScheduler</span><span class="p">);</span>

<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWith</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWith</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;,</span> <span class="n">CancellationToken</span><span class="p">);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWith</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;,</span> <span class="n">TaskContinuationOptions</span><span class="p">);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWith</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;,</span> <span class="n">TaskScheduler</span><span class="p">);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWith</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;,</span> <span class="n">CancellationToken</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">,</span> <span class="n">TaskScheduler</span><span class="p">);</span></code></pre></figure>

<p>There’s also three optional parameters: a <code>CancellationToken</code> (defaulting to <code>CancellationToken.None</code>), a set of <code>TaskContinuationOptions</code> (defaulting to <code>TaskContinuationOptions.None</code>), and a <code>TaskScheduler</code> (defaulting to <code>TaskScheduler.Current</code>). So this list of overloads can be further simplified to:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Task</span> <span class="nf">ContinueWith</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;,</span> <span class="n">CancellationToken</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">,</span> <span class="n">TaskScheduler</span><span class="p">);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWith</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;,</span> <span class="n">CancellationToken</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">,</span> <span class="n">TaskScheduler</span><span class="p">);</span></code></pre></figure>

<p>The <code>Task&lt;T&gt;</code> type has its own matching set of overloads. I won’t bore you with the details - there are another 20 method signatures, which simplify in the same manner down to:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Task</span> <span class="nf">ContinueWith</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;&gt;,</span> <span class="n">CancellationToken</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">,</span> <span class="n">TaskScheduler</span><span class="p">);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TContinuationResult</span><span class="p">&gt;</span> <span class="n">ContinueWith</span><span class="p">&lt;</span><span class="n">TContinuationResult</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;,</span> <span class="n">TContinuationResult</span><span class="p">&gt;,</span> <span class="n">CancellationToken</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">,</span> <span class="n">TaskScheduler</span><span class="p">);</span></code></pre></figure>

<p>At this point, it should be clear that there are two primary types of continuation delegates that can be passed to <code>ContinueWith</code>: one has a result value (<code>Func&lt;...&gt;</code>) and the other does not (<code>Action&lt;...&gt;</code>). The continuation delegate always receives a task as a parameter. This is the task that the continuation is attaching to, so if you were to call <code>task.ContinueWith(t =&gt; ...)</code>, then <code>task</code> and <code>t</code> refer to the same antecedent task instance.</p>

<p><code>ContinueWith</code> also <em>returns</em> a task. This task represents the continuation itself. So, each continuation is itself a task, and may have its own continuations, and so on.</p>

<p>Let’s talk a bit more about the optional parameters.</p>

<p>First, the <code>CancellationToken</code>. If you cancel the token <em>before</em> the continuation is scheduled, then the continuation delegate never actually runs - it’s cancelled. However, note that the token does not cancel the continuation <em>once it has started</em>. In other words, the <code>CancellationToken</code> cancels the <em>scheduling</em> of the continuation, not the continuation itself. For this reason, I think the <code>CancellationToken</code> parameter is misleading, and I never use it myself.</p>

<p>The next parameter is <code>TaskContinuationOptions</code>, a collection of options for the continuation. Most options either have to do with <em>conditions</em>, <em>scheduling</em>, or <em>parenting</em> for the continuation. The <code>None</code> option means to use the default behavior; however, in modern applications, these defaults are only appropriate for <a href="https://msdn.microsoft.com/en-us/library/ff963551.aspx">dynamic task parallelism</a>, which is extremely rare.</p>

<p>The “condition options” will only schedule the continuation if the antecedent task completes in a <a href="/2014/06/a-tour-of-task-part-3-status.html">matching state</a>. <code>OnlyOnRanToCompletion</code>, <code>OnlyOnFaulted</code>, and <code>OnlyOnCanceled</code> will only schedule the continuation if the antecedent task completes in a specific state. <code>NotOnRanToCompletion</code>, <code>NotOnFaulted</code>, and <code>NotOnCanceled</code> will only schedule the continuation if the antecedent task completes in <em>another</em> state. All of these “condition options” are roughly equivalent to just checking the task’s <code>Status</code> from within the continuation.</p>

<p><strong>Update, 2015-01-30 <a href="https://twitter.com/I3arnon/status/561150440960581637">(suggested by Bar Arnon)</a>:</strong> If the condition option is met by the antecedent task (e.g., the task completes in a <code>RanToCompletion</code> state and the continuation specified the <code>OnlyOnRanToCompletion</code> option), then the continuation is scheduled normally. However, if the condition option is <em>not</em> met (e.g., the task completes in a faulted state but the continuation specified the <code>OnlyOnRanToCompletion</code> option), then the continuation is cancelled. The continuation delegate is never executed and the continuation task immediately moves to the canceled state.</p>

<p>Several “scheduling options” are passed along to the <code>TaskScheduler</code> that is responsible for scheduling the continuation. <code>PreferFairness</code> is a hint asking for FIFO behavior. <code>LongRunning</code> is a hint that the continuation will execute for a long time. <code>ExecuteSynchronously</code> is a request that the continuation be scheduled on the same thread that completes the antecedent task. Note that all of these are just hints; it is entirely appropriate for the <code>TaskScheduler</code> to ignore them all; in particular, <a href="http://blogs.msdn.com/b/pfxteam/archive/2012/02/07/10265067.aspx"><code>ExecuteSynchronously</code> does not guarantee that the continuation will execute synchronously</a>.</p>

<div class="alert alert-info">
  <p><i class="fa fa-hand-o-right fa-2x pull-left"></i></p>

  <p>As of this writing, in the .NET 4.6 preview, there is another option called <code>RunContinuationsAsynchronously</code>, which seems to force continuations to execute asynchronously. Currently, there is no way to absolutely force continuations to be synchronous or asynchronous; forcing asynchronous continuations would certainly be useful in some situations.</p>

  <p><strong>Update, 2015-02-02:</strong> The .NET team has <a href="http://blogs.msdn.com/b/pfxteam/archive/2015/02/02/new-task-apis-in-net-4-6.aspx">released a post</a> describing the <code>RunContinuationsAsynchronously</code> option. As the name implies, it does in fact run the continuation asynchronously.</p>
</div>

<p>There are a few more “scheduling options” that are not passed to the <code>TaskScheduler</code>. The <code>HideScheduler</code> option (introduced in .NET 4.5) will use the given task scheulder to schedule the continuation, but then will pretend that there is no current task scheduler while the continuation is executing; this can be used as a workaround for the unexpected default task scheduler (described below). <code>LazyCancellation</code> (introduced in .NET 4.5) is an option that ensures the continuation is completed (canceled) only after its antecedent completes. Without <code>LazyCancellation</code>, if the cancellation token passed to <code>ContinueWith</code> is cancelled, it could cancel the continuation before the original task even completed.</p>

<p>The “parenting options” control how the continuation task is attached to the antecedent task. <a href="https://msdn.microsoft.com/en-us/library/vstudio/dd997417(v=vs.110).aspx">Attached child tasks</a> change the <a href="/2014/06/a-tour-of-task-part-3-status.html">behavior of their parent task</a> in ways that are convenient in some <a href="https://msdn.microsoft.com/en-us/library/ff963551.aspx">dynamic task parallelism</a> scenarios, but are unexpected and awkward anywhere outside that (extremely small) use case. <code>AttachedToParent</code> will attach the continuation as a child task of the antecedent task. In modern code, you almost never want this option; more importantly, you almost never want <em>other</em> code to attach child tasks to your tasks. For this reason, the <code>DenyChildAttach</code> option was introduced in .NET 4.5, which prevents any continuations from using <code>AttachedToParent</code>.</p>

<p>The final optional parameter is a <code>TaskScheduler</code> that is used to schedule the continuation. Unfortunately, the default value for this parameter is <em>not</em> <code>TaskScheduler.Default</code>, but rather <code>TaskScheduler.Current</code>. This fact has caused quite a bit of confusion over the years, because the vast majority of the time, developers expect (and desire) <code>TaskScheduler.Default</code>. <code>Task.Factory.StartNew</code> has a <a href="/2013/08/startnew-is-dangerous.html">similar problem that I have described earlier</a>. Since this default value is unexpected (and almost always undesirable), I recommend that you <em>always</em> pass a <code>TaskScheduler</code> value to <code>ContinueWith</code>. Many companies have run into this issue and enforce similar rules on their codebase.</p>

<p><strong>In conclusion</strong>, I do not recommend using <code>ContinueWith</code> at all, unless you are doing <a href="https://msdn.microsoft.com/en-us/library/ff963551.aspx">dynamic task parallelism</a> (which is extremely rare). In modern code, you should almost always use <code>await</code> instead of <code>ContinueWith</code>. There are several benefits to <code>await</code>.</p>

<p>One benefit is when working with other asynchronous code. As mentioned above, <code>ContinueWith</code> can take only a limited number of delegates, none of which are <a href="/2014/02/synchronous-and-asynchronous-delegate.html"><code>async</code>-aware delegates</a>. When dealing with asynchronous continuations, <code>ContinueWith</code> will treat them as though they were synchronous. This can cause some manner of confusion when working with continuations of those continuations. Also, this means the scheduling options (e.g., <code>LongRunning</code>) do not work as most developers expect; they are only applied to the initial synchronous portion of an asynchronous delegate. In contrast, <code>await</code> works naturally with asynchronous continuations.</p>

<p>Another benefit is a better default task scheduler. Code using <code>ContinueWith</code> should always explicitly specify a task scheduler to reduce confusion, but <code>await</code> has <a href="/2012/02/async-and-await.html">much more reasonable default behavior</a>. Modern code almost never uses task schedulers; it either uses <code>SynchronizationContext.Current</code> or the thread pool scheduler.</p>

<p>The last benefit is that <code>await</code> uses the most appropriate options by default. When you <code>await</code> an incomplete task, under the hood <code>await</code> does use <code>ContinueWith</code> to schedule a continuation for you. However, it will automatically use the appropriate options (<code>DenyChildAttach</code> and <code>ExecuteSynchronously</code>), and doesn’t allow you to specify options that will not work correctly (e.g., <code>AttachedToParent</code> or <code>LongRunning</code>).</p>

<p>In short, <strong>prefer <code>await</code> over <code>ContinueWith</code></strong>. <code>ContinueWith</code> is useful when doing <a href="https://msdn.microsoft.com/en-us/library/ff963551.aspx">dynamic task parallelism</a>, but in every other scenario, <code>await</code> is preferred.</p>

<h2 id="taskfactorycontinuewhenany">TaskFactory.ContinueWhenAny</h2>

<p><code>ContinueWhenAny</code> is a way of executing a <em>single</em> continuation when any of a <em>set</em> of tasks completes. So, it’s a way to attach a single continuation to multiple tasks, and only have that continuation run when the first task completes.</p>

<p>The <code>TaskFactory</code> type has a set of <code>ContinueWhenAny</code> overloads that are somewhat similar to <code>ContinueWith</code>:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Task</span> <span class="nf">ContinueWhenAny</span><span class="p">(</span><span class="n">Task</span><span class="p">[],</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;);</span>
<span class="n">Task</span> <span class="nf">ContinueWhenAny</span><span class="p">(</span><span class="n">Task</span><span class="p">[],</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;,</span> <span class="n">CancellationToken</span><span class="p">);</span>
<span class="n">Task</span> <span class="nf">ContinueWhenAny</span><span class="p">(</span><span class="n">Task</span><span class="p">[],</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;,</span> <span class="n">TaskContinuationOptions</span><span class="p">);</span>
<span class="n">Task</span> <span class="nf">ContinueWhenAny</span><span class="p">(</span><span class="n">Task</span><span class="p">[],</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;,</span> <span class="n">CancellationToken</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">,</span> <span class="n">TaskScheduler</span><span class="p">);</span>

<span class="n">Task</span> <span class="n">ContinueWhenAny</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;(</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;[],</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;&gt;);</span>
<span class="n">Task</span> <span class="n">ContinueWhenAny</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;(</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;[],</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;&gt;,</span> <span class="n">CancellationToken</span><span class="p">);</span>
<span class="n">Task</span> <span class="n">ContinueWhenAny</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;(</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;[],</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;&gt;,</span> <span class="n">TaskContinuationOptions</span><span class="p">);</span>
<span class="n">Task</span> <span class="n">ContinueWhenAny</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;(</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;[],</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;&gt;,</span> <span class="n">CancellationToken</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">,</span> <span class="n">TaskScheduler</span><span class="p">);</span>

<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWhenAny</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Task</span><span class="p">[],</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWhenAny</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Task</span><span class="p">[],</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;,</span> <span class="n">CancellationToken</span><span class="p">);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWhenAny</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Task</span><span class="p">[],</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;,</span> <span class="n">TaskContinuationOptions</span><span class="p">);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWhenAny</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Task</span><span class="p">[],</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;,</span> <span class="n">CancellationToken</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">,</span> <span class="n">TaskScheduler</span><span class="p">);</span>

<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWhenAny</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;[],</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;,</span> <span class="n">TResult</span><span class="p">&gt;);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWhenAny</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;[],</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;,</span> <span class="n">TResult</span><span class="p">&gt;,</span> <span class="n">CancellationToken</span><span class="p">);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWhenAny</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;[],</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;,</span> <span class="n">TResult</span><span class="p">&gt;,</span> <span class="n">TaskContinuationOptions</span><span class="p">);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWhenAny</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;[],</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;,</span> <span class="n">TResult</span><span class="p">&gt;,</span> <span class="n">CancellationToken</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">,</span> <span class="n">TaskScheduler</span><span class="p">);</span></code></pre></figure>

<p>Each of those groups of four overloads simplify down to a central method:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Task</span> <span class="nf">ContinueWhenAny</span><span class="p">(</span><span class="n">Task</span><span class="p">[],</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;,</span> <span class="n">CancellationToken</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">,</span> <span class="n">TaskScheduler</span><span class="p">);</span>
<span class="n">Task</span> <span class="n">ContinueWhenAny</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;(</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;[],</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;&gt;,</span> <span class="n">CancellationToken</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">,</span> <span class="n">TaskScheduler</span><span class="p">);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWhenAny</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Task</span><span class="p">[],</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;,</span> <span class="n">CancellationToken</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">,</span> <span class="n">TaskScheduler</span><span class="p">);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">ContinueWhenAny</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;(</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;[],</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TAntecedentResult</span><span class="p">&gt;,</span> <span class="n">TResult</span><span class="p">&gt;,</span> <span class="n">CancellationToken</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">,</span> <span class="n">TaskScheduler</span><span class="p">);</span></code></pre></figure>

<p>The overloads with a <code>TAntecedentResult</code> generic parameter are for when the antecedent tasks all have the same result type. The overloads with a <code>TResult</code> are for when the continuation returns a result of its own. The <code>TaskFactory&lt;TResult&gt;</code> type only has overloads supporting continuations that return a result, so it has half the overloads that <code>TaskFactory</code> does.</p>

<p>The default parameter values work similarly to <code>ContinueWith</code>, except that they are specified by the <code>TaskFactory</code> properties. So, the default <code>CancellationToken</code> is <code>TaskFactory.CancellationToken</code>, the default <code>ContinuationOptions</code> value is <code>TaskFactory.ContinuationOptions</code>, and the default <code>TaskScheduler</code> is <code>TaskFactory.Scheduler</code>, all of which may be set by passing the desired values into the <code>TaskFactory</code> constructor.</p>

<p>Note that the default <code>TaskScheduler</code> is still dangerous: anytime a <code>TaskFactory</code> is constructed without an explicit <code>TaskScheduler</code>, it will default to the value of <code>TaskScheduler.Current</code> at the time <code>ContinueWhenAny</code> is called. This causes the same surprising behavior as it does for <code>ContinueWith</code>. Note that the static <code>TaskFactory</code> instance <code>Task.Factory</code> does have this problematic default task scheduler.</p>

<p>I recommend not using these overloads at all; instead, use <code>await Task.WhenAny(...)</code> (see below) to asynchronously wait for one of a set of tasks to complete.</p>

<h2 id="taskfactorycontinuewhenall">TaskFactory.ContinueWhenAll</h2>

<p><code>ContinueWhenAll</code> is just like <code>ContinueWhenAny</code>, except the logic is that the continuation is executed once after <em>all</em> the antecedent tasks have completed. There are sixteen overloads on <code>TaskFactory</code> and eight on <code>TaskFactory&lt;TResult&gt;</code>, exactly like <code>ContinueWhenAny</code>. The same default parameter logic applies.</p>

<p>And the same default <code>TaskScheduler</code> is still dangerous.</p>

<p>And I recommend not using these overloads at all, either; instead, use <code>await Task.WhenAll(...)</code> (see below).</p>

<h2 id="taskwhenall">Task.WhenAll</h2>

<p><code>Task.WhenAll</code> returns a task that completes when all of the antecedent tasks have completed. This is conceptually similar to <code>TaskFactory.ContinueWhenAll</code>, but works much more nicely with <code>await</code>:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Task</span> <span class="nf">WhenAll</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;);</span>
<span class="n">Task</span> <span class="nf">WhenAll</span><span class="p">(</span><span class="k">params</span> <span class="n">Task</span><span class="p">[]);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">[]&gt;</span> <span class="n">WhenAll</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;&gt;);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">[]&gt;</span> <span class="n">WhenAll</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="k">params</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;[]);</span></code></pre></figure>

<p>The <code>IEnumerable&lt;&gt;</code> overloads allow you to pass in a sequence of tasks, such as a LINQ expression. The sequence is immediately reified (i.e., copied to an array). For example, this allows you to pass the results of a <code>Select</code> expression directly to <code>WhenAll</code>. Personally, I usually prefer to explicitly reify the sequence by calling <code>ToArray()</code> so that it’s obvious that’s what’s happening, but some folks like the ability to pass the sequence directly in.</p>

<p>The overloads with the <code>TResult</code> generic parameter will retrieve all the results of those tasks, as an array. This is very convenient when you have multiple operations of a similar nature. For example, you can do two concurrent downloads as such:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HttpClient</span><span class="p">();</span>
<span class="kt">string</span><span class="p">[]</span> <span class="n">results</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">WhenAll</span><span class="p">(</span>
    <span class="n">client</span><span class="p">.</span><span class="n">GetStringAsync</span><span class="p">(</span><span class="s">&quot;http://example.com&quot;</span><span class="p">),</span>
    <span class="n">client</span><span class="p">.</span><span class="n">GetStringAsync</span><span class="p">(</span><span class="s">&quot;http://microsoft.com&quot;</span><span class="p">));</span>
<span class="c1">// results[0] has the HTML of example.com</span>
<span class="c1">// results[1] has the HTML of microsoft.com</span></code></pre></figure>

<p>This is also powerful when combined with LINQ. The code below will simultaneously download whatever urls are in the source sequence:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">urls</span> <span class="p">=</span> <span class="p">...;</span>
<span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HttpClient</span><span class="p">();</span>
<span class="kt">string</span><span class="p">[]</span> <span class="n">results</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">WhenAll</span><span class="p">(</span><span class="n">urls</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">url</span> <span class="p">=&gt;</span> <span class="n">client</span><span class="p">.</span><span class="n">GetStringAsync</span><span class="p">(</span><span class="n">url</span><span class="p">)));</span></code></pre></figure>

<h2 id="taskwhenany">Task.WhenAny</h2>

<p><code>Task.WhenAny</code> is similar to <code>Task.WhenAll</code>, but instead of asynchronously waiting for all antecedent tasks to complete, it asynchronously waits for only one. It has a similar set of overloads:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Task</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;</span> <span class="n">WhenAny</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;</span> <span class="n">WhenAny</span><span class="p">(</span><span class="k">params</span> <span class="n">Task</span><span class="p">[]);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;&gt;</span> <span class="n">WhenAny</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;&gt;);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;&gt;</span> <span class="n">WhenAny</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;(</span><span class="k">params</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;[]);</span></code></pre></figure>

<p>The <code>IEnumerable&lt;&gt;</code> and <code>TResult</code> overloads serve the same purposes as they do for <code>WhenAll</code>. However, the <em>return</em> type of <code>WhenAny</code> is interesting. <code>WhenAny</code> returns a task that is completed when any of the antecedent tasks complete. The <em>result</em> of that task is the antecedent task that completed.</p>

<p>This means that applying a single <code>await</code> to a call to <code>WhenAny</code> will give you the task that completed. This allows you to do things like do two operations at the same time and see which finishes first:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HttpClient</span><span class="p">();</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">downloadExampleTask</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="n">GetStringAsync</span><span class="p">(</span><span class="s">&quot;http://example.com&quot;</span><span class="p">);</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">downloadMicrosoftTask</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="n">GetStringAsync</span><span class="p">(</span><span class="s">&quot;http://microsoft.com&quot;</span><span class="p">);</span>
<span class="n">Task</span> <span class="n">completedTask</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">WhenAny</span><span class="p">(</span><span class="n">downloadExampleTask</span><span class="p">,</span> <span class="n">downloadMicrosoftTask</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">completedTask</span> <span class="p">==</span> <span class="n">downloadExampleTask</span><span class="p">)</span>
  <span class="p">;</span> <span class="c1">// example.com downloaded faster.</span></code></pre></figure>

<p>Usually, when you use <code>WhenAny</code>, you actually don’t care about the tasks that <em>don’t</em> complete first. That is, only the results of the first task are important. In this scenario, you can make use of the rare but legal “double await”:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HttpClient</span><span class="p">();</span>
<span class="kt">string</span> <span class="n">results</span> <span class="p">=</span> <span class="k">await</span> <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">WhenAny</span><span class="p">(</span>
    <span class="n">client</span><span class="p">.</span><span class="n">GetStringAsync</span><span class="p">(</span><span class="s">&quot;http://example.com&quot;</span><span class="p">),</span>
    <span class="n">client</span><span class="p">.</span><span class="n">GetStringAsync</span><span class="p">(</span><span class="s">&quot;http://microsoft.com&quot;</span><span class="p">));</span>
<span class="c1">// results contains the HTML for whichever website responded first.</span></code></pre></figure>

<p>If you find the “double await” confusing, just break it out and specify the types. The code above is the same as:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HttpClient</span><span class="p">();</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">firstDownloadToComplete</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">WhenAny</span><span class="p">(</span>
    <span class="n">client</span><span class="p">.</span><span class="n">GetStringAsync</span><span class="p">(</span><span class="s">&quot;http://example.com&quot;</span><span class="p">),</span>
    <span class="n">client</span><span class="p">.</span><span class="n">GetStringAsync</span><span class="p">(</span><span class="s">&quot;http://microsoft.com&quot;</span><span class="p">));</span>
<span class="kt">string</span> <span class="n">results</span> <span class="p">=</span> <span class="k">await</span> <span class="n">firstDownloadToComplete</span><span class="p">;</span> 
<span class="c1">// results contains the HTML for whichever website responded first.</span></code></pre></figure>

<div class="alert alert-info">
  <p><i class="fa fa-hand-o-right fa-2x pull-left"></i></p>

  <p>I do recommend using <code>await</code> to retrieve the results of the completed task. In this case, it might seem that <code>await</code> is supurfluous, since we <em>know</em> that the task is already completed. However, <code>await</code> is still better than <code>Task.Result</code> because <code>await</code> will not wrap exceptions inside an <code>AggregateException</code>.</p>
</div>

  </article>
    
    <footer class="hidden-print">
        
            <ul class="pager">
                <li class="previous"><a href="/2014/12/a-tour-of-task-part-6-results.html" title="A Tour of Task, Part 6: Results">&larr; Previous in A Tour of Task</a></li>
                <li class="next"><a href="/2015/02/a-tour-of-task-part-8-starting.html" title="A Tour of Task, Part 8: Starting">Next in A Tour of Task &rarr;</a></li>
            </ul>
        
        
        <ul class="pager">
            <li class="previous"><a href="/2015/01/codemash-2015.html" title="CodeMash 2015">&larr; Previous Post</a></li>
            <li class="next"><a href="/2015/02/a-tour-of-task-part-8-starting.html" title="A Tour of Task, Part 8: Starting">Next Post &rarr;</a></li>
        </ul>

        <div id="comments"></div>
    </footer>
</div>
        </div>
        <div class="col-sm-2 col-md-3 col-md-offset-0 col-lg-2 col-lg-offset-1 affix hidden-print" data-spy="affix" role="navigation">
            
                <div class="panel panel-primary">
                    <div class="panel-heading">A Tour of Task</div>
                    <div class="panel-body sidenav">
                        <ul class="nav nav-pills nav-stacked">
                                    <li class="sidenavitem"><a href="/2014/04/a-tour-of-task-part-0-overview.html">Overview</a></li>
                                    <li class="sidenavitem"><a href="/2014/05/a-tour-of-task-part-1-constructors.html">Constructors</a></li>
                                    <li class="sidenavitem"><a href="/2014/05/a-tour-of-task-part-2-asyncstate-and-creationoptions.html">AsyncState and CreationOptions</a></li>
                                    <li class="sidenavitem"><a href="/2014/06/a-tour-of-task-part-3-status.html">Status</a></li>
                                    <li class="sidenavitem"><a href="/2014/06/a-tour-of-task-part-4-id.html">Id</a></li>
                                    <li class="sidenavitem"><a href="/2014/10/a-tour-of-task-part-5-wait.html">Waiting</a></li>
                                    <li class="sidenavitem"><a href="/2014/12/a-tour-of-task-part-6-results.html">Results</a></li>
                                    <li class="active sidenavitem"><a href="/2015/01/a-tour-of-task-part-7-continuations.html">Continuations</a></li>
                                    <li class="sidenavitem"><a href="/2015/02/a-tour-of-task-part-8-starting.html">Starting</a></li>
                                    <li class="sidenavitem"><a href="/2015/03/a-tour-of-task-part-9-delegate-tasks.html">Delegate Tasks</a></li>
                                    <li class="sidenavitem"><a href="/2015/04/a-tour-of-task-part-10-promise-tasks.html">Promise Tasks</a></li>
                        </ul>
                    </div>
                </div>
            
        </div>
        <div class="col-sm-2 sidebar hidden-print">
            <div class="panel panel-default">
                <div class="panel-heading">About Stephen Cleary</div>
                <div class="panel-body">
                    <div class="center"><img src="https://stephencleary.com/www.assets/Me-large.jpg"/></div>
                    <div class="center vertical-margins">Stephen Cleary is a <a href="https://stephencleary.com/god/">Christian</a>, husband, father, and programmer living in Northern Michigan.</div>
                    <div class="center"><a href="http://mvp.microsoft.com/en-us/mvp/Stephen%20Cleary-5000058"><img class="mvp-logo" src="https://stephencleary.com/www.assets/MVP.png"/></a></div>
                </div>
            </div>
            <div class="panel panel-primary">
                <div class="panel-heading">My book</div>
                <div class="panel-body center">
                    <div><a href="https://stephencleary.com/book/"><img src="https://stephencleary.com/www.assets/Book-2nd-small.jpg"/></a></div>
                    <div>Available from <a href="http://www.jdoqocy.com/click-7489747-11290546?url=http%3A%2F%2Fshop.oreilly.com%2Fproduct%2F0636920266624.do%3Fcmp%3Daf-code-books-video-product_cj_0636920266624_%25zp&cjsku=0636920266624">O'Reilly (Safari)</a>, <a href="https://amzn.to/2kYzcEY">Amazon (print/Kindle)</a>, or <a href="http://www.tkqlhce.com/click-7489733-13660345?url=https%3A%2F%2Fwww.ebooks.com%2Fcj.asp%3FIID%3D209766469&cjsku=209766469">eBooks.com (PDF/epub)</a>.</div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Advertisement</div>
                <div><a href="https://brave.com/ste083">Don't like ads? Browse privately and ad-free with Brave!</a></div>
                <div class="panel-body">
                    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2749292939902134" data-ad-slot="7584809820" data-ad-format="auto"></ins>
                </div>
            </div>
            
            <div class="panel panel-primary">
                <div class="panel-heading">Popular Posts</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2012/02/async-and-await.html">Async/await Intro</a></li>
                        <li><a href="/2013/11/there-is-no-thread.html">There Is No Thread</a></li>
                        <li><a href="/2012/07/dont-block-on-async-code.html">Don't Block on Async Code</a></li>
                    </ul>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Series</div>
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked">
                        <li><a href="/2016/02/react-redux-todomvc.html">React/Redux TodoMVC</a></li>
                        <li><a href="/2014/04/a-tour-of-task-part-0-overview.html">A Tour of Task</a></li>
                        <li><a href="/2013/10/taskrun-etiquette-and-proper-usage.html">Task.Run Etiquette</a></li>
                        <li><a href="/2013/05/taskrun-vs-backgroundworker-intro.html">Task.Run vs. BackgroundWorker</a></li>
                        <li><a href="/2013/01/async-oop-0-introduction.html">Async OOP</a></li>
                        <li><a href="/2009/04/tcpip-net-sockets-faq.html">TCP/IP .NET Sockets FAQ</a></li>
                        <li><a href="/2013/10/managed-services-roundup.html">Managed Services</a></li>
                        <li><a href="/2009/08/how-to-implement-idisposable-and.html">IDisposable and Finalizers</a></li>
                        <li><a href="/2011/02/option-parsing-introduction.html">Option Parsing</a></li>
                    </ul>
                </div>
            </div>
            
        </div>
    </div>

    <div class="google">
        <gcse:searchresults></gcse:searchresults>
    </div>
    
    <!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
<script type="text/javascript">window.jQuery || document.write('<script src="/lib/jquery-2.1.1.min.js"><\/script>')</script>

<!-- Bootstrap -->
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script type="text/javascript">window.jQuery.fn.modal || document.write('<script src="/lib/bootstrap.min.js"><\/script>')</script>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('body').css('color') !== 'rgb(102, 102, 102)') {
                $('head').prepend('<link rel="stylesheet" href="/lib/bootstrap.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Font Awesome -->
<span id="facheck" class="fa" style="display:none"></span>
<script type="text/javascript">
    (function($) {
        $(function() {
            if ($('#facheck').css('fontFamily') !== 'FontAwesome') {
                $('head').prepend('<link rel="stylesheet" href="/lib/font-awesome.min.css" />');
            }
        });
    })(window.jQuery);
</script>

<!-- Scroll the sidebar into view (if necessary) -->

<script src="/lib/jquery.scrollTo.min.js"></script>
<script type="text/javascript">
    (function ($) {
        $(function () {
            var container = $('.affix').filter(function() { return $(this).css('position') == 'fixed'; });
            var target = container.find('.active');
            container.scrollTo(target, { offset: - (container.height() / 2 - target.height() / 2) });
        });
    })(window.jQuery);
</script>


<!-- Moment -->
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.6.0/moment.min.js"></script>
<script type="text/javascript">window.moment || document.write('<script src="/lib/moment.min.js"><\/script>')</script>

<!-- Google analytics -->
<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-8910661-5', 'stephencleary.com');
    ga('send', 'pageview');
</script>

<!-- Show appropriate elements based on time -->
<script type="text/javascript">
    (function ($) {
        $(function () {
            var targets = $('[data-hide-after]');
            targets.each(function () {
                var $item = $(this);
                if (moment() < moment($item.attr('data-hide-after'))) {
                    $item.removeClass('hidden');
                }
            });
        });
    })(window.jQuery);
</script>








<script src="/lib/uuid-v3-3.2.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/showdown@1.8.6/dist/showdown.min.js" integrity="sha256-dwhppIrxD8qC6lNulndZgtIm4XBU9zoMd9OUoXzIDAE=" crossorigin="anonymous"></script>
<script src="/lib/sanitize-html-1.18.2.min.js"></script>
<script src="/lib/autosize.min.js"></script>
<script src="/lib/base64js.min.js"></script>
<script src="/lib/md5.min.js"></script>

<script type="text/javascript">

var pageUrl = "https://blog.stephencleary.com" + "/2015/01/a-tour-of-task-part-7-continuations.html";

// (unnecessary) 1) If the URL starts with http://, replace with https://

// 2) Take the URL path (not including scheme and domain).
var url = document.createElement('a');
url.href = pageUrl; //'https://developer.mozilla.org:8080/en-US/search?q=URL#search-results-close-container';
var path = url.pathname;

// 3) Path: If the path ends with .html or any two- to six-character [A-Za-z0-9] extension, strip it.
if (path.endsWith(".html"))
    path = path.substr(0, path.length - 5);
else
    path = path.replace(/\.[A-Za-z0-9]{2,6}$/, "");

// 4) Path: For each UTF-16 code unit, if it's not in the whitelist [A-Za-z0-9-_;.~()], then replace it with _.
path = path.replace(/[^-A-Za-z0-9_;.~()]/g, "_");

// 5) Path: Trim leading and trailing _ characters.
path = path.replace(/^_+|_+$/g, "");

// 6) Calculate the V3 URL GUID for the URL.
var guid = uuidv3(pageUrl, uuidv3.URL);

// 7) Combine the path and lowercase-hyphenated GUID, separated by '-'.
var postId = path + "-" + guid;

var nofollowLinkExtension = {
    type: 'output',
    regex: /(<a[^<]+<\/a>)/g,
    replace: (match, $1, $2) => {
        var result = $('<div/>').append($($1).attr('rel', 'nofollow noopener')).html();
        return result;
    }
};
showdown.extension('nofollowLink', nofollowLinkExtension);

var comments;
var markdownConverter = new showdown.Converter({
    omitExtraWLInCodeBlocks: true,
    noHeaderId: true,
    headerLevelStart: 3,
    simplifiedAutoLink: true,
    excludeTrailingPunctuationFromURLs: true,
    literalMidWordUnderscores: true,
    strikethrough: true,
    smoothLivePreview: true,
    disableForced4SpacesIndentedSublists: true,
    extensions: ['nofollowLink']
});
var sanitizeOptions = {
    allowedTags: [ 'blockquote', 'p', 'a', 'ul', 'ol', 'nl', 'li', 'b', 'i', 'strong', 'em', 'strike', 'code', 'br', 'div', 'pre', 'img' ],
    allowedAttributes: {
        a: [
            'href',
            {
                name: 'rel',
                multiple: true,
                values: ['nofollow', 'noopener']
            }
        ],
        img: [ 'src' ]
    },
    allowedIframeHostnames: []
};

function fixedEncodeURIComponent(str) {
  return encodeURIComponent(str).replace(/[!'()*]/g, function(c) {
    return '%' + c.charCodeAt(0).toString(16);
  });
}

function filterComments(replyTo) {
    return comments
        .filter(function (x) { return x.replyTo === replyTo; })
        .sort(function (a, b) { return a.timestamp - b.timestamp; });
}

function avatarUri(authorEmailMD5) {
    if (authorEmailMD5 === "")
        return "https://www.gravatar.com/avatar/?d=mp&f=y";
    else
        return "https://www.gravatar.com/avatar/" + authorEmailMD5 + "?d=retro";
}

var jwk = {"kty":"RSA","alg":"RSA-OAEP","n":"wviXqUJGtV8hZrvJMcTbyzm7MmiJSqsAfWI_7pCyAhXXzz5C9F3NtXp79CCUMqkOck6IbNKUntPtGNOGwtoc5LTJNKLhx3TPi4TJyKUSfNr3pAdLpMRNeeRXCHFyyVsDb6z8ueixlKzdbDpZhV05bam49PurMHfeexJ3EJy2NpdFviykRJxtrERi6ckBe96VMlT_pHHIWLN5EwOK54DvNn1DYjiFK5ux5WRCFatZByzytrFvIllZRctNXZ8oTuMjQwKLY2bUrURblbIvLfX-9Yd7uVgdUSFE7-vSel9-DMyp_NQ-NRXrQbJG7IAYhSGSx-TPepCDPbFpMq3yC0iET7wF7-OQOb-Kwej_TKVJv-z4SbN-cpCqaMr5Q9scyGih7xr1YrOhe3TMs_cbgjtxsZbzkOqcuRreON_sGb9nlDpSIFCo6aH47GeMkA23Hk3HXAPyYQ7AfWhU9daiPcySiAFnfkrg2QvFNJmMSZ-bo4Co-JkjiqKw-LEpOw6Ed9LK4walxWUAqPGcT4_Uys3TH9XVex9_rEmigHXiJY3_Lwi6mTSkW10-zen5UXxqnyHpMxlmumohT96OyLyhEPeaaq8FrTYMCX8TiMOst3jF5QCNP-LFz21yeUEAr5_3-FKV2mjWEU9iW0dOOVTII2rlD0WtCkqkDwZtakQ1ynGdW1E","e":"AQAB"};

function commentId(id) { return "comment-" + id; }

function $commentForm(hideForm, comment) {
    var $previewDiv = $('<div/>');
    var $authorEmailEncrypted = $('<input type="hidden" name="fields[authorEmailEncrypted]">');
    var $authorEmailMD5 = $('<input type="hidden" name="fields[authorEmailMD5]">');
    var $email = $('<input type="email" name="email" class="form-control" placeholder="Email">');
    var $name = $('<input type="text" name="fields[authorName]" class="form-control" placeholder="Name">');
    var $url = $('<input type="url" name="fields[authorUri]" class="form-control" placeholder="Url">');
    var $message = $('<textarea name="fields[message]" class="form-control" placeholder="Message"/></textarea>');
    autosize($message);
    var $replyTo = $('<input type="hidden" name="fields[replyTo]">').val("");
    var $recaptcha = $('<div class="g-recaptcha" data-sitekey="6LfSaV8UAAAAAEFq-7HeUDiSQCkCtLtO_yc_SOi_"></div>');
    var $buttonBar = $('<div class="comment-form-buttonbar"/>').append($('<button type="submit" class="btn btn-primary pull-right">Submit</button>'), $recaptcha);
    var $form = $('<form method="POST" action="https://stephencleary-comments.herokuapp.com/v2/entry/StephenCleary/comments.stephencleary.com/master"/>')
        .append($('<input type="hidden" name="fields[postId]">').val(postId))
        .append($('<input type="hidden" name="fields[postUri]">').val(location.href.replace(/#.*/, '')))
        .append($('<input type="hidden" name="options[reCaptcha][siteKey]" value="6LfSaV8UAAAAAEFq-7HeUDiSQCkCtLtO_yc_SOi_">'))
        .append($('<input type="hidden" name="options[reCaptcha][secret]" value="rlAivB9udiXQ8MQx3HNJ2Cw/qA2OJI1noljbySzRpNLKmdaS7LtDRT4T3hZcQswRl5sajt5dr+Txj46K2oEGH2HiStNdMMxCchBg0T6YcbZoAP7Zvax+6/C293ClnzMYq8Ozk4bMDbXEHC11FvHR2eaBKqTgAmQSQ3+N2NU5Aaw4Cqfgsj55Br+lKyK0Ydll6SF9+IjQnGJ6S9QV7rHopROdV3RCaeSsSrhsqyGjhvPRgSdl23npJbZt8R0e4oGd6ogH+VDhkj+S3LFPL+R7h6BiHuUDNuJheaJKYTJtjWt80esZgFYywTyTWnqkNBHxOXyH8+AN4PGI0trvlXzdsGvNYRP+dlV6AQyShI3zimSmB4mqcAnuNhGNvLIsfgTKRT1gmxgG1uxUMPjRq1L3R2wQMSQ1/cEuX2wiLI3UrtT8N+QUEptMQ1jsR7rg28OxqIVhbd2+LeAS90PxbxJ9h3mKAxQ493TmCIxRLbh9RNLl+jy8NsRwz2RikzKLJDZsfB7n/Z30nSDZkOTtT7fMzS3g4eJzT0sZStFQsW7Gis6MVs8hXUYgiuIseALKvAzmobnlycD/rqlCpZ5rYC2xQToc4ZDczfZ0bCP8/R5Op4J8LhI4l0JfR1pZSD9V9xTyQ6MTuTT63Ra72ANxn/0idxveWPJS7WMKbKoGmuTNji4=">'))
        .append($replyTo)
        .append($authorEmailEncrypted)
        .append($authorEmailMD5)
        .append($('<div class="form-group"><label>Name (optional)</label></div>').append($name))
        .append($('<div class="form-group"><label>Email (optional; always encrypted, never shared)</label></div>').append($email))
        .append($('<div class="form-group"><label>Url (optional; must start with "http://" or "https://")</label></div>').append($url))
        .append($('<div class="form-group"><label>Message (supports some Markdown/HTML)</label></div>').append($message));
    if (comment) {
        $replyTo.val(comment._id);
    }
    $form.submit(function (e) {
        e.preventDefault();
        hideForm();
        var postAction = $form.attr('action');
        var postBody = $form.serialize();
        var retries = 5;

        function postIt() {
            var post = $.post(postAction, postBody, "json");
            post.done(function () {
                alert("Comment successfully posted. It should appear on this page in a minute or so.");
            });
            post.error(function () {
                var message = "Failed to post comment";
                if (post.responseText)
                    message += ": " + post.responseText;
                
                if (--retries > 0) {
                    console.log(message);
                    postIt();
                } else {
                    alert(message);
                }
            });
        }

        postIt();
    });

    function createComment() {
        return normalizeComment({
            date: moment().format(),
            _id: "_",
            replyTo: comment ? comment._id : undefined,
            authorName: $name.val(),
            authorEmailMD5: $authorEmailMD5.val(),
            authorUri: $url.val(),
            message: $message.val()
        });
    };

    function recreatePreview() {
        var email = $email.val();
        if (email && email.indexOf("@") !== -1) {
            var data = new TextEncoder().encode($email.val());
            window.crypto.subtle.importKey("jwk", jwk, { name: "RSA-OAEP", hash: { name: "SHA-1" } }, false, ["encrypt"]).then(function (encryptionKey) {
                return window.crypto.subtle.encrypt({ name: "RSA-OAEP" }, encryptionKey, data)
                    .then(function (encrypted) {
                        var array = new Uint8Array(encrypted);
                        var text = base64js.fromByteArray(array);
                        $authorEmailEncrypted.val(text);
                        return text;
                    });
            });
            $authorEmailMD5.val(md5($email.val().replace(/^ +| +$/g, '').toLowerCase()));
        } else {
            $authorEmailMD5.val("");
            $authorEmailEncrypted.val("");
        }

        var $newPreview = $comment(false, createComment());
        // Turn off permalink and anchor
        var $anchor = $newPreview.find('.comment-date a');
        $anchor.replaceWith($('<span/>').text($anchor.text()));
        $newPreview.find('.comment-anchor').remove();
        $previewDiv.empty();
        $previewDiv.append($newPreview);
    };

    recreatePreview();
    $name.on('change keyup input paste', recreatePreview);
    $email.on('change keyup input paste', recreatePreview);
    $url.on('change keyup input paste', recreatePreview);
    $message.on('change keyup input paste', recreatePreview);

    $form.append($('<h3>Preview:</h3>'), $previewDiv, $buttonBar);
    return {
        $form: $('<div class="comment-form"/>').append($form),
        onShow: function() { grecaptcha.render($recaptcha[0]); }
    };
}

function $replyButton(comment) {
    var $button;
    if (comment)
        $button = $('<button class="btn btn-primary comment-reply"><i class="fa fa-reply"></i> Reply</button>');
    else
        $button = $('<button class="btn btn-primary comment-new"><i class="fa fa-plus-square"></i> New Comment</button>');
    return $button;
}

var now = moment();
function $comment(includeForm, comment) {
    var message = sanitizeHtml(markdownConverter.makeHtml(comment.message), sanitizeOptions);
    var $commentDiv = $('<div class="comment"/>');
    var publicationDate = moment(comment.date);
    var $author = $('<div class="comment-author"/>').append($('<span class="comment-author-name"/>').text(comment.authorName));
    if (comment.authorUri !== "")
        $author.append($('<span> • </span>'), $('<a class="comment-author-uri" rel="nofollow noopener"/>').attr('href', comment.authorUri).text(comment.authorUri));
    var $headerDiv = $('<div class="comment-header"/>').append(
        $('<div class="comment-author-profile" style="float:left;"/>').append($('<img class="comment-author-profile-image" src="' + avatarUri(comment.authorEmailMD5) + '"/>')),
        $author,
        $('<div class="comment-date" />').append(
            $('<a/>').attr('href', '#' + commentId(comment._id)).attr('title', 'permalink').text(publicationDate.from(now) + ' (' + publicationDate.format('YYYY-MM-DD hh:mm:ss a') + ')')
        )
    );
    if (comment.replyTo !== "") {
        var parent = comments.filter(function (x) { return x._id === comment.replyTo })[0];
        $headerDiv.append($('<div/>').append($('<a/>').attr('href', '#' + commentId(comment.replyTo)).text('In reply to ' + parent.authorName)));
    }

    $commentDiv.append($('<div class="comment-anchor"/>').attr('id', commentId(comment._id)),
        $headerDiv,
        $('<div class="comment-message" style="clear:both;"/>').html(message)
    );

    var $commentContainer = $('<div class="comment-container"/>').append($commentDiv);
    if (includeForm)
        $commentContainer.append($expandCollapseForm(comment));
    var childComments = filterComments(comment._id);
    for (var i = 0; i != childComments.length; ++i) {
        var child = childComments[i];
        $commentContainer.append($comment(includeForm, child));
    }

    return $commentContainer;
}

function normalizeComment(x) {
    var uri = x.authorUri;
    if (!uri || (!uri.startsWith("http://") && !uri.startsWith("https://")))
        uri = "";
    return {
            _id: x._id,
            authorName: x.authorName || "Anonymous",
            authorEmailMD5: x.authorEmailMD5 || "",
            authorUri: uri,
            message: x.message || "",
            replyTo: x.replyTo || "",
            date: x.date,
            timestamp: moment(x.date).valueOf()
    };
}

function $expandCollapseForm(comment) {
    var $button = $replyButton(comment);
    var formObj = $commentForm(hideForm, comment);
    var $form = formObj.$form.addClass("comment-hidden");
    var onShow = formObj.onShow;
    function showForm() {
        $button.addClass("comment-hidden");
        if (onShow) {
            onShow();
            onShow = null;
        }
        $form.removeClass("comment-hidden");
    }
    function hideForm() {
        $form.addClass("comment-hidden");
        $button.removeClass("comment-hidden");
    }
    $button.click(showForm);
    return $('<div/>').append($button, $form);
}

function recaptchaLoaded() {
    var req = new XMLHttpRequest();
    req.addEventListener("load", function () {
        var $commentDiv = $('#comments');
        if (req.status === 404 || req.status === 200) {
            if (req.status === 404) {
                comments = [];
            } else {
                comments = JSON.parse(req.responseText).map(normalizeComment);
            }
            var commentCounter = document.getElementById('comment-counter');
            commentCounter.innerText = comments.length + " " + commentCounter.innerText;
            var toplevelComments = filterComments("");
            for (var i = 0; i != toplevelComments.length; ++i) {
                var comment = toplevelComments[i];
                $commentDiv.append($comment(true, comment));
            }
            if (comments.length !== 0) {
                $commentDiv.append($expandCollapseForm());
            }
        }
        $commentDiv.prepend($expandCollapseForm());
    });
    req.open('GET', "https://comments.stephencleary.com/" + postId + ".json");
    req.send();
}
</script>

<script src="https://www.google.com/recaptcha/api.js?onload=recaptchaLoaded&amp;render=explicit"></script>



<!-- Google AdSense -->
<script src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- Moment -->
<script type="text/javascript">
    (function($) {
        $(function () {
            $('time').each(function (_, e) {
                var startOfToday = moment().startOf('day');
                var publicationDate = moment($(e).attr('datetime'), 'YYYY-MM-DD');
                var difference = startOfToday.diff(publicationDate, 'days');
                var text = difference === 0 ? 'Today' :
                    difference === 1 ? 'Yesterday' :
                    publicationDate.from(startOfToday);
                $(e).text(function(_, oldText) { return text + ' (' + oldText + ')'; });
            });
        });
    })(window.jQuery);
</script>




</body>
</html>